<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<feed xmlns="http://www.w3.org/2005/Atom" xml:lang="en-us">
    <title>devDosvid blog</title>
    <id>https://devdosvid.blog/</id>
    <link href="https://devdosvid.blog/series/mac1.metal-at-aws/"/>
    <updated>2024-03-25T17:30:06Z</updated>
    <author>
        <name>devDosvid blog</name>
        <uri>https://devdosvid.blog/</uri>
    </author>
    <generator>Hugo gohugo.io</generator>
    <logo>https://devdosvid.blog/assets/img/websitelogo.jpg</logo>
    <link rel="alternate" type="text/html" href="https://devdosvid.blog/series/mac1.metal-at-aws/" hreflang="en-us"/>
    <entry>
        <title>Mastering AWS API Gateway V2 HTTP and AWS Lambda With Terraform</title>
        <link href="https://devdosvid.blog/2024/01/09/mastering-aws-api-gateway-v2-http-and-aws-lambda-with-terraform/" hreflang="en" rel="alternate"/>
        <published>2024-01-09T02:33:10Z</published>
        <updated>2024-03-25T17:29:29Z</updated>
        <id>https://devdosvid.blog/2024/01/09/mastering-aws-api-gateway-v2-http-and-aws-lambda-with-terraform/</id>
        <author>
            <name>Serhii Vasylenko</name>
        </author>
        <logo>https://devdosvid.blog/2024/01/09/mastering-aws-api-gateway-v2-http-and-aws-lambda-with-terraform/cover-image.jpg</logo>
        <content type="html">&lt;p&gt;With a solid foundation in AWS API Gateway and Lambda for serverless architecture, my recent deep dive into these cloud computing services felt like uncovering new layers in familiar territory. This article aims to be a comprehensive guide for developers and DevOps professionals looking to master serverless solutions using AWS and Terraform.&lt;/p&gt;
&lt;p&gt;The article provides an in-depth guide to &lt;strong&gt;combining AWS API Gateway V2 HTTP API&lt;/strong&gt; (yes, this is the official name of that service üòÑ) &lt;strong&gt;and AWS Lambda&lt;/strong&gt; services to implement a simple, robust, and cost-effective serverless back-end using Terraform.&lt;/p&gt;
&lt;p&gt;The journey was enlightening and engaging, especially as I were transforming these services into Infrastructure as Code. Through this article, I aim to share those moments of insight and the practical, hands-on tips that emerged from weaving these AWS services into a seamless, serverless architecture.&lt;/p&gt;
&lt;h2 id=&#34;navigating-the-system-design-http-api-gateway-and-lambda-in-action&#34;&gt;Navigating the System Design: HTTP API Gateway and Lambda in Action&lt;/h2&gt;
&lt;p&gt;Beginning our journey, we examine the complexities of serverless architecture, focusing on HTTP API and Lambda. A comprehensive system diagram will guide us as we analyze each component&amp;rsquo;s function and their collaborative roles in the larger infrastructure.&lt;/p&gt;
&lt;figure&gt;




&lt;img loading=&#34;lazy&#34;
     src=&#34;api-gateway-lambda-authorization-flow.png&#34;
    alt=&#34;HTTP API Gateway and AWS Lambda flowchart&#34;width=&#34;800&#34;
height=&#34;440.50&#34;
/&gt; &lt;figcaption&gt;
    &lt;p&gt;HTTP API Gateway and AWS Lambda flowchart&lt;/p&gt;
&lt;/figcaption&gt;
&lt;/figure&gt;

&lt;p&gt;In our architecture, the HTTP API delegates access control to the Lambda function called &amp;ldquo;Authorizer&amp;rdquo;. This function stands as the gatekeeper, ensuring that only legitimate requests pass through to the underlying business logic.&lt;/p&gt;
&lt;p&gt;The HTTP API can have multiple routes (e.g., &amp;ldquo;/calendar,&amp;rdquo; &amp;ldquo;/meters,&amp;rdquo; and so on) and use different Authorizers per route or a single one for all of them. Clients that send their requests to the API must include specific identification information in their request header or query string. In this project, I go with a single authorizer to keep it simple.&lt;/p&gt;
&lt;p&gt;Upon receiving a request, the API service forwards a payload to the Authorizer containing metadata about the request, such as headers and query string components. The Authorizer processes this metadata (headers, in my case) to determine the request&amp;rsquo;s legitimacy.&lt;/p&gt;
&lt;p&gt;The decision, Allow or Deny, is passed back to the API, and if allowed, the API service then forwards the original request to the back-end, which, in this case, is implemented by additional Lambda functions. Otherwise, the client gets a response with a 403 status code, and the original request is not passed to the back-end.&lt;/p&gt;
&lt;div class=&#34;substack-embedded-container&#34;&gt;
    &lt;h3&gt;Subscribe to blog updates!&lt;/h3&gt;
    &lt;iframe title=&#34;Substack&#34; class=&#34;substack-embedded-iframe&#34; src=&#34;https://devdosvid.substack.com/embed&#34; height=&#34;250&#34;
            loading=&#34;lazy&#34;&gt;&lt;/iframe&gt;
&lt;/div&gt;
&lt;h2 id=&#34;behind-the-decision-why-such-a-setup&#34;&gt;Behind The Decision: Why Such a Setup?&lt;/h2&gt;
&lt;p&gt;Choosing the right architectural setup is critical in balancing simplicity, cost-efficiency, and security. In this section, we uncover why integrating AWS HTTP API Gateway with Lambda Authorizer is a compelling choice, offering a streamlined approach without compromising security.&lt;/p&gt;
&lt;h3 id=&#34;cost-effectiveness-balancing-performance-and-price&#34;&gt;Cost-Effectiveness: Balancing Performance and Price&lt;/h3&gt;
&lt;p&gt;The AWS HTTP API is noteworthy for its streamlined and simple design compared to other API Gateway options. That translates directly into cost savings for businesses. Its efficiency makes it an ideal choice for cost-effective serverless computing, especially for those looking to optimize their cloud infrastructure with Terraform automation. Here is a more detailed comparison of different API Gateway options ‚Äî &lt;a href=&#34;https://docs.aws.amazon.com/whitepapers/latest/best-practices-api-gateway-private-apis-integration/cost-optimization.html&#34;&gt;Cost optimization&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Security with Lambda Authorizer. This option means a Lambda function used for authorization, which is lean and efficient. It generally requires a bare minimum of resources. It executes quickly, particularly when configured with the ARM-based environment and 128M RAM allocation, costing $0,0000017 per second of running time, with $0.20 per 1M requests per month.&lt;/p&gt;
&lt;p&gt;üí∞ This pricing and performance combination are well-suited for rapid, lightweight authorizations. Together with AWS Lambda as a back-end, it makes a cost-effective solution. For example, if we add a few more Lambdas to back-end and assume that our setup receives 10000 requests per month, it would cost around $0.6 per month. Here is the link to detailed calculations ‚Äî &lt;a href=&#34;https://calculator.aws/#/estimate?id=b1a8a473ab98ede32f5ca384c5e9487b967efafa&#34;&gt;AWS Pricing Calculator&lt;/a&gt;.&lt;/p&gt;
&lt;h3 id=&#34;simplicity-in-configuration-the-power-of-header-based-authorization&#34;&gt;Simplicity in Configuration: The Power of Header-Based Authorization&lt;/h3&gt;
&lt;p&gt;A header-based authentication method facilitates straightforward client-server communication, often requiring less coding and resources to implement compared to more complex schemes.&lt;/p&gt;
&lt;p&gt;Although HTTP API offers stronger JWT-based authorization and mutual TLS authentication, header-based authorization remains a suitable choice for simpler applications that prioritize ease and quickness. &lt;em&gt;By the way, there is also an option for IAM-based authorization whose core idea is the &amp;ldquo;private API&amp;rdquo; or internal usage of the API (e.g., solely inside the VPC, no internet), but with &amp;ldquo;&lt;a href=&#34;https://docs.aws.amazon.com/rolesanywhere/latest/userguide/introduction.html&#34;&gt;IAM Anywhere&lt;/a&gt;,&amp;rdquo; this can be expanded to practically anywhere.&lt;/em&gt; üòÅ&lt;/p&gt;
&lt;p&gt;This architecture suits applications requiring rapid development and deployment without complex authorization mechanisms. It&amp;rsquo;s ideal for small to medium-sized serverless applications or specific use cases in larger systems where quick, cost-effective, and secure access to APIs is a priority.&lt;/p&gt;
&lt;p&gt;üí° Imagine a retail company wanting to manage its inventory efficiently. By leveraging AWS API Gateway and Lambda, they can develop a system where each item&amp;rsquo;s RFID tags are scanned and processed through an API endpoint. When a product is moved or sold, its status is updated in real-time in the database, facilitated by Lambda functions. This serverless architecture ensures high availability and scalability and significantly reduces operational costs, a crucial factor for the highly competitive retail industry. This example showcases how our serverless setup can be effectively utilized in retail for streamlined inventory tracking and management.&lt;/p&gt;
&lt;h2 id=&#34;exploring-aws-lambda-features-and-integration&#34;&gt;Exploring AWS Lambda: Features and Integration&lt;/h2&gt;
&lt;p&gt;Diving into AWS Lambda, this section explores its features and indispensable role within the serverless infrastructure.  We will unravel the complexities of Lambda functions and examine the practicalities of deploying and managing these functions within the project.&lt;/p&gt;
&lt;h3 id=&#34;aws-lambda-runtime-and-deployment-model&#34;&gt;AWS Lambda Runtime and Deployment Model&lt;/h3&gt;
&lt;p&gt;üöÄ Choosing the &lt;strong&gt;AWS Lambda runtime arm64&lt;/strong&gt;, combined with the OS-only runtime based on &lt;strong&gt;Amazon Linux 2023&lt;/strong&gt;, strategically boosts cost efficiency and performance. This choice aligns with the best practices for serverless computing in AWS, offering an optimal solution for those seeking to leverage AWS services for scalable cloud solutions.&lt;/p&gt;
&lt;p&gt;Particularly effective for Go-based functions, this runtime configuration is lean yet powerful. For applications in other languages, delving into &lt;a href=&#34;https://docs.aws.amazon.com/lambda/latest/dg/lambda-runtimes.html&#34;&gt;language-specific runtimes based on AL 2023&lt;/a&gt; can also leverage the latest efficiencies of AWS-managed operating systems.&lt;/p&gt;
&lt;div class=&#34;attention&#34;&gt;
    I also welcome you to read this benchmarking analysis to get more insights about the ARM-based environment for AWS Lambda ‚Äî &lt;a href=&#34;https://aws.amazon.com/blogs/apn/comparing-aws-lambda-arm-vs-x86-performance-cost-and-analysis-2/&#34;&gt;Comparing AWS Lambda Arm vs. x86 Performance, Cost, and Analysis&lt;/a&gt;.
&lt;/div&gt;
&lt;p&gt;The .&lt;strong&gt;zip deployment&lt;/strong&gt; model is chosen for its simplicity, avoiding additional management of the image registry (ECR) and Docker images. Also, AWS automatically patches .zip functions for the latest runtime security and bug fixes.&lt;/p&gt;
&lt;h3 id=&#34;efficient-terraform-coding-for-aws-lambda&#34;&gt;Efficient Terraform Coding for AWS Lambda&lt;/h3&gt;
&lt;p&gt;In our architecture, AWS Lambda functions serve dual purposes ‚Äî as an authentication gatekeeper and a robust back-end for business logic. Despite varying code across functions, their configurations share much of similarities.&lt;/p&gt;
&lt;p&gt;By adhering to the DRY (Don&amp;rsquo;t Repeat Yourself) principle, I have crafted a Terraform module to streamline the management of Lambda functions and their dependencies. This approach ensures maintainable and scalable infrastructure. The module&amp;rsquo;s structure is as follows:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;aws_lambda_function&lt;/code&gt; ‚Äî to describe the core configuration of the function&lt;/li&gt;
&lt;li&gt;&lt;code&gt;aws_iam_role&lt;/code&gt; &#43; &lt;code&gt;aws_iam_role_policy&lt;/code&gt; &#43; &lt;code&gt;aws_iam_policy_document&lt;/code&gt; ‚Äî to manage the access from Lambda to other resources (e.g., SSM Parameter Store)&lt;/li&gt;
&lt;li&gt;&lt;code&gt;aws_cloudwatch_log_group&lt;/code&gt; ‚Äî to keep the execution logs&lt;/li&gt;
&lt;li&gt;&lt;code&gt;aws_ssm_parameter&lt;/code&gt; ‚Äî to store sensitive information (e.g., secrets) and other configurations that we should keep separate from the source code.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;This Terraform module implements a project-specific use case for Lambda functions. However, if you&amp;rsquo;re seeking for a generic all-in-one module for AWS Lambda, I recommend checking out this one ‚Äî &lt;a href=&#34;https://registry.terraform.io/modules/terraform-aws-modules/lambda/aws/latest&#34;&gt;Terraform AWS Lambda Module&lt;/a&gt; by Anton Babenko.&lt;/p&gt;
&lt;div class=&#34;attention&#34;&gt;
    &lt;p&gt;To efficiently develop Terraform code for Lambda functions, use the following techniques:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Use local values, expressions, and variables to implement consistent naming across different resources logically grouped by a module or project;&lt;/li&gt;
&lt;li&gt;Use function environment variables to connect the code with SSM Parameter Store parameters or Secrets Manager secrets to protect sensitive data like tokens or credentials;&lt;/li&gt;
&lt;li&gt;Use &lt;code&gt;for_each&lt;/code&gt; meta-argument and &lt;code&gt;for&lt;/code&gt; expression to reduce the amount of code and automate the configuration for resources of the same type (e.g., &lt;code&gt;ssm_parameter&lt;/code&gt;) or code blocks within a resource.&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;p&gt;Below is a practical example illustrating these Terraform strategies in action:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-terraform&#34; data-lang=&#34;terraform&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;locals {  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  full_function_name = &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#a5d6ff&#34;&gt;${&lt;/span&gt;var.project_name&lt;span style=&#34;color:#a5d6ff&#34;&gt;}&lt;/span&gt;&lt;span style=&#34;color:#a5d6ff&#34;&gt;-&lt;/span&gt;&lt;span style=&#34;color:#a5d6ff&#34;&gt;${&lt;/span&gt;var.function_name&lt;span style=&#34;color:#a5d6ff&#34;&gt;}&lt;/span&gt;&lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;&lt;/span&gt;  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;}  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#ff7b72&#34;&gt;resource&lt;/span&gt; &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;aws_lambda_function&amp;#34;&lt;/span&gt; &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;this&amp;#34;&lt;/span&gt; {  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  function_name = local.full_function_name  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  role          = aws_iam_role.this.arn  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  architectures = [&lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;arm64&amp;#34;&lt;/span&gt;]  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  filename      = var.deployment_file  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  package_type  = &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;Zip&amp;#34;&lt;/span&gt;  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  runtime       = &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;provided.al2023&amp;#34;&lt;/span&gt;  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  handler       = &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;bootstrap.handler&amp;#34;&lt;/span&gt;  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  timeout       = var.function_timeout  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  environment {  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    variables = { &lt;span style=&#34;color:#ff7b72&#34;&gt;for&lt;/span&gt; item &lt;span style=&#34;color:#ff7b72&#34;&gt;in&lt;/span&gt; var.function_ssm_parameter_names &lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;:&lt;/span&gt; upper(replace(item, &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;-&amp;#34;&lt;/span&gt;, &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;_&amp;#34;&lt;/span&gt;)) =&amp;gt; aws_ssm_parameter.function_ssm_parameters[item].name }  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  }  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;}  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#ff7b72&#34;&gt;resource&lt;/span&gt; &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;aws_ssm_parameter&amp;#34;&lt;/span&gt; &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;function_ssm_parameters&amp;#34;&lt;/span&gt; {  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  for_each = var.function_ssm_parameter_names  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  name     = &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;/projects/&lt;/span&gt;&lt;span style=&#34;color:#a5d6ff&#34;&gt;${&lt;/span&gt;var.project_name&lt;span style=&#34;color:#a5d6ff&#34;&gt;}&lt;/span&gt;&lt;span style=&#34;color:#a5d6ff&#34;&gt;/lambda/&lt;/span&gt;&lt;span style=&#34;color:#a5d6ff&#34;&gt;${&lt;/span&gt;var.function_name&lt;span style=&#34;color:#a5d6ff&#34;&gt;}&lt;/span&gt;&lt;span style=&#34;color:#a5d6ff&#34;&gt;/&lt;/span&gt;&lt;span style=&#34;color:#a5d6ff&#34;&gt;${&lt;/span&gt;each.value&lt;span style=&#34;color:#a5d6ff&#34;&gt;}&lt;/span&gt;&lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;&lt;/span&gt;  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  type     = &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;SecureString&amp;#34;&lt;/span&gt;  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  key_id   = data.aws_kms_alias.ssm.arn  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  value    = &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;1&amp;#34;&lt;/span&gt;  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  lifecycle {  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    ignore_changes = [  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      value,  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    ]  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  }  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;}  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#ff7b72&#34;&gt;resource&lt;/span&gt; &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;aws_cloudwatch_log_group&amp;#34;&lt;/span&gt; &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;this&amp;#34;&lt;/span&gt; {  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  name              = &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;/aws/lambda/&lt;/span&gt;&lt;span style=&#34;color:#a5d6ff&#34;&gt;${&lt;/span&gt;local.full_function_name&lt;span style=&#34;color:#a5d6ff&#34;&gt;}&lt;/span&gt;&lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;&lt;/span&gt;  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  log_group_class   = &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;STANDARD&amp;#34;&lt;/span&gt;  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  retention_in_days = &lt;span style=&#34;color:#a5d6ff&#34;&gt;7&lt;/span&gt;  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;em&gt;The complete terraform module code is available in the &lt;a href=&#34;https://github.com/vasylenko/inkyframe/blob/main/infra/modules/lambda/main.tf&#34;&gt;project repository&lt;/a&gt;.&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;In this Terraform code, I deliberately hardcoded specific arguments for an optimal Lambda runtime configuration, ensuring efficiency and performance.&lt;/p&gt;
&lt;p&gt;Then variables and local values, set only once, implement a naming convention for all resource arguments, making it easy to understand the infrastructure and change the naming and attributes later.&lt;/p&gt;
&lt;div class=&#34;attention&#34;&gt;
    Lambda&amp;rsquo;s environment variables and corresponding SSM parameters coexist effectively with the help of &lt;code&gt;for_each&lt;/code&gt; and &lt;code&gt;for&lt;/code&gt;. I used the &lt;code&gt;for_each&lt;/code&gt; meta-argument to dynamically create SSM Parameter resources and the &lt;code&gt;for&lt;/code&gt; expression to configure environment variables in AWS Lambda. This also means that if the &lt;code&gt;function_ssm_parameter_names&lt;/code&gt; variable value is not provided, then Terraform does not create either SSM parameter resources or the environment code block inside the Lambda resource because the default value of that variable is an empty set.
&lt;/div&gt;
&lt;p&gt;By the way, I have another blog post that explains several techniques to enhance your Terraform proficiency ‚Äî &lt;a href=&#34;https://devdosvid.blog/2022/01/16/some-techniques-to-enhance-your-terraform-proficiency&#34;&gt;check it out&lt;/a&gt;!&lt;/p&gt;
&lt;h3 id=&#34;invoking-lambda-permissions-and-resource-based-policies&#34;&gt;Invoking Lambda: Permissions and Resource-Based Policies&lt;/h3&gt;
&lt;p&gt;Configured with just a few input variables, the Terraform module efficiently outputs the &lt;code&gt;aws_lambda_function&lt;/code&gt; resource. This streamlined output is then adeptly used to facilitate subsequent configurations within the HTTP API.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-terraform&#34; data-lang=&#34;terraform&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#ff7b72&#34;&gt;module&lt;/span&gt; &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;lambda_api_gw_authorizer&amp;#34;&lt;/span&gt; {  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  source          = &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;./modules/lambda&amp;#34;&lt;/span&gt;  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  deployment_file = &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;../backend/lambda-apigw-authorizer/deployment.zip&amp;#34;&lt;/span&gt;  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  function_name   = &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;api-gateway-authorizer&amp;#34;&lt;/span&gt;  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  project_name    = local.project_name  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  function_ssm_parameters = [  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;authorization-token&amp;#34;&lt;/span&gt;  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  ]  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#ff7b72&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#ff7b72&#34;&gt;module&lt;/span&gt; &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;lambda_calendar_backend&amp;#34;&lt;/span&gt; {  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  source          = &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;./modules/lambda&amp;#34;&lt;/span&gt;  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  deployment_file = &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;../backend/lambda-calendar-backend/deployment.zip&amp;#34;&lt;/span&gt;  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  function_name   = &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;calendar-backend&amp;#34;&lt;/span&gt;  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  project_name    = local.project_name  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  function_ssm_parameters = [  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;google-api-oauth-token&amp;#34;&lt;/span&gt;,  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;google-api-credentials&amp;#34;&lt;/span&gt;  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  ]  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;As an example of module output usage, here is the configuration of &lt;code&gt;aws_lambda_permissions&lt;/code&gt; resource that I use outside the AWS Lambda module to allow the HTTP API service to invoke the function used as Authorizer:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-terraform&#34; data-lang=&#34;terraform&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#ff7b72&#34;&gt;resource&lt;/span&gt; &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;aws_lambda_permission&amp;#34;&lt;/span&gt; &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;allow_api_gw_invoke_authorizer&amp;#34;&lt;/span&gt; {  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  statement_id  = &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;allowInvokeFromAPIGatewayAuthorizer&amp;#34;&lt;/span&gt;  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  action        = &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;lambda:InvokeFunction&amp;#34;&lt;/span&gt;  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  function_name = module.lambda_api_gw_authorizer.lambda.function_name  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  principal     = &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;apigateway.amazonaws.com&amp;#34;&lt;/span&gt;  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  source_arn    = &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#a5d6ff&#34;&gt;${&lt;/span&gt;aws_apigatewayv2_api.this.execution_arn&lt;span style=&#34;color:#a5d6ff&#34;&gt;}&lt;/span&gt;&lt;span style=&#34;color:#a5d6ff&#34;&gt;/authorizers/&lt;/span&gt;&lt;span style=&#34;color:#a5d6ff&#34;&gt;${&lt;/span&gt;aws_apigatewayv2_authorizer.header_based_authorizer.id&lt;span style=&#34;color:#a5d6ff&#34;&gt;}&lt;/span&gt;&lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;&lt;/span&gt;  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;div class=&#34;attention&#34;&gt;
    The Lambda resource-based policy combines the trust and permission policies, and provides a simple yet efficient way to grant other AWS services or principals the ability to invoke Lambda functions. It is important to note that for an API to invoke a function, Lambda requires its &lt;strong&gt;execution&lt;/strong&gt; ARN, not the resource ARN.
&lt;/div&gt;
&lt;p&gt;As a side note, check out this &lt;a href=&#34;https://docs.aws.amazon.com/lambda/latest/operatorguide/intro.html&#34;&gt;AWS Lambda Operator Guide&lt;/a&gt;, which offers specialized advice on developing, securing, and monitoring applications based on AWS Lambda.&lt;/p&gt;
&lt;p&gt;Let&amp;rsquo;s switch to the HTTP API part to see how it looks and learn how it integrates Lambda functions.&lt;/p&gt;
&lt;h2 id=&#34;deep-dive-into-http-api-gateway&#34;&gt;Deep Dive into HTTP API Gateway&lt;/h2&gt;
&lt;p&gt;Now, we focus on the HTTP API Gateway, delving into its essential concepts, seamless integration with AWS Lambda, and using Terraform efficiently for streamlined configuration.&lt;/p&gt;
&lt;p&gt;But before we do that, and since we have partially covered the Terraform code already, I&amp;rsquo;d like to illustrate the logical connection between three main components of the project&amp;rsquo;s Terraform codebase: AWS Lambda, HTTP API, and API Routes.&lt;/p&gt;
&lt;figure&gt;




&lt;img loading=&#34;lazy&#34;
     src=&#34;terraform-aws-lambda-http-api-integration.png&#34;
    alt=&#34;AWS Lambda and HTTP API Terraform integration diagram&#34;width=&#34;800&#34;
height=&#34;552.50&#34;
/&gt; &lt;figcaption&gt;
    &lt;p&gt;AWS Lambda and HTTP API Terraform integration diagram&lt;/p&gt;
&lt;/figcaption&gt;
&lt;/figure&gt;

&lt;p&gt;I will explain the API Route module in detail a bit later, but for now, for the broader context, here is what happens inside Terraform:
AWS HTTP API code logically represents the &amp;ldquo;global&amp;rdquo; (within a project) set of resources and uses the function created by the Lambda Terraform module for the Authorizer configuration. Meanwhile, the API Route Terraform module configures specific routes for the HTTP API (hence, requires some info from it) with integration to back-ends implemented by Lambdas (hence, requires some info from them, too).&lt;/p&gt;
&lt;p&gt;Back to HTTP API overview. The following &lt;strong&gt;components of the HTTP API&lt;/strong&gt; constitute its backbone:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;Route&lt;/strong&gt; ‚Äî a combination of the HTTP method (e.g., GET or POST) with the API route (e.g., /meters). For example: &amp;ldquo;POST /meters&amp;rdquo;. Routes can optionally use &lt;strong&gt;Authorizers&lt;/strong&gt; ‚Äî a mechanism to control access to the HTTP API.&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Integration&lt;/strong&gt; ‚Äî the technical and logical connection between the Route and one of the supported back-end resources. For example, with AWS Lambda integration, API Gateway sends the entire request as input to a back-end Lambda function and then transforms the Lambda function output to a front-end HTTP response.&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Stage and Deployment&lt;/strong&gt; ‚Äî A stage serves as a designated reference to a deployment, essentially capturing a snapshot of the API at a certain point. It&amp;rsquo;s employed to control and optimize a specific deployment version. For instance, stage configurations can be adjusted to tailor request throttling, set up logging, or establish stage variables to be used by API (if needed).&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;implementing-aws-api-gateway-v2-http-api-with-terraform&#34;&gt;Implementing AWS API Gateway V2 HTTP API with Terraform&lt;/h3&gt;
&lt;p&gt;Below, I detail the Terraform resources essential for implementing the HTTP API, ensuring a transparent and effective setup:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;aws_apigatewayv2_api&lt;/code&gt; ‚Äî the HTTP API itself;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;aws_apigatewayv2_route&lt;/code&gt; ‚Äî the Route for the API that must specify the integration target (e.g., Lambda) and, optionally, the Authorizer;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;aws_apigatewayv2_authorizer&lt;/code&gt; ‚Äî the Authorizer to use for Routes;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;aws_apigatewayv2_integration&lt;/code&gt; ‚Äî the resource that specifies the back-end where the API sends the requests (e.g., AWS Lambda);&lt;/li&gt;
&lt;li&gt;&lt;code&gt;aws_lambda_permission&lt;/code&gt; ‚Äî the resource-based policy for AWS Lambda to allow the invocations from the API;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;aws_apigatewayv2_stage&lt;/code&gt; ‚Äî the name of the Stage that references the Deployment.&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;applying-terraform-for-http-api-gateway-and-lambda-authorizer&#34;&gt;Applying Terraform for HTTP API Gateway and Lambda Authorizer&lt;/h3&gt;
&lt;p&gt;The HTTP API is the simplest in the API Gateway family (so far), so its Terraform resource has relatively few configuration options, most of which can be left at their default values.&lt;/p&gt;
&lt;p&gt;As for the Authorizer, it can have two options for letting API know its decision: &lt;a href=&#34;https://docs.aws.amazon.com/apigateway/latest/developerguide/http-api-lambda-authorizer.html#http-api-lambda-authorizer.payload-format-response&#34;&gt;simple response and IAM policy&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;The &lt;strong&gt;simple response&lt;/strong&gt; just returns a Boolean value to indicate whether the API should allow the request (True) or forbid it (False).&lt;/p&gt;
&lt;p&gt;The IAM policy option is customizable and allows crafting custom policy statements that allow granular access to explicitly provided resources.&lt;/p&gt;
&lt;p&gt;In this project, I follow the way of simplicity and use the &amp;ldquo;simple response&amp;rdquo;, so the response from Lambda Authorizer to HTTP API looks as follows:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-json&#34; data-lang=&#34;json&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;{
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#7ee787&#34;&gt;&amp;#34;isAuthorized&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#79c0ff&#34;&gt;true&lt;/span&gt;&lt;span style=&#34;color:#f85149&#34;&gt;/&lt;/span&gt;&lt;span style=&#34;color:#79c0ff&#34;&gt;false&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Let&amp;rsquo;s review the HTTP API resource along with the API Authorizer that I used for all routes:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-terraform&#34; data-lang=&#34;terraform&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#ff7b72&#34;&gt;resource&lt;/span&gt; &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;aws_apigatewayv2_api&amp;#34;&lt;/span&gt; &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;this&amp;#34;&lt;/span&gt; {  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  name          = local.project_name  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  protocol_type = &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;HTTP&amp;#34;&lt;/span&gt;  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#ff7b72&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#ff7b72&#34;&gt;resource&lt;/span&gt; &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;aws_apigatewayv2_authorizer&amp;#34;&lt;/span&gt; &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;header_based_authorizer&amp;#34;&lt;/span&gt; {  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  api_id                            = aws_apigatewayv2_api.this.id  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  authorizer_type                   = &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;REQUEST&amp;#34;&lt;/span&gt;  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  name                              = &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;header-based-authorizer&amp;#34;&lt;/span&gt;  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  authorizer_payload_format_version = &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;2.0&amp;#34;&lt;/span&gt;  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  authorizer_uri                    = module.lambda_api_gw_authorizer.lambda.invoke_arn  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  enable_simple_responses           = &lt;span style=&#34;color:#79c0ff&#34;&gt;true&lt;/span&gt;  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  identity_sources                  = [&lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;$request.header.authorization&amp;#34;&lt;/span&gt;] 
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  authorizer_result_ttl_in_seconds  = &lt;span style=&#34;color:#a5d6ff&#34;&gt;3600&lt;/span&gt;  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;}  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#ff7b72&#34;&gt;resource&lt;/span&gt; &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;aws_lambda_permission&amp;#34;&lt;/span&gt; &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;allow_api_gw_invoke_authorizer&amp;#34;&lt;/span&gt; {  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  statement_id  = &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;allowInvokeFromAPIGatewayAuthorizer&amp;#34;&lt;/span&gt;  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  action        = &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;lambda:InvokeFunction&amp;#34;&lt;/span&gt;  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  function_name = module.lambda_api_gw_authorizer.lambda.function_name  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  principal     = &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;apigateway.amazonaws.com&amp;#34;&lt;/span&gt;  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  source_arn    = &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#a5d6ff&#34;&gt;${&lt;/span&gt;aws_apigatewayv2_api.this.execution_arn&lt;span style=&#34;color:#a5d6ff&#34;&gt;}&lt;/span&gt;&lt;span style=&#34;color:#a5d6ff&#34;&gt;/authorizers/&lt;/span&gt;&lt;span style=&#34;color:#a5d6ff&#34;&gt;${&lt;/span&gt;aws_apigatewayv2_authorizer.header_based_authorizer.id&lt;span style=&#34;color:#a5d6ff&#34;&gt;}&lt;/span&gt;&lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;&lt;/span&gt;  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;em&gt;The complete code is available in the &lt;a href=&#34;https://github.com/vasylenko/inkyframe/blob/main/infra/apigateway.tf&#34;&gt;project repository&lt;/a&gt;&lt;/em&gt;.&lt;/p&gt;
&lt;p&gt;Consider the following key points when Terraforming this part.&lt;/p&gt;
&lt;p&gt;&lt;code&gt;identity_sources&lt;/code&gt; argument of the &lt;code&gt;aws_apigatewayv2_authorizer&lt;/code&gt; resource: This is where I defined what exactly the Authorizer should validate. I used the header named &lt;code&gt;authorization&lt;/code&gt; so the Authorizer Lambda function would check its value to decide whether to authorize the request.&lt;br&gt;
üí° &lt;em&gt;Check out other options available to use as the identity source ‚Äî &lt;a href=&#34;https://docs.aws.amazon.com/apigateway/latest/developerguide/http-api-lambda-authorizer.html#http-api-lambda-authorizer.identity-sources&#34;&gt;Identity sources&lt;/a&gt;&lt;/em&gt;.&lt;/p&gt;
&lt;p&gt;&lt;code&gt;authorizer_uri&lt;/code&gt; argument of the &lt;code&gt;aws_apigatewayv2_authorizer&lt;/code&gt; resource: It is the &lt;strong&gt;invocation&lt;/strong&gt; ARN of the Lambda function used as Authorizer (not the Lambda&amp;rsquo;s resource ARN).&lt;/p&gt;
&lt;p&gt;&lt;code&gt;authorizer_result_ttl_in_seconds&lt;/code&gt; argument of the &lt;code&gt;aws_apigatewayv2_authorizer&lt;/code&gt; resource: This allows to skip the Authorizer invocation for the given time if a client provided the same identity source values (e.g., authorization header).&lt;/p&gt;
&lt;div class=&#34;attention&#34;&gt;
    AWS API Gateway HTTP can employ the identity sources as the cache key to preserve the authorization results for a while. Should a client provide identical parameters in identity sources within the preset TTL duration, API Gateway will retrieve the result from the cached authorizer instead of calling upon it again. This helps save a lot on AWS Lambda Authorizer invocations and works great with simple scenarios. However, it might be cumbersome if you need severral custom authorization responses per function or if you use custom IAM policies instead of the &amp;ldquo;simple response&amp;rdquo; option.
&lt;/div&gt;
&lt;p&gt;&lt;code&gt;source_arn&lt;/code&gt; argument of &lt;code&gt;aws_lambda_permission&lt;/code&gt;: Similar to the &lt;code&gt;authorizer_uri&lt;/code&gt; argument, this one expects the &lt;strong&gt;execution&lt;/strong&gt; ARN of the HTTP API followed by the Authorizer identifier.&lt;/p&gt;
&lt;p&gt;Now, let&amp;rsquo;s see how Routes are codified with Terraform.&lt;/p&gt;
&lt;h3 id=&#34;applying-terraform-for-http-api-routes&#34;&gt;Applying Terraform for HTTP API Routes&lt;/h3&gt;
&lt;p&gt;üí° Because an API typically has multiple routes, creating another Terraform module that implements the configurable HTTP API Gateway route is beneficial. Hence, the &lt;code&gt;aws_apigatewayv2_route&lt;/code&gt;, &lt;code&gt;aws_apigatewayv2_integration&lt;/code&gt;, and &lt;code&gt;aws_lambda_permission&lt;/code&gt; resources would constitute such a module.&lt;/p&gt;
&lt;p&gt;This Terraform module implements a specific use case for HTTP API Gateway. However, if you&amp;rsquo;re seeking for a generic all-in-one module for API Gateway, I recommend checking out this one ‚Äî &lt;a href=&#34;https://registry.terraform.io/modules/terraform-aws-modules/apigateway-v2/aws/latest&#34;&gt;Terraform AWS API Gateway Module&lt;/a&gt; by Anton Babenko.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-terraform&#34; data-lang=&#34;terraform&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#ff7b72&#34;&gt;resource&lt;/span&gt; &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;aws_apigatewayv2_route&amp;#34;&lt;/span&gt; &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;this&amp;#34;&lt;/span&gt; {  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  api_id             = var.api_id  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  route_key          = var.route_key  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  authorization_type = &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;CUSTOM&amp;#34;&lt;/span&gt;  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  authorizer_id      = var.authorizer_id  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  target             = &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;integrations/&lt;/span&gt;&lt;span style=&#34;color:#a5d6ff&#34;&gt;${&lt;/span&gt;aws_apigatewayv2_integration.this.id&lt;span style=&#34;color:#a5d6ff&#34;&gt;}&lt;/span&gt;&lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;&lt;/span&gt;  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;}  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#ff7b72&#34;&gt;resource&lt;/span&gt; &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;aws_apigatewayv2_integration&amp;#34;&lt;/span&gt; &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;this&amp;#34;&lt;/span&gt; {  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  api_id                 = var.api_id  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  integration_type       = &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;AWS_PROXY&amp;#34;&lt;/span&gt;  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  connection_type        = &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;INTERNET&amp;#34;&lt;/span&gt;  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  integration_uri        = var.lambda_invocation_arn  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  payload_format_version = &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;2.0&amp;#34;&lt;/span&gt;  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;}  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#ff7b72&#34;&gt;resource&lt;/span&gt; &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;aws_lambda_permission&amp;#34;&lt;/span&gt; &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;this&amp;#34;&lt;/span&gt; {  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  statement_id  = &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;allowInvokeFromAPIGatewayRoute&amp;#34;&lt;/span&gt;  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  action        = &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;lambda:InvokeFunction&amp;#34;&lt;/span&gt;  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  function_name = var.lambda_function_name  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  principal     = &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;apigateway.amazonaws.com&amp;#34;&lt;/span&gt;  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  source_arn    = &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#a5d6ff&#34;&gt;${&lt;/span&gt;var.api_gw_execution_arn&lt;span style=&#34;color:#a5d6ff&#34;&gt;}&lt;/span&gt;&lt;span style=&#34;color:#a5d6ff&#34;&gt;/*/*/*/*&amp;#34;&lt;/span&gt;  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;First, I want to highlight several key aspects for understanding the resources&amp;rsquo; arguments within that module.&lt;/p&gt;
&lt;p&gt;The &lt;code&gt;target&lt;/code&gt; argument of the &lt;code&gt;aws_apigatewayv2_route&lt;/code&gt; resource implies that the integration ID should be prefixed with the &amp;ldquo;&lt;code&gt;integrations/&lt;/code&gt;&amp;rdquo; keyword.&lt;/p&gt;
&lt;p&gt;While the &lt;code&gt;connection_type&lt;/code&gt; argument of the &lt;code&gt;aws_apigatewayv2_integration&lt;/code&gt; resource specifies &amp;ldquo;INTERNET&amp;rdquo;, it does not mean that the Lambda function must have the publicly available URL. This value must be used unless you work with a VPC endpoint for API Gateway for internal usage.&lt;/p&gt;
&lt;p&gt;For the &lt;code&gt;source_arn&lt;/code&gt; argument in the &lt;code&gt;aws_lambda_permission&lt;/code&gt; resource, similar to earlier, it requires the &lt;strong&gt;execution&lt;/strong&gt; ARN of the API. However, this time, it is the integration of the HTTP API Route with Lambda. And the ARN format of this one is different and a bit tricky:&lt;/p&gt;
&lt;p&gt;&lt;code&gt;arn:partition:execute-api:region:account-id:api-id/stage/http-method/resource-path&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;The &lt;code&gt;arn:partition:execute-api:region:account-id:api-id&lt;/code&gt; part constitutes the execution ARN of the HTTP API itself, so for the sake of simplicity, I decided to go with wildcards after it.&lt;br&gt;
&lt;em&gt;For your convenience, here is the &lt;a href=&#34;https://docs.aws.amazon.com/apigateway/latest/developerguide/arn-format-reference.html&#34;&gt;detailed specification&lt;/a&gt; of API Gateway ARNs.&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;The HTTP API Route module expects several input variables:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;authorizer_id&lt;/code&gt; ‚Äî the identifier of the Authorizer to use on this route;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;route_key&lt;/code&gt; ‚Äî the route key for the route, e.g., &lt;code&gt;GET /foo/bar&lt;/code&gt;;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;api_id&lt;/code&gt; ‚Äî the identifier of HTTP API created earlier;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;lambda_invocation_arn&lt;/code&gt; ‚Äî the Invocation ARN of the Lambda function;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;lambda_function_name&lt;/code&gt; ‚Äî the name of the Lambda function to integrate with the route;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;api_gw_execution_arn&lt;/code&gt; ‚Äî the Execution ARN of the HTTP API that invokes a Lambda function.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Let&amp;rsquo;s take a closer look on API Gateway V2 HTTP API route.&lt;/p&gt;
&lt;p&gt;A route consists of an HTTP method and a resource path with an optional variable. Based on the pre-defined convention, it uses a simplified routing configuration and methods request model (comparable to other APIs).&lt;/p&gt;
&lt;div class=&#34;attention&#34;&gt;
    &lt;p&gt;While I was working with the HTTP API, I found this simplified approach to be great because it allows easy access to the request context from AWS Lambda functions, for example:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;A path variable in a route, e.g., &lt;code&gt;GET /calendars/{calendar-name}&lt;/code&gt;, would be available for the integrated AWS Lambda by its name inside the pathParameter JSON field, e.g.,  &lt;code&gt;pathParamters.calendar-name&lt;/code&gt;, of the event object sent by API to Lambda. In other words, you do not need to explicitly set the mapping between the path variable and its representation to the back-end.&lt;/li&gt;
&lt;li&gt;A request query string is parsed into separate parameter-value pairs and available in the &lt;code&gt;queryStringParameters&lt;/code&gt; field of the event object sent by API to Lambda. Again, without the explicit mapping configuration.&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;p&gt;Here, you can read more about the Route specification of HTTP API and how to transform requests and responses from the API side if you need to adjust something:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://docs.aws.amazon.com/apigateway/latest/developerguide/http-api-develop-routes.html&#34;&gt;Working with routes for HTTP APIs&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://docs.aws.amazon.com/apigateway/latest/developerguide/http-api-parameter-mapping.html&#34;&gt;Transforming API requests and responses&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Now back to Terraform. Below is the code snippet that illustrates the call of the API Route Terraform module:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-terraform&#34; data-lang=&#34;terraform&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#ff7b72&#34;&gt;module&lt;/span&gt; &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;route_calendars&amp;#34;&lt;/span&gt; {  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  source                = &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;./modules/api-gateway-route&amp;#34;&lt;/span&gt;  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  api_id                = aws_apigatewayv2_api.this.id  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  route_key             = &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;GET /calendars/{calendar-name}&amp;#34;&lt;/span&gt;  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  api_gw_execution_arn  = aws_apigatewayv2_api.this.execution_arn  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  lambda_invocation_arn = module.lambda_calendar_backend.lambda.invoke_arn  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  lambda_function_name  = module.lambda_calendar_backend.lambda.function_name  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  authorizer_id         = aws_apigatewayv2_authorizer.header_based_authorizer.id  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;This module logically relies on both the HTTP API and Lambda resources to configure their integration by implementing the Route.&lt;/p&gt;
&lt;h2 id=&#34;enhancing-security-and-monitoring-of-aws-api-gateway-v2-http-api&#34;&gt;Enhancing Security and Monitoring of AWS API Gateway V2 HTTP API&lt;/h2&gt;
&lt;p&gt;Several additional options are available to monitor and protect the HTTP API: logs, metrics, and throttling.&lt;/p&gt;
&lt;h3 id=&#34;overview-of-http-api-monitoring-and-protection-options&#34;&gt;Overview of HTTP API monitoring and protection options&lt;/h3&gt;
&lt;p&gt;Logging, metrics, and throttling are configured on the Stage level but allow configuration granularity for the Routes.&lt;/p&gt;
&lt;p&gt;For logs, you can configure the CloudWatch log group, the log format (JSON, CLF, XML, CSV), and content filters. The &lt;a href=&#34;https://docs.aws.amazon.com/apigateway/latest/developerguide/http-api-logging-variables.html&#34;&gt;logging variables&lt;/a&gt; allow you to customize the information that appears in logs. I will provide an example of such a configuration later in the article.&lt;/p&gt;
&lt;p&gt;By default, API Gateway sends only API and stage-level metrics to CloudWatch in one-minute periods. However, you can enable &lt;a href=&#34;https://docs.aws.amazon.com/apigateway/latest/developerguide/http-api-metrics.html&#34;&gt;detailed metrics&lt;/a&gt; and additionally collect the per-route metrics.&lt;/p&gt;
&lt;p&gt;To safeguard your HTTP API from excessive requests, you can employ throttling settings, which allow you to set limits per individual route as well as for all routes collectively.&lt;/p&gt;
&lt;h3 id=&#34;configuring-monitoring-and-protection-for-http-api-with-terraform&#34;&gt;Configuring monitoring and protection for HTTP API with Terraform&lt;/h3&gt;
&lt;p&gt;Now, let&amp;rsquo;s see how Terraform helps configure the protection and monitoring for HTTP API.&lt;/p&gt;
&lt;p&gt;As mentioned earlier, API Gateway applies these configurations at the Stage level, which is why the aws_apigatewayv2_stage resource encapsulates them all.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-terraform&#34; data-lang=&#34;terraform&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#ff7b72&#34;&gt;resource&lt;/span&gt; &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;aws_apigatewayv2_stage&amp;#34;&lt;/span&gt; &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;default&amp;#34;&lt;/span&gt; {  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  api_id      = aws_apigatewayv2_api.this.id  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  name        = &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;$default&amp;#34;&lt;/span&gt;  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  auto_deploy = &lt;span style=&#34;color:#79c0ff&#34;&gt;true&lt;/span&gt;  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  description = &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;Default stage (i.e., Production mode)&amp;#34;&lt;/span&gt;  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  default_route_settings {  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    throttling_burst_limit = &lt;span style=&#34;color:#a5d6ff&#34;&gt;1&lt;/span&gt;  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    throttling_rate_limit  = &lt;span style=&#34;color:#a5d6ff&#34;&gt;1&lt;/span&gt;  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  }  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  access_log_settings {  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    destination_arn = aws_cloudwatch_log_group.api_gateway_logs_inkyframe.arn  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    format = jsonencode({  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      authorizerError           = &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;$context.authorizer.error&amp;#34;&lt;/span&gt;,  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      identitySourceIP          = &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;$context.identity.sourceIp&amp;#34;&lt;/span&gt;,  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      integrationError          = &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;$context.integration.error&amp;#34;&lt;/span&gt;,  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      integrationErrorMessage   = &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;$context.integration.errorMessage&amp;#34;&lt;/span&gt;  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      integrationLatency        = &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;$context.integration.latency&amp;#34;&lt;/span&gt;,  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      integrationRequestId      = &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;$context.integration.requestId&amp;#34;&lt;/span&gt;,  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      integrationStatus         = &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;$context.integration.integrationStatus&amp;#34;&lt;/span&gt;,  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      integrationStatusCode     = &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;$context.integration.status&amp;#34;&lt;/span&gt;,  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      requestErrorMessage       = &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;$context.error.message&amp;#34;&lt;/span&gt;,  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      requestErrorMessageString = &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;$context.error.messageString&amp;#34;&lt;/span&gt;,  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      requestId                 = &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;$context.requestId&amp;#34;&lt;/span&gt;,  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      routeKey                  = &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;$context.routeKey&amp;#34;&lt;/span&gt;,  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    })   
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  }  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Here, I applied the default &lt;a href=&#34;https://docs.aws.amazon.com/apigateway/latest/developerguide/http-api-throttling.html&#34;&gt;throttling settings&lt;/a&gt;: for my project, 1 request per second was enough at that point.&lt;/p&gt;
&lt;p&gt;ü§î There is a nuance, though, that makes Terraforming API Gateway a little inconvenient ‚Äî the IAM role that allows API to write logs must be defined on a region level. Therefore, if you maintain several Terraform projects for the same AWS account, you might need to have the following configuration stand separately to avoid conflicts or misunderstandings:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-terraform&#34; data-lang=&#34;terraform&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#ff7b72&#34;&gt;resource&lt;/span&gt; &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;aws_api_gateway_account&amp;#34;&lt;/span&gt; &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;this&amp;#34;&lt;/span&gt; {  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  cloudwatch_role_arn = aws_iam_role.api_gateway_cloudwatch_logs.arn  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;}  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#ff7b72&#34;&gt;resource&lt;/span&gt; &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;aws_iam_role&amp;#34;&lt;/span&gt; &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;api_gateway_cloudwatch_logs&amp;#34;&lt;/span&gt; {  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  name = &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;api-gateway-cloudwatch-logs&amp;#34;&lt;/span&gt;  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  assume_role_policy = jsonencode({  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    Version = &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;2012-10-17&amp;#34;&lt;/span&gt;  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    Statement = [  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      {  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        Effect = &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;Allow&amp;#34;&lt;/span&gt;  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        Principal = {  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;          Service = &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;apigateway.amazonaws.com&amp;#34;&lt;/span&gt;  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        }  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        Action = &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;sts:AssumeRole&amp;#34;&lt;/span&gt;  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      }  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    ]  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  })  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  managed_policy_arns = [&lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;arn:aws:iam::aws:policy/service-role/AmazonAPIGatewayPushToCloudWatchLogs&amp;#34;&lt;/span&gt;]  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;}  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#ff7b72&#34;&gt;resource&lt;/span&gt; &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;aws_cloudwatch_log_group&amp;#34;&lt;/span&gt; &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;api_gateway_logs_inkyframe&amp;#34;&lt;/span&gt; {  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  name              = &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;/aws/apigateway/inkyframe&amp;#34;&lt;/span&gt;  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  log_group_class   = &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;STANDARD&amp;#34;&lt;/span&gt;  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  retention_in_days = &lt;span style=&#34;color:#a5d6ff&#34;&gt;7&lt;/span&gt;  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;And one more thing about HTTP API deployments and stages. I use the special &lt;code&gt;$default&lt;/code&gt; keyword to have a single stage (hence, the default one), and I also used automatic deployments: with any change made to API configuration, AWS will automatically generate a new Deployment and bound it with the Stage. If you prefer controlling deployments manually, there is a special resource exists that implements this ‚Äî &lt;code&gt;aws_apigatewayv2_deployment&lt;/code&gt;&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-terraform&#34; data-lang=&#34;terraform&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#ff7b72&#34;&gt;resource&lt;/span&gt; &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;aws_apigatewayv2_deployment&amp;#34;&lt;/span&gt; &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;example&amp;#34;&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  api_id      = aws_apigatewayv2_api.example.id
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  description = &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;Example deployment&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  triggers = {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    redeployment = sha1(join(&lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;,&amp;#34;&lt;/span&gt;, tolist([
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      jsonencode(aws_apigatewayv2_integration.example),
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      jsonencode(aws_apigatewayv2_route.example),
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    ])))
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  }
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  lifecycle {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    create_before_destroy = &lt;span style=&#34;color:#79c0ff&#34;&gt;true&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  }
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;In that case, the &lt;code&gt;aws_apigatewayv2_stage&lt;/code&gt; resource requires the &lt;code&gt;deployment_id&lt;/code&gt; argument to link itself with a particular Deployment and, therefore, represent the state of the API configuration.&lt;/p&gt;
&lt;p&gt;Also, API Gateway requires at least one configured API Route before the deployment is initiated/created. However, these resources do not explicitly depend on each other via attribute references. To avoid the race condition in Terraform, you need to reference the Route resource in the &lt;code&gt;aws_apigatewayv2_deployment&lt;/code&gt; resource via the &lt;code&gt;triggers&lt;/code&gt; argument (as shown above) or via the &lt;code&gt;depends_on&lt;/code&gt; meta-argument. Otherwise, Terraform will try to apply changes to both resources simultaneously.&lt;/p&gt;
&lt;h2 id=&#34;afterword-simplifying-serverless-architectures&#34;&gt;Afterword: Simplifying Serverless Architectures&lt;/h2&gt;
&lt;p&gt;In wrapping up our exploration of AWS HTTP API Gateway, AWS Lambda, and Terraform, we&amp;rsquo;ve delved into how these powerful tools work in tandem to streamline and enhance serverless architectures. This article aimed to combine my experience with new knowledge and demystify the complexities of used services, showcasing their capabilities in creating efficient, cost-effective solutions for modern cloud-based applications.&lt;/p&gt;
&lt;p&gt;We focused on practical implementation and the tangible benefits of combining these technologies. By leveraging Terraform, we&amp;rsquo;ve seen how infrastructure management can be simplified, allowing for clearer, more maintainable code. The combination of AWS Lambda and HTTP API Gateway has demonstrated the efficiency of serverless computing, offering scalability and performance without the burden of extensive configuration and management.&lt;/p&gt;
&lt;p&gt;This exploration underlines the importance of choosing the right tools and strategies in cloud computing. It reminds developers and architects that creating robust and efficient serverless systems is within reach with a thoughtful approach and the right set of tools. As the cloud landscape continues to evolve, staying informed and adaptable is key to harnessing the full potential of these technologies. üíö&lt;/p&gt;</content>
    </entry>
    <entry>
        <title>Hello Terraform Data; Goodbye Null Resource</title>
        <link href="https://devdosvid.blog/2023/04/16/hello-terraform-data-goodbye-null-resource/" hreflang="en" rel="alternate"/>
        <published>2023-04-15T23:25:18Z</published>
        <updated>2024-03-25T17:29:29Z</updated>
        <id>https://devdosvid.blog/2023/04/16/hello-terraform-data-goodbye-null-resource/</id>
        <author>
            <name>Serhii Vasylenko</name>
        </author>
        <logo>https://devdosvid.blog/2023/04/16/hello-terraform-data-goodbye-null-resource/cover-image.png</logo>
        <content type="html">&lt;p&gt;Terraform version 1.4 was recently released and brought a range of new features, including improved run output in Terraform Cloud, the ability to use OPA policy results in the CLI, and a built-in alternative to the null resource ‚Äî terraform_data.&lt;/p&gt;
&lt;p&gt;In this blog post, I want to demonstrate and explain the &lt;strong&gt;terraform_data&lt;/strong&gt; resource that serves two purposes:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;firstly, it allows arbitrary values to be stored and used afterward to implement lifecycle triggers of other resources&lt;/li&gt;
&lt;li&gt;secondly, it can be used to trigger provisioners when there isn&amp;rsquo;t a more appropriate managed resource available.&lt;/li&gt;
&lt;/ul&gt;
&lt;div class=&#34;substack-embedded-container&#34;&gt;
    &lt;h3&gt;Subscribe to blog updates!&lt;/h3&gt;
    &lt;iframe title=&#34;Substack&#34; class=&#34;substack-embedded-iframe&#34; src=&#34;https://devdosvid.substack.com/embed&#34; height=&#34;250&#34;
            loading=&#34;lazy&#34;&gt;&lt;/iframe&gt;
&lt;/div&gt;
&lt;p&gt;For those of you, who are familiar with the null provider, the &lt;code&gt;terraform_data&lt;/code&gt; resource might look very similar. And you&amp;rsquo;re right!&lt;br&gt;
Rather than being a separate provider, the terraform_data managed resource now offers the same capabilities as an integrated feature. Pretty cool! &lt;br&gt;
While the null provider is still available and there are no statements about its deprecation thus far (&lt;a href=&#34;https://registry.terraform.io/providers/hashicorp/null/3.2.1/docs&#34;&gt;as of April 2023, v3.2.1&lt;/a&gt;), the  &lt;code&gt;terraform_data&lt;/code&gt; is the native replacement of the &lt;code&gt;null_resource&lt;/code&gt;, and the latter might soon become deprecated.&lt;/p&gt;
&lt;p&gt;The  &lt;code&gt;terraform_data&lt;/code&gt; resource has two optional arguments, &lt;strong&gt;input&lt;/strong&gt; and &lt;strong&gt;triggers_replace&lt;/strong&gt;, and its configuration looks as follows:&lt;/p&gt;
&lt;figure&gt;




&lt;img loading=&#34;lazy&#34;
     src=&#34;code-snippet-1.png&#34;
    alt=&#34;terraform data resource arguments&#34;width=&#34;800&#34;
height=&#34;182.16&#34;
/&gt; &lt;figcaption&gt;
    &lt;p&gt;terraform data resource arguments&lt;/p&gt;
&lt;/figcaption&gt;
&lt;/figure&gt;

&lt;ul&gt;
&lt;li&gt;The &lt;code&gt;input&lt;/code&gt; (optional) stores the value that is passed to the resource&lt;/li&gt;
&lt;li&gt;The &lt;code&gt;triggers_replace&lt;/code&gt; (optional) is a value that triggers resource replacement when changes.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;There are two attributes, in addition to the arguments, which are stored in the state: &lt;strong&gt;id&lt;/strong&gt; and &lt;strong&gt;output&lt;/strong&gt; after the resource is created. Let&amp;rsquo;s take a look:&lt;/p&gt;
&lt;figure&gt;




&lt;img loading=&#34;lazy&#34;
     src=&#34;code-snippet-2.png&#34;
    alt=&#34;terraform data resource attributes&#34;width=&#34;800&#34;
height=&#34;271.36&#34;
/&gt; &lt;figcaption&gt;
    &lt;p&gt;terraform data resource attributes&lt;/p&gt;
&lt;/figcaption&gt;
&lt;/figure&gt;

&lt;ul&gt;
&lt;li&gt;The  &lt;code&gt;output&lt;/code&gt; attribute is computed based on the value of the &lt;code&gt;input&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;The &lt;code&gt;id&lt;/code&gt; is just a unique value of the resource instance in the state (as for any other resource).&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;use-case-for-terraform_data-with-replace_triggered_by&#34;&gt;Use case for terraform_data with replace_triggered_by&lt;/h2&gt;
&lt;p&gt;Let&amp;rsquo;s take a look at the first use case for the terraform_data resource. It is the ability to trigger resource replacement based on the value of the input argument.&lt;/p&gt;
&lt;p&gt;A bit of context here: the &lt;strong&gt;replace_triggered_by&lt;/strong&gt; argument of the resource lifecycle meta-argument allows you to trigger resource replacement based on another referenced resource or its attribute.&lt;/p&gt;
&lt;div class=&#34;attention&#34;&gt;
    If you are not yet familiar with the &lt;code&gt;replace_triggered_by&lt;/code&gt;, you can check &lt;a href=&#34;https://devdosvid.blog/2022/05/04/new-lifecycle-options-and-refactoring-capabilities-in-terraform-1-1-and-1-2/#trigger-resource-replacement-with-replace_triggered_by&#34;&gt;another blog post that explains it&lt;/a&gt;.
&lt;/div&gt;
&lt;p&gt;The replace_triggered_by is a powerful feature, but here is the thing about it: only a resource or its attribute must be specified, and &lt;strong&gt;you cannot use a variable or a local value for replace_triggered_by&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;But with terraform_data, you can indirectly initiate another resource replacement by using either a variable or an expression within a local value for the &lt;code&gt;input&lt;/code&gt; argument.&lt;/p&gt;
&lt;p&gt;Let me give you an example here. Consider the following code:&lt;/p&gt;
&lt;figure&gt;




&lt;img loading=&#34;lazy&#34;
     src=&#34;code-snippet-3.png&#34;
    alt=&#34;trigger replacement based on input variable&#34;width=&#34;800&#34;
height=&#34;386.00&#34;
/&gt; &lt;figcaption&gt;
    &lt;p&gt;trigger replacement based on input variable&lt;/p&gt;
&lt;/figcaption&gt;
&lt;/figure&gt;

&lt;p&gt;By modifying the  &lt;code&gt;revision&lt;/code&gt; variable, the next Terraform plan will suggest a replacement action against aws_instance.webserver:&lt;/p&gt;
&lt;figure&gt;




&lt;img loading=&#34;lazy&#34;
     src=&#34;code-snippet-4.png&#34;
    alt=&#34;terraform_data with replace_triggered_by&#34;width=&#34;800&#34;
height=&#34;341.59&#34;
/&gt; &lt;figcaption&gt;
    &lt;p&gt;terraform_data with replace_triggered_by&lt;/p&gt;
&lt;/figcaption&gt;
&lt;/figure&gt;

&lt;h2 id=&#34;use-case-for-terraform_data-with-provisioner&#34;&gt;Use case for terraform_data with provisioner&lt;/h2&gt;
&lt;p&gt;Before we start: HashiCorp suggests (and I also support that) avoiding provisioner usage unless you have no other options left. One of the reasons ‚Äî additional, implicit, and unobvious dependency that appears in the codebase ‚Äî the binary, which is called inside the provisioner block, must be present on the machine. &lt;br&gt;
But let&amp;rsquo;s be real, the provisioner feature is still kicking, and there&amp;rsquo;s always that one unique project that needs it.&lt;/p&gt;
&lt;p&gt;Here is the code snippet that demonstrates the usage of the provisioner within the terraform_data resource:&lt;/p&gt;
&lt;figure&gt;




&lt;img loading=&#34;lazy&#34;
     src=&#34;code-snippet-5.png&#34;
    alt=&#34;terraform_data with provisioner&#34;width=&#34;800&#34;
height=&#34;409.00&#34;
/&gt; &lt;figcaption&gt;
    &lt;p&gt;terraform_data with provisioner&lt;/p&gt;
&lt;/figcaption&gt;
&lt;/figure&gt;

&lt;p&gt;In this example, the following happens:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;When resources are created the first time, the provisioner inside &lt;code&gt;terraform_data&lt;/code&gt; runs&lt;/li&gt;
&lt;li&gt;Sequential plan/apply will trigger another execution of the provisioner only when the private IP of the instance (aws_instance.webserver.private_ip) changes because that will trigger &lt;code&gt;terraform_data&lt;/code&gt; recreation. At the same time, no changes to the internal IP mean no provisioner execution.&lt;/li&gt;
&lt;/ul&gt;
&lt;hr&gt;
&lt;p&gt;With its ability to store and use values for lifecycle triggers and provisioners, &lt;strong&gt;terraform_data&lt;/strong&gt; is a powerful tool that can enhance your Terraform configuration.&lt;/p&gt;
&lt;p&gt;Although the null provider still has its place in the Terraform ecosystem, terraform_data is its evolution, and its integration as a feature is certainly something to be excited about.&lt;/p&gt;
&lt;p&gt;Why not give it a try in your next project and see how it can simplify your infrastructure as code workflows? Keep on coding! üôå&lt;/p&gt;</content>
    </entry>
    <entry>
        <title>Five Practical Ways To Get The Verified EC2 AMI</title>
        <link href="https://devdosvid.blog/2022/07/24/five-practical-ways-to-get-the-verified-ec2-ami/" hreflang="en" rel="alternate"/>
        <published>2022-07-24T13:21:05Z</published>
        <updated>2024-03-25T17:29:29Z</updated>
        <id>https://devdosvid.blog/2022/07/24/five-practical-ways-to-get-the-verified-ec2-ami/</id>
        <author>
            <name>Serhii Vasylenko</name>
        </author>
        <logo>https://devdosvid.blog/2022/07/24/five-practical-ways-to-get-the-verified-ec2-ami/cover-image.png</logo>
        <content type="html">&lt;p&gt;EC2 AMI catalog consists of more than 160k public AMIs ‚Äî a mix of shared AMIs created by users, published by vendors, and provided by AWS.&lt;/p&gt;
&lt;p&gt;So how to ensure that an AMI comes from the verified vendor or that is an official AMI published by AWS?&lt;/p&gt;
&lt;p&gt;How to find the trusted AMI among them all when you&amp;rsquo;re about to launch an EC2 Instance?&lt;/p&gt;
&lt;figure&gt;




&lt;img loading=&#34;lazy&#34;
     src=&#34;who-is-ami-owner.png&#34;
    alt=&#34;Find the Waldo verified AMI owner&#34;width=&#34;800&#34;
height=&#34;400.00&#34;
/&gt; &lt;figcaption&gt;
    &lt;p&gt;Find the &lt;del&gt;Waldo&lt;/del&gt; verified AMI owner&lt;/p&gt;
&lt;/figcaption&gt;
&lt;/figure&gt;

&lt;p&gt;On AWS, it&amp;rsquo;s typical that something can be made or done in several ways ‚Äî that&amp;rsquo;s awesome. Some of them work better than others, some methods are official, and some you can use just for fun (&lt;a href=&#34;https://www.lastweekinaws.com/blog/the-17-ways-to-run-containers-on-aws/&#34;&gt;check&lt;/a&gt; &lt;a href=&#34;https://www.lastweekinaws.com/blog/17-more-ways-to-run-containers-on-aws/&#34;&gt;that&lt;/a&gt;).&lt;/p&gt;
&lt;p&gt;In this article, I will describe five ways of getting the official and verified AMI for your next EC2 Instance launch.&lt;/p&gt;
&lt;h2 id=&#34;use-ec2-launch-wizard-and-ami-catalog-to-get-the-official-ami&#34;&gt;Use EC2 Launch Wizard and AMI Catalog to get the official AMI&lt;/h2&gt;
&lt;p&gt;When launching an EC2 Instance from a Management Console, you can apply the &amp;ldquo;Verified Provider&amp;rdquo; filter for the Community AMIs tab to ensure you get an AMI from a verified provider. The &amp;ldquo;Verified provider&amp;rdquo; label means an AMI is owned by an Amazon verified account.&lt;/p&gt;
&lt;p&gt;In the following example, I want to make sure that the Ubuntu 20.04 AMI comes from the verified source:&lt;/p&gt;
&lt;figure&gt;




&lt;img loading=&#34;lazy&#34;
     src=&#34;verified-ami-in-ami-catalog.png&#34;
    alt=&#34;Verified AMI in the AMI Catalog&#34;width=&#34;800&#34;
height=&#34;413.65&#34;
/&gt; &lt;figcaption&gt;
    &lt;p&gt;Verified AMI in the AMI Catalog&lt;/p&gt;
&lt;/figcaption&gt;
&lt;/figure&gt;

&lt;p&gt;In the past, you had to compare the AMI Owner ID with the publicly shared list of verified Owner IDs for every region. Not rocket science, but it takes time. So now it&amp;rsquo;s much more straightforward, thanks to the &amp;ldquo;Verified Provider&amp;rdquo; label.&lt;/p&gt;
&lt;p&gt;This feature also works great when you are creating a Launch Template. The Launch Template creation wizard seamlessly guides you from itself to the AMI Catalog (where you can search and pick the AMI) and back again.&lt;/p&gt;
&lt;h2 id=&#34;look-for-verified-amis-on-the-ami-page&#34;&gt;Look for verified AMIs on the AMI page&lt;/h2&gt;
&lt;p&gt;Another interface in the Management Console acts as the AMI browser. It does not have any fancy name except for the &amp;ldquo;AMIs page&amp;rdquo;, but you probably already know about it: it looks like a list of AMIs, and you can see it when you click on the &amp;ldquo;AMIs&amp;rdquo; menu item on the left side of the EC2 page menu.&lt;/p&gt;
&lt;p&gt;The AMI page allows you to leverage the API filters to narrow down the search, and the &amp;ldquo;Owner alias&amp;rdquo; filter is the one you need to ensure that an AMI comes from a trusted owner.&lt;/p&gt;
&lt;p&gt;Here is how it looks for my search of the official Amazon Linux 2 AMI:&lt;/p&gt;
&lt;figure&gt;




&lt;img loading=&#34;lazy&#34;
     src=&#34;verified-amazon-linux-2-ami-in-ami-browser-ec2-console.png&#34;
    alt=&#34;Official Amazon Linux 2 AMI&#34;width=&#34;800&#34;
height=&#34;400.00&#34;
/&gt; &lt;figcaption&gt;
    &lt;p&gt;Official Amazon Linux 2 AMI&lt;/p&gt;
&lt;/figcaption&gt;
&lt;/figure&gt;

&lt;p&gt;AMIs shared by verified sources have &lt;code&gt;amazon&lt;/code&gt; (for AWS) or &lt;code&gt;aws-marketplace&lt;/code&gt; (for AWS partners) as the value for the Owner alias filter.&lt;/p&gt;
&lt;h2 id=&#34;find-the-ec2-ami-with-terraform&#34;&gt;Find the EC2 AMI with Terraform&lt;/h2&gt;
&lt;p&gt;Finding the official AMI with Terraform is also simple ‚Äî the &lt;a href=&#34;https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/ami&#34;&gt;aws_ami data source&lt;/a&gt; does the job.&lt;/p&gt;
&lt;p&gt;For example, here is how you can find the same Amazon Linux 2 AMI by specifying the &lt;code&gt;amazon&lt;/code&gt; as the value for the &lt;code&gt;owner&lt;/code&gt; argument of the data source:&lt;/p&gt;
&lt;figure&gt;




&lt;img loading=&#34;lazy&#34;
     src=&#34;verified-official-amazon-linux-2-ami-terraform-datasource.png&#34;
    alt=&#34;Finding the official Amazon Linux 2 AMI with Terraform&#34;width=&#34;800&#34;
height=&#34;580.24&#34;
/&gt; &lt;figcaption&gt;
    &lt;p&gt;Finding the official Amazon Linux 2 AMI with Terraform&lt;/p&gt;
&lt;/figcaption&gt;
&lt;/figure&gt;

&lt;p&gt;Compare that with the filters on the AMI page ‚Äî it looks similar, right? This is because of how Terraform works: it translates your code into API calls and sends them to AWS API endpoints.&lt;/p&gt;
&lt;p&gt;If you&amp;rsquo;re very new to Terraform, I suggest reading this article to understand the basic concepts of Terraform and Infrastructure as Code: &lt;a href=&#34;https://devdosvid.blog/2020/05/02/terraform-explained-in-english/&#34;&gt;Terraform explained in English&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&#34;find-the-official-aws-ami-using-describe-images-cli&#34;&gt;Find the official AWS AMI using Describe Images CLI&lt;/h2&gt;
&lt;p&gt;Sometimes you might need to get the AMI from CLI to pass it along as an argument downstream of the pipeline.&lt;/p&gt;
&lt;p&gt;This can be done with the &lt;strong&gt;ec2 describe-images&lt;/strong&gt; command of the AWS CLI
&lt;figure&gt;




&lt;img loading=&#34;lazy&#34;
     src=&#34;verified-official-amazon-linux-2-ami-in-aws-cli.png&#34;
    alt=&#34;Find the verified AMI with AWS CLI&#34;width=&#34;800&#34;
height=&#34;486.75&#34;
/&gt; &lt;figcaption&gt;
    &lt;p&gt;Find the verified AMI with AWS CLI&lt;/p&gt;
&lt;/figcaption&gt;
&lt;/figure&gt;
&lt;/p&gt;
&lt;p&gt;The API filters I mentioned before also work here ‚Äî use them to narrow your search.&lt;/p&gt;
&lt;h2 id=&#34;find-the-trusted-aws-ami-with-ssm&#34;&gt;Find the trusted AWS AMI with SSM&lt;/h2&gt;
&lt;p&gt;Another way that involves AWS CLI is the &lt;strong&gt;ssm get-parameter&lt;/strong&gt; command:
&lt;figure&gt;




&lt;img loading=&#34;lazy&#34;
     src=&#34;verified-official-amazon-eks-optimized-ami-aws-cli.png&#34;
    alt=&#34;Get the latest EKS optimized AMI from SSM&#34;width=&#34;800&#34;
height=&#34;213.69&#34;
/&gt; &lt;figcaption&gt;
    &lt;p&gt;Get the latest EKS optimized AMI from SSM&lt;/p&gt;
&lt;/figcaption&gt;
&lt;/figure&gt;
&lt;/p&gt;
&lt;p&gt;It reveals one helpful feature of the Systems Manager ‚Äî the Public parameters.&lt;/p&gt;
&lt;p&gt;Systems Manager Public parameters are how AWS distributes some widely used artifacts related to their services.&lt;/p&gt;
&lt;p&gt;For example, you can find official AMIs for many distributives there: Amazon Linux, Windows, macOS, Bottlerocket, Ubuntu, Debian, and FreeBSD.&lt;/p&gt;
&lt;p&gt;Read more at the &lt;a href=&#34;https://docs.aws.amazon.com/systems-manager/latest/userguide/parameter-store-finding-public-parameters.html&#34;&gt;Finding public parameters&lt;/a&gt; documentation page if you want to know more.&lt;/p&gt;
&lt;h2 id=&#34;are-all-verified-amis-good&#34;&gt;Are all verified AMIs good?&lt;/h2&gt;
&lt;p&gt;The &amp;ldquo;Verified provider&amp;rdquo; badge can be earned by a third party only when an AMI developer is registered as a Seller on the AWS Marketplace.&lt;/p&gt;
&lt;p&gt;Becoming a Seller there is not trivial and requires some &lt;a href=&#34;https://docs.aws.amazon.com/marketplace/latest/userguide/user-guide-for-sellers.html#seller-requirements-for-publishing-free-products&#34;&gt;conditions&lt;/a&gt; to be met, and the &lt;a href=&#34;https://docs.aws.amazon.com/marketplace/latest/userguide/seller-registration-process.html&#34;&gt;registration process&lt;/a&gt; itself also implies submitting the tax and banking information.&lt;/p&gt;
&lt;p&gt;Additionally, there are &lt;a href=&#34;https://docs.aws.amazon.com/marketplace/latest/userguide/product-and-ami-policies.html&#34;&gt;specific policies and review processes&lt;/a&gt; apply to all AMIs submitted to the Marketplace.&lt;/p&gt;
&lt;p&gt;So it is okay to trust the third-party vendors with the &amp;ldquo;Verified&amp;rdquo; badge on a certain level. However, it is also always good to have additional scans and validation of the software you use. ü™≤ üòâ&lt;/p&gt;</content>
    </entry>
    <entry>
        <title>Golden Image Pipelines With HCP Packer</title>
        <link href="https://devdosvid.blog/2022/06/26/golden-image-pipelines-with-hcp-packer/" hreflang="en" rel="alternate"/>
        <published>2022-06-26T13:13:12Z</published>
        <updated>2024-03-25T17:29:29Z</updated>
        <id>https://devdosvid.blog/2022/06/26/golden-image-pipelines-with-hcp-packer/</id>
        <author>
            <name>Serhii Vasylenko</name>
        </author>
        <logo>https://devdosvid.blog/2022/06/26/golden-image-pipelines-with-hcp-packer/cover-image.png</logo>
        <content type="html">&lt;p&gt;Many of us know and use Packer to build golden images for cloud providers. But did you know that Packer is not just a CLI tool?&lt;/p&gt;
&lt;p&gt;There is an HCP (&lt;em&gt;stands for &lt;strong&gt;H&lt;/strong&gt;ashiCorp &lt;strong&gt;C&lt;/strong&gt;loud &lt;strong&gt;P&lt;/strong&gt;latform&lt;/em&gt;) Packer that acts as the image registry that stores the image metadata, allows you to organize images in distribution channels, and perform other management actions.&lt;/p&gt;
&lt;p&gt;In this blog, I would like to showcase some features of the HCP Packer and explain how you can use it to set up an image factory for the organization (or for your own fun üôÉ) to maintain the Golden Images.&lt;/p&gt;
&lt;p&gt;I will be using AWS AMI as the OS image appliance for examples in this blog, but Packer supports many other formats and clouds through its &lt;a href=&#34;https://www.packer.io/plugins&#34;&gt;plugins&lt;/a&gt;.&lt;/p&gt;
&lt;h2 id=&#34;hcp-packer-registry&#34;&gt;HCP Packer Registry&lt;/h2&gt;
&lt;p&gt;HCP Packer is the image metadata registry that stores the information (not an image file) about OS images you create using the Packer CLI tool.&lt;/p&gt;
&lt;p&gt;It solves the challenge of the Golden Image pipeline maintenance by acting as a hub that organizes and streamlines the processes of OS image creation, usage, and continuity.&lt;/p&gt;
&lt;figure&gt;




&lt;img loading=&#34;lazy&#34;
     src=&#34;hcp-packer-how-it-works.png&#34;
    alt=&#34;OS Image lifecycle with HCP Packer&#34;width=&#34;800&#34;
height=&#34;400&#34;
/&gt; &lt;figcaption&gt;
    &lt;p&gt;OS Image lifecycle with HCP Packer&lt;/p&gt;
&lt;/figcaption&gt;
&lt;/figure&gt;

&lt;p&gt;HCP Packer introduces several new concepts that compose the registry: Image Buckets, Iterations, and Channels. Further in this blog, I will explain them, but let&amp;rsquo;s start with security first.&lt;/p&gt;
&lt;h2 id=&#34;security-first--creating-service-principals&#34;&gt;Security First ‚Äî Creating Service Principals&lt;/h2&gt;
&lt;p&gt;Before launching the builds, you need to create a Service Principal to allow your local Packer CLI to communicate with the HCP.&lt;/p&gt;
&lt;p&gt;I recommend creating at least two principals: the one with the &amp;ldquo;contributor&amp;rdquo; role ‚Äî used by Packer CLI to store the image metadata in HCP; and another one with the &amp;ldquo;viewer&amp;rdquo; role ‚Äî used by Terraform (as it requires only read-level access for Packer HCP).&lt;/p&gt;
&lt;figure&gt;




&lt;img loading=&#34;lazy&#34;
     src=&#34;hcp-packer-service-principals.png&#34;
    alt=&#34;Service Principals for HCP&#34;width=&#34;800&#34;
height=&#34;237.88&#34;
/&gt; &lt;figcaption&gt;
    &lt;p&gt;Service Principals for HCP&lt;/p&gt;
&lt;/figcaption&gt;
&lt;/figure&gt;

&lt;p&gt;Once you have created a principal, you can generate a key for authentication. The key consists of an ID and a secret.&lt;/p&gt;
&lt;div class=&#34;attention&#34;&gt;
    &lt;p&gt;Both the Packer CLI and the Packer Terraform provider support environment variables for the principal client ID and client secret for authentication:&lt;/p&gt;
&lt;p&gt;&lt;code&gt;HCP_CLIENT_ID&lt;/code&gt; and &lt;code&gt;HCP_CLIENT_SECRET&lt;/code&gt;&lt;/p&gt;

&lt;/div&gt;
&lt;h2 id=&#34;image-buckets-to-store-image-metadata&#34;&gt;Image Buckets to Store Image Metadata&lt;/h2&gt;
&lt;p&gt;The central entity in HCP Packer is the Image Buckets.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Image Bucket&lt;/strong&gt; is a repository where the metadata from a Packer template is stored once image(s) creation is completed.&lt;/p&gt;
&lt;p&gt;Image Bucket can contain a single image or several images if you define several sources for the &lt;code&gt;build&lt;/code&gt; block in the Packet template.&lt;/p&gt;
&lt;p&gt;For example, a bucket can span several custom AMIs based on Ubuntu AMI provided by Amazon and built and distributed within several regions.&lt;/p&gt;
&lt;p&gt;You cannot create buckets manually from the web interface (at least as of June 2022), but I will show you how they are defined as code inside a Packer template file just a bit later.&lt;/p&gt;
&lt;figure&gt;




&lt;img loading=&#34;lazy&#34;
     src=&#34;image-buckets.png&#34;
    alt=&#34;HCP Packer Image Buckets&#34;width=&#34;800&#34;
height=&#34;278.87&#34;
/&gt; &lt;figcaption&gt;
    &lt;p&gt;HCP Packer Image Buckets&lt;/p&gt;
&lt;/figcaption&gt;
&lt;/figure&gt;

&lt;h2 id=&#34;iterations-of-image-creation&#34;&gt;Iterations of Image Creation&lt;/h2&gt;
&lt;p&gt;Every execution of the  &lt;code&gt;build&lt;/code&gt; action made by Packer CLI (if used in conjunction with HCP) is recorded specially and called &lt;strong&gt;Iteration&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;Each Iteration has a unique fingerprint ‚Äî an SHA value of the head reference in the Git repository that contains your Packer template.&lt;/p&gt;
&lt;div class=&#34;attention&#34;&gt;
    Tip: you can override that with the &lt;code&gt;HCP_PACKER_BUILD_FINGERPRINT&lt;/code&gt; env variable if you want to set the Iteration ID manually.
&lt;/div&gt;
&lt;figure&gt;




&lt;img loading=&#34;lazy&#34;
     src=&#34;packer-iterations.png&#34;
    alt=&#34;HCP Packer Iterations&#34;width=&#34;800&#34;
height=&#34;278.87&#34;
/&gt; &lt;figcaption&gt;
    &lt;p&gt;HCP Packer Iterations&lt;/p&gt;
&lt;/figcaption&gt;
&lt;/figure&gt;

&lt;p&gt;Every Iteration consists of at least one Build ‚Äî another special record that contains image metadata produced by Packer CLI.&lt;/p&gt;
&lt;p&gt;The Builds inside Iteration are represented by the number of sources specified in your Packer template&amp;rsquo;s &lt;code&gt;build&lt;/code&gt;  section.&lt;/p&gt;
&lt;figure&gt;




&lt;img loading=&#34;lazy&#34;
     src=&#34;packer-iteration-builds.png&#34;
    alt=&#34;HCP Packer Iteration Builds&#34;width=&#34;800&#34;
height=&#34;574.57&#34;
/&gt; &lt;figcaption&gt;
    &lt;p&gt;HCP Packer Iteration Builds&lt;/p&gt;
&lt;/figcaption&gt;
&lt;/figure&gt;

&lt;h2 id=&#34;packer-template-configuration-for-hcp&#34;&gt;Packer Template Configuration for HCP&lt;/h2&gt;
&lt;p&gt;Let&amp;rsquo;s now review a code example to understand how all this combines.&lt;/p&gt;
&lt;p&gt;Here is a &lt;code&gt;build&lt;/code&gt; block from Packer template file.&lt;/p&gt;
&lt;figure&gt;




&lt;img loading=&#34;lazy&#34;
     src=&#34;packer-template-example.png&#34;
    alt=&#34;HCP Packer registry usage in a Packer template&#34;width=&#34;800&#34;
height=&#34;554.00&#34;
/&gt; &lt;figcaption&gt;
    &lt;p&gt;HCP Packer registry usage in a Packer template&lt;/p&gt;
&lt;/figcaption&gt;
&lt;/figure&gt;

&lt;p&gt;Look at the &lt;code&gt;hcp_packer_registry&lt;/code&gt; block: it defines the Bucket where Packer will store image information and custom labels for the Bucket and the image.&lt;/p&gt;
&lt;p&gt;The &lt;code&gt;bucket_name&lt;/code&gt; defines my Image Bucket: Packer will either use the existing Bucket with that name or create a new one if it does not exist.&lt;/p&gt;
&lt;p&gt;The &lt;code&gt;bucket_labels&lt;/code&gt; map defines custom labels you specify for an Image Bucket. In my example, I set the Bucket owner and the OS name.&lt;/p&gt;
&lt;p&gt;The &lt;code&gt;build_labels&lt;/code&gt; map defines custom labels for the Builds within the Iteration inside a bucket.&lt;/p&gt;
&lt;p&gt;And because I define two &lt;code&gt;sources&lt;/code&gt; here, my Iteration will have two Builds inside it.&lt;/p&gt;
&lt;h2 id=&#34;using-channels&#34;&gt;Using Channels&lt;/h2&gt;
&lt;p&gt;Although all Iterations have unique identifiers, giving a familiar name to some of them would be more convenient.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Channel&lt;/strong&gt; is a way to assign a specific Iteration to a friendly name that you can use later:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;in other Packer templates, if you want to use your custom image as the base for other images&lt;/li&gt;
&lt;li&gt;in Terraform code (we will review this further) to reference the image by the channel name, avoiding the hard code of the image ID.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Channels are created through the web interface or using the API. And I hope HashiCorp will add HCP Packer resources to the HCP Terraform provider in the future so channel creation can be described as code.&lt;/p&gt;
&lt;figure&gt;




&lt;img loading=&#34;lazy&#34;
     src=&#34;hcp-packer-image-channel.png&#34;
    alt=&#34;HCP Packer Image Channel&#34;width=&#34;800&#34;
height=&#34;338.15&#34;
/&gt; &lt;figcaption&gt;
    &lt;p&gt;HCP Packer Image Channel&lt;/p&gt;
&lt;/figcaption&gt;
&lt;/figure&gt;

&lt;p&gt;You can manually promote an Iteration to a channel with a web interface.&lt;/p&gt;
&lt;p&gt;But before promoting an Iteration to a channel, you might want to perform the following:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;test and validate the newly created image before its promotion to a channel: create a temporary virtual machine using Terraform and ensure it successfully boots from the image.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;assess that VM with some vulnerability scanning service. For example, if you&amp;rsquo;re an AWS customer, then &lt;a href=&#34;https://docs.aws.amazon.com/inspector/latest/user/what-is-inspector.html&#34;&gt;Amazon Inspector&lt;/a&gt; might work for you in such a case.&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Once an image from the Iteration is validated and passed the security assessment, it&amp;rsquo;s safe to promote that Iteration to a channel.&lt;/p&gt;
&lt;p&gt;HCP Packer provides a rich &lt;a href=&#34;https://cloud.hashicorp.com/api-docs/packer&#34;&gt;API&lt;/a&gt; that you can leverage to automate that process.&lt;/p&gt;
&lt;p&gt;When a &lt;code&gt;packer build&lt;/code&gt; successfully finishes its execution, it returns the Iteration ID (ULID) that you can use later for an API call with a request to promote the new Iteration to a channel.&lt;/p&gt;
&lt;figure&gt;




&lt;img loading=&#34;lazy&#34;
     src=&#34;packer-build-output.png&#34;
    alt=&#34;Packer build output with Iteration ULID&#34;width=&#34;800&#34;
height=&#34;218.00&#34;
/&gt; &lt;figcaption&gt;
    &lt;p&gt;Packer build output with Iteration ULID&lt;/p&gt;
&lt;/figcaption&gt;
&lt;/figure&gt;

&lt;p&gt;The &amp;ldquo;Update Channel&amp;rdquo; PATCH API method is needed to assign the Iteration to a channel.&lt;/p&gt;
&lt;p&gt;First, you need to obtain the access token as described in &lt;a href=&#34;https://support.hashicorp.com/hc/en-us/articles/6676505991699-HCP-API-Authentication-with-Curl&#34;&gt;this guide&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Then, the following cURL request can be used to update the channel with a new Iteration ULID (please expand the code snippet below):&lt;/p&gt;
&lt;div class=&#34;code-snippet&#34;&gt;
&lt;details&gt;
&lt;summary markdown=&#34;span&#34;&gt;Click here to see the code snippet&lt;/summary&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-shell&#34; data-lang=&#34;shell&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#79c0ff&#34;&gt;HCP_ACCESS_TOKEN&lt;/span&gt;&lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;your token here&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#79c0ff&#34;&gt;HCP_ORG_ID&lt;/span&gt;&lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;your org id here&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#79c0ff&#34;&gt;HCP_PROJECT_ID&lt;/span&gt;&lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;your project id here&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#79c0ff&#34;&gt;HCP_BUCKET_NAME&lt;/span&gt;&lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;amazon-linux2&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#79c0ff&#34;&gt;HCP_CHANNEL_NAME&lt;/span&gt;&lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;stable&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#79c0ff&#34;&gt;HCP_BASE_URL&lt;/span&gt;&lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;https://api.cloud.hashicorp.com/packer/2021-04-30&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;curl -X PATCH &lt;span style=&#34;color:#79c0ff&#34;&gt;\
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#79c0ff&#34;&gt;&lt;/span&gt;--header &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;Authorization: Bearer &lt;/span&gt;&lt;span style=&#34;color:#79c0ff&#34;&gt;$HCP_ACCESS_TOKEN&lt;/span&gt;&lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;&lt;/span&gt; &lt;span style=&#34;color:#79c0ff&#34;&gt;\
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#79c0ff&#34;&gt;&lt;/span&gt;--data &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#39;{
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;incremental_version&amp;#34;:&amp;#34;3&amp;#34;,
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;iteration_id&amp;#34;:&amp;#34;01H8V7WBDWRBCMZDZ2HG3MKSDL&amp;#34;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#a5d6ff&#34;&gt;}&amp;#39;&lt;/span&gt; &lt;span style=&#34;color:#79c0ff&#34;&gt;\
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#79c0ff&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#a5d6ff&#34;&gt;${&lt;/span&gt;&lt;span style=&#34;color:#79c0ff&#34;&gt;HCP_BASE_URL&lt;/span&gt;&lt;span style=&#34;color:#a5d6ff&#34;&gt;}&lt;/span&gt;&lt;span style=&#34;color:#a5d6ff&#34;&gt;/organizations/&lt;/span&gt;&lt;span style=&#34;color:#a5d6ff&#34;&gt;${&lt;/span&gt;&lt;span style=&#34;color:#79c0ff&#34;&gt;HCP_ORG_ID&lt;/span&gt;&lt;span style=&#34;color:#a5d6ff&#34;&gt;}&lt;/span&gt;&lt;span style=&#34;color:#a5d6ff&#34;&gt;/projects/&lt;/span&gt;&lt;span style=&#34;color:#a5d6ff&#34;&gt;${&lt;/span&gt;&lt;span style=&#34;color:#79c0ff&#34;&gt;HCP_PROJECT_ID&lt;/span&gt;&lt;span style=&#34;color:#a5d6ff&#34;&gt;}&lt;/span&gt;&lt;span style=&#34;color:#a5d6ff&#34;&gt;/images/&lt;/span&gt;&lt;span style=&#34;color:#a5d6ff&#34;&gt;${&lt;/span&gt;&lt;span style=&#34;color:#79c0ff&#34;&gt;HCP_BUCKET_NAME&lt;/span&gt;&lt;span style=&#34;color:#a5d6ff&#34;&gt;}&lt;/span&gt;&lt;span style=&#34;color:#a5d6ff&#34;&gt;/channels/&lt;/span&gt;&lt;span style=&#34;color:#a5d6ff&#34;&gt;${&lt;/span&gt;&lt;span style=&#34;color:#79c0ff&#34;&gt;HCP_CHANNEL_NAME&lt;/span&gt;&lt;span style=&#34;color:#a5d6ff&#34;&gt;}&lt;/span&gt;&lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;/details&gt;
&lt;/div&gt;
&lt;h2 id=&#34;using-hcp-packer-with-terraform&#34;&gt;Using HCP Packer with Terraform&lt;/h2&gt;
&lt;p&gt;Having a streamlined golden image creation process is good. Still, it would be even better to have an easy way to always use the latest validated image without hardcoding or some other duck taping.&lt;/p&gt;
&lt;p&gt;With the help of the &lt;a href=&#34;https://registry.terraform.io/providers/hashicorp/hcp&#34;&gt;HCP Terraform provider&lt;/a&gt;, you can reference the image channel in your Terraform code and have a completed end-to-end workflow.&lt;/p&gt;
&lt;p&gt;Here is an example of the Terraform configuration that uses the HCP Packer registry as the source of AMI ID for an AWS instance:&lt;/p&gt;
&lt;figure&gt;




&lt;img loading=&#34;lazy&#34;
     src=&#34;terraform-hcp-packer.png&#34;
    alt=&#34;Using HCP Packer registry with Terraform&#34;width=&#34;800&#34;
height=&#34;529.00&#34;
/&gt; &lt;figcaption&gt;
    &lt;p&gt;Using HCP Packer registry with Terraform&lt;/p&gt;
&lt;/figcaption&gt;
&lt;/figure&gt;

&lt;p&gt;Two data sources do all the magic here.&lt;/p&gt;
&lt;p&gt;The  &lt;code&gt;hcp_packer_iteration&lt;/code&gt;  data source gets the most recent Iteration assigned to the specified Channel (i.e., latest). We need that because the Iteration (not the Channel) holds the image information.&lt;/p&gt;
&lt;p&gt;Then the &lt;code&gt;hcp_packer_image&lt;/code&gt; gets the cloud image ID (AWS AMI ID in my example) from that Iteration so you can use it later in your code.&lt;/p&gt;
&lt;p&gt;The configuration of the &lt;code&gt;hcp&lt;/code&gt; provider in this example is empty on purpose: this provider supports &lt;code&gt;HCP_CLIENT_ID&lt;/code&gt; and &lt;code&gt;HCP_CLIENT_SECRET&lt;/code&gt; env variables to use their values for the &lt;a href=&#34;https://registry.terraform.io/providers/hashicorp/hcp/latest/docs/guides/auth&#34;&gt;authentication&lt;/a&gt; and avoid hard coding. Alternatively, you can use the &lt;code&gt;client_id&lt;/code&gt; and &lt;code&gt;client_secret&lt;/code&gt; options to configure the provider.&lt;/p&gt;
&lt;h2 id=&#34;image-revocation&#34;&gt;Image revocation&lt;/h2&gt;
&lt;p&gt;It is possible to revoke a specific Iteration, and therefore all Images in it, to alert the users about the Image decommission. For example, your SecOps team can revoke it due to the new CVE announced.&lt;/p&gt;
&lt;p&gt;Revoked Images are treated differently by Packer CLI and Terraform CLI.&lt;/p&gt;
&lt;h3 id=&#34;packer-cli-and-revoked-image&#34;&gt;Packer CLI and Revoked Image&lt;/h3&gt;
&lt;p&gt;When you reference the Image in a Packer template to use it as a source for another image, its revocation makes further Packer builds to fail.&lt;/p&gt;
&lt;p&gt;In other words, Packer won&amp;rsquo;t let you build a new Image on top of the revoked Image.&lt;/p&gt;
&lt;h3 id=&#34;terraform-cli-and-revoked-image&#34;&gt;Terraform CLI and Revoked Image&lt;/h3&gt;
&lt;p&gt;On the contrary, Terraform CLI does not prevent the usage of the revoked Image by default, although its Cloud version does it if used with the &amp;ldquo;Run tasks&amp;rdquo; feature.&lt;/p&gt;
&lt;p&gt;Although you can get the Image ID, when the Iteration is revoked, the &lt;code&gt;hcp_packer_image&lt;/code&gt; data source returns a non-empty &lt;code&gt;revoke_at&lt;/code&gt; attribute with the value set to the revocation timestamp.&lt;/p&gt;
&lt;p&gt;Therefore, you can use the &lt;code&gt;precondition&lt;/code&gt; (available in &lt;a href=&#34;https://devdosvid.blog/2022/05/04/new-lifecycle-options-and-refactoring-capabilities-in-terraform-1-1-and-1-2/#precondition-and-postcondition&#34;&gt;Terraform CLI v1.2.0&lt;/a&gt; and higher) to validate the Image with Terraform CLI and make sure it was not revoked&lt;/p&gt;
&lt;p&gt;Here is the code example that illustrates that:&lt;/p&gt;
&lt;figure&gt;




&lt;img loading=&#34;lazy&#34;
     src=&#34;logic-for-revoked-iteration.png&#34;
    alt=&#34;Work with revoked HCP Packer image in Terraform&#34;width=&#34;800&#34;
height=&#34;501.24&#34;
/&gt; &lt;figcaption&gt;
    &lt;p&gt;Work with revoked HCP Packer image in Terraform&lt;/p&gt;
&lt;/figcaption&gt;
&lt;/figure&gt;

&lt;h2 id=&#34;why-hcp-packer&#34;&gt;Why HCP Packer?&lt;/h2&gt;
&lt;p&gt;So what makes the HCP Packer a good fit and worth a try?&lt;/p&gt;
&lt;p&gt;1Ô∏è‚É£ A centralized place to view and manage the OS images throughout an organization. And as for me, it is good to have a neat web panel to look at things.&lt;/p&gt;
&lt;p&gt;2Ô∏è‚É£ Image Channels that help with logical organization and control.&lt;/p&gt;
&lt;p&gt;3Ô∏è‚É£ Ability to revoke an image to prevent its usage.&lt;/p&gt;
&lt;p&gt;4Ô∏è‚É£ API and Terraform provider as additional tools that enrich the user experience.&lt;/p&gt;
&lt;p&gt;When dealing with multiple golden images or with various cloud providers, the &lt;a href=&#34;https://cloud.hashicorp.com/products/packer&#34;&gt;HCP Packer&lt;/a&gt; can be a good fit for your image pipeline.&lt;/p&gt;
&lt;p&gt;As a registry, it enables the end-to-end workflow for golden image usage: create, validate, use and decommission the images in a centralized way.&lt;/p&gt;
&lt;p&gt;And no more hard-coded IDs, manual variable settings, or other duck tape and glue in your Terraform.&lt;/p&gt;
&lt;p&gt;If you want to learn more about HCP Packer and have some practice, I suggest starting from the &lt;a href=&#34;https://learn.hashicorp.com/collections/packer/hcp&#34;&gt;tutorial at HashiCorp Learn portal&lt;/a&gt;.&lt;/p&gt;</content>
    </entry>
    <entry>
        <title>New Lifecycle Options and Refactoring Capabilities in Terraform 1.1 and 1.2</title>
        <link href="https://devdosvid.blog/2022/05/04/new-lifecycle-options-and-refactoring-capabilities-in-terraform-1-1-and-1-2/" hreflang="en" rel="alternate"/>
        <published>2022-05-04T20:27:47Z</published>
        <updated>2024-03-25T17:29:29Z</updated>
        <id>https://devdosvid.blog/2022/05/04/new-lifecycle-options-and-refactoring-capabilities-in-terraform-1-1-and-1-2/</id>
        <author>
            <name>Serhii Vasylenko</name>
        </author>
        <logo>https://devdosvid.blog/2022/05/04/new-lifecycle-options-and-refactoring-capabilities-in-terraform-1-1-and-1-2/cover-image.png</logo>
        <content type="html">&lt;p&gt;In this blog, I would like to tell you about new cool features that Terraform 1.1 and 1.2 bring. It feels like Terraform has doubled its speed of delivering the new features after they released the 1.0. ü§©&lt;/p&gt;
&lt;p&gt;It&amp;rsquo;s been only a few months since Terraform 1.1 was released with the &lt;code&gt;moved&lt;/code&gt; block that empowers the code refactoring.&lt;/p&gt;
&lt;p&gt;Now Terraform 1.2 is almost &lt;a href=&#34;*https://github.com/hashicorp/terraform/releases/tag/v1.2.0-rc1*&#34;&gt;ready&lt;/a&gt; (as I am writing this blog in early May 2022) to bring three new efficient controls to the resource lifecycle.&lt;br&gt;
These are three new expressions: &lt;code&gt;precondition&lt;/code&gt;, &lt;code&gt;postcondition&lt;/code&gt;, and &lt;code&gt;replace_triggered_by&lt;/code&gt;.&lt;/p&gt;
&lt;div class=&#34;substack-embedded-container&#34;&gt;
    &lt;h3&gt;Subscribe to blog updates!&lt;/h3&gt;
    &lt;iframe title=&#34;Substack&#34; class=&#34;substack-embedded-iframe&#34; src=&#34;https://devdosvid.substack.com/embed&#34; height=&#34;250&#34;
            loading=&#34;lazy&#34;&gt;&lt;/iframe&gt;
&lt;/div&gt;
&lt;h2 id=&#34;terraform-code-refactoring-with-the-moved-block&#34;&gt;Terraform Code Refactoring With the Moved Block&lt;/h2&gt;
&lt;p&gt;Starting from the 1.1 version, Terraform users can use the &lt;code&gt;moved&lt;/code&gt; block to describe the changes in resource or module addresses (or resources inside a module) in the form of code. &lt;br&gt;
Once that is described, Terraform performs the movement of the resource within the state during the first apply.&lt;/p&gt;
&lt;p&gt;In other words, what this feature gives you, is the ability to document your &lt;code&gt;terraform state mv&lt;/code&gt; actions, so you and other project or module users don&amp;rsquo;t need to perform them manually.&lt;/p&gt;
&lt;p&gt;As your code evolves, a resource or module can have several &lt;code&gt;moved&lt;/code&gt; blocks associated with it, and Terraform will thoroughly reproduce the whole history of its movement within a state (i.e., renaming).&lt;/p&gt;
&lt;p&gt;Let&amp;rsquo;s review some examples that illustrate how it works.&lt;/p&gt;
&lt;h3 id=&#34;move-or-rename-a-resource&#34;&gt;Move or rename a resource&lt;/h3&gt;
&lt;p&gt;In a module, I have a bucket policy that has a generic, meaningless name. It is used in a module that creates a CloudFront distribution with an S3 bucket.&lt;/p&gt;
&lt;figure&gt;




&lt;img loading=&#34;lazy&#34;
     src=&#34;figure-1.png&#34;
    alt=&#34;An example resource&#34;width=&#34;800&#34;
height=&#34;150&#34;
/&gt; &lt;figcaption&gt;
    &lt;p&gt;An example resource&lt;/p&gt;
&lt;/figcaption&gt;
&lt;/figure&gt;

&lt;p&gt;It&amp;rsquo;s pretty OK to name a resource like that if you have only a single instance of that kind in your code.&lt;/p&gt;
&lt;p&gt;Later, when I need to add another policy to the module, I don&amp;rsquo;t want to name it &amp;ldquo;that&amp;rdquo;. Instead, I want my policies to have meaningful names now.&lt;br&gt;
For example, I could rename the old policy with the &lt;code&gt;terraform state mv&lt;/code&gt; command, but other users of my module would not know about that.&lt;/p&gt;
&lt;p&gt;That is where the &lt;code&gt;moved&lt;/code&gt; block turns out to be helpful!&lt;/p&gt;
&lt;div class=&#34;attention&#34;&gt;
    The &lt;code&gt;moved&lt;/code&gt; block allows you to document how you rename or move an object in Terraform so that other code users can have the same changes afterward.
&lt;/div&gt;
&lt;figure&gt;




&lt;img loading=&#34;lazy&#34;
     src=&#34;figure-2.png&#34;
    alt=&#34;Resource address update with the Moved block&#34;width=&#34;800&#34;
height=&#34;270&#34;
/&gt; &lt;figcaption&gt;
    &lt;p&gt;Resource address update with the Moved block&lt;/p&gt;
&lt;/figcaption&gt;
&lt;/figure&gt;

&lt;p&gt;Terraform follows the instructions inside the &lt;code&gt;module&lt;/code&gt; block to plan and apply changes. Although the resource address update is not counted as a change in the Plan output, Terraform will perform that update during apply.&lt;/p&gt;
&lt;figure&gt;




&lt;img loading=&#34;lazy&#34;
     src=&#34;figure-3.png&#34;
    alt=&#34;Terraform plan output&#34;width=&#34;800&#34;
height=&#34;318&#34;
/&gt; &lt;figcaption&gt;
    &lt;p&gt;Terraform plan output&lt;/p&gt;
&lt;/figcaption&gt;
&lt;/figure&gt;

&lt;h3 id=&#34;move-or-rename-a-module&#34;&gt;Move or rename a module&lt;/h3&gt;
&lt;p&gt;The same approach can be applied to a module ‚Äî you can move or rename it as a code too.&lt;/p&gt;
&lt;p&gt;Here, I use two modules to create static hosting for a website with a custom TLS certificate.&lt;/p&gt;
&lt;figure&gt;




&lt;img loading=&#34;lazy&#34;
     src=&#34;figure-4.png&#34;
    alt=&#34;Two modules with generic names&#34;width=&#34;800&#34;
height=&#34;437&#34;
/&gt; &lt;figcaption&gt;
    &lt;p&gt;Two modules with generic names&lt;/p&gt;
&lt;/figcaption&gt;
&lt;/figure&gt;

&lt;p&gt;Again, if I need to add another couple of the CDN&#43;Certificate modules, I would like to have meaningful names in my code so clearly distinguish one from another.&lt;/p&gt;
&lt;p&gt;Therefore, I would add two &lt;code&gt;moved&lt;/code&gt; blocks ‚Äî one per module call.&lt;/p&gt;
&lt;p&gt;And by the way, since I renamed the module (from &lt;code&gt;cert&lt;/code&gt; to &lt;code&gt;example_com_cert&lt;/code&gt;), I need to update all references to that module&amp;rsquo;s outputs in the code too.&lt;/p&gt;
&lt;figure&gt;




&lt;img loading=&#34;lazy&#34;
     src=&#34;figure-5.png&#34;
    alt=&#34;Two modules renamed&#34;width=&#34;800&#34;
height=&#34;629&#34;
/&gt; &lt;figcaption&gt;
    &lt;p&gt;Two modules renamed&lt;/p&gt;
&lt;/figcaption&gt;
&lt;/figure&gt;

&lt;p&gt;However, there is one nuance: when you rename a module and declare that in the &lt;code&gt;moved&lt;/code&gt; block, you need to run the &lt;code&gt;terraform init&lt;/code&gt; before applying the change because Terraform must initialize the module with the new name first.&lt;/p&gt;
&lt;figure&gt;




&lt;img loading=&#34;lazy&#34;
     src=&#34;figure-6.png&#34;
    alt=&#34;Terraform error: module not installed&#34;width=&#34;800&#34;
height=&#34;246&#34;
/&gt; &lt;figcaption&gt;
    &lt;p&gt;Terraform error: module not installed&lt;/p&gt;
&lt;/figcaption&gt;
&lt;/figure&gt;

&lt;p&gt;There are some more advanced actions you can make with the &lt;code&gt;moved&lt;/code&gt; block:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Implement count and for_each meta-arguments to resources and modules&lt;/li&gt;
&lt;li&gt;Break one module into multiple
Check the following detailed guide from HashiCorp that explains how to do that ‚Äî &lt;a href=&#34;https://www.terraform.io/language/modules/develop/refactoring&#34;&gt;Refactoring&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Introducing the &lt;code&gt;moved&lt;/code&gt; blocks into your codebase defacto starts the refactoring process for your module users. But the finale of that refactoring happens when you ultimately remove these blocks.&lt;/p&gt;
&lt;p&gt;Therefore, here is some advice on how to manage that:&lt;/p&gt;
&lt;div class=&#34;attention&#34;&gt;
    &lt;ul&gt;
&lt;li&gt;
&lt;p&gt;Keep the &lt;code&gt;moved&lt;/code&gt; blocks in your code for long. For example, when removing a &lt;code&gt;moved&lt;/code&gt; block from the code, Terraform does not treat the new object name as a renaming anymore. Instead, Terraform will plan to delete the resource or module with the old name instead of renaming it.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Keep the complete chains of object renaming (sequence of moves). The whole history of object movement ensures that users with different module versions will get a consistent and predictable behavior of the refactoring.&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;

&lt;/div&gt;
&lt;h2 id=&#34;lifecycle-expressions-conditions-and-replacement-trigger&#34;&gt;Lifecycle expressions: conditions and replacement trigger&lt;/h2&gt;
&lt;p&gt;Terraform 1.2 fundamentally improves the &lt;code&gt;lifecycle&lt;/code&gt; meta-argument by adding three new configuration options with rich capabilities.&lt;/p&gt;
&lt;figure&gt;




&lt;img loading=&#34;lazy&#34;
     src=&#34;figure-7.png&#34;
    alt=&#34;New configuration options for the lifecycle meta-argument&#34;width=&#34;800&#34;
height=&#34;365&#34;
/&gt; &lt;figcaption&gt;
    &lt;p&gt;New configuration options for the lifecycle meta-argument&lt;/p&gt;
&lt;/figcaption&gt;
&lt;/figure&gt;

&lt;h3 id=&#34;precondition-and-postcondition&#34;&gt;Precondition and Postcondition&lt;/h3&gt;
&lt;p&gt;When you need to make sure that specific condition is met before or after you create a resource, you can use &lt;code&gt;postcondition&lt;/code&gt; and &lt;code&gt;precondition&lt;/code&gt; blocks.&lt;/p&gt;
&lt;p&gt;The &lt;em&gt;condition&lt;/em&gt; here ‚Äî is some data or information about a resource you need to confirm to apply the code.&lt;/p&gt;
&lt;p&gt;Here are a few examples of such conditions:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Validate some attributes of the Data Source that you cannot check using filters or other available arguments;&lt;/li&gt;
&lt;li&gt;Confirm the Resource argument that can compound several variables (e.g., list);&lt;/li&gt;
&lt;/ul&gt;
&lt;div class=&#34;attention&#34;&gt;
    &lt;p&gt;&lt;strong&gt;Precondition&lt;/strong&gt; works as an expectation or a guess about some external (but within a module) value that a resource depends on.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Postcondition&lt;/strong&gt; works as the assurance that a resource fulfills a specific condition so other resources may rely on that. If postcondition fails for a resource, this prevents changes to all other resources that depend on it.&lt;/p&gt;

&lt;/div&gt;
&lt;p&gt;Let&amp;rsquo;s review this new feature with an example of &lt;code&gt;postcondition&lt;/code&gt; usage.&lt;/p&gt;
&lt;p&gt;Consider the following case: our module receives AMI ID as the input variable, and that AMI should be used in the Launch Template then; we also have the requirement for the EC2 instance created from that Launch Template ‚Äî its root EBS size must be equal or bigger than 600 GB.&lt;/p&gt;
&lt;p&gt;We cannot validate the EBS size using the variable that accepts the AMI ID. But we can write a &lt;strong&gt;postcondition&lt;/strong&gt; for the Data Source that gets the information about the AMI and reference that Data Source in the Launch Template resource afterward.&lt;/p&gt;
&lt;figure&gt;




&lt;img loading=&#34;lazy&#34;
     src=&#34;figure-8.png&#34;
    alt=&#34;Data Source Postcondition&#34;width=&#34;800&#34;
height=&#34;446&#34;
/&gt; &lt;figcaption&gt;
    &lt;p&gt;Data Source Postcondition&lt;/p&gt;
&lt;/figcaption&gt;
&lt;/figure&gt;

&lt;p&gt;The &lt;code&gt;condition&lt;/code&gt; argument within the block accepts any of Terraform&amp;rsquo;s built-in functions or language operators.&lt;/p&gt;
&lt;p&gt;The special &lt;code&gt;self&lt;/code&gt; object is available only for the &lt;code&gt;postcondition&lt;/code&gt; block because it assumes that validation can be performed after the object is created and its attributes are known.&lt;/p&gt;
&lt;p&gt;Later, if a module user specifies the AMI with an EBS size lesser than 600 GB, Terraform will fail to create the Launch Template because it depends on the Data Source that did not pass the postcondition check.&lt;/p&gt;
&lt;figure&gt;




&lt;img loading=&#34;lazy&#34;
     src=&#34;figure-9.png&#34;
    alt=&#34;Resource postcondition error&#34;width=&#34;800&#34;
height=&#34;240&#34;
/&gt; &lt;figcaption&gt;
    &lt;p&gt;Resource postcondition error&lt;/p&gt;
&lt;/figcaption&gt;
&lt;/figure&gt;

&lt;p&gt;Terraform tries to evaluate the condition expressions as soonest: sometimes Terraform can check the value during the planning phase, but sometimes that can be done only after the resource is created if the value is unknown.&lt;/p&gt;
&lt;h3 id=&#34;validate-module-output-with-precondition&#34;&gt;Validate module output with precondition&lt;/h3&gt;
&lt;p&gt;The &lt;code&gt;precondition&lt;/code&gt; block is also available for the module outputs.&lt;/p&gt;
&lt;p&gt;Just like the variable validation block assures that module input meets certain expectations, the &lt;code&gt;precondition&lt;/code&gt; is intended to ensure that a module produces the valid output.&lt;/p&gt;
&lt;p&gt;Here is an example: a module that creates an ACM certificate must prevent the usage of a specific domain name in the certificate&amp;rsquo;s Common Name or its SANs.&lt;/p&gt;
&lt;figure&gt;




&lt;img loading=&#34;lazy&#34;
     src=&#34;figure-10.png&#34;
    alt=&#34;Module output precondition&#34;width=&#34;800&#34;
height=&#34;342&#34;
/&gt; &lt;figcaption&gt;
    &lt;p&gt;Module output precondition&lt;/p&gt;
&lt;/figcaption&gt;
&lt;/figure&gt;

&lt;p&gt;In this case, instead of validating several input variables, we can write the validation only once for the output.&lt;/p&gt;
&lt;div class=&#34;attention&#34;&gt;
    Validation of the module output helps with standardization and control of the data passed between Terraform modules.
&lt;/div&gt;
&lt;h3 id=&#34;trigger-resource-replacement-with-replace_triggered_by&#34;&gt;Trigger resource replacement with replace_triggered_by&lt;/h3&gt;
&lt;p&gt;Sometimes it&amp;rsquo;s needed to specify the dependency in the way that recreates a resource when another resource or its attribute changes.&lt;/p&gt;
&lt;p&gt;This is useful when two (or more) resources do not have any explicit dependency.&lt;/p&gt;
&lt;p&gt;Consider the following case: you have two EC2 instances, A and B, and need to recreate the B instance if the private IP of instance A is changed.&lt;/p&gt;
&lt;figure&gt;




&lt;img loading=&#34;lazy&#34;
     src=&#34;figure-11.png&#34;
    alt=&#34;replace_triggered_by example&#34;width=&#34;800&#34;
height=&#34;342&#34;
/&gt; &lt;figcaption&gt;
    &lt;p&gt;replace_triggered_by example&lt;/p&gt;
&lt;/figcaption&gt;
&lt;/figure&gt;

&lt;p&gt;This is extremely useful when you&amp;rsquo;re dealing with logical abstractions over the set of resources.&lt;/p&gt;
&lt;div class=&#34;attention&#34;&gt;
    &lt;p&gt;Resource replacement is triggered when:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;any of the resources referenced in &lt;code&gt;replace_triggered_by&lt;/code&gt; are updated&lt;/li&gt;
&lt;li&gt;any value is set to the resource attribute that is referenced in &lt;code&gt;replace_triggered_by&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;h2 id=&#34;getting-started-with-terraform-11-and-12&#34;&gt;Getting started with Terraform 1.1 and 1.2&lt;/h2&gt;
&lt;p&gt;If you&amp;rsquo;re still using older Terraform versions, these new features might be a good motivation for you to upgrade!&lt;/p&gt;
&lt;p&gt;Before upgrading, be sure to read the upgrade notes for the specific version at the &lt;a href=&#34;https://github.com/hashicorp/terraform/releases&#34;&gt;releases page&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Also, an excellent tool can help with fast switching between different Terraform versions while you&amp;rsquo;re experimenting ‚Äî &lt;a href=&#34;https://tfswitch.warrensbox.com/&#34;&gt;tfswitch&lt;/a&gt;.&lt;/p&gt;</content>
    </entry>
    <entry>
        <title>Monterey Shortcuts for Easy and Fast Image Processing</title>
        <link href="https://devdosvid.blog/2022/01/31/monterey-shortcuts-for-easy-and-fast-image-processing/" hreflang="en" rel="alternate"/>
        <published>2022-01-31T21:46:04Z</published>
        <updated>2024-03-25T17:29:29Z</updated>
        <id>https://devdosvid.blog/2022/01/31/monterey-shortcuts-for-easy-and-fast-image-processing/</id>
        <author>
            <name>Serhii Vasylenko</name>
        </author>
        <logo>https://devdosvid.blog/2022/01/31/monterey-shortcuts-for-easy-and-fast-image-processing/cover-image.png</logo>
        <content type="html">&lt;p&gt;Here I want to share two Apple Shortcuts that I created for myself and use to process images for this blog:&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;#optimization&#34;&gt;Image Optimization&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;and&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;#resize&#34;&gt;Image Resize&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;About a year ago, I posted &lt;a href=&#34;https://devdosvid.blog/2021/02/14/using-tinypng-image-compression-from-macos-finder-contextual-menu/&#34; title=&#34;Using TinyPNG Image Compression From MacOS Finder Contextual Menu&#34;&gt;the blog about the Automator quick action&lt;/a&gt; to optimize PNG and JPEG images with TinyPNG service and save the processed images next to the original ones.&lt;/p&gt;
&lt;p&gt;While that Automator-based solution still works, macOS Monterey now supports Shortcuts ‚Äî a new automating tool that seems to substitute the old fellow Automator.&lt;/p&gt;
&lt;p&gt;So I decided to create a couple of automation with Shortcuts: one for image optimization (reduce file size but not the size in pixels), and one for image scaling (change its size in pixels).&lt;/p&gt;
&lt;p&gt;I have used them for several months to prepare images for this blog, and I really like how they work!&lt;/p&gt;
&lt;h2 id=&#34;optimization&#34;&gt;Image Optimization with Monterey Shortcuts&lt;/h2&gt;
&lt;p&gt;This Shortcut replicates the functionality of the Automator quick action and also uses TinyPNG service as a back-end. There are tons of other similar services, but I like TinyPNG for its simplicity: it just does one thing, and it does it well.&lt;/p&gt;
&lt;p&gt;So first, you need to get yourself an &lt;a href=&#34;https://tinypng.com/developers&#34; title=&#34;TinyPNG Developers API&#34;&gt;API key&lt;/a&gt; for TinyPNG.&lt;/p&gt;
&lt;p&gt;The simplest way to reuse my Shortcut is to import it from iCloud using the following URL:&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://www.icloud.com/shortcuts/0a44de1596c745eaaad8181e61289248&#34; title=&#34;Click here to import the Image Optimization Shortcut&#34;&gt;‚û°Ô∏è &lt;strong&gt;Click here to import the Image Optimization Shortcut&lt;/strong&gt; ‚¨ÖÔ∏è&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;The import will work only when the link is opened in &lt;strong&gt;Safari&lt;/strong&gt;.&lt;/p&gt;
&lt;figure&gt;




&lt;img loading=&#34;lazy&#34;
     src=&#34;shortcut-import-optimized.png&#34;
    alt=&#34;Shortcut Import Dialog&#34;width=&#34;800&#34;
height=&#34;595.00&#34;
/&gt; &lt;figcaption&gt;
    &lt;p&gt;Shortcut Import Dialog&lt;/p&gt;
&lt;/figcaption&gt;
&lt;/figure&gt;

&lt;p&gt;To make the Shortcut work from the context menu of the Finder, set the options on the Details panel of the Shortcut setting as displayed on the screenshot:&lt;/p&gt;
&lt;figure&gt;




&lt;img loading=&#34;lazy&#34;
     src=&#34;shortcut-settings-optimized.png&#34;
    alt=&#34;Shortcut Settings&#34;width=&#34;800&#34;
height=&#34;666.00&#34;
/&gt; &lt;figcaption&gt;
    &lt;p&gt;Shortcut Settings&lt;/p&gt;
&lt;/figcaption&gt;
&lt;/figure&gt;

&lt;p&gt;Here is what this Image Optimization Shortcut does:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;em&gt;The Shortcut receives image files. Then, for every image file received, the Shotcut does the following:&lt;/em&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;em&gt;Gets the file&amp;rsquo;s name and parent directory&lt;/em&gt;&lt;/li&gt;
&lt;li&gt;&lt;em&gt;Sends the original file to TinyPNG&lt;/em&gt;&lt;/li&gt;
&lt;li&gt;&lt;em&gt;Process the response with URL to download the optimized image&lt;/em&gt;&lt;/li&gt;
&lt;li&gt;&lt;em&gt;Downloads the optimized image using the URL from the response and replaces the original image with the optimized&lt;/em&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;p&gt;And here is how this Shortcuts looks if you want to create it from scratch:&lt;/p&gt;
&lt;figure&gt;




&lt;img loading=&#34;lazy&#34;
     src=&#34;image-optimization-shortcut.png&#34;
    alt=&#34;Image Optimization Shortcut&#34;width=&#34;800&#34;
height=&#34;1954.66&#34;
/&gt; &lt;figcaption&gt;
    &lt;p&gt;Image Optimization Shortcut&lt;/p&gt;
&lt;/figcaption&gt;
&lt;/figure&gt;

&lt;p&gt;&lt;em&gt;Unfortunately, this Shortcut won&amp;rsquo;t work on iOS or watchOS because they do not support the &amp;ldquo;File Storage&amp;rdquo; actions used in the Shortcut.&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;üåü &lt;strong&gt;Demo&lt;/strong&gt; üåü
&lt;figure&gt;




&lt;img loading=&#34;lazy&#34;
     src=&#34;shortcut-demo.gif&#34;
    alt=&#34;Shortcut Demo&#34;width=&#34;800&#34;
height=&#34;620.00&#34;
/&gt; &lt;figcaption&gt;
    &lt;p&gt;Shortcut Demo&lt;/p&gt;
&lt;/figcaption&gt;
&lt;/figure&gt;
&lt;/p&gt;
&lt;h2 id=&#34;resize&#34;&gt;Image Resize with Monterey Shortcuts&lt;/h2&gt;
&lt;p&gt;Another Shortcut I actively use is the image resizer. Most of the images on my blog are 1600px width fitted into an 800px frame to look sharp on the high-res displays (e.g., Retina).&lt;/p&gt;
&lt;p&gt;And when I have many images in my folder, I want to make them all be 1600px width at once or don&amp;rsquo;t change their own size if they were created smaller intentionally (no upscale, in other words).&lt;/p&gt;
&lt;p&gt;Here is the link to Shortcut import (again, the import will work only when the link is opened in &lt;strong&gt;Safari&lt;/strong&gt;):&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://www.icloud.com/shortcuts/0af8005cc9ac4207a380be445601d541&#34; title=&#34;Click here to import the Image Resize Shortcut&#34;&gt;‚û°Ô∏è &lt;strong&gt;Click here to import the Image Resize Shortcut&lt;/strong&gt; ‚¨ÖÔ∏è&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;Here is how the Image Resize Shortcut looks if you want to create it from scratch:&lt;/p&gt;
&lt;figure&gt;




&lt;img loading=&#34;lazy&#34;
     src=&#34;image-resize-shortcut-optimized.png&#34;
    alt=&#34;Image Resizing Shortcut&#34;width=&#34;800&#34;
height=&#34;1176.98&#34;
/&gt; &lt;figcaption&gt;
    &lt;p&gt;Image Resizing Shortcut&lt;/p&gt;
&lt;/figcaption&gt;
&lt;/figure&gt;

&lt;h2 id=&#34;fun-with-shortcuts&#34;&gt;Fun with Shortcuts&lt;/h2&gt;
&lt;p&gt;I love the way Apple works on routine automation. This Shortcuts app, ported from iOS, brings a lot of cool and fun possibilities to Mac.&lt;/p&gt;
&lt;p&gt;Do you use Shortcuts? What is your favorite? I would love to know!&lt;/p&gt;</content>
    </entry>
    <entry>
        <title>Some Techniques to Enhance Your Terraform Proficiency</title>
        <link href="https://devdosvid.blog/2022/01/16/some-techniques-to-enhance-your-terraform-proficiency/" hreflang="en" rel="alternate"/>
        <published>2022-01-15T23:59:51Z</published>
        <updated>2024-03-25T17:29:29Z</updated>
        <id>https://devdosvid.blog/2022/01/16/some-techniques-to-enhance-your-terraform-proficiency/</id>
        <author>
            <name>Serhii Vasylenko</name>
        </author>
        <logo>https://devdosvid.blog/2022/01/16/some-techniques-to-enhance-your-terraform-proficiency/cover-image.png</logo>
        <content type="html">&lt;p&gt;Terraform built-in functionality is very feature-rich: functions, expressions,  and meta-arguments provide many ways to shape the code and fit it to a particular use case. I want to share a few valuable practices to boost your Terraform expertise in this blog.&lt;/p&gt;
&lt;div class=&#34;attention&#34;&gt;
    Some code examples in this article will work with Terraform version 0.15 and onwards. But if you&amp;rsquo;re still using 0.14 or lower, here&amp;rsquo;s another motivation for you to upgrade.
&lt;/div&gt;
&lt;h2 id=&#34;conditional-resource-creation-or-how-to-implement-the-if-else-statement-in-terraform&#34;&gt;Conditional resource creation or how to implement the &amp;ldquo;if else&amp;rdquo; statement in Terraform&lt;/h2&gt;
&lt;figure&gt;




&lt;img loading=&#34;lazy&#34;
     src=&#34;condiitonal-resource-creation.png&#34;width=&#34;400&#34;
height=&#34;400.00&#34;
/&gt; 
&lt;/figure&gt;

&lt;p&gt;With Terraform, you can have a conditional module or a resource creation by implementing the ternary operator ‚Äî so-called Conditional Expressions.&lt;/p&gt;
&lt;p&gt;Let&amp;rsquo;s start from the most popular one: whether to create a resource depending on some fact, e.g., the value of a variable.&lt;/p&gt;
&lt;p&gt;Terraform meta-argument &lt;code&gt;count&lt;/code&gt; helps to describe that kind of resource creation logic.&lt;/p&gt;
&lt;p&gt;Here is how it may look like:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-terraform&#34; data-lang=&#34;terraform&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#ff7b72&#34;&gt;data&lt;/span&gt; &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;aws_ssm_parameter&amp;#34;&lt;/span&gt; &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;ami_id&amp;#34;&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  count    = var.ami_channel =&lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;&amp;#34;&lt;/span&gt; &lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;?&lt;/span&gt; &lt;span style=&#34;color:#a5d6ff&#34;&gt;0&lt;/span&gt; &lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#a5d6ff&#34;&gt;1&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  name     = local.ami_channels[var.ami_channel]
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;The notation &lt;code&gt;var.ami_channel == &amp;quot;&amp;quot; ? 0 : 1&lt;/code&gt; is called &lt;em&gt;conditional expression&lt;/em&gt; and means the following: if my variable is empty (&lt;code&gt;var.ami_channel == &amp;quot;&amp;quot;&lt;/code&gt; ‚Äî hence, true) then set the count to 0, otherwise set to 1.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-shell&#34; data-lang=&#34;shell&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;condition ? true_val : false_val
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;In this illustration, I want to get the AMI ID from the SSM Parameter only if the AMI channel (e.g., beta or alpha) is specified. Otherwise, providing that the &lt;code&gt;ami_channel&lt;/code&gt; variable is an empty string by default (&amp;quot;&amp;quot;), the data source should not be created.&lt;/p&gt;
&lt;p&gt;When following this method, keep in mind that the resource address will contain the index identifier. So when I need to use the value of the SSM parameter from our example, I need to reference it the following way:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-terraform&#34; data-lang=&#34;terraform&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;ami_id = data.aws_ssm_parameter.ami_id[&lt;span style=&#34;color:#a5d6ff&#34;&gt;0&lt;/span&gt;].value
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;The &lt;code&gt;count&lt;/code&gt; meta-argument can also be used when you need to conditionally create a Terraform module.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-terraform&#34; data-lang=&#34;terraform&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#ff7b72&#34;&gt;module&lt;/span&gt; &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;bucket&amp;#34;&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  count             = var.create_bucket =&lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#79c0ff&#34;&gt;true&lt;/span&gt; &lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;?&lt;/span&gt; &lt;span style=&#34;color:#a5d6ff&#34;&gt;1&lt;/span&gt; &lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#a5d6ff&#34;&gt;0&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  source            = &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;./modules/s3_bucket&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  name              = &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;my-unique-bucket&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  ...
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;The &lt;code&gt;var.create_bucket == true ? 1 : 0&lt;/code&gt;  expression can be written even shorter: &lt;code&gt;var.create_bucket ? 1 : 0&lt;/code&gt;  because the &lt;code&gt;create_bucket&lt;/code&gt; variable has boolean type, apparently.&lt;/p&gt;
&lt;p&gt;But what if you need to produce more than one instance of a resource or module? And still be able to avoid their creation.&lt;/p&gt;
&lt;p&gt;Another meta-argument ‚Äî &lt;code&gt;for_each&lt;/code&gt; ‚Äî will do the trick.&lt;/p&gt;
&lt;p&gt;For example, this is how the &lt;code&gt;for_each&lt;/code&gt; argument works for the conditional module creation:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-terraform&#34; data-lang=&#34;terraform&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#ff7b72&#34;&gt;module&lt;/span&gt; &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;bucket&amp;#34;&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  for_each          = var.bucket_names =&lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;=&lt;/span&gt; [] &lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;?&lt;/span&gt; [] &lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;:&lt;/span&gt; var.bucket_names
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  source            = &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;./modules/s3_bucket&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  name              = &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#a5d6ff&#34;&gt;${&lt;/span&gt;each.key&lt;span style=&#34;color:#a5d6ff&#34;&gt;}&lt;/span&gt;&lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  enable_encryption = &lt;span style=&#34;color:#79c0ff&#34;&gt;true&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  ...
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;In this illustration, I also used a conditional expression that makes Terraform iterate through the set of values of &lt;code&gt;var.bucket_names&lt;/code&gt; if it&amp;rsquo;s not empty and create several modules. Otherwise, do not iterate at all and do not create anything.&lt;/p&gt;
&lt;p&gt;The same can be done for the resources. For example, when you need to create an arbitrary number of security group rules, e.g., to allowlist some IPs for your bastion host:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-terraform&#34; data-lang=&#34;terraform&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#ff7b72&#34;&gt;resource&lt;/span&gt; &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;aws_security_group_rule&amp;#34;&lt;/span&gt; &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;allowlist&amp;#34;&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  for_each           = var.cidr_blocks =&lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;=&lt;/span&gt; [] &lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;?&lt;/span&gt; [] &lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;:&lt;/span&gt; var.cidr_blocks
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  type               = &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;ingress&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  from_port          = &lt;span style=&#34;color:#a5d6ff&#34;&gt;22&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  to_port            = &lt;span style=&#34;color:#a5d6ff&#34;&gt;22&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  protocol           = &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;tcp&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  cidr_blocks        = [each.value]
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  security_group_id  = aws_security_group.bastion.id
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;And just like with the &lt;code&gt;count&lt;/code&gt; meta-argument, with the &lt;code&gt;for_each&lt;/code&gt;, resource addresses will have the identifier named by the values provided to &lt;code&gt;for_each&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;For example, here is how I would reference a resource created in the module with &lt;code&gt;for_each&lt;/code&gt; described earlier:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-terraform&#34; data-lang=&#34;terraform&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;bucket_name = module.bucket[&lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;photos&amp;#34;&lt;/span&gt;].name
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;div class=&#34;substack-embedded-container&#34;&gt;
    &lt;h3&gt;Subscribe to blog updates!&lt;/h3&gt;
    &lt;iframe title=&#34;Substack&#34; class=&#34;substack-embedded-iframe&#34; src=&#34;https://devdosvid.substack.com/embed&#34; height=&#34;250&#34;
            loading=&#34;lazy&#34;&gt;&lt;/iframe&gt;
&lt;/div&gt;
&lt;h2 id=&#34;conditional-resource-arguments-attributes-setting&#34;&gt;Conditional resource arguments (attributes) setting&lt;/h2&gt;
&lt;figure&gt;




&lt;img loading=&#34;lazy&#34;
     src=&#34;conditional-resource-argument.png&#34;width=&#34;400&#34;
height=&#34;400.00&#34;
/&gt; 
&lt;/figure&gt;

&lt;p&gt;Now let&amp;rsquo;s go deeper and see how resource arguments can be conditionally set (or not).&lt;/p&gt;
&lt;p&gt;First, let&amp;rsquo;s review the conditional argument value setting with the &lt;code&gt;null&lt;/code&gt; data type:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-terraform&#34; data-lang=&#34;terraform&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#ff7b72&#34;&gt;resource&lt;/span&gt; &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;aws_launch_template&amp;#34;&lt;/span&gt; &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;this&amp;#34;&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  name     = &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;my-launch-template&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  ...
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  key_name = var.use_default_keypair &lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;?&lt;/span&gt; var.keypair_name &lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;:&lt;/span&gt; null
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  ...
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Here I want to skip the usage of the EC2 Key Pair for the Launch Template in some instances and Terraform allows me to write the conditional expression that will set the &lt;code&gt;null&lt;/code&gt; value for the argument. It means the &lt;em&gt;absence&lt;/em&gt; or &lt;em&gt;omission&lt;/em&gt; and Terraform would behave the same as if you did not specify the argument at all.&lt;/p&gt;
&lt;p&gt;Dynamic blocks are another case where conditional creation suits best. Take a look at the following piece of CloudFront resource code where I want to either describe the configuration for the custom error response or omit that completely:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-terraform&#34; data-lang=&#34;terraform&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#ff7b72&#34;&gt;resource&lt;/span&gt; &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;aws_cloudfront_distribution&amp;#34;&lt;/span&gt; &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;cdn&amp;#34;&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  enabled = &lt;span style=&#34;color:#79c0ff&#34;&gt;true&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  ...
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  dynamic &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;custom_error_response&amp;#34;&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    for_each = var.custom_error_response =&lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;=&lt;/span&gt; null &lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;?&lt;/span&gt; [] &lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;:&lt;/span&gt; [var.custom_error_response]
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    iterator = cer
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    content {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      error_code            = lookup(cer.value, &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;error_code&amp;#34;&lt;/span&gt;, null)
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      error_caching_min_ttl = lookup(cer.value, &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;error_caching_min_ttl&amp;#34;&lt;/span&gt;, null)
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      response_code         = lookup(cer.value, &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;response_code&amp;#34;&lt;/span&gt;, null)
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      response_page_path    = lookup(cer.value, &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;response_page_path&amp;#34;&lt;/span&gt;, null)
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    }
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  }
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  ...
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;The &lt;code&gt;custom_error_response&lt;/code&gt; variable is &lt;code&gt;null&lt;/code&gt; by default, but it has the &lt;code&gt;object&lt;/code&gt; type, and users can assign the variable with the required nested specifications if needed. And when they do it, Terraform will add the &lt;code&gt;custom_error_response&lt;/code&gt; block to the resource configuration. Otherwise, it will be omitted entirely.&lt;/p&gt;
&lt;h2 id=&#34;convert-types-in-terraform-with-ease&#34;&gt;Convert types in Terraform with ease&lt;/h2&gt;
&lt;p&gt;&lt;figure&gt;




&lt;img loading=&#34;lazy&#34;
     src=&#34;types-converstion.png&#34;width=&#34;400&#34;
height=&#34;400.00&#34;
/&gt; 
&lt;/figure&gt;

Ok, let&amp;rsquo;s move to the less conditional things now üòÖ&lt;/p&gt;
&lt;p&gt;Terraform has several type conversion functions: &lt;code&gt;tobool()&lt;/code&gt;, &lt;code&gt;tolist()&lt;/code&gt;,&lt;code&gt;tomap()&lt;/code&gt;, &lt;code&gt;tonumber()&lt;/code&gt;, &lt;code&gt;toset()&lt;/code&gt;, and &lt;code&gt;tostring()&lt;/code&gt;. Their purpose is to convert the input values to the compatible types.&lt;/p&gt;
&lt;p&gt;For example, suppose I need to pass the set to the &lt;code&gt;for_each&lt;/code&gt; (it accepts only sets and maps types of value), but I got the list as an input; let&amp;rsquo;s say I got it as an output from another module. In such a case, I would do something like this:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-terraform&#34; data-lang=&#34;terraform&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;for_each = toset(var.remote_access_ports)
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;However, I can make my code cleaner and avoid the explicit conversion ‚Äî I just need to define the value type in the configuration block of the &lt;code&gt;my_list&lt;/code&gt; variable. Terraform will do the conversion automatically when the value is assigned.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-terraform&#34; data-lang=&#34;terraform&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#ff7b72&#34;&gt;variable&lt;/span&gt; &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;remote_access_ports&amp;#34;&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  description = &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;Ports for remote access&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  type        = set(string)
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;While Terraform can do a lot of implicit conversions for you, explicit type conversions are practical during values normalization or when you need to calculate some complex value for a variable. For example, the Local Values, known as &lt;code&gt;locals&lt;/code&gt;, are the most suitable place for doing that.&lt;/p&gt;
&lt;p&gt;By the way, although there is a &lt;code&gt;tolist()&lt;/code&gt; function, there is no such thing as the &lt;code&gt;tostring()&lt;/code&gt; function. But what if you need to convert the list to string in Terraform?&lt;/p&gt;
&lt;p&gt;The &lt;code&gt;one()&lt;/code&gt; function can help here: it takes a list, set, or tuple value with either zero or one element and returns either &lt;code&gt;null&lt;/code&gt; or that one element in the form of string.&lt;/p&gt;
&lt;p&gt;It&amp;rsquo;s useful in cases when a resource created using conditional expression is represented as either a zero- or one-element list, and you need to get a single value which may be either &lt;code&gt;null&lt;/code&gt; or &lt;code&gt;string&lt;/code&gt;, for example:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-terraform&#34; data-lang=&#34;terraform&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#ff7b72&#34;&gt;resource&lt;/span&gt; &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;aws_kms_key&amp;#34;&lt;/span&gt; &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;main&amp;#34;&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  count               = var.ebs_encrypted &lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;?&lt;/span&gt; &lt;span style=&#34;color:#a5d6ff&#34;&gt;1&lt;/span&gt; &lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#a5d6ff&#34;&gt;0&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  enable_key_rotation = &lt;span style=&#34;color:#79c0ff&#34;&gt;true&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  tags                = var.tags
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#ff7b72&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#ff7b72&#34;&gt;resource&lt;/span&gt; &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;aws_kms_alias&amp;#34;&lt;/span&gt; &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;main&amp;#34;&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  count         = var.ebs_encrypted &lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;?&lt;/span&gt; &lt;span style=&#34;color:#a5d6ff&#34;&gt;1&lt;/span&gt; &lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#a5d6ff&#34;&gt;0&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  name          = &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;alias/encrypt-ebs&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  target_key_id = one(aws_kms_key.main[&lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;*&lt;/span&gt;]key_id)
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id=&#34;write-yaml-or-json-as-terraform-code-hcl&#34;&gt;Write YAML or JSON as Terraform code (HCL)&lt;/h2&gt;
&lt;p&gt;&lt;figure&gt;




&lt;img loading=&#34;lazy&#34;
     src=&#34;write-yaml-json-as-terraform-code.png&#34;width=&#34;400&#34;
height=&#34;400.00&#34;
/&gt; 
&lt;/figure&gt;

Sometimes you need to supply JSON or YAML files to the services you manage with Terraform. For example, if you want to create something with CloudFormation using Terraform (and I am not kidding). Sometimes the AWS Terraform provider does not support the needed resource, and you want to maintain the whole infrastructure code using only one tool.&lt;/p&gt;
&lt;p&gt;Instead of maintaining another file in JSON or YAML format, you can embed JSON or YAML code management into HCL by taking benefit of the  &lt;code&gt;jsonencode()&lt;/code&gt; or &lt;code&gt;yamlencode()&lt;/code&gt;  functions.&lt;/p&gt;
&lt;p&gt;The attractiveness of this approach is that you can reference other Terraform resources or their attributes right in the code of your object, and you have more freedom in terms of the code syntax and its formatting comparable to native JSON or YAML.&lt;/p&gt;
&lt;p&gt;Here is how it looks like:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-terraform&#34; data-lang=&#34;terraform&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;locals {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;	some_string = &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;ult&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  myjson_object = jsonencode({
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;Hashicorp Products&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;:&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      Terra&lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;form&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      Con&lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;:&lt;/span&gt;   &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;sul&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      Vag&lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;:&lt;/span&gt;   &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;rant&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      Va&lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;:&lt;/span&gt;    local.some_string
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    }
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  })
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;The value of the &lt;code&gt;myjson_object&lt;/code&gt; local variable would look like this:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-json&#34; data-lang=&#34;json&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;{
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#7ee787&#34;&gt;&amp;#34;Hashicorp Products&amp;#34;&lt;/span&gt;: {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#7ee787&#34;&gt;&amp;#34;Con&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;sul&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#7ee787&#34;&gt;&amp;#34;Terra&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;form&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#7ee787&#34;&gt;&amp;#34;Va&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;ult&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#7ee787&#34;&gt;&amp;#34;Vag&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;rant&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  }
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;And here is a piece of real-world example:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-terraform&#34; data-lang=&#34;terraform&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;locals {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  cf_template_body = jsonencode({
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    Resources &lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;:&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      DedicatedHostGroup &lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;:&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        Type &lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;AWS::ResourceGroups::Group&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        Properties &lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;:&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;          Name &lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;:&lt;/span&gt; var.service_name
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;          Configuration &lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;:&lt;/span&gt; [
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;              Type &lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;AWS::EC2::HostManagement&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;              Parameters &lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;:&lt;/span&gt; [
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                  Name &lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;auto-allocate-host&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                  Values &lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;:&lt;/span&gt; [var.auto_allocate_host]
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                },
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;			...
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;			...
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id=&#34;create-custom-file-templates-in-terraform&#34;&gt;Create custom file templates in Terraform&lt;/h2&gt;
&lt;p&gt;&lt;figure&gt;




&lt;img loading=&#34;lazy&#34;
     src=&#34;templatize-stuff.png&#34;width=&#34;400&#34;
height=&#34;400.00&#34;
/&gt; 
&lt;/figure&gt;

The last case in this blog but not the least by its efficacy ‚Äî render source file content as a template in Terraform.&lt;/p&gt;
&lt;p&gt;Let&amp;rsquo;s review the following scenario: you launch an EC2 instance and want to supply it with a bash script (via the user-data parameter) for some additional configuration at launch.&lt;/p&gt;
&lt;p&gt;Suppose we have the following bash script &lt;code&gt;instance-init.sh&lt;/code&gt; that sets the hostname and registers our instance in a monitoring system:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#8b949e;font-weight:bold;font-style:italic&#34;&gt;#!/bin/bash
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#8b949e;font-weight:bold;font-style:italic&#34;&gt;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;hostname example.com
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;bash /opt/system-init/register-monitoring.sh
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;But what if you want to set a different hostname per instance, and some instances should not be registered in the monitoring system?&lt;/p&gt;
&lt;p&gt;In such a case, here is how the script file content will look:&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code class=&#34;language-gotemplate&#34; data-lang=&#34;gotemplate&#34;&gt;#!/bin/bash

hostname ${system_hostname}
%{ if register_monitoring }
bash /opt/system-init/register-monitoring.sh
%{endif}
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;And when you supply this file as an argument for the EC2 instance resource in Terraform, you will use the &lt;code&gt;templatefile()&lt;/code&gt; function to make the magic happen:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-terraform&#34; data-lang=&#34;terraform&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#ff7b72&#34;&gt;resource&lt;/span&gt; &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;aws_instance&amp;#34;&lt;/span&gt; &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;web&amp;#34;&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  ami           = var.my_ami_id
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  instance_type = var.instance_type
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  ...
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  user_data = templatefile(&lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#a5d6ff&#34;&gt;${&lt;/span&gt;path.module&lt;span style=&#34;color:#a5d6ff&#34;&gt;}&lt;/span&gt;&lt;span style=&#34;color:#a5d6ff&#34;&gt;/instance-init.tftpl&amp;#34;&lt;/span&gt;, {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    system_hostname     = var.system_hostname
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    register_monitoring = var.add_to_monitoring
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  })
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  ...
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;And of course, you can create a template from any file type. The only requirement here is that the template file must exist on the disk at the beginning of the Terraform execution.&lt;/p&gt;
&lt;h2 id=&#34;key-takeaways&#34;&gt;Key takeaways&lt;/h2&gt;
&lt;p&gt;Terraform is far beyond the standard resource management operations. With the power of built-in functions, you can write more versatile code and reusable Terraform modules.&lt;/p&gt;
&lt;p&gt;‚úÖ Use &lt;a href=&#34;https://www.terraform.io/language/expressions/conditionals&#34;&gt;conditional expressions&lt;/a&gt; with &lt;a href=&#34;https://www.terraform.io/language/meta-arguments/count&#34;&gt;count&lt;/a&gt; and &lt;a href=&#34;https://www.terraform.io/language/meta-arguments/for_each&#34;&gt;for_each&lt;/a&gt; meta-arguments, when the creation of a resource depends on some context or user input.&lt;/p&gt;
&lt;p&gt;‚úÖ Take advantage of &lt;a href=&#34;https://www.terraform.io/language/expressions/types#type-conversion&#34;&gt;implicit type conversion&lt;/a&gt; when working with input variables and their values to keep your code cleaner.&lt;/p&gt;
&lt;p&gt;‚úÖ Embed YAML and JSON-based objects right into your Terraform code using built-in &lt;a href=&#34;https://www.terraform.io/language/functions/jsonencode&#34;&gt;encoding&lt;/a&gt; &lt;a href=&#34;https://www.terraform.io/language/functions/yamlencode&#34;&gt;functions&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;‚úÖ And when you need to pass some files to the managed service, you can treat them as &lt;a href=&#34;https://www.terraform.io/language/functions/templatefile&#34;&gt;templates&lt;/a&gt; and make them multipurpose.&lt;/p&gt;
&lt;p&gt;Thank you for reading down to this point! ü§ó&lt;/p&gt;
&lt;p&gt;If you have some favorite Terraform tricks ‚Äî I would love to know!&lt;/p&gt;</content>
    </entry>
    <entry>
        <title>Guide to Using Terraform in CI/CD</title>
        <link href="https://devdosvid.blog/2021/11/24/guide-to-using-terraform-in-ci/cd/" hreflang="en" rel="alternate"/>
        <published>2021-11-24T20:20:45Z</published>
        <updated>2024-03-25T17:29:29Z</updated>
        <id>https://devdosvid.blog/2021/11/24/guide-to-using-terraform-in-ci/cd/</id>
        <author>
            <name>Serhii Vasylenko</name>
        </author>
        <logo>https://devdosvid.blog/2021/11/24/guide-to-using-terraform-in-ci/cd/cover-image.png</logo>
        <content type="html">&lt;p&gt;Terraform by itself automates a lot of things: it creates, changes, and versions your cloud resources. Although many teams run Terraform locally (sometimes with wrapper scripts), running Terraform in CI/CD can boost the organization&amp;rsquo;s performance and ensure consistent deployments.&lt;/p&gt;
&lt;p&gt;In this article, I would like to review different approaches to integrating Terraform into generic deployment pipelines.&lt;/p&gt;
&lt;h1 id=&#34;where-to-store-the-terraform-code&#34;&gt;Where to store the Terraform code&lt;/h1&gt;
&lt;p&gt;Storing Terraform code in the same repository as the application code or maintaining a separate repository for the infrastructure?&lt;/p&gt;
&lt;p&gt;This question has no strict and clear answer, but here are some insights that may help you decide:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;The Terraform and application code coupled together represent one unit, so it&amp;rsquo;s simple to maintain by one team;&lt;/li&gt;
&lt;li&gt;Conversely, if you have a dedicated team that manages infrastructure (e.g., platform team), a separate repository for infrastructure is more convenient because it&amp;rsquo;s a standalone project in that case.&lt;/li&gt;
&lt;li&gt;When infrastructure code is stored with the application, sometimes you have to deal with additional rules for the pipeline to separate triggers for these code parts. But sometimes (e.g., serverless apps) changes to either part (app/infra) should trigger the deployment.&lt;/li&gt;
&lt;/ul&gt;
&lt;div class=&#34;attention&#34;&gt;
    There is no right or wrong approach, but whichever you choose, remember to follow the &lt;strong&gt;Don‚Äôt Repeat Yourself (DRY)&lt;/strong&gt; principle: make the infrastructure code modular by logically grouping resources into higher abstractions and reusing these modules.
&lt;/div&gt;
&lt;h1 id=&#34;preparing-terraform-execution-environment&#34;&gt;Preparing Terraform execution environment&lt;/h1&gt;
&lt;p&gt;Running Terraform locally generally means that all dependencies are already in-place: you have the binary installed and present in the user&amp;rsquo;s &lt;code&gt;PATH&lt;/code&gt; and perhaps even some providers already stored in the &lt;code&gt;.terraform&lt;/code&gt; directory.&lt;/p&gt;
&lt;p&gt;But when you shift Terraform runs from your local machine to stateless pipelines, this is not the case. However, you can still have a pre-built environment ‚Äî this will speed up the pipeline execution and provide control over the process.&lt;/p&gt;
&lt;p&gt;Docker image with a Terraform binary is one of the popular solutions that address this. Once created, you can execute Terraform within a container context with configuration files mounted as a Docker volume.&lt;/p&gt;
&lt;p&gt;You can use the official &lt;a href=&#34;https://hub.docker.com/r/hashicorp/terraform/&#34;&gt;image from Hashicorp&lt;/a&gt;, but sometimes it makes sense to maintain your own Docker images with additional tools you may need. For instance, you can bake the &lt;code&gt;tfsec&lt;/code&gt; tool into the image to use it for security inspection and have it ready inside the Docker container without the need to install it every time.&lt;/p&gt;
&lt;p&gt;Here is an example of a Dockerfile that builds an image with a custom Terraform version (you can override it as a build argument) and a &lt;code&gt;tfsec&lt;/code&gt; tool. This example also shows how to verify the installed Terraform binary to make sure it&amp;rsquo;s signed by HashiCorp before we run it.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-dockerfile&#34; data-lang=&#34;dockerfile&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#ff7b72&#34;&gt;FROM&lt;/span&gt;&lt;span style=&#34;color:#a5d6ff&#34;&gt; alpine:3.14&lt;/span&gt;&lt;span style=&#34;color:#f85149&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f85149&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#ff7b72&#34;&gt;ARG&lt;/span&gt; &lt;span style=&#34;color:#79c0ff&#34;&gt;TERRAFORM_VERSION&lt;/span&gt;&lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#a5d6ff&#34;&gt;1&lt;/span&gt;.0.11&lt;span style=&#34;color:#f85149&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f85149&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#ff7b72&#34;&gt;ARG&lt;/span&gt; &lt;span style=&#34;color:#79c0ff&#34;&gt;TFSEC_VERSION&lt;/span&gt;&lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#a5d6ff&#34;&gt;0&lt;/span&gt;.59.0&lt;span style=&#34;color:#f85149&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f85149&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#ff7b72&#34;&gt;RUN&lt;/span&gt; apk add --no-cache --virtual .sig-check gnupg&lt;span style=&#34;color:#f85149&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f85149&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#ff7b72&#34;&gt;RUN&lt;/span&gt; wget -O /usr/bin/tfsec https://github.com/aquasecurity/tfsec/releases/download/v&lt;span style=&#34;color:#a5d6ff&#34;&gt;${&lt;/span&gt;&lt;span style=&#34;color:#79c0ff&#34;&gt;TFSEC_VERSION&lt;/span&gt;&lt;span style=&#34;color:#a5d6ff&#34;&gt;}&lt;/span&gt;/tfsec-linux-amd64 &lt;span style=&#34;color:#79c0ff&#34;&gt;\
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#79c0ff&#34;&gt;&lt;/span&gt;    &lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt; chmod &#43;x /usr/bin/tfsec&lt;span style=&#34;color:#f85149&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f85149&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#ff7b72&#34;&gt;RUN&lt;/span&gt; cd /tmp &lt;span style=&#34;color:#79c0ff&#34;&gt;\
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#79c0ff&#34;&gt;&lt;/span&gt;    &lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt; wget &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;https://releases.hashicorp.com/terraform/&lt;/span&gt;&lt;span style=&#34;color:#a5d6ff&#34;&gt;${&lt;/span&gt;&lt;span style=&#34;color:#79c0ff&#34;&gt;TERRAFORM_VERSION&lt;/span&gt;&lt;span style=&#34;color:#a5d6ff&#34;&gt;}&lt;/span&gt;&lt;span style=&#34;color:#a5d6ff&#34;&gt;/terraform_&lt;/span&gt;&lt;span style=&#34;color:#a5d6ff&#34;&gt;${&lt;/span&gt;&lt;span style=&#34;color:#79c0ff&#34;&gt;TERRAFORM_VERSION&lt;/span&gt;&lt;span style=&#34;color:#a5d6ff&#34;&gt;}&lt;/span&gt;&lt;span style=&#34;color:#a5d6ff&#34;&gt;_linux_amd64.zip&amp;#34;&lt;/span&gt; &lt;span style=&#34;color:#79c0ff&#34;&gt;\
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#79c0ff&#34;&gt;&lt;/span&gt;    &lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt; wget https://keybase.io/hashicorp/pgp_keys.asc &lt;span style=&#34;color:#79c0ff&#34;&gt;\
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#79c0ff&#34;&gt;&lt;/span&gt;    &lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt; gpg --import pgp_keys.asc &lt;span style=&#34;color:#79c0ff&#34;&gt;\
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#79c0ff&#34;&gt;&lt;/span&gt;    &lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt; gpg --fingerprint --list-signatures &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;HashiCorp Security&amp;#34;&lt;/span&gt; | grep -q &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;C874 011F 0AB4 0511 0D02  1055 3436 5D94 72D7 468F&amp;#34;&lt;/span&gt; &lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;||&lt;/span&gt; exit &lt;span style=&#34;color:#a5d6ff&#34;&gt;1&lt;/span&gt; &lt;span style=&#34;color:#79c0ff&#34;&gt;\
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#79c0ff&#34;&gt;&lt;/span&gt;    &lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt; gpg --fingerprint --list-signatures &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;HashiCorp Security&amp;#34;&lt;/span&gt; | grep -q &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;34365D9472D7468F&amp;#34;&lt;/span&gt; &lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;||&lt;/span&gt; exit &lt;span style=&#34;color:#a5d6ff&#34;&gt;1&lt;/span&gt; &lt;span style=&#34;color:#79c0ff&#34;&gt;\
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#79c0ff&#34;&gt;&lt;/span&gt;    &lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt; wget https://releases.hashicorp.com/terraform/&lt;span style=&#34;color:#a5d6ff&#34;&gt;${&lt;/span&gt;&lt;span style=&#34;color:#79c0ff&#34;&gt;TERRAFORM_VERSION&lt;/span&gt;&lt;span style=&#34;color:#a5d6ff&#34;&gt;}&lt;/span&gt;/terraform_&lt;span style=&#34;color:#a5d6ff&#34;&gt;${&lt;/span&gt;&lt;span style=&#34;color:#79c0ff&#34;&gt;TERRAFORM_VERSION&lt;/span&gt;&lt;span style=&#34;color:#a5d6ff&#34;&gt;}&lt;/span&gt;_SHA256SUMS &lt;span style=&#34;color:#79c0ff&#34;&gt;\
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#79c0ff&#34;&gt;&lt;/span&gt;    &lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt; wget https://releases.hashicorp.com/terraform/&lt;span style=&#34;color:#a5d6ff&#34;&gt;${&lt;/span&gt;&lt;span style=&#34;color:#79c0ff&#34;&gt;TERRAFORM_VERSION&lt;/span&gt;&lt;span style=&#34;color:#a5d6ff&#34;&gt;}&lt;/span&gt;/terraform_&lt;span style=&#34;color:#a5d6ff&#34;&gt;${&lt;/span&gt;&lt;span style=&#34;color:#79c0ff&#34;&gt;TERRAFORM_VERSION&lt;/span&gt;&lt;span style=&#34;color:#a5d6ff&#34;&gt;}&lt;/span&gt;_SHA256SUMS.sig &lt;span style=&#34;color:#79c0ff&#34;&gt;\
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#79c0ff&#34;&gt;&lt;/span&gt;    &lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt; gpg --verify terraform_&lt;span style=&#34;color:#a5d6ff&#34;&gt;${&lt;/span&gt;&lt;span style=&#34;color:#79c0ff&#34;&gt;TERRAFORM_VERSION&lt;/span&gt;&lt;span style=&#34;color:#a5d6ff&#34;&gt;}&lt;/span&gt;_SHA256SUMS.sig terraform_&lt;span style=&#34;color:#a5d6ff&#34;&gt;${&lt;/span&gt;&lt;span style=&#34;color:#79c0ff&#34;&gt;TERRAFORM_VERSION&lt;/span&gt;&lt;span style=&#34;color:#a5d6ff&#34;&gt;}&lt;/span&gt;_SHA256SUMS &lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;||&lt;/span&gt; exit &lt;span style=&#34;color:#a5d6ff&#34;&gt;1&lt;/span&gt; &lt;span style=&#34;color:#79c0ff&#34;&gt;\
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#79c0ff&#34;&gt;&lt;/span&gt;    &lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt; sha256sum -c terraform_&lt;span style=&#34;color:#a5d6ff&#34;&gt;${&lt;/span&gt;&lt;span style=&#34;color:#79c0ff&#34;&gt;TERRAFORM_VERSION&lt;/span&gt;&lt;span style=&#34;color:#a5d6ff&#34;&gt;}&lt;/span&gt;_SHA256SUMS 2&amp;gt;&amp;amp;&lt;span style=&#34;color:#a5d6ff&#34;&gt;1&lt;/span&gt; | grep -q &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;terraform_&lt;/span&gt;&lt;span style=&#34;color:#a5d6ff&#34;&gt;${&lt;/span&gt;&lt;span style=&#34;color:#79c0ff&#34;&gt;TERRAFORM_VERSION&lt;/span&gt;&lt;span style=&#34;color:#a5d6ff&#34;&gt;}&lt;/span&gt;&lt;span style=&#34;color:#a5d6ff&#34;&gt;_linux_amd64.zip: OK&amp;#34;&lt;/span&gt; &lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;||&lt;/span&gt; exit &lt;span style=&#34;color:#a5d6ff&#34;&gt;1&lt;/span&gt; &lt;span style=&#34;color:#79c0ff&#34;&gt;\
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#79c0ff&#34;&gt;&lt;/span&gt;    &lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt; unzip terraform_&lt;span style=&#34;color:#a5d6ff&#34;&gt;${&lt;/span&gt;&lt;span style=&#34;color:#79c0ff&#34;&gt;TERRAFORM_VERSION&lt;/span&gt;&lt;span style=&#34;color:#a5d6ff&#34;&gt;}&lt;/span&gt;_linux_amd64.zip -d /bin &lt;span style=&#34;color:#79c0ff&#34;&gt;\
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#79c0ff&#34;&gt;&lt;/span&gt;    &lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt; rm -rf /tmp/* &lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt; apk del .sig-check&lt;span style=&#34;color:#f85149&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;But the main functionality of Terraform is delivered by provider plugins. It takes time to download the provider: for example, the AWS provider is about 250MB, and in a large scale, with hundreds of Terraform runs per day, this makes a difference.&lt;/p&gt;
&lt;p&gt;There are two common ways to deal with it: either use a shared cache available to your pipeline workloads or bake provider binaries into the runtime environment (i.e., Docker image).&lt;/p&gt;
&lt;p&gt;The critical element for both approaches is the configuration of the plugin cache directory path. By default, Terraform looks for plugins and downloads them in the &lt;code&gt;.terraform&lt;/code&gt; directory, which is local to the main project directory. But you can override this, and you can leverage the &lt;code&gt;TF_PLUGIN_CACHE_DIR&lt;/code&gt; environment variable to do that.&lt;/p&gt;
&lt;p&gt;If supported by your CI/CD tool, the shared cache can significantly reduce the operational burden because all your pipeline runtime environments can use it to get the needed provider versions.&lt;/p&gt;
&lt;p&gt;So all you have to do is to maintain the provider versions in the shared cache and instruct Terraform to use it:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Mount the cache directory to the pipeline runtime (i.e., docker container) and specify its internal path&lt;/li&gt;
&lt;li&gt;Set the value of the &lt;code&gt;TF_PLUGIN_CACHE_DIR&lt;/code&gt; environment variable accordingly&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;On the other hand, you can bake the provider binaries into the Docker image and inject the value for the &lt;code&gt;TF_PLUGIN_CACHE_DIR&lt;/code&gt; environment variable right into the Dockerfile.&lt;/p&gt;
&lt;div class=&#34;attention&#34;&gt;
    This approach takes more operational effort &lt;strong&gt;but makes the Terraform environment self-sufficient and stateless&lt;/strong&gt;. It also allows you to set strict boundaries around permitted provider versions as a security measure.
&lt;/div&gt;
&lt;h1 id=&#34;planning-and-applying-changes&#34;&gt;Planning and Applying changes&lt;/h1&gt;
&lt;p&gt;Now let&amp;rsquo;s review the ways to automate planning and applying of changes. Although &lt;code&gt;terraform apply&lt;/code&gt; can do both, it&amp;rsquo;s sometimes useful to separate these actions.&lt;/p&gt;
&lt;h2 id=&#34;initialization&#34;&gt;Initialization&lt;/h2&gt;
&lt;p&gt;CI/CD pipelines generally run in stateless environments. Thus, every subsequent run of Terraform looks like a fresh start, so the project needs to be initialized before other actions can be performed.&lt;/p&gt;
&lt;p&gt;The usage of the &lt;code&gt;init&lt;/code&gt; command in CI/CD slightly differs from its common local usage:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-shell&#34; data-lang=&#34;shell&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&amp;gt; terraform init -input&lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;=&lt;/span&gt;false
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;The &lt;code&gt;-input=false&lt;/code&gt; option prevents Terraform CLI from asking for user actions (it will throw an error if the input was required).&lt;/p&gt;
&lt;p&gt;&lt;em&gt;Also, there is &lt;code&gt;-no-color&lt;/code&gt; option that prevents the usage of color codes in a shell, so the output will look much cleaner if your CI/CD logging system cannot render the terminal formatting.&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;Another option of the init command that is useful in CI ‚Äî is the &lt;code&gt;-backend-config&lt;/code&gt;. That option allows you to override the backend configuration in your code or define it if you prefer to use partial configuration, thus creating more uniform pipelines.&lt;/p&gt;
&lt;p&gt;For example, here is how you can use the same code with different roles in different environments on AWS:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-shell&#34; data-lang=&#34;shell&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&amp;gt; terraform init -input&lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;=&lt;/span&gt;false &lt;span style=&#34;color:#79c0ff&#34;&gt;\
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#79c0ff&#34;&gt;&lt;/span&gt;-backend-config&lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;role_arn=arn:aws:iam::012345678901:role/QADeploymentAutomation&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Terraform &lt;code&gt;init&lt;/code&gt; produces two artifacts:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;.terraform&lt;/code&gt; directory, which Terraform uses to manage cached provider plugins and modules, and record backend information&lt;/li&gt;
&lt;li&gt;&lt;code&gt;.terraform.lock.hcl&lt;/code&gt; file, which Terraform uses to track provider dependencies&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;They both must be present in the project directory to successfully run the subsequent plan and apply commands.&lt;/p&gt;
&lt;p&gt;However, I suggest checking in &lt;code&gt;.terraform.lock.hcl&lt;/code&gt; to your repository as suggested by HashiCorp (&lt;a href=&#34;https://www.terraform.io/docs/language/dependency-lock.html&#34;&gt;Dependency Lock File&lt;/a&gt;): this way you will be able to control dependencies more thoroughly, and you will not worry about transferring this file between build stages.&lt;/p&gt;
&lt;h2 id=&#34;plan&#34;&gt;Plan&lt;/h2&gt;
&lt;p&gt;The  &lt;code&gt;terraform plan&lt;/code&gt; command helps you validate the changes manually. However, there are ways to use it in automation as well.&lt;/p&gt;
&lt;p&gt;By default, Terraform prints the plan output in a human-friendly format but also supports machine-readable JSON. With additional command-line options, you can extend your CI experience.&lt;/p&gt;
&lt;p&gt;For example, you can use your validation conditions to decide whether to apply the changes automatically; or you can parse the plan details and integrate the summary into a Pull Request description. Let‚Äôs review a simple example that illustrates it.&lt;/p&gt;
&lt;p&gt;First, you need to save the plan output to the file:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-shell&#34; data-lang=&#34;shell&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&amp;gt; terraform plan -input&lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;=&lt;/span&gt;false -compact-warnings -out&lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;=&lt;/span&gt;plan.file
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;The main point here is the &lt;code&gt;-out&lt;/code&gt; option ‚Äî it tells Terraform to save its output into a binary plan file, and we will talk about it in the next paragraph.&lt;/p&gt;
&lt;p&gt;The &lt;code&gt;-compact-warnings&lt;/code&gt; option suppresses the warning-level messages produced by Terraform.&lt;/p&gt;
&lt;p&gt;Also, the &lt;code&gt;plan&lt;/code&gt; command has the &lt;code&gt;-detailed-exitcode&lt;/code&gt; option that returns detailed exit codes when the command exits. For example, you can leverage this in a script that wraps Terraform and adds more conditional logic to its execution, because CIs will generally fail the pipeline on a command‚Äôs non-zero exit code. However, that may add complexity to the pipeline logic.&lt;/p&gt;
&lt;p&gt;So if you need to get detailed info about the plan, I suggest parsing the plan output.&lt;/p&gt;
&lt;p&gt;When you have a plan file, you can read it in JSON format and parse it. Here is a code snippet that illustrates that:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-shell&#34; data-lang=&#34;shell&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&amp;gt; terraform show -json plan.file| jq -r &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#39;([.resource_changes[]?.change.actions?]|flatten)|{&amp;#34;create&amp;#34;:(map(select(.==&amp;#34;create&amp;#34;))|length),&amp;#34;update&amp;#34;:(map(select(.==&amp;#34;update&amp;#34;))|length),&amp;#34;delete&amp;#34;:(map(select(.==&amp;#34;delete&amp;#34;))|length)}&amp;#39;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;create&amp;#34;&lt;/span&gt;: 1,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;update&amp;#34;&lt;/span&gt;: 0,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;delete&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#a5d6ff&#34;&gt;0&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Another way to see the information about changes, is to run the &lt;code&gt;plan&lt;/code&gt; command with &lt;code&gt;-json&lt;/code&gt; option and parse its output to stdout (available starting from Terraform 1.0.5):&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-shell&#34; data-lang=&#34;shell&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&amp;gt; terraform plan -json|jq &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#39;select( .type == &amp;#34;change_summary&amp;#34;)|.&amp;#34;@message&amp;#34;&amp;#39;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;Plan: 1 to add, 0 to change, 0 to destroy.&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;div class=&#34;attention&#34;&gt;
    This technique can make your Pull Request messages more informative and improve your collaboration with teammates.
&lt;/div&gt;
You can write a custom script/function that sends a Pull Request comment to VCS using its API. Or you can try the existing features of your VCS: with GitHub Actions, you can use the &lt;a href=&#34;https://github.com/marketplace/actions/terraform-pr-commenter&#34;&gt;Terraform PR Commenter&lt;/a&gt; or similar action to achieve that; for GitLab, there is a built-in functionality that integrates plan results into the Merge Request ‚Äî &lt;a href=&#34;https://docs.gitlab.com/ee/user/infrastructure/iac/mr_integration.html&#34;&gt;Terraform integration in Merge Requests&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;You can find more information about the specification of the JSON output here ‚Äî &lt;a href=&#34;https://www.terraform.io/docs/internals/json-format.html&#34;&gt;Terraform JSON Output Format&lt;/a&gt;.&lt;/p&gt;
&lt;h2 id=&#34;apply&#34;&gt;Apply&lt;/h2&gt;
&lt;p&gt;When the plan file is ready, and the proposed changes are expected and approved, it&amp;rsquo;s time to &lt;code&gt;apply&lt;/code&gt; them.&lt;/p&gt;
&lt;p&gt;Here is how the &lt;code&gt;apply&lt;/code&gt; command may look like in automation:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-shell&#34; data-lang=&#34;shell&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;terraform apply -input&lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;=&lt;/span&gt;false -compact-warnings plan.file
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Here, the &lt;code&gt;plan.file&lt;/code&gt; is the file we got from the previous plan step.&lt;/p&gt;
&lt;p&gt;Alternatively, you might want to omit the planning phase at all. In that case, the following command will apply the configuration immediately, without the need for a plan:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-shell&#34; data-lang=&#34;shell&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;terraform apply -input&lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;=&lt;/span&gt;false -compact-warnings -auto-approve
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Here, the &lt;code&gt;-auto-approve&lt;/code&gt; option tells Terraform to create the plan implicitly and skip the interactive approval of that plan before applying.&lt;/p&gt;
&lt;p&gt;Whichever way you choose, keep in mind the destructive nature of the apply command. Hence, the fully automated apply of configuration generally works well with environments that tolerate unexpected downtimes, such as development or testing. Whereas plan review is recommended for production-grade environments, and in that case, the &lt;code&gt;apply&lt;/code&gt; job is configured for a manual trigger.&lt;/p&gt;
&lt;h1 id=&#34;dealing-with-stateless-environments&#34;&gt;Dealing with stateless environments&lt;/h1&gt;
&lt;p&gt;If you run &lt;code&gt;init&lt;/code&gt;, &lt;code&gt;plan&lt;/code&gt;, and &lt;code&gt;apply&lt;/code&gt; commands in different environments, you need to care for some artifacts produced by Terraform:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;The &lt;code&gt;.terraform&lt;/code&gt; directory with information about modules, providers, and the state file (even in the case of remote state).&lt;/li&gt;
&lt;li&gt;The &lt;code&gt;.terraform.lock.hcl&lt;/code&gt; file ‚Äî the dependency lock file which Terraform uses to check the integrity of provider versions used for the project. If your VCS does not track it, you&amp;rsquo;ll need to pass that file to the &lt;code&gt;plan&lt;/code&gt; and &lt;code&gt;apply&lt;/code&gt; commands to make them work after &lt;code&gt;init&lt;/code&gt;.&lt;/li&gt;
&lt;li&gt;The output file of the &lt;code&gt;plan&lt;/code&gt; command is essential for the &lt;code&gt;apply&lt;/code&gt; command, so treat it as a vital artifact. This file includes a full copy of the project configuration, the state, and variables passed to the &lt;code&gt;plan&lt;/code&gt; command (if any). Therefore, mind the security precautions because sensitive information may be present there.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;There is one shortcut, though. You can execute the &lt;code&gt;init&lt;/code&gt; and &lt;code&gt;plan&lt;/code&gt; commands within the same step/stage and transfer the artifacts only once ‚Äî to the &lt;code&gt;apply&lt;/code&gt; execution.&lt;/p&gt;
&lt;h1 id=&#34;using-the-command-line-and-environments-variables&#34;&gt;Using the command-line and environments variables&lt;/h1&gt;
&lt;p&gt;Last but not least, a few words about ways to maximize the advantage of variables when running Terraform in CI.&lt;/p&gt;
&lt;p&gt;There are two common ways how you can pass values for the variables used in the configuration:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Using a &lt;code&gt;-var-file&lt;/code&gt; option with the variable definitions file ‚Äî a filename ending in &lt;code&gt;.tfvars&lt;/code&gt; or &lt;code&gt;.tfvars.json&lt;/code&gt;. For example:
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-shell&#34; data-lang=&#34;shell&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;terraform apply -var-file&lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;=&lt;/span&gt;development.tfvars -input&lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;=&lt;/span&gt;false -no-color -compact-warnings -auto-approve
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;Also, Terraform can automatically load the variables from files named exactly &lt;code&gt;terraform.tfvars&lt;/code&gt; or &lt;code&gt;terraform.tfvars.json&lt;/code&gt;: with that approach, you don‚Äôt need to specify the tfvar file as a command option explicitly.&lt;/li&gt;
&lt;li&gt;Using environment variables with the prefix &lt;code&gt;TF_VAR_&lt;/code&gt;. Implicitly, Terraform always looks for the environment variables (within its process context) with that prefix, so the same &amp;ldquo;instance_type&amp;rdquo; variables from the example above can be passed as follows:
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-shell&#34; data-lang=&#34;shell&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;export &lt;span style=&#34;color:#79c0ff&#34;&gt;TF_VAR_instance_type&lt;/span&gt;&lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;=&lt;/span&gt;t3.nano
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;terraform -input&lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;=&lt;/span&gt;false -no-color -compact-warnings -auto-approve
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;The latter method is widely used in CI because modern CI/CD tools support the management of the environment variables for automation jobs.&lt;/p&gt;
&lt;p&gt;Please refer to the following official documentation if you want to know more about variables ‚Äî &lt;a href=&#34;https://www.terraform.io/docs/language/values/variables.html&#34;&gt;Terraform Input Variables&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Along with that, Terraform supports several configuration parameters in the form of environment variables. These parameters are optional; however, they can simplify the automation management and streamline its code.&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;TF_INPUT&lt;/code&gt; ‚Äî when set to &amp;ldquo;false&amp;rdquo; or &amp;ldquo;0&amp;rdquo;, this tells Terraform to behave the same way as with the &lt;code&gt;-input=false&lt;/code&gt; flag;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;TF_CLI_ARGS&lt;/code&gt; ‚Äî can contain a set of command-line options that will be passed to one or another Terraform command. Therefore, the following notation can simplify the execution of &lt;code&gt;apply&lt;/code&gt; and &lt;code&gt;plan&lt;/code&gt; commands by unifying their options for CI:
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-shell&#34; data-lang=&#34;shell&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;export &lt;span style=&#34;color:#79c0ff&#34;&gt;TF_CLI_ARGS&lt;/span&gt;&lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;-input=false -no-color -compact-warnings&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;terraform plan ...
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;terraform apply ...
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;You can advantage this even more when using this variable as the environment configuration of stages or jobs in a CI/CD tool.&lt;/li&gt;
&lt;li&gt;&lt;code&gt;TF_IN_AUTOMATION&lt;/code&gt;  ‚Äî when set to any non-empty value (e.g., &amp;ldquo;true&amp;rdquo;), Terraform stops suggesting commands run after the one you execute, hence producing less output.&lt;/li&gt;
&lt;/ul&gt;
&lt;h1 id=&#34;key-takeaways&#34;&gt;Key takeaways&lt;/h1&gt;
&lt;p&gt;There are two primary outcomes from automating Terraform executions: consistent results and integrating with the code or project management solutions. Although the exact implementation of Terraform in CI may vary per project or team, try to aim the following goals when working on it:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Ease of code management&lt;/li&gt;
&lt;li&gt;A secure and controlled execution environment&lt;/li&gt;
&lt;li&gt;Coherent runs of init, plan, apply phases&lt;/li&gt;
&lt;li&gt;Leveraging of built-in Terraform capabilities&lt;/li&gt;
&lt;/ul&gt;
&lt;h5 id=&#34;i-originally-wrote-this-article-for-the-spaceliftio-technical-blog-but-i-decided-to-keep-it-here-as-well-for-the-history-the-canonical-link-to-their-blog-has-been-set-accordingly&#34;&gt;I originally wrote this article for the Spacelift.io technical blog. But I decided to keep it here as well, for the history. The canonical link to their blog has been set accordingly.&lt;/h5&gt;</content>
    </entry>
    <entry>
        <title>Apply Cloudfront Security Headers With Terraform</title>
        <link href="https://devdosvid.blog/2021/11/05/apply-cloudfront-security-headers-with-terraform/" hreflang="en" rel="alternate"/>
        <published>2021-11-05T12:20:58Z</published>
        <updated>2024-03-25T17:29:29Z</updated>
        <id>https://devdosvid.blog/2021/11/05/apply-cloudfront-security-headers-with-terraform/</id>
        <author>
            <name>Serhii Vasylenko</name>
        </author>
        <logo>https://devdosvid.blog/2021/11/05/apply-cloudfront-security-headers-with-terraform/cover-image.png</logo>
        <content type="html">&lt;p&gt;In November 2021, AWS announced Response Headers Policies ‚Äî native support of response headers in CloudFront. You can read the full announcement here: &lt;a href=&#34;https://aws.amazon.com/blogs/networking-and-content-delivery/amazon-cloudfront-introduces-response-headers-policies/&#34;&gt;Amazon CloudFront introduces Response Headers Policies&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;I said &amp;ldquo;native&amp;rdquo; because previously you could set response headers either using &lt;a href=&#34;https://devdosvid.blog/2021/05/21/configure-http-security-headers-with-cloudfront-functions.html&#34;&gt;CloudFront Functions&lt;/a&gt; or &lt;a href=&#34;https://aws.amazon.com/blogs/networking-and-content-delivery/adding-http-security-headers-using-lambdaedge-and-amazon-cloudfront/&#34;&gt;Lambda@Edge&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;And one of the common use cases for that was to set security headers. Now you don&amp;rsquo;t need to add intermediate requests processing to modify the headers: CloudFront does that for you &lt;strong&gt;with no additional fee&lt;/strong&gt;.&lt;/p&gt;
&lt;h2 id=&#34;manage-security-headers-as-code&#34;&gt;Manage Security Headers as Code&lt;/h2&gt;
&lt;p&gt;Starting from the &lt;a href=&#34;https://github.com/hashicorp/terraform-provider-aws/blob/main/CHANGELOG.md#3640-november-04-2021&#34;&gt;3.64.0&lt;/a&gt; version of Terraform AWS provider, you can create the security headers policies and apply them for your distribution.&lt;/p&gt;
&lt;p&gt;Let&amp;rsquo;s see how that looks!&lt;/p&gt;
&lt;p&gt;First, you need to describe the &lt;code&gt;aws_cloudfront_response_headers_policy&lt;/code&gt; resource:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-hcl&#34; data-lang=&#34;hcl&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#ff7b72&#34;&gt;resource&lt;/span&gt; &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;aws_cloudfront_response_headers_policy&amp;#34; &amp;#34;security_headers_policy&amp;#34;&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  name &lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;my-security-headers-policy&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#ff7b72&#34;&gt;security_headers_config&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#ff7b72&#34;&gt;content_type_options&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      override &lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ff7b72&#34;&gt;true&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    }
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#ff7b72&#34;&gt;frame_options&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      frame_option &lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;DENY&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      override     &lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ff7b72&#34;&gt;true&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    }
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#ff7b72&#34;&gt;referrer_policy&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      referrer_policy &lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;same-origin&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      override        &lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ff7b72&#34;&gt;true&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    }
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#ff7b72&#34;&gt;xss_protection&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      mode_block &lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ff7b72&#34;&gt;true&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      protection &lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ff7b72&#34;&gt;true&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      override   &lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ff7b72&#34;&gt;true&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    }
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#ff7b72&#34;&gt;strict_transport_security&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      access_control_max_age_sec &lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;63072000&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      include_subdomains         &lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ff7b72&#34;&gt;true&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      preload                    &lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ff7b72&#34;&gt;true&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      override                   &lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ff7b72&#34;&gt;true&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    }
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#ff7b72&#34;&gt;content_security_policy&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      content_security_policy &lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;frame-ancestors &amp;#39;none&amp;#39;; default-src &amp;#39;none&amp;#39;; img-src &amp;#39;self&amp;#39;; script-src &amp;#39;self&amp;#39;; style-src &amp;#39;self&amp;#39;; object-src &amp;#39;none&amp;#39;&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      override                &lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ff7b72&#34;&gt;true&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    }
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  }
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;List of security headers used:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://infosec.mozilla.org/guidelines/web_security#x-content-type-options&#34;&gt;X-Content-Type-Options&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://infosec.mozilla.org/guidelines/web_security#x-frame-options&#34;&gt;X-Frame-Options&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://infosec.mozilla.org/guidelines/web_security#referrer-policy&#34;&gt;Referrer Policy&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://infosec.mozilla.org/guidelines/web_security#x-xss-protection&#34;&gt;X-XSS-Protection&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://infosec.mozilla.org/guidelines/web_security#http-strict-transport-security&#34;&gt;Strict Transport Security&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://infosec.mozilla.org/guidelines/web_security#content-security-policy&#34;&gt;Content Security Policy&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;The values for the security headers can be different, of course. However, the provided ones cover the majority of cases. And you can always get the up to date info about these headers and possible values here: &lt;a href=&#34;https://infosec.mozilla.org/guidelines/web_security&#34;&gt;Mozilla web Security Guidelines&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;Also, you could notice that provided example uses the &lt;code&gt;override&lt;/code&gt; argument a lot. The &lt;code&gt;override&lt;/code&gt; argument tells CloudFront to set these values for specified headers despite the values received from the origin. This way, you can enforce your security headers configuration.&lt;/p&gt;
&lt;p&gt;Once you have the &lt;code&gt;aws_cloudfront_response_headers_policy&lt;/code&gt; resource, you can refer to it in the code of &lt;code&gt;aws_cloudfront_distribution&lt;/code&gt; resource inside cache behavior block (default or ordered). For example, in your &lt;code&gt;default_cache_behavior&lt;/code&gt;:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-hcl&#34; data-lang=&#34;hcl&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#ff7b72&#34;&gt;resource&lt;/span&gt; &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;aws_cloudfront_distribution&amp;#34; &amp;#34;test&amp;#34;&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#ff7b72&#34;&gt;default_cache_behavior&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    target_origin_id           &lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ff7b72&#34;&gt;aws_s3_bucket&lt;/span&gt;.&lt;span style=&#34;color:#ff7b72&#34;&gt;my_origin&lt;/span&gt;.&lt;span style=&#34;color:#ff7b72&#34;&gt;id&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    allowed_methods            &lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;=&lt;/span&gt; [&lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;GET&amp;#34;, &amp;#34;HEAD&amp;#34;, &amp;#34;OPTIONS&amp;#34;&lt;/span&gt;]
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    cached_methods             &lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;=&lt;/span&gt; [&lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;GET&amp;#34;, &amp;#34;HEAD&amp;#34;&lt;/span&gt;]
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    viewer_protocol_policy     &lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;redirect-to-https&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#8b949e;font-style:italic&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#8b949e;font-style:italic&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#8b949e;font-style:italic&#34;&gt;    # some arguments skipped from listing for the sake of simplicity
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#8b949e;font-style:italic&#34;&gt;&lt;/span&gt;    
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    response_headers_policy_id &lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ff7b72&#34;&gt;aws_cloudfront_response_headers_policy&lt;/span&gt;.&lt;span style=&#34;color:#ff7b72&#34;&gt;security_headers_policy&lt;/span&gt;.&lt;span style=&#34;color:#ff7b72&#34;&gt;id&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  }&lt;span style=&#34;color:#8b949e;font-style:italic&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#8b949e;font-style:italic&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#8b949e;font-style:italic&#34;&gt;  # some arguments skipped from listing for the sake of simplicity
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#8b949e;font-style:italic&#34;&gt;&lt;/span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id=&#34;security-scan-results&#34;&gt;Security Scan Results&lt;/h3&gt;
&lt;p&gt;Here is what Mozilla Observatory reports about my test CF distribution where I enabled the policy described above:&lt;/p&gt;
&lt;figure&gt;




&lt;img loading=&#34;lazy&#34;
     src=&#34;observatory-results.png&#34;
    alt=&#34;Scan summary for CloudFront distribution with security headers policy&#34;width=&#34;800&#34;
height=&#34;903.43&#34;
/&gt; &lt;figcaption&gt;
    &lt;p&gt;Scan summary for CloudFront distribution with security headers policy&lt;/p&gt;
&lt;/figcaption&gt;
&lt;/figure&gt;

&lt;p&gt;So with just minimum effort, you can greatly boost your web application security posture.&lt;/p&gt;
&lt;h3 id=&#34;more-to-read&#34;&gt;More to read:&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/cloudfront_response_headers_policy&#34;&gt;Terraform Resource: aws_cloudfront_response_headers_policy&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/creating-response-headers-policies.html&#34;&gt;Creating response headers policies - Amazon CloudFront&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/using-managed-response-headers-policies.html&#34;&gt;Using the managed response headers policies - Amazon CloudFront&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/understanding-response-headers-policies.html&#34;&gt;Understanding response headers policies - Amazon CloudFront&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</content>
    </entry>
    <entry>
        <title>Auto Scaling Group for your macOS EC2 Instances fleet</title>
        <link href="https://devdosvid.blog/2021/10/24/auto-scaling-group-for-your-macos-ec2-instances-fleet/" hreflang="en" rel="alternate"/>
        <published>2021-10-23T23:00:31Z</published>
        <updated>2024-03-25T17:29:29Z</updated>
        <id>https://devdosvid.blog/2021/10/24/auto-scaling-group-for-your-macos-ec2-instances-fleet/</id>
        <author>
            <name>Serhii Vasylenko</name>
        </author>
        <logo>https://devdosvid.blog/2021/10/24/auto-scaling-group-for-your-macos-ec2-instances-fleet/cover-image.png</logo>
        <content type="html">&lt;p&gt;It‚Äôs been almost a year since I started using macOS EC2 instances on AWS: there were &lt;a href=&#34;https://devdosvid.blog/2021/01/19/mac1-metal-EC2-Instance-user-experience.html&#34;&gt;ups and downs in service offerings&lt;/a&gt; and a lot of discoveries with &lt;a href=&#34;https://devdosvid.blog/2021/02/01/customizing-mac1-metal-ec2-ami.html&#34;&gt;macOS AMI build&lt;/a&gt; automation.&lt;/p&gt;
&lt;p&gt;And I like this small but so helpful update to the offerings list of the EC2 service: with mac1.metal instances, seamless integration of Apple-oriented CI/CD with other AWS infrastructure could finally happen.&lt;/p&gt;
&lt;p&gt;But while management of a single mac1.metal node (or a tiny number of ones) is not a big deal (especially when &lt;a href=&#34;https://devdosvid.blog/2021/01/20/terraforming-mac1-metal-at-AWS.html&#34;&gt;Dedicated Host support&lt;/a&gt; was added to Terraform provider), governing the fleet of instances is still complicated.&lt;/p&gt;
&lt;p&gt;Or it has been complicated until recent days.&lt;/p&gt;
&lt;p&gt;With a growing number of instances, the following challenges arise:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Scale mac1.metal instances horizontally&lt;/li&gt;
&lt;li&gt;Automatically allocate and release Dedicated Hosts needed for instances&lt;/li&gt;
&lt;li&gt;Automatically replace unhealthy instances&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;If you have worked with AWS before, you know that Auto Scaling Group service can solve such things.&lt;/p&gt;
&lt;h2 id=&#34;auto-scaling-for-macos-ec2-instances&#34;&gt;Auto Scaling for macOS EC2 Instances&lt;/h2&gt;
&lt;p&gt;So how does all that work?&lt;/p&gt;
&lt;p&gt;Let‚Äôs review the diagram that illustrates the interconnection between involved services:&lt;/p&gt;
&lt;figure&gt;




&lt;img loading=&#34;lazy&#34;
     src=&#34;general-scheme_compressed.png&#34;
    alt=&#34;Services logical interconnection&#34;width=&#34;800&#34;
height=&#34;639&#34;
/&gt; &lt;figcaption&gt;
    &lt;p&gt;Services logical interconnection&lt;/p&gt;
&lt;/figcaption&gt;
&lt;/figure&gt;

&lt;p&gt;With the help of Licence Manager service and Launch Templates, you can set up EC2 Auto Scaling Group for mac1.metal and leave the automated instance provisioning to the service.&lt;/p&gt;
&lt;h3 id=&#34;license-configuration&#34;&gt;License Configuration&lt;/h3&gt;
&lt;p&gt;First, you need to create a License Configuration so that the Host resource group can allocate the hots.&lt;/p&gt;
&lt;p&gt;Go to AWS License Manager -&amp;gt; Customer managed licenses -&amp;gt; Create customer-managed license.&lt;/p&gt;
&lt;p&gt;Specify &lt;strong&gt;Sockets&lt;/strong&gt; as the Licence type. You may skip setting the Number of Sockets. However, the actual limit of mac1.metal instances per account is regulated by Service Quota. The default number of mac instances allowed per account is 3. Therefore, consider &lt;a href=&#34;https://docs.aws.amazon.com/servicequotas/latest/userguide/request-quota-increase.html&#34;&gt;increasing&lt;/a&gt; this to a more significant number.&lt;/p&gt;
&lt;figure&gt;




&lt;img loading=&#34;lazy&#34;
     src=&#34;license-configuration_compressed.png&#34;
    alt=&#34;Licence configuration values&#34;width=&#34;800&#34;
height=&#34;807&#34;
/&gt; &lt;figcaption&gt;
    &lt;p&gt;Licence configuration values&lt;/p&gt;
&lt;/figcaption&gt;
&lt;/figure&gt;

&lt;h3 id=&#34;host-resource-group&#34;&gt;Host resource group&lt;/h3&gt;
&lt;p&gt;Second, create the Host resource group: AWS License Manager -&amp;gt; Host resource groups -&amp;gt; Create host resource group.&lt;/p&gt;
&lt;p&gt;When creating the Host resource group, check ‚Äú&lt;strong&gt;Allocate hosts automatically&lt;/strong&gt;‚Äù and ‚Äú&lt;strong&gt;Release hosts automatically&lt;/strong&gt;‚Äù but leave ‚ÄúRecover hosts automatically‚Äù unchecked. Dedicated Host does &lt;a href=&#34;https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/dedicated-hosts-recovery.html#dedicated-hosts-recovery-instances&#34;&gt;not support host recovery&lt;/a&gt; for mac1.metal.
However, Auto Scaling Group will maintain the desired number of instances if one fails the health check (which assumes the case of host failure as well).&lt;/p&gt;
&lt;p&gt;Also, I recommend specifying ‚Äúmac1‚Äù as an allowed Instance family for the sake of transparent resource management: only this instance type is permitted to allocate hosts in the group.&lt;/p&gt;
&lt;figure&gt;




&lt;img loading=&#34;lazy&#34;
     src=&#34;host-resource-group_compressed.png&#34;
    alt=&#34;Host resource group configuration values&#34;width=&#34;800&#34;
height=&#34;902&#34;
/&gt; &lt;figcaption&gt;
    &lt;p&gt;Host resource group configuration values&lt;/p&gt;
&lt;/figcaption&gt;
&lt;/figure&gt;

&lt;p&gt;Optionally, you may specify the license association here (the Host group will pick any compatible license) or select the license you created on step one.&lt;/p&gt;
&lt;h3 id=&#34;launch-template&#34;&gt;Launch Template&lt;/h3&gt;
&lt;p&gt;Create Launch Template: EC2 -&amp;gt; Launch templates -&amp;gt; Create launch template.&lt;/p&gt;
&lt;p&gt;I will skip the description of all Launch Template parameters (but here is a nice &lt;a href=&#34;https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-launch-templates.html&#34;&gt;tutorial&lt;/a&gt;), if you don‚Äôt mind, and keep focus only on the items relevant to the current case.&lt;/p&gt;
&lt;p&gt;Specify mac1.metal as the Instance type. Later, in Advanced details: find the &lt;strong&gt;Tenancy&lt;/strong&gt; parameter and set it to ‚ÄúDedicated host‚Äù; for &lt;strong&gt;Target host by&lt;/strong&gt; select ‚ÄúHost resource group‚Äù, and once selected the new parameter &lt;strong&gt;Tenancy host resource group&lt;/strong&gt; will appear where you should choose your host group; select your license in &lt;strong&gt;License configurations&lt;/strong&gt; parameter.&lt;/p&gt;
&lt;figure&gt;




&lt;img loading=&#34;lazy&#34;
     src=&#34;launch-template_compressed.png&#34;
    alt=&#34;Launch Template configuration values&#34;width=&#34;800&#34;
height=&#34;741&#34;
/&gt; &lt;figcaption&gt;
    &lt;p&gt;Launch Template configuration values&lt;/p&gt;
&lt;/figcaption&gt;
&lt;/figure&gt;

&lt;h3 id=&#34;auto-scaling-group&#34;&gt;Auto Scaling Group&lt;/h3&gt;
&lt;p&gt;Finally, create the Auto Scaling Group: EC2 -&amp;gt; Auto Scaling groups -&amp;gt; Create Auto Scaling group.&lt;/p&gt;
&lt;p&gt;The vital thing to note here ‚Äî is the availability of the mac1.metal instance in particular AZ.&lt;/p&gt;
&lt;p&gt;Mac instances are available in us-east-1 and &lt;a href=&#34;https://aws.amazon.com/about-aws/whats-new/2021/10/amazon-ec2-mac-instances-additional-regions/&#34;&gt;7 more regions&lt;/a&gt;, but not every Availability Zone in the region supports it. So you must figure out which AZ supports the needed instance type.&lt;/p&gt;
&lt;p&gt;There is no documentation for that, but there is an AWS CLI command that can answer this question: &lt;a href=&#34;https://awscli.amazonaws.com/v2/documentation/api/latest/reference/ec2/describe-instance-type-offerings.html&#34;&gt;describe-instance-type-offerings ‚Äî AWS CLI 2.3.0 Command Reference&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;Here is an example for the us-east-1 region:
&lt;div class=&#34;code-snippet&#34;&gt;
&lt;details&gt;
&lt;summary markdown=&#34;span&#34;&gt;Click here to see the code snippet&lt;/summary&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-shell&#34; data-lang=&#34;shell&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&amp;gt; aws ec2 describe-instance-type-offerings --location-type availability-zone-id --filters &lt;span style=&#34;color:#79c0ff&#34;&gt;Name&lt;/span&gt;&lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;=&lt;/span&gt;instance-type,Values&lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;=&lt;/span&gt;mac1.metal --region us-east-1 --output text
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;INSTANCETYPEOFFERINGS	mac1.metal	use1-az6	availability-zone-id
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;INSTANCETYPEOFFERINGS	mac1.metal	use1-az4	availability-zone-id
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;/details&gt;
&lt;/div&gt;&lt;/p&gt;
&lt;p&gt;Keep that nuance in mind when selecting a subnet for the mac1.metal instances.&lt;/p&gt;
&lt;p&gt;When you know the AZ, specify the respective Subnet in the Auto Scaling Group settings, and you&amp;rsquo;re ready to go!&lt;/p&gt;
&lt;h2 id=&#34;bring-infrastructure-as-code-here&#34;&gt;Bring Infrastructure as Code here&lt;/h2&gt;
&lt;p&gt;I suggest describing all that as a code. I prefer Terraform, and its AWS provider supports the needed resources. Except one.&lt;/p&gt;
&lt;p&gt;As of October 2021, resources supported :&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/servicequotas_service_quota&#34;&gt;aws_servicequotas_service_quota&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/licensemanager_license_configuration&#34;&gt;aws_licensemanager_license_configuration&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/launch_template&#34;&gt;aws_launch_template&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/autoscaling_group&#34;&gt;aws_autoscaling_group&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;The Host resource group is not yet supported by the provider, unfortunately. However, we can use CloudFormation in Terraform to overcome that: describe the Host resource group as &lt;a href=&#34;https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/cloudformation_stack&#34;&gt;aws_cloudformation_stack&lt;/a&gt; Terraform resource using CloudFormation template from a file.&lt;/p&gt;
&lt;p&gt;Here is how it looks like:
&lt;div class=&#34;code-snippet&#34;&gt;
&lt;details&gt;
&lt;summary markdown=&#34;span&#34;&gt;Click here to see the code snippet&lt;/summary&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-hcl&#34; data-lang=&#34;hcl&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#ff7b72&#34;&gt;resource&lt;/span&gt; &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;aws_licensemanager_license_configuration&amp;#34; &amp;#34;this&amp;#34;&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  name                     &lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ff7b72&#34;&gt;local&lt;/span&gt;.&lt;span style=&#34;color:#ff7b72&#34;&gt;full_name&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  license_counting_type    &lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;Socket&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#ff7b72&#34;&gt;resource&lt;/span&gt; &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;aws_cloudformation_stack&amp;#34; &amp;#34;this&amp;#34;&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  name          &lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ff7b72&#34;&gt;local&lt;/span&gt;.&lt;span style=&#34;color:#ff7b72&#34;&gt;full_name&lt;/span&gt;&lt;span style=&#34;color:#8b949e;font-style:italic&#34;&gt; # the name of CloudFormation stack
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#8b949e;font-style:italic&#34;&gt;&lt;/span&gt;  template_body &lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ff7b72&#34;&gt;file&lt;/span&gt;(&lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;${path.module}/resource-group-cf-stack-template.json&amp;#34;&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  parameters &lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;=&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    GroupName &lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ff7b72&#34;&gt;local&lt;/span&gt;.&lt;span style=&#34;color:#ff7b72&#34;&gt;full_name&lt;/span&gt;&lt;span style=&#34;color:#8b949e;font-style:italic&#34;&gt; # the name for the Host group, passed to CloudFormation template
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#8b949e;font-style:italic&#34;&gt;&lt;/span&gt;  }
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  on_failure &lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;DELETE&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;/details&gt;
&lt;/div&gt;&lt;/p&gt;
&lt;p&gt;And the next code snippet explains the CloudFromation template (which is the &lt;code&gt;resource-group-cf-stack-template.json&lt;/code&gt; file in the code snippet above)
&lt;div class=&#34;code-snippet&#34;&gt;
&lt;details&gt;
&lt;summary markdown=&#34;span&#34;&gt;Click here to see the code snippet&lt;/summary&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-json&#34; data-lang=&#34;json&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;{
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#7ee787&#34;&gt;&amp;#34;Parameters&amp;#34;&lt;/span&gt; : {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#7ee787&#34;&gt;&amp;#34;GroupName&amp;#34;&lt;/span&gt; : {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      &lt;span style=&#34;color:#7ee787&#34;&gt;&amp;#34;Type&amp;#34;&lt;/span&gt; : &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;String&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      &lt;span style=&#34;color:#7ee787&#34;&gt;&amp;#34;Description&amp;#34;&lt;/span&gt; : &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;The name of Host Group&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    }
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  },
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#7ee787&#34;&gt;&amp;#34;Resources&amp;#34;&lt;/span&gt; : {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#7ee787&#34;&gt;&amp;#34;DedicatedHostGroup&amp;#34;&lt;/span&gt;: {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      &lt;span style=&#34;color:#7ee787&#34;&gt;&amp;#34;Type&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;AWS::ResourceGroups::Group&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      &lt;span style=&#34;color:#7ee787&#34;&gt;&amp;#34;Properties&amp;#34;&lt;/span&gt;: {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#7ee787&#34;&gt;&amp;#34;Name&amp;#34;&lt;/span&gt;: { &lt;span style=&#34;color:#7ee787&#34;&gt;&amp;#34;Ref&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;GroupName&amp;#34;&lt;/span&gt; },
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#7ee787&#34;&gt;&amp;#34;Configuration&amp;#34;&lt;/span&gt;: [
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;          {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            &lt;span style=&#34;color:#7ee787&#34;&gt;&amp;#34;Type&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;AWS::ResourceGroups::Generic&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            &lt;span style=&#34;color:#7ee787&#34;&gt;&amp;#34;Parameters&amp;#34;&lt;/span&gt;: [
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;              {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                &lt;span style=&#34;color:#7ee787&#34;&gt;&amp;#34;Name&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;allowed-resource-types&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                &lt;span style=&#34;color:#7ee787&#34;&gt;&amp;#34;Values&amp;#34;&lt;/span&gt;: [&lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;AWS::EC2::Host&amp;#34;&lt;/span&gt;]
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;              },
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;              {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                &lt;span style=&#34;color:#7ee787&#34;&gt;&amp;#34;Name&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;deletion-protection&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                &lt;span style=&#34;color:#7ee787&#34;&gt;&amp;#34;Values&amp;#34;&lt;/span&gt;: [&lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;UNLESS_EMPTY&amp;#34;&lt;/span&gt;]
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;              }
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            ]
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;          },
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;          {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            &lt;span style=&#34;color:#7ee787&#34;&gt;&amp;#34;Type&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;AWS::EC2::HostManagement&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            &lt;span style=&#34;color:#7ee787&#34;&gt;&amp;#34;Parameters&amp;#34;&lt;/span&gt;: [
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;              {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                &lt;span style=&#34;color:#7ee787&#34;&gt;&amp;#34;Name&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;allowed-host-families&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                &lt;span style=&#34;color:#7ee787&#34;&gt;&amp;#34;Values&amp;#34;&lt;/span&gt;: [&lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;mac1&amp;#34;&lt;/span&gt;]
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;              },
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;              {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                &lt;span style=&#34;color:#7ee787&#34;&gt;&amp;#34;Name&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;auto-allocate-host&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                &lt;span style=&#34;color:#7ee787&#34;&gt;&amp;#34;Values&amp;#34;&lt;/span&gt;: [&lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;true&amp;#34;&lt;/span&gt;]
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;              },
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;              {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                &lt;span style=&#34;color:#7ee787&#34;&gt;&amp;#34;Name&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;auto-release-host&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                &lt;span style=&#34;color:#7ee787&#34;&gt;&amp;#34;Values&amp;#34;&lt;/span&gt;: [&lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;true&amp;#34;&lt;/span&gt;]
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;              },
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;              {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                &lt;span style=&#34;color:#7ee787&#34;&gt;&amp;#34;Name&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;any-host-based-license-configuration&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                &lt;span style=&#34;color:#7ee787&#34;&gt;&amp;#34;Values&amp;#34;&lt;/span&gt;: [&lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;true&amp;#34;&lt;/span&gt;]
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;              }
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            ]
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;          }
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        ]
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      }
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    }
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  },
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#7ee787&#34;&gt;&amp;#34;Outputs&amp;#34;&lt;/span&gt; : {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#7ee787&#34;&gt;&amp;#34;ResourceGroupARN&amp;#34;&lt;/span&gt; : {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      &lt;span style=&#34;color:#7ee787&#34;&gt;&amp;#34;Description&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;ResourceGroupARN&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      &lt;span style=&#34;color:#7ee787&#34;&gt;&amp;#34;Value&amp;#34;&lt;/span&gt; : { &lt;span style=&#34;color:#7ee787&#34;&gt;&amp;#34;Fn::GetAtt&amp;#34;&lt;/span&gt; : [&lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;DedicatedHostGroup&amp;#34;&lt;/span&gt;, &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;Arn&amp;#34;&lt;/span&gt;] }
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    }
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  }
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;/details&gt;
&lt;/div&gt;&lt;/p&gt;
&lt;p&gt;The &lt;code&gt;aws_cloudformation_stack&lt;/code&gt; resource will export the &lt;code&gt;DedicatedHostGroup&lt;/code&gt; attribute (see the code of CloudFromation template), which you will use later in the Launch Template resource.&lt;/p&gt;
&lt;div class=&#34;attention&#34;&gt;
    &lt;p&gt;If you manage an AWS Organization, I have good news: Host groups and Licenses are supported by &lt;a href=&#34;https://docs.aws.amazon.com/ram/latest/userguide/shareable.html&#34;&gt;Resource Access Manager&lt;/a&gt; service.&lt;/p&gt;
&lt;p&gt;Hence, you can host all mac instances in one account and share them with other accounts ‚Äî it might be helpful for costs allocation, for example. Also, check out &lt;a href=&#34;https://devdosvid.blog/2021/09/25/aws-resource-access-manager-multi-account-resource-governance/&#34;&gt;my blog about AWS RAM&lt;/a&gt; if you are very new to this service.&lt;/p&gt;
&lt;p&gt;&lt;br&gt;
And you can leverage the &lt;a href=&#34;https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/ec2_instance_type_offerings&#34;&gt;aws_ec2_instance_type_offerings&lt;/a&gt; and &lt;a href=&#34;https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/subnet_ids&#34;&gt;aws_subnet_ids&lt;/a&gt; data sources to solve the ‚Äúwhich AZ supports mac metal‚Äù puzzle.&lt;/p&gt;

&lt;/div&gt;
&lt;h2 id=&#34;costs-considerations&#34;&gt;Costs considerations&lt;/h2&gt;
&lt;p&gt;License Manager is a &lt;a href=&#34;https://aws.amazon.com/license-manager/pricing/&#34;&gt;free of charge service&lt;/a&gt;, as well as &lt;a href=&#34;https://aws.amazon.com/autoscaling/pricing/&#34;&gt;Auto Scaling&lt;/a&gt;, and &lt;a href=&#34;https://aws.amazon.com/about-aws/whats-new/2017/11/introducing-launch-templates-for-amazon-ec2-instances/&#34;&gt;Launch Template&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;So it‚Äôs all about the price for mac1.metal Dedicated Host which is &lt;a href=&#34;https://aws.amazon.com/ec2/dedicated-hosts/pricing/&#34;&gt;$1.083 per hour&lt;/a&gt; as of October 2021. However, &lt;a href=&#34;https://docs.aws.amazon.com/savingsplans/latest/userguide/what-is-savings-plans.html&#34;&gt;Saving Plans&lt;/a&gt; can be applied.&lt;/p&gt;
&lt;p&gt;Please note that the minimum allocation time for that type of host is 24 hours. Maybe someday AWS will change that to 1-hour minimum someday (fingers crossed).&lt;/p&gt;
&lt;h2 id=&#34;oh-so-asg&#34;&gt;Oh. So. ASG.&lt;/h2&gt;
&lt;p&gt;The Auto Scaling for mac1.metal opens new possibilities for CI/CD: you can integrate that to your favorite tool (GitLab, Jenkins, whatsoever) using AWS Lambda and provision new instances when your development/testing environments need that.&lt;/p&gt;
&lt;p&gt;Or you can use other cool ASG stuff, such as Lifecycle hooks, to create even more custom scenarios.&lt;/p&gt;
&lt;p&gt;Also, I want to say thanks (thanks, pal!) to &lt;a href=&#34;https://github.com/hashicorp/terraform/issues/28531&#34;&gt;OliverKoo&lt;/a&gt;, who started digging into that back in April&#39;21.&lt;/p&gt;</content>
    </entry>
    <entry>
        <title>AWS Resource Access Manager ‚Äî Multi Account Resource Governance</title>
        <link href="https://devdosvid.blog/2021/09/25/aws-resource-access-manager-multi-account-resource-governance/" hreflang="en" rel="alternate"/>
        <published>2021-09-24T21:54:23Z</published>
        <updated>2024-03-25T17:29:29Z</updated>
        <id>https://devdosvid.blog/2021/09/25/aws-resource-access-manager-multi-account-resource-governance/</id>
        <author>
            <name>Serhii Vasylenko</name>
        </author>
        <logo>https://devdosvid.blog/2021/09/25/aws-resource-access-manager-multi-account-resource-governance/cover-image.png</logo>
        <content type="html">&lt;p&gt;With a multi-account approach of building the infrastructure, there is always a challenge of provision and governance of the resources to subordinate accounts within the Organization. Provision resources, keep them up to date, and decommission them properly ‚Äî that&amp;rsquo;s only a part of them.&lt;/p&gt;
&lt;p&gt;AWS has numerous solutions that help make this process reliable and secure, and the Resource Access Manager (RAM) is one of them.
In a nutshell, the RAM service allows you to share the AWS resources you create in one AWS account with other AWS accounts. They can be your organizations&amp;rsquo; accounts, organizational units (OU), or even third-party accounts.&lt;/p&gt;
&lt;p&gt;So let&amp;rsquo;s see what the RAM is and review some of its usage examples.&lt;/p&gt;
&lt;h2 id=&#34;why-using-ram&#34;&gt;Why using RAM&lt;/h2&gt;
&lt;p&gt;There are several benefits of using the RAM service:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;Reduced operational overhead&lt;/strong&gt;: eliminate the need of provisioning the same kind of resource multiple times ‚Äî RAM does that for you&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;Simplified security management&lt;/strong&gt;: AWS RAM-managed permissions (at least one per resource type) define the actions that principals with access to the resources (i.e., resource users) can perform on those resources.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;Consistent experience&lt;/strong&gt;: you share the resource in its state and with its security configuration with an arbitrary number of accounts.&lt;/p&gt;
&lt;p&gt;That plays incredibly well in the case of organization-wide sharing: new accounts get the resources automatically. And the shared resource itself looks like a native resource in the account that accepts your sharing.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;Audit and visibility&lt;/strong&gt;: RAM integrates with the CloudWatch and CloudTrail.&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id=&#34;how-to-share-a-resource&#34;&gt;How to share a resource&lt;/h2&gt;
&lt;p&gt;When you share a resource, the AWS account that owns that resource retains full ownership of the resource.&lt;/p&gt;
&lt;p&gt;Sharing of the resource doesn&amp;rsquo;t change any permissions or quotas that apply to that resource. Also, you can share the resource only if you own it.&lt;/p&gt;
&lt;p&gt;Availability of the shared resources scopes to the Region: the users of your shared resources can access these resources only in the same Region where resources belong.&lt;/p&gt;
&lt;p&gt;Creation of resource share consists of three steps:
&lt;figure&gt;




&lt;img loading=&#34;lazy&#34;
     src=&#34;ram-diagram-800.png&#34;width=&#34;800&#34;
height=&#34;533&#34;
/&gt; 
&lt;/figure&gt;
&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;Specify the share name and the resource(s) you want to share. It can be either one resource type or several. You can also skip the resources selection and do that later.&lt;/p&gt;
&lt;p&gt;It&amp;rsquo;s possible to modify the resource share later (e.g., you want to add some resources to the share).&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Associate permissions with resource types you share. Some resources can have only one managed permission (will be attached automatically), and some can have multiple.&lt;/p&gt;
&lt;p&gt;You can check the Permissions Library in the AWS RAM Console to see what managed permissions are available.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Select who can use the resources you share: either external or Organization account or IAM role/user. If you share the resource with third parties, they will have to accept the sharing explicitly.&lt;/p&gt;
&lt;p&gt;Organization-wide resource share is accepted implicitly if resource sharing is enabled for the Organization.&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;Finally, review the summary page of the resource share and create it.&lt;/p&gt;
&lt;p&gt;Only specific actions are available to the users of shared resources. These actions mostly have the &amp;ldquo;read-only&amp;rdquo; nature and &lt;a href=&#34;https://docs.aws.amazon.com/ram/latest/userguide/shareable.html&#34;&gt;vary by resource type&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Also, the RAM service is &lt;a href=&#34;https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/ram_resource_share&#34;&gt;supported by Terraform&lt;/a&gt;, so the resource sharing configuration may look like that, for example:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-hcl&#34; data-lang=&#34;hcl&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#ff7b72&#34;&gt;resource&lt;/span&gt; &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;aws_ram_resource_share&amp;#34; &amp;#34;example&amp;#34;&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  name                      &lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;example&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  allow_external_principals &lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ff7b72&#34;&gt;false&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  tags &lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;=&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    Environment &lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;Production&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  }
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#ff7b72&#34;&gt;resource&lt;/span&gt; &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;aws_ram_resource_association&amp;#34; &amp;#34;example&amp;#34;&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  resource_arn       &lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ff7b72&#34;&gt;aws_subnet&lt;/span&gt;.&lt;span style=&#34;color:#ff7b72&#34;&gt;example&lt;/span&gt;.&lt;span style=&#34;color:#ff7b72&#34;&gt;arn&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  resource_share_arn &lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ff7b72&#34;&gt;aws_ram_resource_share&lt;/span&gt;.&lt;span style=&#34;color:#ff7b72&#34;&gt;example&lt;/span&gt;.&lt;span style=&#34;color:#ff7b72&#34;&gt;arn&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id=&#34;example-use-cases&#34;&gt;Example use cases&lt;/h2&gt;
&lt;p&gt;One of the trivial but valuable examples of RAM service usage is sharing a Manged Prefix List.
Suppose you have some service user across your Organization, a self-hosted VPN server, for example. And you have a static set of IPs for that VPN: you trust these IPs and would like them to be allow-listed in your other services.
How to report these IPs to all organization accounts/users? And if the IP set changes, how to announce that change, and what should be done to reflect that change in services that depend on it, for example, Security Groups?&lt;/p&gt;
&lt;p&gt;The answer is a shared &lt;a href=&#34;https://docs.aws.amazon.com/vpc/latest/userguide/managed-prefix-lists.html#managed-prefix-lists-concepts&#34;&gt;Managed Prefix List&lt;/a&gt;. You create the list once in the account and share it across your Organization. Other accounts automatically get access to that list and can reference the list in their Security Groups. And when the list entry is changed, they do not need to perform any actions: their Security Groups will get the updated IPs implicitly.&lt;/p&gt;
&lt;p&gt;Another everyday use case of RAM is the VPC sharing that can form the foundation of the &lt;a href=&#34;https://aws.amazon.com/blogs/networking-and-content-delivery/vpc-sharing-a-new-approach-to-multiple-accounts-and-vpc-management/&#34;&gt;multi-account AWS architectures&lt;/a&gt;.&lt;/p&gt;
&lt;hr&gt;
&lt;p&gt;Of course, the RAM service is not the only way to organize and centralize resource management in AWS. There are Service Catalog, Control Tower, Systems Manager, Config, and others. However, the RAM is relatively simple to adopt but is capable of providing worthy outcomes.&lt;/p&gt;</content>
    </entry>
    <entry>
        <title>Run Ansible playbook on Mac EC2 Instances fleet with AWS Systems Manager</title>
        <link href="https://devdosvid.blog/2021/05/27/run-ansible-playbook-on-mac-ec2-instances-fleet-with-aws-systems-manager/" hreflang="en" rel="alternate"/>
        <published>2021-05-27T00:00:00Z</published>
        <updated>2024-03-25T17:29:29Z</updated>
        <id>https://devdosvid.blog/2021/05/27/run-ansible-playbook-on-mac-ec2-instances-fleet-with-aws-systems-manager/</id>
        <author>
            <name>Serhii Vasylenko</name>
        </author>
        <logo>https://devdosvid.blog/2021/05/27/run-ansible-playbook-on-mac-ec2-instances-fleet-with-aws-systems-manager/cover-image.png</logo>
        <content type="html">&lt;p&gt;In days of containers and serverless applications, Ansible looks not such a trendy thing.&lt;/p&gt;
&lt;p&gt;But still, there are cases when it helps, and there are cases when it combines very well with brand new product offerings, such as EC2 Mac instances.&lt;/p&gt;
&lt;p&gt;The &lt;a href=&#34;https://devdosvid.blog/2021/02/01/customizing-mac1-metal-ec2-ami.html&#34;&gt;more I use mac1.metal&lt;/a&gt; in AWS, the more I see that Ansible becomes a bedrock of software customization in my case.&lt;/p&gt;
&lt;p&gt;And when you have a large instances fleet, the AWS Systems Manager becomes your best friend (the sooner you get along together, the better).&lt;/p&gt;
&lt;p&gt;So is it possible to use Ansible playbooks for mac1.metal on a big scale, with the help of AWS Systems Manager?&lt;/p&gt;
&lt;h2 id=&#34;not-available-out-of-the-box&#34;&gt;(Not) Available out of the box&lt;/h2&gt;
&lt;p&gt;AWS Systems Manager (SSM hereafter) has a pre-defined, shared Document that allows running Ansible playbooks.&lt;/p&gt;
&lt;p&gt;It‚Äôs called ‚ÄúAWS-RunAnsiblePlaybook,‚Äù and you can find it in AWS SSM ‚Üí Documents ‚Üí Owned by Amazon.&lt;/p&gt;
&lt;p&gt;However, this Document is not quite ‚Äúfriendly‚Äù to macOS. When the SSM agent calls Ansible on the Mac EC2 instance, it does not recognize the Ansible installed with Homebrew (de-facto most used macOS package manager).&lt;/p&gt;
&lt;p&gt;So if you try to run a command on the mac1.metal instance using this Document, you will get the following error:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-shell&#34; data-lang=&#34;shell&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;Ansible is not installed. Please install Ansible and rerun the command.
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;The root cause is trivial: the path to Ansible binary is not present on the list of paths available to the SSM agent by default.&lt;/p&gt;
&lt;p&gt;There are several ways to solve that, but I believe that the most convenient one would be to create your custom Document ‚Äî a slightly adjusted version of the default one provided by AWS.&lt;/p&gt;
&lt;h2 id=&#34;creating-own-ssm-document-for-ansible-installed-with-homebrew&#34;&gt;Creating own SSM Document for Ansible installed with Homebrew&lt;/h2&gt;
&lt;p&gt;All you need to do is clone the Document provided by AWS and change its code a little ‚Äî replace the callouts of &lt;code&gt;ansible&lt;/code&gt; with the full path to the binary.&lt;/p&gt;
&lt;p&gt;Navigate to AWS SSM ‚Üí Documents ‚Üí Owned by Amazon and type &lt;code&gt;AWS-RunAnsiblePlaybook&lt;/code&gt; in the search field.&lt;/p&gt;
&lt;p&gt;Select the Document by pressing the circle on its top-right corner and then click Actions ‚Üí Clone document.&lt;/p&gt;
&lt;figure&gt;




&lt;img loading=&#34;lazy&#34;
     src=&#34;aws_ssm_document_clone.png&#34;width=&#34;800&#34;
height=&#34;476.68&#34;
/&gt; 
&lt;/figure&gt;

&lt;p&gt;Give the new SSM Document a name, e.g., &lt;code&gt;macos-arbitrary-ansible-playbook&lt;/code&gt;, and change the &lt;code&gt;ansible&lt;/code&gt; callouts (at the end of the code) with the full path to the ansible symlink made by Homebrew which is &lt;code&gt;/usr/local/bin/ansible&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;Here is the complete source code of the Document with adjusted Ansible path:&lt;/p&gt;
&lt;div class=&#34;code-snippet&#34;&gt;
&lt;details&gt;
&lt;summary markdown=&#34;span&#34;&gt;Click here to see the code snippet&lt;/summary&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-json&#34; data-lang=&#34;json&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;{
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#7ee787&#34;&gt;&amp;#34;schemaVersion&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;2.0&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#7ee787&#34;&gt;&amp;#34;description&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;Use this document to run arbitrary Ansible playbooks on macOS EC2 instances. Specify either YAML text or URL. If you specify both, the URL parameter will be used. Use the extravar parameter to send runtime variables to the Ansible execution. Use the check parameter to perform a dry run of the Ansible execution. The output of the dry run shows the changes that will be made when the playbook is executed.&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#7ee787&#34;&gt;&amp;#34;parameters&amp;#34;&lt;/span&gt;: {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#7ee787&#34;&gt;&amp;#34;playbook&amp;#34;&lt;/span&gt;: {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      &lt;span style=&#34;color:#7ee787&#34;&gt;&amp;#34;type&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;String&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      &lt;span style=&#34;color:#7ee787&#34;&gt;&amp;#34;description&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;(Optional) If you don&amp;#39;t specify a URL, then you must specify playbook YAML in this field.&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      &lt;span style=&#34;color:#7ee787&#34;&gt;&amp;#34;default&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      &lt;span style=&#34;color:#7ee787&#34;&gt;&amp;#34;displayType&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;textarea&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    },
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#7ee787&#34;&gt;&amp;#34;playbookurl&amp;#34;&lt;/span&gt;: {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      &lt;span style=&#34;color:#7ee787&#34;&gt;&amp;#34;type&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;String&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      &lt;span style=&#34;color:#7ee787&#34;&gt;&amp;#34;description&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;(Optional) If you don&amp;#39;t specify playbook YAML, then you must specify a URL where the playbook is stored. You can specify the URL in the following formats: http://example.com/playbook.yml  or s3://examplebucket/plabook.url. For security reasons, you can&amp;#39;t specify a URL with quotes.&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      &lt;span style=&#34;color:#7ee787&#34;&gt;&amp;#34;default&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      &lt;span style=&#34;color:#7ee787&#34;&gt;&amp;#34;allowedPattern&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;^\\s*$|^(http|https|s3)://[^&amp;#39;]*$&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    },
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#7ee787&#34;&gt;&amp;#34;extravars&amp;#34;&lt;/span&gt;: {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      &lt;span style=&#34;color:#7ee787&#34;&gt;&amp;#34;type&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;String&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      &lt;span style=&#34;color:#7ee787&#34;&gt;&amp;#34;description&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;(Optional) Additional variables to pass to Ansible at runtime. Enter a space separated list of key/value pairs. For example: color=red or fruits=[apples,pears]&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      &lt;span style=&#34;color:#7ee787&#34;&gt;&amp;#34;default&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;foo=bar&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      &lt;span style=&#34;color:#7ee787&#34;&gt;&amp;#34;displayType&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;textarea&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      &lt;span style=&#34;color:#7ee787&#34;&gt;&amp;#34;allowedPattern&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;^((^|\\s)\\w&#43;=(\\S&#43;|&amp;#39;.*&amp;#39;))*$&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    },
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#7ee787&#34;&gt;&amp;#34;check&amp;#34;&lt;/span&gt;: {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      &lt;span style=&#34;color:#7ee787&#34;&gt;&amp;#34;type&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;String&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      &lt;span style=&#34;color:#7ee787&#34;&gt;&amp;#34;description&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34; (Optional) Use the check parameter to perform a dry run of the Ansible execution.&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      &lt;span style=&#34;color:#7ee787&#34;&gt;&amp;#34;allowedValues&amp;#34;&lt;/span&gt;: [
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;True&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;False&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      ],
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      &lt;span style=&#34;color:#7ee787&#34;&gt;&amp;#34;default&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;False&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    },
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#7ee787&#34;&gt;&amp;#34;timeoutSeconds&amp;#34;&lt;/span&gt;: {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      &lt;span style=&#34;color:#7ee787&#34;&gt;&amp;#34;type&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;String&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      &lt;span style=&#34;color:#7ee787&#34;&gt;&amp;#34;description&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;(Optional) The time in seconds for a command to be completed before it is considered to have failed.&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      &lt;span style=&#34;color:#7ee787&#34;&gt;&amp;#34;default&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;3600&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    }
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  },
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#7ee787&#34;&gt;&amp;#34;mainSteps&amp;#34;&lt;/span&gt;: [
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      &lt;span style=&#34;color:#7ee787&#34;&gt;&amp;#34;action&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;aws:runShellScript&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      &lt;span style=&#34;color:#7ee787&#34;&gt;&amp;#34;name&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;runShellScript&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      &lt;span style=&#34;color:#7ee787&#34;&gt;&amp;#34;inputs&amp;#34;&lt;/span&gt;: {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#7ee787&#34;&gt;&amp;#34;timeoutSeconds&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;{{ timeoutSeconds }}&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#7ee787&#34;&gt;&amp;#34;runCommand&amp;#34;&lt;/span&gt;: [
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;          &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;#!/bin/bash&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;          &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;/usr/local/bin/ansible --version&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;          &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;if [ $? -ne 0 ]; then&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;          &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34; echo \&amp;#34;Ansible is not installed. Please install Ansible and rerun the command\&amp;#34; &amp;gt;&amp;amp;2&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;          &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34; exit 1&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;          &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;fi&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;          &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;execdir=$(dirname $0)&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;          &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;cd $execdir&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;          &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;if [ -z &amp;#39;{{playbook}}&amp;#39; ] ; then&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;          &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34; if [[ \&amp;#34;{{playbookurl}}\&amp;#34; == http* ]]; then&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;          &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;   wget &amp;#39;{{playbookurl}}&amp;#39; -O playbook.yml&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;          &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;   if [ $? -ne 0 ]; then&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;          &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;       echo \&amp;#34;There was a problem downloading the playbook. Make sure the URL is correct and that the playbook exists.\&amp;#34; &amp;gt;&amp;amp;2&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;          &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;       exit 1&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;          &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;   fi&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;          &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34; elif [[ \&amp;#34;{{playbookurl}}\&amp;#34; == s3* ]] ; then&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;          &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;   aws --version&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;          &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;   if [ $? -ne 0 ]; then&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;          &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;       echo \&amp;#34;The AWS CLI is not installed. The CLI is required to process Amazon S3 URLs. Install the AWS CLI and run the command again.\&amp;#34; &amp;gt;&amp;amp;2&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;          &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;       exit 1&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;          &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;   fi&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;          &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;   aws s3 cp &amp;#39;{{playbookurl}}&amp;#39; playbook.yml&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;          &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;   if [ $? -ne 0 ]; then&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;          &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;       echo \&amp;#34;Error while downloading the document from S3\&amp;#34; &amp;gt;&amp;amp;2&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;          &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;       exit 1&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;          &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;   fi&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;          &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34; else&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;          &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;   echo \&amp;#34;The playbook URL is not valid. Verify the URL and try again.\&amp;#34;&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;          &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34; fi&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;          &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;else&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;          &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34; echo &amp;#39;{{playbook}}&amp;#39; &amp;gt; playbook.yml&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;          &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;fi&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;          &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;if  [[ \&amp;#34;{{check}}\&amp;#34; == True ]] ; then&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;          &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;   /usr/local/bin/ansible-playbook -i \&amp;#34;localhost,\&amp;#34; --check -c local -e \&amp;#34;{{extravars}}\&amp;#34; playbook.yml&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;          &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;else&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;          &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;   /usr/local/bin/ansible-playbook -i \&amp;#34;localhost,\&amp;#34; -c local -e \&amp;#34;{{extravars}}\&amp;#34; playbook.yml&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;          &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;fi&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        ]
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      }
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    }
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  ]
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;/details&gt;
&lt;/div&gt;
&lt;h2 id=&#34;applying-ansible-playbook-to-the-fleet-of-mac1metal&#34;&gt;Applying Ansible playbook to the fleet of mac1.metal&lt;/h2&gt;
&lt;p&gt;Let‚Äôs give our new SSM Document a try! (I suppose you have at least one mac1 instance running, right?)&lt;/p&gt;
&lt;p&gt;In AWS SSM, go to the Run Command feature, then click on the Run Command button.&lt;/p&gt;
&lt;p&gt;On the new panel, type the name of your Document (&lt;code&gt;macos-arbitrary-ansible-playbook&lt;/code&gt; in this example) in the search field and press enter.&lt;/p&gt;
&lt;p&gt;Select the Document, and you‚Äôll see its parameters and settings.&lt;/p&gt;
&lt;p&gt;The rest is self-explanatory. Enter either a playbook code or a link to the source file, add extra variables if needed, and select the target host or a filtered bunch (I like that feature with tags filtering!). Finally, click on the ‚ÄúRun‚Äù orange button to apply your playbook.&lt;/p&gt;
&lt;p&gt;That‚Äôs it! Now you can make all your ansible-playbook dreams come true! üòÅ&lt;/p&gt;</content>
    </entry>
    <entry>
        <title>Configure HTTP Security headers with CloudFront Functions</title>
        <link href="https://devdosvid.blog/2021/05/21/configure-http-security-headers-with-cloudfront-functions/" hreflang="en" rel="alternate"/>
        <published>2021-05-21T00:00:00Z</published>
        <updated>2024-03-25T17:29:29Z</updated>
        <id>https://devdosvid.blog/2021/05/21/configure-http-security-headers-with-cloudfront-functions/</id>
        <author>
            <name>Serhii Vasylenko</name>
        </author>
        <logo>https://devdosvid.blog/2021/05/21/configure-http-security-headers-with-cloudfront-functions/cover-image.png</logo>
        <content type="html">&lt;div class=&#34;updatenotice&#34;&gt;
    &lt;p&gt;In November 2021, AWS has added this functionality as a native CloudFront feature.&lt;/p&gt;
&lt;p&gt;I suggest switching to the native implementation. I have described how to configure Security Response Headers for CloudFront in the following article:&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://devdosvid.blog/2021/11/05/apply-cloudfront-security-headers-with-terraform/&#34;&gt;Apply Cloudfront Security Headers With Terraform&lt;/a&gt;&lt;/p&gt;

&lt;/div&gt;
&lt;p&gt;A couple of weeks ago, AWS released CloudFront Functions ‚Äî a ‚Äútrue edge‚Äù compute capability for the CloudFront.&lt;/p&gt;
&lt;p&gt;It is ‚Äútrue edge‚Äù because Functions work on 200&#43; edge locations (&lt;a href=&#34;https://aws.amazon.com/cloudfront/features/?whats-new-cloudfront.sort-by=item.additionalFields.postDateTime&amp;amp;whats-new-cloudfront.sort-order=desc#Edge_Computing&#34;&gt;link to doc&lt;/a&gt;) while its predecessor, the Lambda@Edge, runs on a small number of regional edge caches.&lt;/p&gt;
&lt;p&gt;One of the use cases for Lambda@Edge was adding security HTTP headers (it‚Äôs even listed on the &lt;a href=&#34;https://aws.amazon.com/lambda/edge/&#34;&gt;product page&lt;/a&gt;), and now there is one more way to make it using CloudFront Functions.&lt;/p&gt;
&lt;div class=&#34;substack-embedded-container&#34;&gt;
    &lt;h3&gt;Subscribe to blog updates!&lt;/h3&gt;
    &lt;iframe title=&#34;Substack&#34; class=&#34;substack-embedded-iframe&#34; src=&#34;https://devdosvid.substack.com/embed&#34; height=&#34;250&#34;
            loading=&#34;lazy&#34;&gt;&lt;/iframe&gt;
&lt;/div&gt;
&lt;h2 id=&#34;what-are-security-headers-and-why-it-matters&#34;&gt;What are security headers, and why it matters&lt;/h2&gt;
&lt;p&gt;Security Headers are one of the web security pillars.&lt;/p&gt;
&lt;p&gt;They specify security-related information of communication between a web application (i.e., website) and a client (i.e., browser) and protect the web app from different types of attacks. Also, HIPAA and PCI, and other security standard certifications generally include these headers in their rankings.&lt;/p&gt;
&lt;p&gt;We will use CloudFront Functions to set the following headers:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://infosec.mozilla.org/guidelines/web_security#content-security-policy&#34;&gt;Content Security Policy&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://infosec.mozilla.org/guidelines/web_security#http-strict-transport-security&#34;&gt;Strict Transport Security&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://infosec.mozilla.org/guidelines/web_security#x-content-type-options&#34;&gt;X-Content-Type-Options&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://infosec.mozilla.org/guidelines/web_security#x-xss-protection&#34;&gt;X-XSS-Protection&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://infosec.mozilla.org/guidelines/web_security#x-frame-options&#34;&gt;X-Frame-Options&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://infosec.mozilla.org/guidelines/web_security#referrer-policy&#34;&gt;Referrer Policy&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;You can find a short and detailed explanation for each security header on &lt;a href=&#34;https://infosec.mozilla.org/guidelines/web_security&#34;&gt;Web Security cheatsheet made by Mozilla&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&#34;cloudfront-functions-overview&#34;&gt;CloudFront Functions overview&lt;/h2&gt;
&lt;p&gt;In a nutshell, CloudFront Functions allow performing simple actions against HTTP(s) request (from the client) and response (from the CloudFront cache at the edge). Functions take less than one millisecond to execute, support JavaScript (ECMAScript 5.1 compliant), and cost $0.10 per 1 million invocations.&lt;/p&gt;
&lt;p&gt;Every CloudFront distribution has one (default) or more Cache behaviors, and Functions can be associated with these behaviors to execute upon a specific event.&lt;/p&gt;
&lt;p&gt;That is how the request flow looks like in general, and here is where CloudFront Functions execution happens:&lt;/p&gt;
&lt;figure&gt;




&lt;img loading=&#34;lazy&#34;
     src=&#34;request_flow.png&#34;width=&#34;800&#34;
height=&#34;171.67&#34;
/&gt; 
&lt;/figure&gt;

&lt;p&gt;CloudFront Functions support Viewer Request (after CloudFront receives a request from a client) and Viewer Response (before CloudFront forwards the response to the client) events.&lt;/p&gt;
&lt;p&gt;You can read more about the events types and their properties here ‚Äî &lt;a href=&#34;https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/lambda-cloudfront-trigger-events.html&#34;&gt;CloudFront Events That Can Trigger a Lambda Function - Amazon CloudFront&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Also, the CloudFront Functions allow you to manage and operate the code and lifecycle of the functions directly from the CloudFront web interface.&lt;/p&gt;
&lt;h2 id=&#34;solution-overview&#34;&gt;Solution overview&lt;/h2&gt;
&lt;p&gt;CloudFront distribution should exist before Function creation so you could associate the Function with the distribution.&lt;/p&gt;
&lt;p&gt;Creation and configuration of the CloudFront Function consist of the following steps:&lt;/p&gt;
&lt;h3 id=&#34;create-function&#34;&gt;Create Function&lt;/h3&gt;
&lt;p&gt;In the AWS Console, open CloudFront service and lick on the Functions on the left navigation bar, then click Create function button.
&lt;figure&gt;




&lt;img loading=&#34;lazy&#34;
     src=&#34;create_function.png&#34;width=&#34;800&#34;
height=&#34;255.83&#34;
/&gt; 
&lt;/figure&gt;

Enter the name of your Function (e.g., ‚Äúsecurity-headers‚Äù) and click Continue.&lt;/p&gt;
&lt;h3 id=&#34;build-function&#34;&gt;Build Function&lt;/h3&gt;
&lt;p&gt;On the function settings page, you will see four tabs with the four lifecycle steps: Build, Test, Publish, Associate.&lt;/p&gt;
&lt;p&gt;Paste the function code into the editor and click ‚ÄúSave.‚Äù&lt;/p&gt;
&lt;figure&gt;




&lt;img loading=&#34;lazy&#34;
     src=&#34;function_editor.png&#34;width=&#34;800&#34;
height=&#34;467.84&#34;
/&gt; 
&lt;/figure&gt;

&lt;p&gt;Here is the source code of the function:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-javascript&#34; data-lang=&#34;javascript&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#ff7b72&#34;&gt;function&lt;/span&gt; handler(event) {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#ff7b72&#34;&gt;var&lt;/span&gt; response &lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;=&lt;/span&gt; event.response;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#ff7b72&#34;&gt;var&lt;/span&gt; headers &lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;=&lt;/span&gt; response.headers;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;headers[&lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#39;strict-transport-security&amp;#39;&lt;/span&gt;] &lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;=&lt;/span&gt; { value&lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#39;max-age=63072000; includeSubdomains; preload&amp;#39;&lt;/span&gt;}; 
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;headers[&lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#39;content-security-policy&amp;#39;&lt;/span&gt;] &lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;=&lt;/span&gt; { value&lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;default-src &amp;#39;none&amp;#39;; img-src &amp;#39;self&amp;#39;; script-src &amp;#39;self&amp;#39;; style-src &amp;#39;self&amp;#39;; object-src &amp;#39;none&amp;#39;; frame-ancestors &amp;#39;none&amp;#39;&amp;#34;&lt;/span&gt;}; 
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;headers[&lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#39;x-content-type-options&amp;#39;&lt;/span&gt;] &lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;=&lt;/span&gt; { value&lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#39;nosniff&amp;#39;&lt;/span&gt;}; 
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;headers[&lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#39;x-xss-protection&amp;#39;&lt;/span&gt;] &lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;=&lt;/span&gt; {value&lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#39;1; mode=block&amp;#39;&lt;/span&gt;};
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;headers[&lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#39;referrer-policy&amp;#39;&lt;/span&gt;] &lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;=&lt;/span&gt; {value&lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#39;same-origin&amp;#39;&lt;/span&gt;};
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;headers[&lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#39;x-frame-options&amp;#39;&lt;/span&gt;] &lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;=&lt;/span&gt; {value&lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#39;DENY&amp;#39;&lt;/span&gt;};
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#ff7b72&#34;&gt;return&lt;/span&gt; response;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id=&#34;test-function&#34;&gt;Test Function&lt;/h3&gt;
&lt;p&gt;Open the ‚ÄúTest‚Äù tab ‚Äî let‚Äôs try our function first before it becomes live!&lt;/p&gt;
&lt;p&gt;Select Viewer Response event type and Development Stage, then select ‚ÄúViewer response with headers‚Äù as a Sample test event (you will get a simple set of headers automatically).&lt;/p&gt;
&lt;p&gt;Now click the blue ‚ÄúTest‚Äù button and observe the output results:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Compute utilization represents the relative amount of time (on a scale between 0 and 100) your function took to run&lt;/li&gt;
&lt;li&gt;Check the Response headers tab and take a look at how the function added custom headers.&lt;/li&gt;
&lt;/ul&gt;
&lt;figure&gt;




&lt;img loading=&#34;lazy&#34;
     src=&#34;function_test.png&#34;width=&#34;800&#34;
height=&#34;624.03&#34;
/&gt; 
&lt;/figure&gt;

&lt;h3 id=&#34;publish-function&#34;&gt;Publish Function&lt;/h3&gt;
&lt;p&gt;Let‚Äôs publish our function. To do that, open the Publish tab and click on the blue button ‚ÄúPublish and update.‚Äù
&lt;figure&gt;




&lt;img loading=&#34;lazy&#34;
     src=&#34;function_publish.png&#34;width=&#34;800&#34;
height=&#34;257.24&#34;
/&gt; 
&lt;/figure&gt;
&lt;/p&gt;
&lt;h3 id=&#34;associate-your-function-with-cloudfront-distribution&#34;&gt;Associate your Function with CloudFront distribution&lt;/h3&gt;
&lt;p&gt;Now, you can associate the function with the CloudFront distribution.&lt;/p&gt;
&lt;p&gt;To do so, open the Associate tab, select the distribution and event type (Viewer Response), and select the Cache behavior of your distribution which you want to use for the association.&lt;/p&gt;
&lt;figure&gt;




&lt;img loading=&#34;lazy&#34;
     src=&#34;function_associate.png&#34;width=&#34;800&#34;
height=&#34;366.08&#34;
/&gt; 
&lt;/figure&gt;

&lt;p&gt;Once you associate the function with the CloudFront distribution, you can test it in live mode.&lt;/p&gt;
&lt;p&gt;I will use curl here to demonstrate it:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-shell&#34; data-lang=&#34;shell&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&amp;gt; curl -i https://d30i87a4ss9ifz.cloudfront.net
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;HTTP/2 &lt;span style=&#34;color:#a5d6ff&#34;&gt;200&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;content-type: text/html
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;content-length: &lt;span style=&#34;color:#a5d6ff&#34;&gt;140&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;date: Sat, &lt;span style=&#34;color:#a5d6ff&#34;&gt;22&lt;/span&gt; May &lt;span style=&#34;color:#a5d6ff&#34;&gt;2021&lt;/span&gt; 00:22:18 GMT
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;last-modified: Tue, &lt;span style=&#34;color:#a5d6ff&#34;&gt;27&lt;/span&gt; Apr &lt;span style=&#34;color:#a5d6ff&#34;&gt;2021&lt;/span&gt; 23:07:14 GMT
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;etag: &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;a855a3189f8223db53df8a0ca362dd62&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;accept-ranges: bytes
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;server: AmazonS3
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;via: 1.1 50f21cb925e6471490e080147e252d7d.cloudfront.net &lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;(&lt;/span&gt;CloudFront&lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;content-security-policy: default-src &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#39;none&amp;#39;&lt;/span&gt;; img-src &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#39;self&amp;#39;&lt;/span&gt;; script-src &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#39;self&amp;#39;&lt;/span&gt;; style-src &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#39;self&amp;#39;&lt;/span&gt;; object-src &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#39;none&amp;#39;&lt;/span&gt;; frame-ancestors &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#39;none&amp;#39;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;strict-transport-security: max-age&lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;=&lt;/span&gt;63072000; includeSubdomains; preload
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;x-xss-protection: 1; &lt;span style=&#34;color:#79c0ff&#34;&gt;mode&lt;/span&gt;&lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;=&lt;/span&gt;block
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;x-frame-options: DENY
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;referrer-policy: same-origin
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;x-content-type-options: nosniff
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;x-cache: Miss from cloudfront
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;x-amz-cf-pop: WAW50-C1
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;x-amz-cf-id: ud3qH8rLs7QmbhUZ-DeupGwFhWLpKDSD59vr7uWC65Hui5m2U8o2mw&lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;==&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;You can also test your results here ‚Äî &lt;a href=&#34;https://observatory.mozilla.org/&#34;&gt;Mozilla Observatory&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;figure&gt;




&lt;img loading=&#34;lazy&#34;
     src=&#34;scan_result-1.png&#34;width=&#34;800&#34;
height=&#34;345.58&#34;
/&gt; 
&lt;/figure&gt;

&lt;figure&gt;




&lt;img loading=&#34;lazy&#34;
     src=&#34;scan_result-2.png&#34;width=&#34;800&#34;
height=&#34;626.15&#34;
/&gt; 
&lt;/figure&gt;
&lt;/p&gt;
&lt;h2 id=&#34;read-more&#34;&gt;Read more&lt;/h2&gt;
&lt;p&gt;That was a simplified overview of the CloudFront Functions capabilities.&lt;/p&gt;
&lt;p&gt;But if you want to get deeper, here is a couple of useful links to start:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Another overview from AWS ‚Äî &lt;a href=&#34;https://aws.amazon.com/blogs/aws/introducing-cloudfront-functions-run-your-code-at-the-edge-with-low-latency-at-any-scale&#34;&gt;CloudFront Functions Launch Blog&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;More about creating, testing, updating and publishing of CloudFront Functions ‚Äî &lt;a href=&#34;https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/managing-functions.html&#34;&gt;Managing functions in CloudFront Functions - Amazon CloudFront&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;so-what-to-choose&#34;&gt;So what to choose?&lt;/h2&gt;
&lt;p&gt;CloudFront Functions are simpler than Lambda@Edge and run faster with minimal latency and minimal time penalty for your web clients.&lt;/p&gt;
&lt;p&gt;Lambda@Edge takes more time to invoke, but it can run upon Origin Response event so that CloudFront can cache the processed response (including headers) and return it faster afterward.&lt;/p&gt;
&lt;p&gt;But again, the CloudFront Functions invocations are much cheaper (6x times) than Lambda@Edge, and you do not pay for the function execution duration.&lt;/p&gt;
&lt;p&gt;The final decision would also depend on the dynamic/static nature of the content you have at your origin.&lt;/p&gt;
&lt;p&gt;To make a wise and deliberate decision, try to analyze your use case using these two documentation articles:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/edge-functions.html&#34;&gt;Choosing between CloudFront Functions and Lambda@Edge&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/lambda-how-to-choose-event.html&#34;&gt;How to Decide Which CloudFront Event to Use to Trigger a Lambda Function&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</content>
    </entry>
    <entry>
        <title>Using TinyPNG Image Compression From MacOS Finder Contextual Menu</title>
        <link href="https://devdosvid.blog/2021/02/14/using-tinypng-image-compression-from-macos-finder-contextual-menu/" hreflang="en" rel="alternate"/>
        <published>2021-02-14T00:00:00Z</published>
        <updated>2024-03-25T17:29:29Z</updated>
        <id>https://devdosvid.blog/2021/02/14/using-tinypng-image-compression-from-macos-finder-contextual-menu/</id>
        <author>
            <name>Serhii Vasylenko</name>
        </author>
        <logo>https://devdosvid.blog/2021/02/14/using-tinypng-image-compression-from-macos-finder-contextual-menu/cover-image.png</logo>
        <content type="html">&lt;p&gt;I just wanted to compress one image, but went to far&amp;hellip;&lt;/p&gt;
&lt;p&gt;or &amp;ldquo;How to add TinyPNG image compression to your macOS Finder contextual menu.&amp;rdquo;&lt;/p&gt;
&lt;h1 id=&#34;what-is-it-and-how-it-works&#34;&gt;What is it and how it works&lt;/h1&gt;
&lt;p&gt;You select needed files or folders, then right-click on them, click on the Services menu item and choose TinyPNG.&lt;/p&gt;
&lt;p&gt;After a moment, the new optimized versions of images will appear near to original files.&lt;/p&gt;
&lt;p&gt;If you selected a folder along with the files, the script would process all &lt;code&gt;png&lt;/code&gt; and &lt;code&gt;jpeg&lt;/code&gt; files in it.&lt;/p&gt;
&lt;video class=&#34;animation&#34; autoplay loop muted playsinline&gt;
    &lt;source src=&#34;context_menu_full_compressed.webm&#34; type=&#34;video/webm&#34;&gt;
&lt;/video&gt;


&lt;h1 id=&#34;prerequisites&#34;&gt;Prerequisites&lt;/h1&gt;
&lt;p&gt;You need to register at TinyPNG and get your API key here ‚Äî &lt;a href=&#34;https://tinypng.com/developers&#34;&gt;Developer API&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;They sometimes block some countries (for example, Ukraine) from registration; in that case, try to use a web-proxy or VPN.&lt;/p&gt;
&lt;h1 id=&#34;how-to-create-quick-action-workflow&#34;&gt;How to create Quick Action Workflow&lt;/h1&gt;
&lt;p&gt;Open Automator application. If you never used this app before, please read about it on the official &lt;a href=&#34;https://support.apple.com/guide/automator/create-a-workflow-aut7cac58839/2.10/mac/11.0&#34;&gt;user guide website&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;On the New Action screen, chose &lt;strong&gt;Quick Action&lt;/strong&gt;&lt;/p&gt;
&lt;figure&gt;




&lt;img loading=&#34;lazy&#34;
     src=&#34;quick_action_compressed.png&#34;width=&#34;800&#34;
height=&#34;695.62&#34;
/&gt; 
&lt;/figure&gt;

&lt;p&gt;After you click the &amp;ldquo;Choose&amp;rdquo; button, you&amp;rsquo;ll see the workflow configuration window.&lt;/p&gt;
&lt;h1 id=&#34;workflow-configuration&#34;&gt;Workflow configuration&lt;/h1&gt;
&lt;p&gt;Find the &lt;strong&gt;Run Shell Script&lt;/strong&gt; action on the Utilities list in Library on the left, and drag it onto the right side of the panel.&lt;/p&gt;
&lt;p&gt;Set the following workflow configuration options as described below:&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Workflow receives current&lt;/strong&gt; &lt;code&gt;files and folders&lt;/code&gt; &lt;strong&gt;in&lt;/strong&gt; &lt;code&gt;Finder&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Shell&lt;/strong&gt; &lt;code&gt;/bin/zsh&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Pass input&lt;/strong&gt; &lt;code&gt;as arguments&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;Click the &lt;strong&gt;Option&lt;/strong&gt; button at the bottom of the Action window and &lt;strong&gt;Uncheck&lt;/strong&gt; &lt;code&gt;Show this action when the workflow runs.&lt;/code&gt;&lt;/p&gt;
&lt;figure&gt;




&lt;img loading=&#34;lazy&#34;
     src=&#34;run_shell_script_compressed.png&#34;width=&#34;800&#34;
height=&#34;702.36&#34;
/&gt; 
&lt;/figure&gt;

&lt;p&gt;Put the following script into the &lt;strong&gt;Run Shell Script&lt;/strong&gt; window, replacing the &lt;em&gt;YOUR_API_KEY_HERE&lt;/em&gt; string with your API key obtained from TinyPNG.&lt;/p&gt;
&lt;script src=&#34;https://gist.github.com/vasylenko/13cb423aa83265e79ac5ad900195603f.js&#34;&gt;&lt;/script&gt;

&lt;h2 id=&#34;utilities-used-in-the-script--explained&#34;&gt;Utilities used in the script ‚Äî explained&lt;/h2&gt;
&lt;p&gt;&lt;code&gt;curl&lt;/code&gt; ‚Äî used to make web requests (like your browser does)&lt;/p&gt;
&lt;p&gt;&lt;code&gt;grep&lt;/code&gt; ‚Äî used to parse the response for the needed header (i.e., field) with the file download link&lt;/p&gt;
&lt;p&gt;&lt;code&gt;cut&lt;/code&gt; ‚Äî used to extract the URL from the parsed result&lt;/p&gt;
&lt;p&gt;&lt;code&gt;sed&lt;/code&gt; ‚Äî used to remove the trailing &amp;ldquo;carriage return&amp;rdquo; symbol at the end of extracted string&lt;/p&gt;
&lt;p&gt;The response body also contains a JSON object that includes the download URL; you can parse it with &lt;code&gt;jq&lt;/code&gt;, for example. But I intentionally refused to use the &lt;code&gt;jq&lt;/code&gt; tool because it is not pre-installed in MacOS.&lt;/p&gt;
&lt;h1 id=&#34;conclusion&#34;&gt;Conclusion&lt;/h1&gt;
&lt;p&gt;It is simple, and it does its job fine. And you don&amp;rsquo;t need to install anything to make it work.&lt;/p&gt;
&lt;p&gt;To make this a bit fancier, you might also like to add a &amp;ldquo;Display Notification&amp;rdquo; (from the Utilities library on the left) after the &amp;ldquo;Run Shell Script&amp;rdquo;. The action will display a notification once image processing is completed.&lt;/p&gt;
&lt;p&gt;Thank you for reading!&lt;/p&gt;</content>
    </entry>
    <entry>
        <title>Customizing mac1.metal EC2 AMI ‚Äî new guts, more glory</title>
        <link href="https://devdosvid.blog/2021/02/01/customizing-mac1.metal-ec2-ami-new-guts-more-glory/" hreflang="en" rel="alternate"/>
        <published>2021-02-01T00:00:00Z</published>
        <updated>2024-03-25T17:29:29Z</updated>
        <id>https://devdosvid.blog/2021/02/01/customizing-mac1.metal-ec2-ami-new-guts-more-glory/</id>
        <author>
            <name>Serhii Vasylenko</name>
        </author>
        <logo>https://devdosvid.blog/2021/02/01/customizing-mac1.metal-ec2-ami-new-guts-more-glory/cover-image.png</logo>
        <content type="html">&lt;p&gt;I guess macOS was designed for a user, not for the ops or engineers, so this is why its customization and usage for CI/CD are not trivial (compared to something Linux-based). A smart guess, huh?&lt;/p&gt;
&lt;h1 id=&#34;configuration-management&#34;&gt;Configuration Management&lt;/h1&gt;
&lt;p&gt;Native Apple&amp;rsquo;s Mobile device management (a.k.a MDM) and Jamf is probably the most potent combination for macOS configuration. But as much as it&amp;rsquo;s mighty, it is a cumbersome combination, and Jamf is not free.&lt;/p&gt;
&lt;p&gt;Then we have Ansible, Chef, Puppet, SaltStack ‚Äî they all are good with Linux, but what about macOS?&lt;/p&gt;
&lt;p&gt;I tried to search for use cases of mentioned CM tools for macOS. However, I concluded that they wrap the execution of native macOS command-line utilities most of the time.&lt;/p&gt;
&lt;p&gt;And if you search for the &amp;lsquo;macos&amp;rsquo; word in Chef Supermarket or Puppet Forge, you won&amp;rsquo;t be impressed by the number of actively maintained packages. Although, here is a motivating article about using Chef &lt;a href=&#34;https://pspdfkit.com/blog/2016/chef-on-macos/&#34;&gt;automating-macos-provisioning-with-chef&lt;/a&gt; if you prefer it. I could not find something similar and fresh for Puppet, so I am sorry, Puppet fans.&lt;/p&gt;
&lt;p&gt;That is why I decided to follow the KISS principle and chose Ansible.&lt;/p&gt;
&lt;p&gt;It&amp;rsquo;s easy to write and read the configuration, it allows to group tasks and to add execution logic &lt;del&gt;, and it feels more DevOps executing shell commands inside Ansible tasks instead of shell scripts; I know you know that üòÇ&lt;/del&gt;&lt;/p&gt;
&lt;p&gt;By the way, Ansible Galaxy does not have many management packages for macOS, either. But thankfully, it has the basics:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://docs.ansible.com/ansible/latest/collections/community/general/homebrew_module.html#ansible-collections-community-general-homebrew-module&#34;&gt;homebrew&lt;/a&gt; with &lt;a href=&#34;https://docs.ansible.com/ansible/latest/collections/community/general/homebrew_cask_module.html#ansible-collections-community-general-homebrew-cask-module&#34;&gt;homebrew_cask&lt;/a&gt; and &lt;a href=&#34;https://docs.ansible.com/ansible/latest/collections/community/general/homebrew_tap_module.html#ansible-collections-community-general-homebrew-tap-module&#34;&gt;homebrew_tap&lt;/a&gt; ‚Äî to install software&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://docs.ansible.com/ansible/latest/collections/community/general/launchd_module.html#ansible-collections-community-general-launchd-module&#34;&gt;launchd&lt;/a&gt; ‚Äî to manage services&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://docs.ansible.com/ansible/latest/collections/community/general/osx_defaults_module.html#ansible-collections-community-general-osx-defaults-module&#34;&gt;osx_defaults&lt;/a&gt; ‚Äî to manage some user settings (not all!)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;I used Ansible to build the macOS AMI for CI/CD, so here are some tips for such a case.&lt;/p&gt;
&lt;p&gt;&lt;em&gt;Some values are hardcoded intentionally in the code examples for the sake of simplicity and easy reading. You would probably want to parametrize them.&lt;/em&gt;&lt;/p&gt;
&lt;h2 id=&#34;xcode-installation-example&#34;&gt;Xcode installation example&lt;/h2&gt;
&lt;p&gt;The following tasks will help you to automate the basics.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-yaml&#34; data-lang=&#34;yaml&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;- &lt;span style=&#34;color:#7ee787&#34;&gt;name&lt;/span&gt;:&lt;span style=&#34;color:#6e7681&#34;&gt; &lt;/span&gt;&lt;span style=&#34;color:#a5d6ff&#34;&gt;Install Xcode&lt;/span&gt;&lt;span style=&#34;color:#6e7681&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#6e7681&#34;&gt;      &lt;/span&gt;&lt;span style=&#34;color:#7ee787&#34;&gt;shell&lt;/span&gt;:&lt;span style=&#34;color:#6e7681&#34;&gt; &lt;/span&gt;&lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;xip --expand Xcode.xip&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#6e7681&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#6e7681&#34;&gt;      &lt;/span&gt;&lt;span style=&#34;color:#7ee787&#34;&gt;args&lt;/span&gt;:&lt;span style=&#34;color:#6e7681&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#6e7681&#34;&gt;        &lt;/span&gt;&lt;span style=&#34;color:#7ee787&#34;&gt;chdir&lt;/span&gt;:&lt;span style=&#34;color:#6e7681&#34;&gt; &lt;/span&gt;&lt;span style=&#34;color:#a5d6ff&#34;&gt;/Applications&lt;/span&gt;&lt;span style=&#34;color:#6e7681&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#6e7681&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#6e7681&#34;&gt;&lt;/span&gt;- &lt;span style=&#34;color:#7ee787&#34;&gt;name&lt;/span&gt;:&lt;span style=&#34;color:#6e7681&#34;&gt; &lt;/span&gt;&lt;span style=&#34;color:#a5d6ff&#34;&gt;Accept License Agreement&lt;/span&gt;&lt;span style=&#34;color:#6e7681&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#6e7681&#34;&gt;  &lt;/span&gt;&lt;span style=&#34;color:#7ee787&#34;&gt;shell&lt;/span&gt;:&lt;span style=&#34;color:#6e7681&#34;&gt; &lt;/span&gt;&lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;/Applications/Xcode.app/Contents/Developer/usr/bin/xcodebuild -license accept&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#6e7681&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#6e7681&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#6e7681&#34;&gt;&lt;/span&gt;- &lt;span style=&#34;color:#7ee787&#34;&gt;name&lt;/span&gt;:&lt;span style=&#34;color:#6e7681&#34;&gt; &lt;/span&gt;&lt;span style=&#34;color:#a5d6ff&#34;&gt;Accept License Agreement&lt;/span&gt;&lt;span style=&#34;color:#6e7681&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#6e7681&#34;&gt;  &lt;/span&gt;&lt;span style=&#34;color:#7ee787&#34;&gt;shell&lt;/span&gt;:&lt;span style=&#34;color:#6e7681&#34;&gt; &lt;/span&gt;&lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;/Applications/Xcode.app/Contents/Developer/usr/bin/xcodebuild -runFirstLaunch&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#6e7681&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#6e7681&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#6e7681&#34;&gt;&lt;/span&gt;- &lt;span style=&#34;color:#7ee787&#34;&gt;name&lt;/span&gt;:&lt;span style=&#34;color:#6e7681&#34;&gt; &lt;/span&gt;&lt;span style=&#34;color:#a5d6ff&#34;&gt;Switch into newly installed Xcode context&lt;/span&gt;&lt;span style=&#34;color:#6e7681&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#6e7681&#34;&gt;  &lt;/span&gt;&lt;span style=&#34;color:#7ee787&#34;&gt;shell&lt;/span&gt;:&lt;span style=&#34;color:#6e7681&#34;&gt; &lt;/span&gt;&lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;xcode-select --switch /Applications/Xcode.app/Contents/Developer&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#6e7681&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id=&#34;example-of-software-installation-with-brew&#34;&gt;Example of software installation with Brew&lt;/h2&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-yaml&#34; data-lang=&#34;yaml&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;- &lt;span style=&#34;color:#7ee787&#34;&gt;name&lt;/span&gt;:&lt;span style=&#34;color:#6e7681&#34;&gt; &lt;/span&gt;&lt;span style=&#34;color:#a5d6ff&#34;&gt;Install common build software&lt;/span&gt;&lt;span style=&#34;color:#6e7681&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#6e7681&#34;&gt;  &lt;/span&gt;&lt;span style=&#34;color:#7ee787&#34;&gt;community.general.homebrew&lt;/span&gt;:&lt;span style=&#34;color:#6e7681&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#6e7681&#34;&gt;    &lt;/span&gt;&lt;span style=&#34;color:#7ee787&#34;&gt;name&lt;/span&gt;:&lt;span style=&#34;color:#6e7681&#34;&gt; &lt;/span&gt;&lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;{{ item }}&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#6e7681&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#6e7681&#34;&gt;    &lt;/span&gt;&lt;span style=&#34;color:#7ee787&#34;&gt;state&lt;/span&gt;:&lt;span style=&#34;color:#6e7681&#34;&gt; &lt;/span&gt;&lt;span style=&#34;color:#a5d6ff&#34;&gt;latest&lt;/span&gt;&lt;span style=&#34;color:#6e7681&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#6e7681&#34;&gt;  &lt;/span&gt;&lt;span style=&#34;color:#7ee787&#34;&gt;loop&lt;/span&gt;:&lt;span style=&#34;color:#6e7681&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#6e7681&#34;&gt;    &lt;/span&gt;- &lt;span style=&#34;color:#a5d6ff&#34;&gt;swiftlint&lt;/span&gt;&lt;span style=&#34;color:#6e7681&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#6e7681&#34;&gt;    &lt;/span&gt;- &lt;span style=&#34;color:#a5d6ff&#34;&gt;swiftformat&lt;/span&gt;&lt;span style=&#34;color:#6e7681&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#6e7681&#34;&gt;    &lt;/span&gt;- &lt;span style=&#34;color:#a5d6ff&#34;&gt;wget&lt;/span&gt;&lt;span style=&#34;color:#6e7681&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id=&#34;screensharing-remote-desktop-configuration-example&#34;&gt;ScreenSharing (remote desktop) configuration example&lt;/h2&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-yaml&#34; data-lang=&#34;yaml&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;- &lt;span style=&#34;color:#7ee787&#34;&gt;name&lt;/span&gt;:&lt;span style=&#34;color:#6e7681&#34;&gt; &lt;/span&gt;&lt;span style=&#34;color:#a5d6ff&#34;&gt;Turn On Remote Management&lt;/span&gt;&lt;span style=&#34;color:#6e7681&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#6e7681&#34;&gt;  &lt;/span&gt;&lt;span style=&#34;color:#7ee787&#34;&gt;shell&lt;/span&gt;:&lt;span style=&#34;color:#6e7681&#34;&gt; &lt;/span&gt;&lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;./kickstart -activate -configure -allowAccessFor -specifiedUsers&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#6e7681&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#6e7681&#34;&gt;  &lt;/span&gt;&lt;span style=&#34;color:#7ee787&#34;&gt;args&lt;/span&gt;:&lt;span style=&#34;color:#6e7681&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#6e7681&#34;&gt;    &lt;/span&gt;&lt;span style=&#34;color:#7ee787&#34;&gt;chdir&lt;/span&gt;:&lt;span style=&#34;color:#6e7681&#34;&gt; &lt;/span&gt;&lt;span style=&#34;color:#a5d6ff&#34;&gt;/System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/&lt;/span&gt;&lt;span style=&#34;color:#6e7681&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#6e7681&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#6e7681&#34;&gt;&lt;/span&gt;- &lt;span style=&#34;color:#7ee787&#34;&gt;name&lt;/span&gt;:&lt;span style=&#34;color:#6e7681&#34;&gt; &lt;/span&gt;&lt;span style=&#34;color:#a5d6ff&#34;&gt;Enable Remote Management for CI user&lt;/span&gt;&lt;span style=&#34;color:#6e7681&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#6e7681&#34;&gt;  &lt;/span&gt;&lt;span style=&#34;color:#7ee787&#34;&gt;shell&lt;/span&gt;:&lt;span style=&#34;color:#6e7681&#34;&gt; &lt;/span&gt;&lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;./kickstart -configure -users ec2-user -access -on -privs -all&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#6e7681&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#6e7681&#34;&gt;  &lt;/span&gt;&lt;span style=&#34;color:#7ee787&#34;&gt;args&lt;/span&gt;:&lt;span style=&#34;color:#6e7681&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#6e7681&#34;&gt;    &lt;/span&gt;&lt;span style=&#34;color:#7ee787&#34;&gt;chdir&lt;/span&gt;:&lt;span style=&#34;color:#6e7681&#34;&gt; &lt;/span&gt;&lt;span style=&#34;color:#a5d6ff&#34;&gt;/System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/&lt;/span&gt;&lt;span style=&#34;color:#6e7681&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Shell rulez, yes.&lt;/p&gt;
&lt;h1 id=&#34;building-the-ami&#34;&gt;Building the AMI&lt;/h1&gt;
&lt;video class=&#34;animation&#34; autoplay loop muted playsinline&gt;
    &lt;source src=&#34;ami-build.webm&#34; type=&#34;video/webm&#34;&gt;
&lt;/video&gt;


&lt;p&gt;&lt;a href=&#34;https://www.packer.io/docs/builders/amazon/ebs&#34;&gt;Packer by HashiCorp&lt;/a&gt;, of course.&lt;/p&gt;
&lt;p&gt;I would love to compare Packer with EC2 Image Builder, but it &lt;a href=&#34;https://docs.aws.amazon.com/imagebuilder/latest/userguide/what-is-image-builder.html#image-builder-os&#34;&gt;does not support macOS&lt;/a&gt; yet (as of Feb&#39;21).&lt;/p&gt;
&lt;p&gt;Packer configuration is straightforward, so I want to highlight only the things specific to the &amp;ldquo;mac1.metal&amp;rdquo; use case.&lt;/p&gt;
&lt;h2 id=&#34;timeouts&#34;&gt;Timeouts&lt;/h2&gt;
&lt;p&gt;As I mentioned in the &lt;a href=&#34;https://devdosvid.blog/2021/01/19/mac1-metal-EC2-Instance-user-experience.html&#34;&gt;previous article&lt;/a&gt;, the creation and deletion time of the &amp;ldquo;mac1.metal&amp;rdquo; Instance is significantly bigger than Linux. That is why you should raise the polling parameters for the builder.&lt;/p&gt;
&lt;p&gt;Example:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-json&#34; data-lang=&#34;json&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;aws_polling&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#f85149&#34;&gt;:&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#7ee787&#34;&gt;&amp;#34;delay_seconds&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#a5d6ff&#34;&gt;30&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#7ee787&#34;&gt;&amp;#34;max_attempts&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#a5d6ff&#34;&gt;60&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;And it would be best if you also increased the SSH timeout:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-json&#34; data-lang=&#34;json&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;ssh_timeout&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#f85149&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;1h&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Fortunately, Packer&amp;rsquo;s AMI builder does not require an explicit declaration of the Dedicated Host ID. So you can just reference the same subnet where you allocated the Host, assuming you did it with the enabled &amp;ldquo;Auto placement&amp;rdquo; parameter during the host creation.&lt;/p&gt;
&lt;p&gt;Example:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-json&#34; data-lang=&#34;json&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;tenancy&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#f85149&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;host&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#f85149&#34;&gt;,&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;subnet_id&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#f85149&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;your-subnet-id&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id=&#34;provisioning&#34;&gt;Provisioning&lt;/h2&gt;
&lt;p&gt;Packer has &lt;a href=&#34;https://www.packer.io/docs/provisioners/ansible&#34;&gt;Ansible Provisioner&lt;/a&gt; that I used for the AMI. Its documentation is also very clean and straightforward.&lt;/p&gt;
&lt;p&gt;But it is still worth mentioning that if you want to parametrize the Ansible playbook, then the following configuration example will be handy:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-json&#34; data-lang=&#34;json&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;extra_arguments&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#f85149&#34;&gt;:&lt;/span&gt; [
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;--extra-vars&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;your-variable-foo=your-value-bar]&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  ]&lt;span style=&#34;color:#f85149&#34;&gt;,&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;ansible_env_vars&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#f85149&#34;&gt;:&lt;/span&gt; [
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;ANSIBLE_PYTHON_INTERPRETER=auto_legacy_silent&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;ANSIBLE_OTHER_ENV_VARIABLE=other_value&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  ]
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h1 id=&#34;configuration-at-launch&#34;&gt;Configuration at launch&lt;/h1&gt;
&lt;p&gt;If you&amp;rsquo;re familiar with AWS EC2, you probably know what the Instance &lt;code&gt;user data&lt;/code&gt; is.&lt;/p&gt;
&lt;p&gt;A group of AWS developers made something similar for the macOS: &lt;a href=&#34;https://github.com/aws/ec2-macos-init&#34;&gt;EC2 macOS Init&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;It does not support &lt;code&gt;cloud-init&lt;/code&gt; as on Linux-based Instances, but it can run shell scripts, which is quite enough.&lt;/p&gt;
&lt;p&gt;EC2 macOS Init utility is a Launch Daemon (macOS terminology) that runs on behalf of the &lt;code&gt;root&lt;/code&gt; user at system boot. It executes the commands according to the so-called Priority Groups, or the sequence in other words.&lt;/p&gt;
&lt;p&gt;The number of the group corresponds to the execution order. You can put several tasks into a single Priority Group, and the tool will execute them simultaneously.&lt;/p&gt;
&lt;p&gt;EC2 macOS Init uses a human-readable configuration file in &lt;code&gt;toml&lt;/code&gt; format.&lt;/p&gt;
&lt;p&gt;Example:&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;[[Module]]
  Name = &amp;#34;Create-some-folder&amp;#34;
  PriorityGroup = 3
  FatalOnError = false 
  RunPerInstance = true 
  [Module.Command]
    Cmd = [&amp;#34;mkdir&amp;#34;, &amp;#34;/Users/ec2-user/my-directory&amp;#34;] 
    RunAsUser = &amp;#34;ec2-user&amp;#34;
    EnvironmentVars = [&amp;#34;MY_VAR_FOO=myValueBar&amp;#34;]
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;I should clarify some things here.&lt;/p&gt;
&lt;p&gt;Modules ‚Äî a set of pre-defined modules for different purposes. It is something similar to the Ansible modules.&lt;/p&gt;
&lt;p&gt;You can find the list of available modules here &lt;a href=&#34;https://github.com/aws/ec2-macos-init/tree/master/lib/ec2macosinit&#34;&gt;ec2-macos-init/lib/ec2macosinit&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;The &lt;code&gt;RunPerInstance&lt;/code&gt; directive controls whether a module should run. There are three of such directives, and here is what they mean:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;RunPerBoot&lt;/code&gt; ‚Äî module will run at every system boot&lt;/li&gt;
&lt;li&gt;&lt;code&gt;RunPerInstance&lt;/code&gt; ‚Äî module will run once for the Instance. Each Instance has a unique ID; the init tool fetches it from the AWS API before the execution and keeps its execution history per Instance ID. When you create a new Instance from the AMI, it will have a unique ID, and the module will run again.&lt;/li&gt;
&lt;li&gt;&lt;code&gt;RunOnce&lt;/code&gt; ‚Äî module will run only once, despite the instance ID change&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;I mentioned the execution history above. When EC2 macOS Init runs on the Instance first time, it creates a unique directory with the name per Instance ID to store the execution history and user data copy.&lt;/p&gt;
&lt;p&gt;&lt;code&gt;RunPerInstance&lt;/code&gt; and &lt;code&gt;RunOnce&lt;/code&gt; directives depend on the execution history, and modules with those directives will run again on the next boot if the previous execution failed. It was not obvious to me why RunOnce keeps repeating itself every boot until I dug into &lt;a href=&#34;https://github.com/aws/ec2-macos-init/blob/master/lib/ec2macosinit/module.go#L110&#34;&gt;the source code&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Finally, there is a module for user data. It runs at the end by default (priority group #4) and pulls the user data script from AWS API before script execution.&lt;/p&gt;
&lt;p&gt;I suggest looking into the default &lt;a href=&#34;https://github.com/aws/ec2-macos-init/blob/master/configuration/init.toml&#34;&gt;init.toml&lt;/a&gt; configuration file to get yourself more familiar with the capabilities of the tool.&lt;/p&gt;
&lt;p&gt;The init tool can also clear its history, which is useful for the new AMI creation.&lt;/p&gt;
&lt;p&gt;Example:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-shell&#34; data-lang=&#34;shell&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;ec2-macos-init clean -all
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;And you can run the init manually for debugging purposes.&lt;/p&gt;
&lt;p&gt;Example:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-shell&#34; data-lang=&#34;shell&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;ec2-macos-init run
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;You can also combine the EC2 macOS Init actions (made by modules) with your script in user data for more accurate nontrivial configurations.&lt;/p&gt;
&lt;h1 id=&#34;wrapping-up&#34;&gt;Wrapping up&lt;/h1&gt;
&lt;p&gt;As a whole, building and operating macOS-based AMI does not differ from AMI management for other platforms.&lt;/p&gt;
&lt;p&gt;There are the same principle stages: prepare, clear, build, execute deployment script (if necessary). Though, the particular implementation of each step has its nuances and constraints.&lt;/p&gt;
&lt;p&gt;So the whole process may look as follows:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Provision and configure needed software with Ansible playbook&lt;/li&gt;
&lt;li&gt;Clean-up system logs and EC2 macOS Init history (again, with Ansible task)&lt;/li&gt;
&lt;li&gt;Create the AMI&lt;/li&gt;
&lt;li&gt;Add more customizations at launch with EC2 macOS Init modules and user data (that also executes your Ansible playbook or shell commands)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Getting into all this was both fun and interesting. Sometimes painful, though. üòÜ&lt;/p&gt;
&lt;p&gt;I sincerely hope this article was helpful to you. Thank you for reading!&lt;/p&gt;</content>
    </entry>
    <entry>
        <title>Terraforming mac1.metal at AWS</title>
        <link href="https://devdosvid.blog/2021/01/20/terraforming-mac1.metal-at-aws/" hreflang="en" rel="alternate"/>
        <published>2021-01-20T00:00:00Z</published>
        <updated>2024-03-25T17:29:29Z</updated>
        <id>https://devdosvid.blog/2021/01/20/terraforming-mac1.metal-at-aws/</id>
        <author>
            <name>Serhii Vasylenko</name>
        </author>
        <logo>https://devdosvid.blog/2021/01/20/terraforming-mac1.metal-at-aws/cover-image.jpg</logo>
        <content type="html">&lt;div class=&#34;updatenotice&#34;&gt;
    Updated on the 23rd of October, 2021: Terraform AWS provider now &lt;a href=&#34;https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/ec2_host&#34;&gt;supports&lt;/a&gt; Dedicated Hosts natively
&lt;/div&gt;
&lt;p&gt;In November 2021, AWS &lt;a href=&#34;https://aws.amazon.com/blogs/aws/new-use-mac-instances-to-build-test-macos-ios-ipados-tvos-and-watchos-apps/&#34;&gt;announced&lt;/a&gt; the support for Mac mini instances.&lt;/p&gt;
&lt;p&gt;I believe this is huge, even despite the number of constraints this solution has. This offering opens the door to seamless macOS CI/CD integration into existing AWS infrastructure.&lt;/p&gt;
&lt;p&gt;So here is a quick-start example of creating the dedicated host and the instance altogether using Terraform.&lt;/p&gt;
&lt;p&gt;I intentionally used some hardcoded values for the sake of simplicity in the example.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-hcl&#34; data-lang=&#34;hcl&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#ff7b72&#34;&gt;resource&lt;/span&gt; &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;aws_ec2_host&amp;#34; &amp;#34;example_host&amp;#34;&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  instance_type     &lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;mac1.metal&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  availability_zone &lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;us-east-1a&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#ff7b72&#34;&gt;resource&lt;/span&gt; &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;aws_instance&amp;#34; &amp;#34;example_instance&amp;#34;&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  ami           &lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ff7b72&#34;&gt;data&lt;/span&gt;.&lt;span style=&#34;color:#ff7b72&#34;&gt;aws_ami&lt;/span&gt;.&lt;span style=&#34;color:#ff7b72&#34;&gt;mac1metal&lt;/span&gt;.&lt;span style=&#34;color:#ff7b72&#34;&gt;id&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  host_id       &lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ff7b72&#34;&gt;aws_ec2_host&lt;/span&gt;.&lt;span style=&#34;color:#ff7b72&#34;&gt;example_host&lt;/span&gt;.&lt;span style=&#34;color:#ff7b72&#34;&gt;id&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  instance_type &lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;mac1.metal&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  subnet_id     &lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ff7b72&#34;&gt;data&lt;/span&gt;.&lt;span style=&#34;color:#ff7b72&#34;&gt;aws_subnet&lt;/span&gt;.&lt;span style=&#34;color:#ff7b72&#34;&gt;example_subnet&lt;/span&gt;.&lt;span style=&#34;color:#ff7b72&#34;&gt;id&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#ff7b72&#34;&gt;data&lt;/span&gt; &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;aws_subnet&amp;#34; &amp;#34;example_subnet&amp;#34;&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  availability_zone &lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;us-east-1a&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#ff7b72&#34;&gt;filter&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    name   &lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;tag:Tier&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#8b949e;font-style:italic&#34;&gt; # you should omit this filter if you don&amp;#39;t distinguish your subnets on private and public 
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#8b949e;font-style:italic&#34;&gt;&lt;/span&gt;    values &lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;=&lt;/span&gt; [&lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;private&amp;#34;&lt;/span&gt;]
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  }
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#ff7b72&#34;&gt;data&lt;/span&gt; &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;aws_ami&amp;#34; &amp;#34;mac1metal&amp;#34;&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  owners      &lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;=&lt;/span&gt; [&lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;amazon&amp;#34;&lt;/span&gt;]
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  most_recent &lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ff7b72&#34;&gt;true&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#ff7b72&#34;&gt;filter&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    name   &lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;name&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    values &lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;=&lt;/span&gt; [&lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#34;amzn-ec2-macos-11*&amp;#34;&lt;/span&gt;]&lt;span style=&#34;color:#8b949e;font-style:italic&#34;&gt; # get latest BigSur AMI
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#8b949e;font-style:italic&#34;&gt;&lt;/span&gt;  }
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Simple as that, yes. Now, you can integrate it into your CI system and have the Mac instance with the underlying host in a bundle.
&lt;div class=&#34;attention&#34;&gt;
    Pro tip: you can leverage the &lt;code&gt;aws_ec2_instance_type_offerings&lt;/code&gt; &lt;a href=&#34;https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/ec2_instance_type_offerings&#34;&gt;Data Source&lt;/a&gt; and use its output with &lt;code&gt;aws_subnet&lt;/code&gt; source to avoid availability zone hardcoding.
&lt;/div&gt;&lt;/p&gt;
&lt;p&gt;To make the code more uniform and reusable, you can wrap it into a &lt;a href=&#34;https://devdosvid.blog/2020/09/09/terraform-modules-explained.html&#34;&gt;Terraform module&lt;/a&gt; that accepts specific parameters (such as &lt;code&gt;instance_type&lt;/code&gt; or &lt;code&gt;availability_zone&lt;/code&gt;) as input variables.&lt;/p&gt;</content>
    </entry>
    <entry>
        <title>mac1.metal and mac2.metal EC2 Instances ‚Äî user experience</title>
        <link href="https://devdosvid.blog/2021/01/19/mac1.metal-and-mac2.metal-ec2-instances-user-experience/" hreflang="en" rel="alternate"/>
        <published>2021-01-19T00:00:00Z</published>
        <updated>2024-03-25T17:29:29Z</updated>
        <id>https://devdosvid.blog/2021/01/19/mac1.metal-and-mac2.metal-ec2-instances-user-experience/</id>
        <author>
            <name>Serhii Vasylenko</name>
        </author>
        <logo>https://devdosvid.blog/2021/01/19/mac1.metal-and-mac2.metal-ec2-instances-user-experience/cover-image.jpg</logo>
        <content type="html">&lt;p&gt;This is the review of EC2 Mac instances, &lt;strong&gt;mac1.metal&lt;/strong&gt; and &lt;strong&gt;mac2.metal&lt;/strong&gt; ‚Äî the new EC2 instance types that enables macOS workloads on AWS.&lt;/p&gt;
&lt;div class=&#34;updatenotice&#34;&gt;
    &lt;strong&gt;Updated in June 2022&lt;/strong&gt;: new information added about the offering ‚Äî more cool stuff ü§©
&lt;/div&gt;
&lt;p&gt;AWS announced EC2 macOS instances based on the Intel CPU on 30 November 2020.&lt;/p&gt;
&lt;p&gt;After a year and a half, the M1 Mac Instances arrived (7 July 2022).&lt;/p&gt;
&lt;p&gt;Some basic information about the Mac EC2 first:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;The &lt;strong&gt;mac1.metal&lt;/strong&gt; instances are Intel-based&lt;/p&gt;
&lt;p&gt;12 vCPU, 32 GiB RAM | 10 Gbps Network and 8 Gbps EBS bandwidth&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;The &lt;strong&gt;mac2.metal&lt;/strong&gt; instances are powered by M1 Apple Silicon processors.&lt;/p&gt;
&lt;p&gt;8 vCPU, 16 GiB RAM, 16 core Apple Neural Engine | 10 Gbps Network and 8 Gbps EBS bandwidth&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;The Instance must be placed onto a &lt;a href=&#34;https://aws.amazon.com/ec2/dedicated-hosts/&#34;&gt;Dedicated Host&lt;/a&gt; because these are physical Apple Mac minis.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;AWS has integrated the &lt;a href=&#34;https://aws.amazon.com/ec2/nitro/&#34;&gt;Nitro System&lt;/a&gt; to make Macs work as EC2 instances and connect them with many other services.&lt;/p&gt;
&lt;p&gt;Mac minis are connected to the AWS Nitro via Thunderbolt, just a fun fact.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;You don&amp;rsquo;t pay anything for the Instance itself, but you pay for the Dedicated Host leasing, and the minimum lease time is 24 hours.&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;div class=&#34;substack-embedded-container&#34;&gt;
    &lt;h3&gt;Subscribe to blog updates!&lt;/h3&gt;
    &lt;iframe title=&#34;Substack&#34; class=&#34;substack-embedded-iframe&#34; src=&#34;https://devdosvid.substack.com/embed&#34; height=&#34;250&#34;
            loading=&#34;lazy&#34;&gt;&lt;/iframe&gt;
&lt;/div&gt;
&lt;h2 id=&#34;ec2-mac-instance-prices-june-2022&#34;&gt;EC2 Mac Instance Prices (June 2022)&lt;/h2&gt;
&lt;p&gt;On-demand pricing (us-east-1, North Virginia:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;mac1.metal costs 1.083 USD per hour or about 780 USD per month&lt;/li&gt;
&lt;li&gt;mac2.metal costs 0.65 USD per hour or about 470 USD per month&lt;/li&gt;
&lt;/ul&gt;
&lt;div class=&#34;attention&#34;&gt;
    The mac2.metal costs 40% less compared to the mac1.metal
&lt;/div&gt;
&lt;p&gt;Since the minimal leas time for the mac*.metal dedicated host is 24 hours, the first launch of the Instance is always costly, mind that while testing.&lt;/p&gt;
&lt;p&gt;One day of mac1.metal usage costs 26 USD&lt;/p&gt;
&lt;p&gt;One day of mac2.metal usage costs 15.6 USD&lt;/p&gt;
&lt;p&gt;To save yourself some money, you can use &lt;a href=&#34;https://aws.amazon.com/savingsplans/compute-pricing/&#34;&gt;Savings Plans&lt;/a&gt;, both Instance and Compute, and save up to 44% off On-Demand pricing.&lt;/p&gt;
&lt;p&gt;For example, with the one-year commitment, partial 50% upfront payment, and the Instance Savings pricing model, you can get the 20% lower price per hour:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;mac1.metal ‚Äî 0.867 USD&lt;/li&gt;
&lt;li&gt;mac2.metal ‚Äî 0.52 USD&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Feel free to play with the numbers in the &lt;a href=&#34;https://calculator.aws/#/createCalculator/EC2DedicatedHosts&#34;&gt;Dedicated Host Pricing Calculator&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&#34;supported-operating-systems-june-2022&#34;&gt;Supported Operating Systems (June 2022)&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;macOS Mojave 10.14.x (mac1.metal only)&lt;/li&gt;
&lt;li&gt;macOS Catalina 10.15.x (mac1.metal only)&lt;/li&gt;
&lt;li&gt;macOS Big Sur 11.x&lt;/li&gt;
&lt;li&gt;macOS Monterey 12.x&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;what-can-it-do&#34;&gt;What can it do&lt;/h2&gt;
&lt;p&gt;Here is a list of some features that the mac1.metal and mac2.metal instances have:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;It lives in your VPC because it is an EC2 Instance, so you can access many other services.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;For EBS, it supports the attachment of up to 16 volumes for mac1 and 10 for mac2.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;It supports SSM Agent and Session Manager.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;It has several AWS tools pre-installed: AWS CLI, SSM Agent, EFS Utils, and more.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;It has pre-installed Enhanced Network Interface drivers. My test upload/download to S3 was about 300GB/s.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;It can report CPU metrics to CloudWatch.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;It supports &lt;a href=&#34;https://devdosvid.blog/2021/10/24/auto-scaling-group-for-your-macos-ec2-instances-fleet/&#34;&gt;AutoScaling&lt;/a&gt; üöÄ&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;And you can share the instances using &lt;a href=&#34;https://devdosvid.blog/2021/09/25/aws-resource-access-manager-multi-account-resource-governance/&#34;&gt;AWS Resource Access Manager&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;For example, you can have a dedicated AWS account used solely as a MacOS-based farm in your organization where instances are shared with other accounts.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Although there is a local SSD disk available, EC2 Mac can boot only from the EBS&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;div class=&#34;attention&#34;&gt;
    &lt;p&gt;The built-it physical SSD is still there and yours to use: build-cache, temporary storage, etc.&lt;/p&gt;
&lt;p&gt;However, AWS does not manage or support the Apple hardware&amp;rsquo;s internal SSD. So there is no guarantee for data persistency.&lt;/p&gt;

&lt;/div&gt;
&lt;h2 id=&#34;what-cant-it-do&#34;&gt;What can&amp;rsquo;t it do&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;It can&amp;rsquo;t recognize the attached EBS if you connected it while the instance was running ‚Äî you must reboot the instance to make it visible.&lt;/li&gt;
&lt;li&gt;It does not recognize the live resize of EBS either ‚Äî you must reboot the instance so resize change can take effect.&lt;/li&gt;
&lt;li&gt;And the same relates to the Elastic Network Interfaces ‚Äî attach and reboot the instance to apply it.&lt;/li&gt;
&lt;li&gt;It does not support several services that rely on additional custom software, such as &amp;ldquo;EC2 Instance Connect&amp;rdquo; and &amp;ldquo;AWS Inspect.&amp;rdquo; But I think that AWS will add macOS distros for those soon.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;As of July 2022, mac2.metal is not supported by Host Resource Groups. Therefore you cannot use mac2.metal Instances in Auto Scaling Groups. But AWS support says they are working on that, so fingers crossed!&lt;/p&gt;
&lt;h2 id=&#34;launching-the-instance&#34;&gt;Launching the Instance&lt;/h2&gt;
&lt;figure&gt;




&lt;img loading=&#34;lazy&#34;
     src=&#34;launch.png&#34;width=&#34;400&#34;
height=&#34;200&#34;
/&gt; 
&lt;/figure&gt;

&lt;p&gt;Jeff Bar &lt;a href=&#34;https://aws.amazon.com/blogs/aws/new-use-mac-instances-to-build-test-macos-ios-ipados-tvos-and-watchos-apps/&#34;&gt;published&lt;/a&gt; an excellent how-to about kickstart of the &amp;ldquo;mac1.metal&amp;rdquo;, so I will focus on things he did not mention.&lt;/p&gt;
&lt;p&gt;Once you allocated the Dedicated Host and launched an Instance, the underlying system connects the EBS with a root file system to the Mac Mini.&lt;/p&gt;
&lt;p&gt;The Mac metal Instances can boot from the EBS-backed macOS AMIs only.&lt;/p&gt;
&lt;p&gt;If you specified the EBS size to be more than AMI&amp;rsquo;s default, you need to resize the disk inside the system manually after the boot &lt;sup id=&#34;fnref:1&#34;&gt;&lt;a href=&#34;#fn:1&#34; class=&#34;footnote-ref&#34; role=&#34;doc-noteref&#34;&gt;1&lt;/a&gt;&lt;/sup&gt;.&lt;/p&gt;
&lt;p&gt;The time from the Instance launch until you can SSH into it varies between 5 and 20 minutes.&lt;/p&gt;
&lt;p&gt;You have the option to access it over SSH with your private key. For example, if you need to set up Screen Sharing, you must allow it through the &amp;ldquo;kickstart&amp;rdquo; command-line utility and set the user password &lt;sup id=&#34;fnref:2&#34;&gt;&lt;a href=&#34;#fn:2&#34; class=&#34;footnote-ref&#34; role=&#34;doc-noteref&#34;&gt;2&lt;/a&gt;&lt;/sup&gt;.&lt;/p&gt;
&lt;h2 id=&#34;customizing-the-instance&#34;&gt;Customizing the Instance&lt;/h2&gt;
&lt;p&gt;&lt;figure&gt;




&lt;img loading=&#34;lazy&#34;
     src=&#34;customize.png&#34;width=&#34;400&#34;
height=&#34;200&#34;
/&gt; 
&lt;/figure&gt;

I wrote a separate post about mac1.metal AMI customization and creation, so check it out!&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://devdosvid.blog/2021/02/01/customizing-mac1.metal-ec2-ami-new-guts-more-glory/&#34;&gt;&lt;strong&gt;Customizing mac1.metal EC2 AMI ‚Äî new guts, more glory&lt;/strong&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;Though, I would like to mention two things here:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;System updates are disabled by default in the macOS AMIs provided by AWS.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;But you can use them with no issues. For example:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-shell&#34; data-lang=&#34;shell&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;sudo softwareupdate --install --all
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ol start=&#34;2&#34;&gt;
&lt;li&gt;It is possible to set a custom screen resolution when connected to the instance using native ScreenSharing or any other VNC-compatible software.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;There are many tools, but AWS suggests the &lt;a href=&#34;https://github.com/jakehilborn/displayplacer&#34;&gt;displayplacer&lt;/a&gt;.&lt;/p&gt;
&lt;h2 id=&#34;destroying-the-instance&#34;&gt;Destroying the Instance&lt;/h2&gt;
&lt;p&gt;&lt;figure&gt;




&lt;img loading=&#34;lazy&#34;
     src=&#34;cleanup.png&#34;width=&#34;400&#34;
height=&#34;200&#34;
/&gt; 
&lt;/figure&gt;

Such an easy thing to do, right? Well, it depends.&lt;/p&gt;
&lt;p&gt;The complex Instance scrubbing process begins when you click on the &amp;ldquo;Terminate&amp;rdquo; item in the Instance actions menu.&lt;/p&gt;
&lt;p&gt;AWS wants to ensure that anyone who uses the Host (Mac mini) after you will get your data stored neither on disks (including the physical SSD mentioned earlier) nor inside memory or NVRAM, nor anywhere else.&lt;/p&gt;
&lt;p&gt;AWS does not share many details of this scrubbing process, but it takes more than an hour to complete.&lt;/p&gt;
&lt;p&gt;When scrubbing is started, the Dedicated Host transitions to the Pending state.&lt;/p&gt;
&lt;p&gt;Dedicated Host transitions to Available state once scrubbing is finished. But you must wait for another 10-15 minutes to be able to release it finally.&lt;/p&gt;
&lt;p&gt;I don&amp;rsquo;t know why they set the Available state value earlier than the Host is available for operations, but this is how it works now (Jan&#39;21).&lt;/p&gt;
&lt;p&gt;Therefore, you can launch the next Instance on the same Host no earlier than ~1,5 hours after you terminated the previous one. That doesn&amp;rsquo;t seem very pleasant in the first couple of weeks, but you will get used to it. üòÑ&lt;/p&gt;
&lt;p&gt;And again: you can release the &amp;ldquo;mac1.metal&amp;rdquo; Dedicated Host no earlier than 24 hours after it was allocated. So plan your tests wisely.&lt;/p&gt;
&lt;div class=&#34;attention&#34;&gt;
    If the lease time of a host is more than 24 hours, you don‚Äôt need to wait for the scrubbing process to finish to release that host.
&lt;/div&gt;
&lt;h2 id=&#34;legal-things&#34;&gt;Legal things&lt;/h2&gt;
&lt;p&gt;It is a bit tricky thing, but in short words:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;you are allowed to use the Instances solely for developer purposes&lt;/li&gt;
&lt;li&gt;you must agree to all software EULAs on the system&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Here is the license agreement of the macOS Monterey if you want to deal with it like a pro ‚Äî &lt;a href=&#34;https://www.apple.com/legal/sla/docs/macOSMonterey.pdf&#34;&gt;link&lt;/a&gt;.&lt;/p&gt;
&lt;h2 id=&#34;some-more-cool-stuff-to-check&#34;&gt;Some more cool stuff to check:&lt;/h2&gt;
&lt;p&gt;&lt;a href=&#34;https://github.com/aws/ec2-macos-init&#34;&gt;EC2 macOS Init&lt;/a&gt; launch daemon, which initializes Mac instances.
&lt;a href=&#34;https://github.com/aws/homebrew-aws&#34;&gt;EC2 macOS Homebrew Tap&lt;/a&gt; (Third-Party Repository) with several management tools which come pre-installed into macOS AMI from AWS.&lt;/p&gt;
&lt;p&gt;Indeed it is powerful, and it has its trade-offs, such as price and some technical constraints. But it is an actual macOS device natively integrated into the AWS environment. So I guess it is worth to be tried!&lt;/p&gt;
&lt;p&gt;Thanks for reading this! Stay tuned for more user experience feedback about baking custom AMIs, automated software provisioning with Ansible, and other adventures with mac1.metal!&lt;/p&gt;
&lt;div class=&#34;footnotes&#34; role=&#34;doc-endnotes&#34;&gt;
&lt;hr&gt;
&lt;ol&gt;
&lt;li id=&#34;fn:1&#34;&gt;
&lt;p&gt;&lt;strong&gt;How to resize the EBS at mac1.metal in Terminal&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;Get the identifier of EBS (look for the first one with GUID_partition_scheme):
&lt;code&gt;diskutil list physical external&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;Or here is a more advanced version to be used in a script:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-shell&#34; data-lang=&#34;shell&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#79c0ff&#34;&gt;DISK_ID&lt;/span&gt;&lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#ff7b72&#34;&gt;$(&lt;/span&gt;diskutil list physical external | grep &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#39;GUID_partition_scheme&amp;#39;&lt;/span&gt;| tr -s &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#39; &amp;#39;&lt;/span&gt; | cut -d&lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#39; &amp;#39;&lt;/span&gt; -f6&lt;span style=&#34;color:#ff7b72&#34;&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;It would probably be &lt;code&gt;disk0&lt;/code&gt; if you did not attach additional EBS.&lt;/p&gt;
&lt;p&gt;Then run the repair job for the disk, using its identifier:
&lt;code&gt;diskutil repairDisk disk0&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;Advanced version:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-shell&#34; data-lang=&#34;shell&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;yes | diskutil repairDisk &lt;span style=&#34;color:#79c0ff&#34;&gt;$DISK_ID&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Now get the APFS container identifier (look for Apple_APFS):
&lt;code&gt;diskutil list physical external&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;Advanced version:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-shell&#34; data-lang=&#34;shell&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#79c0ff&#34;&gt;APFS_ID&lt;/span&gt;&lt;span style=&#34;color:#ff7b72;font-weight:bold&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#ff7b72&#34;&gt;$(&lt;/span&gt;diskutil list physical external | grep &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#39;Apple_APFS&amp;#39;&lt;/span&gt; | tr -s &lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#39; &amp;#39;&lt;/span&gt; | cut -d&lt;span style=&#34;color:#a5d6ff&#34;&gt;&amp;#39; &amp;#39;&lt;/span&gt; -f8&lt;span style=&#34;color:#ff7b72&#34;&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;It would probably be &lt;code&gt;disk0s2&lt;/code&gt; if you did not attach additional EBS.&lt;/p&gt;
&lt;p&gt;Finally, resize the APFS container:
&lt;code&gt;diskutil apfs resizeContainer disk0s2&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;Advanced version&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-shell&#34; data-lang=&#34;shell&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;diskutil apfs resizeContainer &lt;span style=&#34;color:#79c0ff&#34;&gt;$APFS_ID&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&amp;#160;&lt;a href=&#34;#fnref:1&#34; class=&#34;footnote-backref&#34; role=&#34;doc-backlink&#34;&gt;&amp;#x21a9;&amp;#xfe0e;&lt;/a&gt;&lt;/li&gt;
&lt;li id=&#34;fn:2&#34;&gt;
&lt;p&gt;&lt;strong&gt;How to setup Screen Sharing at mac1.metal in Terminal&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;The &lt;code&gt;kickstart&lt;/code&gt; command-line tool resides in &lt;code&gt;/System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/&lt;/code&gt; so you&amp;rsquo;ll better to cd into that directory for convenience:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-shell&#34; data-lang=&#34;shell&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#8b949e;font-style:italic&#34;&gt;# Turn On Remote Management for a user to be specified later&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;sudo ./kickstart -activate -configure -allowAccessFor -specifiedUsers
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#8b949e;font-style:italic&#34;&gt;# Enable Remote Management for ec2-user user&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;sudo ./kickstart -configure -users ec2-user -access -on -privs -all
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#8b949e;font-style:italic&#34;&gt;# Set the user password &lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;sudo passwd ec2-user
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&amp;#160;&lt;a href=&#34;#fnref:2&#34; class=&#34;footnote-backref&#34; role=&#34;doc-backlink&#34;&gt;&amp;#x21a9;&amp;#xfe0e;&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;/div&gt;</content>
    </entry>
    <entry>
        <title>AWS CloudShell</title>
        <link href="https://devdosvid.blog/2020/12/16/aws-cloudshell/" hreflang="en" rel="alternate"/>
        <published>2020-12-16T00:00:00Z</published>
        <updated>2024-03-25T17:29:29Z</updated>
        <id>https://devdosvid.blog/2020/12/16/aws-cloudshell/</id>
        <author>
            <name>Serhii Vasylenko</name>
        </author>
        <logo>https://devdosvid.blog/2020/12/16/aws-cloudshell/cover-image.png</logo>
        <content type="html">&lt;p&gt;A simple but cool announcement from AWS ‚Äî &lt;a href=&#34;https://aws.amazon.com/cloudshell/&#34;&gt;AWS CloudShell&lt;/a&gt;.
A tool for ad-hoc AWS management via CLI directly in your browser.&lt;/p&gt;
&lt;p&gt;I like when AWS releases something simple to understand and yet powerful.&lt;br&gt;
So it is not another &lt;a href=&#34;https://aws.amazon.com/devops-guru/&#34;&gt;DevOps Guru&lt;/a&gt;, believe me :)&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Yes, this is similar to the shells that GCE and Azure have.&lt;/li&gt;
&lt;li&gt;No, you can‚Äôt access your instances from it, so it‚Äôs not a jump server (bastion host).&lt;/li&gt;
&lt;li&gt;Yes, it has AWS CLI and other tools pre-installed. Even Python and Node.js.&lt;/li&gt;
&lt;li&gt;No, you can‚Äôt (well, you can, but should not) use it as an alternative to the day-to-day console on your laptop.&lt;/li&gt;
&lt;li&gt;Yes, you can manage all resources from that shell as much as your IAM permissions allow you (even with SSO, which is pretty cool).&lt;/li&gt;
&lt;li&gt;No, it does not support Docker.&lt;/li&gt;
&lt;li&gt;Yes, you have 1 GB of permanent storage and the ability to transfer files in and out.&lt;/li&gt;
&lt;/ul&gt;
&lt;h5 id=&#34;more-yes-and-nos-here&#34;&gt;More Yes and No‚Äôs here:&lt;/h5&gt;
&lt;p&gt;&lt;a href=&#34;https://docs.aws.amazon.com/cloudshell/latest/userguide/faq-list.html&#34;&gt;https://docs.aws.amazon.com/cloudshell/latest/userguide/faq-list.html&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://aws.amazon.com/cloudshell/faqs/&#34;&gt;https://aws.amazon.com/cloudshell/faqs/&lt;/a&gt;&lt;/p&gt;</content>
    </entry>
    <entry>
        <title>Terraform Workflow ‚Äî Working Individually and in a Team</title>
        <link href="https://devdosvid.blog/2020/09/16/terraform-workflow-working-individually-and-in-a-team/" hreflang="en" rel="alternate"/>
        <published>2020-09-16T00:00:00Z</published>
        <updated>2024-03-25T17:29:29Z</updated>
        <id>https://devdosvid.blog/2020/09/16/terraform-workflow-working-individually-and-in-a-team/</id>
        <author>
            <name>Serhii Vasylenko</name>
        </author>
        <logo>https://devdosvid.blog/2020/09/16/terraform-workflow-working-individually-and-in-a-team/cover-image.jpeg</logo>
        <content type="html">&lt;p&gt;The work with Terraform code may become tangled sometimes. Here are some guides on how to streamline it and make it transparent for you and your team.&lt;/p&gt;
&lt;p&gt;It is extremely helpful in a team, and can benefit you even if you work individually. A good workflow enables you to streamline a process, organize it, and make it less error-prone.&lt;/p&gt;
&lt;p&gt;This article summaries several approaches when working with Terraform, both individually and in a team. I tried to gather the most common ones, but you might also want to develop your own.&lt;/p&gt;
&lt;p&gt;The common requirement for all of them is a version control system (such as Git). This is how you ensure nothing is lost and all your code changes are properly versioned tracked.&lt;/p&gt;
&lt;h2 id=&#34;basic-concepts&#34;&gt;Basic Concepts&lt;/h2&gt;
&lt;p&gt;Let‚Äôs define the basic actions first.&lt;/p&gt;
&lt;p&gt;All described workflows are built on top of three key steps: Write, Plan, and Apply. Nevertheless, their details and actions vary between workflows.&lt;/p&gt;
&lt;figure&gt;




&lt;img loading=&#34;lazy&#34;
     src=&#34;tf-workflow.png&#34;
    alt=&#34;Basic 3-steps Terraform workflow&#34;width=&#34;800&#34;
height=&#34;89.88&#34;
/&gt; &lt;figcaption&gt;
    &lt;p&gt;Basic 3-steps Terraform workflow&lt;/p&gt;
&lt;/figcaption&gt;
&lt;/figure&gt;

&lt;p&gt;&lt;strong&gt;Write&lt;/strong&gt; ‚Äì this is where you make changes to the code.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Plan&lt;/strong&gt; ‚Äì this is where you review changes and decide whether to accept them.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Apply&lt;/strong&gt; ‚Äì this is where you accept changes and apply them against real infrastructure.&lt;/p&gt;
&lt;p&gt;It&amp;rsquo;s a simple idea with a variety of possible implementations.&lt;/p&gt;
&lt;h2 id=&#34;core-individual-workflow&#34;&gt;Core individual workflow&lt;/h2&gt;
&lt;p&gt;This is the most simple workflow if you work alone on a relatively small TF project. This workflow suits both local and remote backends well.&lt;/p&gt;
&lt;figure&gt;




&lt;img loading=&#34;lazy&#34;
     src=&#34;tf-workflow-individual.png&#34;
    alt=&#34;Git-based Terraform workflow&#34;width=&#34;800&#34;
height=&#34;267.41&#34;
/&gt; &lt;figcaption&gt;
    &lt;p&gt;Git-based Terraform workflow&lt;/p&gt;
&lt;/figcaption&gt;
&lt;/figure&gt;

&lt;h3 id=&#34;write&#34;&gt;Write&lt;/h3&gt;
&lt;p&gt;You clone the remote code repo or pull the latest changes, edit the configuration code, then run the &lt;code&gt;terraform validate&lt;/code&gt; and &lt;code&gt;terraform fmt&lt;/code&gt; commands to make sure your code works well.&lt;/p&gt;
&lt;h3 id=&#34;plan&#34;&gt;Plan&lt;/h3&gt;
&lt;p&gt;This is where you run the &lt;code&gt;terraform plan&lt;/code&gt; command to make sure that your changes do what you need. This is a good time to commit your code changes changes (or you can do it in the next step).&lt;/p&gt;
&lt;h3 id=&#34;apply&#34;&gt;Apply&lt;/h3&gt;
&lt;p&gt;This is when you run &lt;code&gt;terraform apply&lt;/code&gt; and introduce the changes to real infrastructure objects. Also, this is when you push committed changes to the remote repository.&lt;/p&gt;
&lt;h2 id=&#34;core-team-workflow&#34;&gt;Core team workflow&lt;/h2&gt;
&lt;p&gt;This workflow is good for when you work with configuration code in a team and want to use feature branches to manage the changes accurately.&lt;/p&gt;
&lt;figure&gt;




&lt;img loading=&#34;lazy&#34;
     src=&#34;tf-core-workflow-team.png&#34;
    alt=&#34;Git-based Terraform workflow in a team&#34;width=&#34;800&#34;
height=&#34;298.41&#34;
/&gt; &lt;figcaption&gt;
    &lt;p&gt;Git-based Terraform workflow in a team&lt;/p&gt;
&lt;/figcaption&gt;
&lt;/figure&gt;

&lt;h3 id=&#34;write-1&#34;&gt;Write&lt;/h3&gt;
&lt;p&gt;Start by checking out a new branch, make your changes, and run the &lt;code&gt;terraform validate&lt;/code&gt; and &lt;code&gt;terraform fmt&lt;/code&gt; commands to make sure your code works well.&lt;/p&gt;
&lt;p&gt;Running &lt;code&gt;terraform plan&lt;/code&gt; at this step will help ensure that you&amp;rsquo;ll get what you expect.&lt;/p&gt;
&lt;h3 id=&#34;plan-1&#34;&gt;Plan&lt;/h3&gt;
&lt;p&gt;This is where code and plan reviews happen.&lt;/p&gt;
&lt;p&gt;Add the output of the &lt;code&gt;terraform plan&lt;/code&gt; command to the Pull Request with your changes. It would be a good idea to add only the changed parts of the common output, which is the part that starts with &amp;ldquo;Terraform will perform the following actions&amp;rdquo; string.&lt;/p&gt;
&lt;h3 id=&#34;apply-1&#34;&gt;Apply&lt;/h3&gt;
&lt;p&gt;Once the PR is reviewed and merged to the upstream branch, it is safe to finally pull the upstream branch locally and apply the configuration with &lt;code&gt;terraform apply&lt;/code&gt;.&lt;/p&gt;
&lt;h2 id=&#34;team-workflow-with-automation&#34;&gt;Team workflow with automation&lt;/h2&gt;
&lt;p&gt;In a nutshell, this workflow allows you to introduce a kind of smoke test for your infrastructure code (using &lt;code&gt;plan&lt;/code&gt;) and also to automate the feedback in the CI process.&lt;/p&gt;
&lt;p&gt;The automated part of this workflow consists of a speculative plan on commit and/or Pull Request (PR ), along with adding the output of &lt;code&gt;plan&lt;/code&gt; to the comment of the PR. A speculative plan mean just to show the changes, and not apply them afterward.&lt;/p&gt;
&lt;figure&gt;




&lt;img loading=&#34;lazy&#34;
     src=&#34;tf-workflow-team-automation-1.png&#34;
    alt=&#34;Git-based Terraform workflow with automation&#34;width=&#34;800&#34;
height=&#34;272.90&#34;
/&gt; &lt;figcaption&gt;
    &lt;p&gt;Git-based Terraform workflow with automation&lt;/p&gt;
&lt;/figcaption&gt;
&lt;/figure&gt;

&lt;h3 id=&#34;write-2&#34;&gt;Write&lt;/h3&gt;
&lt;p&gt;This step is the same as in the previous workflow.&lt;/p&gt;
&lt;h3 id=&#34;plan-2&#34;&gt;Plan&lt;/h3&gt;
&lt;p&gt;This is where your CI tool does its job.&lt;/p&gt;
&lt;p&gt;Let‚Äôs review this step by step:&lt;/p&gt;
&lt;p&gt;1Ô∏è‚É£ You create a PR with the code changes you wish to implement.&lt;/p&gt;
&lt;p&gt;2Ô∏è‚É£ The CI pipeline is triggered by an event from your code repository (such as webhook push) and it runs a speculative plan against your code.&lt;/p&gt;
&lt;p&gt;3Ô∏è‚É£ The list of changes (a so-called &amp;ldquo;plan diff&amp;rdquo;) is added to PR for review by the CI.&lt;/p&gt;
&lt;p&gt;4Ô∏è‚É£ Once merged, the CI pipeline runs again and you get the final plan that&amp;rsquo;s ready to be applied to the infrastructure.&lt;/p&gt;
&lt;h3 id=&#34;apply-2&#34;&gt;Apply&lt;/h3&gt;
&lt;p&gt;Now that you have a branch (i.e. main) with the fresh code to apply, you need to pull it locally and run &lt;code&gt;terraform apply&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;You can also add the automated apply here ‚Äì step 5 in the picture below. This may be very useful for disposable environments such as testing, staging, development, and so on.&lt;/p&gt;
&lt;p&gt;The exact CI tool to be used here is up to you: Jenkins, GitHub Actions, and Travis CI all work well.&lt;/p&gt;
&lt;p&gt;An important thing to note is that the CI pipeline must be configured in a bi-directional way with your repository to get the code from it and report back with comments to PR.&lt;/p&gt;
&lt;p&gt;As an option, you may consider using Terraform Cloud which has a lot of functionality, including the above mentioned repo integration, even with the free subscription.&lt;/p&gt;
&lt;p&gt;If you have never worked with Terraform Cloud before and want to advice to get started, I&amp;rsquo;ll provide the links at the end of this article.&lt;/p&gt;
&lt;h2 id=&#34;import-workflow&#34;&gt;Import workflow&lt;/h2&gt;
&lt;p&gt;This workflow refers to a situation when you have some objects already created (i.e., up and running), and you need to manage them with Terraform.&lt;/p&gt;
&lt;p&gt;Suppose we already have an S3 bucket in AWS called &amp;ldquo;someassetsbucket&amp;rdquo; and we want to include it into our configuration code.‚Äå‚Äå&lt;/p&gt;
&lt;figure&gt;




&lt;img loading=&#34;lazy&#34;
     src=&#34;tf-workflow-import.png&#34;
    alt=&#34;Terraform resource import workflow&#34;width=&#34;800&#34;
height=&#34;238.20&#34;
/&gt; &lt;figcaption&gt;
    &lt;p&gt;Terraform resource import workflow&lt;/p&gt;
&lt;/figcaption&gt;
&lt;/figure&gt;

&lt;h3 id=&#34;prepare&#34;&gt;Prepare&lt;/h3&gt;
&lt;p&gt;You should create a resource block to be used later for the real object you‚Äôre going to import.&lt;/p&gt;
&lt;p&gt;You don‚Äôt need to fill the arguments in it at the start, so it may be just a blank resource block, for example:&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;resource &amp;#34;aws_s3_bucket&amp;#34; &amp;#34;someassetsbucket&amp;#34; {

}
&lt;/code&gt;&lt;/pre&gt;&lt;h3 id=&#34;import&#34;&gt;Import&lt;/h3&gt;
&lt;p&gt;Now you need to import the information about the real object into your existing Terraform state file.&lt;/p&gt;
&lt;p&gt;This can be done with the &lt;code&gt;terraform import&lt;/code&gt; command, for example:&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;terraform import aws_s3_bucket.assets &amp;#34;someassetsbucket&amp;#34;
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Be sure to also check the list of possible options import accepts with &lt;code&gt;terraform import -h&lt;/code&gt;&lt;/p&gt;
&lt;h3 id=&#34;write-3&#34;&gt;Write&lt;/h3&gt;
&lt;p&gt;Now you need to write the corresponding Terraform code for this bucket.&lt;/p&gt;
&lt;p&gt;To avoid modifying your real object on the &lt;code&gt;terraform apply&lt;/code&gt; action, you should specify all needed arguments with the exact values from the import phase.&lt;/p&gt;
&lt;p&gt;You can see the details by running the &lt;code&gt;terraform state show&lt;/code&gt; command, for example:&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;terraform state show aws_s3_bucket.assets
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;The output of this command will be very similar to the configuration code. But it contains both arguments and attributes of the resource, so you need to clean it up before applying it.&lt;/p&gt;
&lt;p&gt;You can use one of the following tactics:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;either copy/paste it, and then run &lt;code&gt;terraform validate&lt;/code&gt; and &lt;code&gt;terraform plan&lt;/code&gt; several times to make sure there are no errors like &amp;ldquo;argument is not expected here&amp;rdquo; or &amp;ldquo;this field cannot be set&amp;rdquo;&lt;/li&gt;
&lt;li&gt;or you can pick and write only the necessary arguments&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;In any case, be sure to refer to the documentation of the resource during this process.&lt;/p&gt;
&lt;h3 id=&#34;plan-3&#34;&gt;Plan&lt;/h3&gt;
&lt;p&gt;The goal is to have a &lt;code&gt;terraform plan&lt;/code&gt; output showing &amp;ldquo;~ update in-place&amp;rdquo; changes only.&lt;/p&gt;
&lt;p&gt;However, it is not always clear whether the real object will be modified or only the state file will be updated. This is why you should understand how a real object works and know its life cycle to make sure it is safe to apply the plan.&lt;/p&gt;
&lt;h3 id=&#34;apply-3&#34;&gt;Apply&lt;/h3&gt;
&lt;p&gt;This is usual the &lt;code&gt;terraform apply&lt;/code&gt; action.&lt;/p&gt;
&lt;p&gt;Once applied, your configuration and state file will correspond to the real object configuration.&lt;/p&gt;
&lt;h2 id=&#34;wrapping-up&#34;&gt;Wrapping up&lt;/h2&gt;
&lt;p&gt;Here is an overview of Terraform Cloud for those who never worked with it before: &lt;a href=&#34;https://www.terraform.io/docs/cloud/overview.html&#34;&gt;‚Äå‚ÄåOverview of Terraform Cloud Features&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;And here is a nice tutorial to start with: &lt;a href=&#34;https://learn.hashicorp.com/collections/terraform/cloud-get-started&#34;&gt;Get Started - Terraform Cloud&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;Also, here is an overview of workflows at scale from the HashiCorp CTO which might be useful for more experienced Terraform users: &lt;a href=&#34;https://www.hashicorp.com/resources/terraform-workflow-best-practices-at-scale&#34;&gt;Terraform Workflow Best Practices at Scale&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;Thank you for reading. I hope you will try one of these workflows, or develop your own!&lt;/p&gt;</content>
    </entry>
    <entry>
        <title>Terraform Certification Tips</title>
        <link href="https://devdosvid.blog/2020/09/15/terraform-certification-tips/" hreflang="en" rel="alternate"/>
        <published>2020-09-15T00:00:00Z</published>
        <updated>2024-03-25T17:29:29Z</updated>
        <id>https://devdosvid.blog/2020/09/15/terraform-certification-tips/</id>
        <author>
            <name>Serhii Vasylenko</name>
        </author>
        <logo>https://devdosvid.blog/2020/09/15/terraform-certification-tips/cover-image.png</logo>
        <content type="html">&lt;p&gt;I successfully passed the &amp;ldquo;HashiCorp Certified ‚Äî Terraform Associate&amp;rdquo; exam last Friday and decided to share some advice for exam preparation.&lt;/p&gt;
&lt;h2 id=&#34;make-yourself-a-plan&#34;&gt;Make yourself a plan&lt;/h2&gt;
&lt;p&gt;Make a list of things you are going to go through: links to the study materials, practice tasks, some labs, some articles on relative blogs (Medium, Dev.to, etc.).
It should look at a &amp;ldquo;todo&amp;rdquo; or &amp;ldquo;check&amp;rdquo;-list. It may seem silly at first glance, but the list with checkboxes does its &amp;ldquo;cognitive magic&amp;rdquo;. When you go point by point, marking items as &amp;ldquo;done&amp;rdquo;, you feel the progress and this motivates you to keep going further.
For example, you can make a plan from the resources I outlined below in this article.&lt;/p&gt;
&lt;p&gt;I encourage you to explore the Internet for something by yourself as well. Who knows, perhaps you will find some learning course that fits you better. And that is great! However, when you find it, take extra 5-10 minutes to go through its curriculum and create a list with lessons.&lt;/p&gt;
&lt;p&gt;It feels so nice to cross out items off the todo list, believe me üòÑ
&lt;figure&gt;




&lt;img loading=&#34;lazy&#34;
     src=&#34;todo-list.jpg&#34;width=&#34;585&#34;
height=&#34;540&#34;
/&gt; 
&lt;/figure&gt;
&lt;/p&gt;
&lt;h2 id=&#34;go-through-the-official-study-guide&#34;&gt;Go through the official Study Guide&lt;/h2&gt;
&lt;p&gt;Despite your findings on the Internet, I strongly suggest going through the official study guide&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://learn.hashicorp.com/tutorials/terraform/associate-study&#34;&gt;Study Guide - Terraform Associate Certification&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;It took me about 20 hours to complete it (including practice tasks based on topics in the guide), and it was the core of my studying. I did not buy or search for some third-party course intentionally because I did have some Terraform experience before starting the preparation. But give the official guide a chance even if you found some course. It is well-made and matches real exam questions very precisely.&lt;/p&gt;
&lt;p&gt;Also, there is an official &lt;a href=&#34;https://learn.hashicorp.com/tutorials/terraform/associate-review&#34;&gt;Exam Review&lt;/a&gt;. Someone might find this even better because it is a direct mapping of each exam objective to HashiCorp&amp;rsquo;s documentation and training.&lt;/p&gt;
&lt;h2 id=&#34;take-additional-tutorials&#34;&gt;Take additional tutorials&lt;/h2&gt;
&lt;p&gt;Here is a list of additional tutorials and materials I suggest adding into your learning program:&lt;/p&gt;
&lt;h4 id=&#34;official-guides--documentation&#34;&gt;Official guides / documentation:&lt;/h4&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://learn.hashicorp.com/collections/terraform/automation&#34;&gt;Automate Terraform&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://learn.hashicorp.com/collections/terraform/cloud&#34;&gt;Collaborate using Terraform Cloud&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://learn.hashicorp.com/collections/terraform/0-13&#34;&gt;Terraform tutorials&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://learn.hashicorp.com/collections/terraform/modules&#34;&gt;Reuse Configuration with Modules&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://www.hashicorp.com/resources/a-practitioner-s-guide-to-using-hashicorp-terraform-cloud-with-github&#34;&gt;A Practitioner‚Äôs Guide to Using HashiCorp Terraform Cloud with GitHub&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://learn.hashicorp.com/collections/terraform/policy&#34;&gt;Enforce Policy with Sentinel&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h4 id=&#34;third-party-articles-and-guides&#34;&gt;Third-party articles and guides:&lt;/h4&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://prefetch.net/blog/2020/04/27/using-the-terraform-console-to-debug-interpolation-syntax/&#34;&gt;Using the terraform console to debug interpolation syntax&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://www.youtube.com/playlist?list=PL5VXZTK6spA2HF5Kf0rI9RDRHF9Hopffr&#34;&gt;YouTube playlist with exam-like questions review&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;find-yourself-some-practice&#34;&gt;Find yourself some practice&lt;/h2&gt;
&lt;h4 id=&#34;mockup-a-project&#34;&gt;Mockup a project&lt;/h4&gt;
&lt;p&gt;You can greatly improve your practice by mocking some real business cases.&lt;/p&gt;
&lt;p&gt;If you already work in some company you can set up the project you&amp;rsquo;re working with using Terraform. If you don‚Äôt have a real project or afraid to accidentally violate NDA, try this open-source demo project: &lt;a href=&#34;https://github.com/gothinkster/realworld&#34;&gt;Real World Example Apps&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;It is a collection of different codebases for front-end and back-end used to build the same project. Just find the combination that suits your experience better and try to build the infrastructure for it using Terraform.&lt;/p&gt;
&lt;figure&gt;




&lt;img loading=&#34;lazy&#34;
     src=&#34;real-world-demo.jpg&#34;width=&#34;585&#34;
height=&#34;405&#34;
/&gt; 
&lt;/figure&gt;

&lt;h4 id=&#34;answer-forum-topics&#34;&gt;Answer forum topics&lt;/h4&gt;
&lt;p&gt;Last but not least advice ‚Äî try to answer some questions on the official &lt;a href=&#34;https://discuss.hashicorp.com/c/terraform-core/&#34;&gt;Terraform forum&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;This is a nice way to test your knowledge, help others, and develop the community around Terraform. Just register there, look for the latest topics, and have fun!&lt;/p&gt;
&lt;figure&gt;




&lt;img loading=&#34;lazy&#34;
     src=&#34;tf-forum.jpg&#34;width=&#34;585&#34;
height=&#34;650&#34;
/&gt; 
&lt;/figure&gt;

&lt;p&gt;üçÄ I sincerely wish you exciting preparation and a successful exam! üçÄ&lt;/p&gt;</content>
    </entry>
</feed>