<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Some Techniques to Enhance Your Terraform Proficiency | Serhii Vasylenko â€” Technical Blog</title><meta name=keywords content="terraform,experience,guide"><meta name=description content="Learn what cool things Terraform can do with its built-in functionality"><meta name=author content="Serhii Vasylenko"><link rel=canonical href=https://serhii.vasylenko.info/2022/01/16/some-techniques-to-enhance-your-terraform-proficiency/><link crossorigin=anonymous href=/assets/css/stylesheet.min.29d7575f68709dea8cc6bc05d13a22101a472c50627f31e11d6f0170e69b4ccf.css integrity="sha256-KddXX2hwneqMxrwF0ToiEBpHLFBifzHhHW8BcOabTM8=" rel="preload stylesheet" as=style><link rel=preload href=/apple-touch-icon.png as=image><script defer crossorigin=anonymous src=/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5+kdJvBz5iKbt6B5PJI=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://serhii.vasylenko.info/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://serhii.vasylenko.info/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://serhii.vasylenko.info/favicon-32x32.png><link rel=apple-touch-icon href=https://serhii.vasylenko.info/apple-touch-icon.png><link rel=mask-icon href=https://serhii.vasylenko.info/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.91.2"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-GK7SE0XWGK"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-GK7SE0XWGK',{anonymize_ip:!1})}</script><meta property="og:title" content="Some Techniques to Enhance Your Terraform Proficiency"><meta property="og:description" content="Learn what cool things Terraform can do with its built-in functionality"><meta property="og:type" content="article"><meta property="og:url" content="https://serhii.vasylenko.info/2022/01/16/some-techniques-to-enhance-your-terraform-proficiency/"><meta property="og:image" content="https://serhii.vasylenko.info/2022/01/16/some-techniques-to-enhance-your-terraform-proficiency/cover-image.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-01-16T01:59:51+02:00"><meta property="article:modified_time" content="2022-01-16T01:59:51+02:00"><meta property="og:site_name" content="Serhii Vasylenko â€” Technical Blog"><meta property="og:see_also" content="https://serhii.vasylenko.info/2021/11/24/guide-to-using-terraform-in-ci/cd/"><meta property="og:see_also" content="https://serhii.vasylenko.info/2020/08/25/terraform-cli-shortcuts.html"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://serhii.vasylenko.info/2022/01/16/some-techniques-to-enhance-your-terraform-proficiency/cover-image.png"><meta name=twitter:title content="Some Techniques to Enhance Your Terraform Proficiency"><meta name=twitter:description content="Learn what cool things Terraform can do with its built-in functionality"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://serhii.vasylenko.info/posts/"},{"@type":"ListItem","position":3,"name":"Some Techniques to Enhance Your Terraform Proficiency","item":"https://serhii.vasylenko.info/2022/01/16/some-techniques-to-enhance-your-terraform-proficiency/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Some Techniques to Enhance Your Terraform Proficiency","name":"Some Techniques to Enhance Your Terraform Proficiency","description":"Learn what cool things Terraform can do with its built-in functionality","keywords":["terraform","experience","guide"],"articleBody":"Terraform built-in functionality is very feature-rich: functions, expressions, and meta-arguments provide many ways to shape the code and fit it to a particular use case. I want to share a few valuable practices to boost your Terraform expertise in this blog.\nSome code examples in this article will work with Terraform version 0.15 and onwards. But if youâ€™re still using 0.14 or lower, hereâ€™s another motivation for you to upgrade.  Conditional resources creation   Letâ€™s start from the most popular one (although, still may be new for somebody): whether to create a resource depending on some fact, e.g., the value of a variable. Terraform meta-argument count helps to describe that kind of logic.\nHere is how it may look like:\ndata \"aws_ssm_parameter\" \"ami_id\" { count = var.ami_channel == \"\" ? 0 : 1 name = local.ami_channels[var.ami_channel] } The notation var.ami_channel == \"\" ? 0 : 1 is called conditional expression and means the following: if my variable is empty (var.ami_channel == \"\" â€” hence, true) then set the count to 0, otherwise set to 1.\ncondition ? true_val : false_val In this illustration, I want to get the AMI ID from the SSM Parameter only if the AMI channel (e.g., beta or alpha) is specified. Otherwise, providing that the ami_channel variable is an empty string by default (\"\"), the data source should not be created.\nWhen following this method, keep in mind that the resource address will contain the index identifier. So when I need to use the value of the SSM parameter from our example, I need to reference it the following way:\nami_id = data.aws_ssm_parameter.ami_id[0].value The count meta-argument can also be used when you need to conditionally create a Terraform module.\nmodule \"bucket\" { count = var.create_bucket == true ? 1 : 0 source = \"./modules/s3_bucket\" name = \"my-unique-bucket\" ... } The var.create_bucket == true ? 1 : 0 expression can be written even shorter: var.create_bucket ? 1 : 0 because the create_bucket variable has boolean type, apparently.\nBut what if you need to produce more than one instance of a resource or module? And still be able to avoid their creation.\nAnother meta-argument â€” for_each â€” will do the trick.\nFor example, this is how it looks for a module:\nmodule \"bucket\" { for_each = var.bucket_names == [] ? [] : var.bucket_names source = \"./modules/s3_bucket\" name = \"${each.key}\" enable_encryption = true ... } In this illustration, I also used a conditional expression that makes Terraform iterate through the set of values of var.bucket_names if itâ€™s not empty and create several modules. Otherwise, do not iterate at all and do not create anything.\nThe same can be done for the resources. For example, when you need to create an arbitrary number of security group rules, e.g., to allowlist some IPs for your bastion host:\nresource \"aws_security_group_rule\" \"allowlist\" { for_each = var.cidr_blocks == [] ? [] : var.cidr_blocks type = \"ingress\" from_port = 22 to_port = 22 protocol = \"tcp\" cidr_blocks = [each.value] security_group_id = aws_security_group.bastion.id } And just like with the count meta-argument, with the for_each, resource addresses will have the identifier named by the values provided to for_each. For example, here is how I would reference a resource created in the module with for_each described earlier:\nbucket_name = module.bucket[\"photos\"].name Conditional resource arguments (attributes) setting   Now letâ€™s go deeper and see how resource arguments can be conditionally set (or not). First, letâ€™s review the conditional argument value setting with the null data type:\nresource \"aws_launch_template\" \"this\" { name = \"my-launch-template\" ... key_name = var.use_default_keypair ? var.keypair_name : null ... Here I want to skip the usage of the EC2 Key Pair for the Launch Template in some instances and Terraform allows me to write the conditional expression that will set the null value for the argument. It means the absence or omission and Terraform would behave the same as if you did not specify the argument at all.\nDynamic blocks are another case where conditional creation suits best. Take a look at the following piece of CloudFront resource code where I want to either describe the configuration for the custom error response or omit that completely:\nresource \"aws_cloudfront_distribution\" \"cdn\" { enabled = true ... dynamic \"custom_error_response\" { for_each = var.custom_error_response == null ? [] : [var.custom_error_response] iterator = cer content { error_code =lookup(cer.value, \"error_code\", null) error_caching_min_ttl =lookup(cer.value, \"error_caching_min_ttl\", null) response_code =lookup(cer.value, \"response_code\", null) response_page_path =lookup(cer.value, \"response_page_path\", null) } } ... } The custom_error_response variable is null by default, but it has the object type, and users can assign the variable with the required nested specifications if needed. And when they do it, Terraform will add the custom_error_response block to the resource configuration. Otherwise, it will be omitted entirely.\nConvert types with ease   Ok, letâ€™s move to the less conditional things now ðŸ˜…\nTerraform has several type conversion functions: tobool(), tolist(),tomap(), tonumber(), toset(), and tostring(). Their purpose is to convert the input values to the compatible types.\nFor example, suppose I need to pass the set to the for_each (it accepts only sets and maps types of value), but I got the list as an input; letâ€™s say I got it as an output from another module. In such a case, I would do something like this:\nfor_each = toset(var.remote_access_ports) However, I can make my code cleaner and avoid the explicit conversion â€” I just need to define the value type in the configuration block of the my_list variable. Terraform will do the conversion automatically when the value is assigned.\nvariable \"remote_access_ports\" { description = \"Ports for remote access\" type = set(string) } While Terraform can do a lot of implicit conversions for you, explicit type conversions are practical during values normalization or when you need to calculate some complex value for a variable. For example, the Local Values, known as locals, are the most suitable place for doing that.\nBy the way, although there is a tolist() function, there is no such thing as the tostring() function. But what if you need to convert the list to string in Terraform?\nThe one() function can help here: it takes a list, set, or tuple value with either zero or one element and returns either null or that one element in the form of string.\nItâ€™s useful in cases when a resource created using conditional expression is represented as either a zero- or one-element list, and you need to get a single value which may be either null or string, for example:\nresource \"aws_kms_key\" \"main\" { count = var.ebs_encrypted ? 1 : 0 enable_key_rotation = true tags = var.tags } resource \"aws_kms_alias\" \"main\" { count = var.ebs_encrypted ? 1 : 0 name = \"alias/encrypt-ebs\" target_key_id = one(aws_kms_key.main[*]key_id) } Write YAML or JSON as Terraform code (HCL)   Sometimes you need to supply JSON or YAML files to the services you manage with Terraform. For example, if you want to create something with CloudFormation using Terraform (and I am not kidding). Sometimes the AWS Terraform provider does not support the needed resource, and you want to maintain the whole infrastructure code using only one tool.\nInstead of maintaining another file in JSON or YAML format, you can embed JSON or YAML code management into HCL by taking benefit of the jsonencode() or yamlencode() functions.\nThe attractiveness of this approach is that you can reference other Terraform resources or their attributes right in the code of your object, and you have more freedom in terms of the code syntax and its formatting comparable to native JSON or YAML.\nHere is how it looks like:\nlocals { some_string = \"ult\" myjson_object =jsonencode({ \"Hashicorp Products\": { Terra: \"form\" Con: \"sul\" Vag: \"rant\" Va: local.some_string } }) } The value of the myjson_object local variable would look like this:\n{ \"Hashicorp Products\": { \"Con\": \"sul\", \"Terra\": \"form\", \"Va\": \"ult\", \"Vag\": \"rant\" } } And here is a piece of real-world example:\nlocals { cf_template_body =jsonencode({ Resources : { DedicatedHostGroup : { Type : \"AWS::ResourceGroups::Group\" Properties : { Name : var.service_name Configuration : [ { Type : \"AWS::EC2::HostManagement\" Parameters : [ { Name : \"auto-allocate-host\" Values : [var.auto_allocate_host] }, ... ... Templatize stuff   The last case in this blog but not the least by its efficacy â€” render source file content as a template in Terraform.\nLetâ€™s review the following scenario: you launch an EC2 instance and want to supply it with a bash script (via the user-data parameter) for some additional configuration at launch.\nSuppose we have the following bash script instance-init.sh that sets the hostname and registers our instance in a monitoring system:\n#!/bin/bash  hostname example.com bash /opt/system-init/register-monitoring.sh But what if you want to set a different hostname per instance, and some instances should not be registered in the monitoring system?\nIn such a case, here is how the script file content will look:\n#!/bin/bash hostname ${system_hostname} %{ if register_monitoring } bash /opt/system-init/register-monitoring.sh %{endif} And when you supply this file as an argument for the EC2 instance resource in Terraform, you will use the templatefile() function to make the magic happen:\nresource \"aws_instance\" \"web\" { ami = var.my_ami_id instance_type = var.instance_type ... user_data = templatefile(\"${path.module}/instance-init.tftpl\", { system_hostname = var.system_hostname register_monitoring = var.add_to_monitoring }) ... } And of course, you can create a template from any file type. The only requirement here is that the template file must exist on the disk at the beginning of the Terraform execution.\nKey takeaways Terraform is far beyond the standard resource management operations. With the power of built-in functions, you can write more versatile code and reusable Terraform modules.\nâœ… Use conditional expressions with count and for_each meta-arguments, when the creation of a resource depends on some context or user input.\nâœ… Take advantage of implicit type conversion when working with input variables and their values to keep your code cleaner.\nâœ… Embed YAML and JSON-based objects right into your Terraform code using built-in encoding functions.\nâœ… And when you need to pass some files to the managed service, you can treat them as templates and make them multipurpose.\nThank you for reading down to this point! ðŸ¤—\nIf you have some favorite Terraform tricks â€” I would love to know!\n","wordCount":"1681","inLanguage":"en","image":"https://serhii.vasylenko.info/2022/01/16/some-techniques-to-enhance-your-terraform-proficiency/cover-image.png","datePublished":"2022-01-16T01:59:51+02:00","dateModified":"2022-01-16T01:59:51+02:00","author":{"@type":"Person","name":"Serhii Vasylenko"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://serhii.vasylenko.info/2022/01/16/some-techniques-to-enhance-your-terraform-proficiency/"},"publisher":{"@type":"Person","name":"Serhii Vasylenko â€” Technical Blog","logo":{"@type":"ImageObject","url":"https://serhii.vasylenko.info/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script><header class=header><nav class=nav><div class=logo><a href=https://serhii.vasylenko.info accesskey=h title="Home (Alt + H)"><img src=https://serhii.vasylenko.info/apple-touch-icon.png alt=logo aria-label=logo height=" 30px">Home</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://serhii.vasylenko.info/index.xml title="RSS Feed ðŸ“°"><span>RSS Feed ðŸ“°</span></a></li><li><a href=https://serhii.vasylenko.info/about/ title="About me"><span>About me</span></a></li><li><a href=https://serhii.vasylenko.info/cv/ title="My CV"><span>My CV</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://serhii.vasylenko.info>Home</a>&nbsp;Â»&nbsp;<a href=https://serhii.vasylenko.info/posts/>Posts</a></div><h1 class=post-title>Some Techniques to Enhance Your Terraform Proficiency</h1><div class=post-description>Learn what cool things Terraform can do with its built-in functionality</div><div class=post-meta><span title="2022-01-16 01:59:51 +0200 +0200">January 16, 2022</span>&nbsp;Â·&nbsp;Serhii Vasylenko&nbsp;|&nbsp;<a href=mailto:email-from-blog@vasylenko.info rel="noopener noreferrer" target=_blank>ðŸ“© Suggest Changes</a></div></header><figure class=entry-cover><img loading=lazy srcset="https://serhii.vasylenko.info/2022/01/16/some-techniques-to-enhance-your-terraform-proficiency/cover-image_hu634978e7e6936d2b035fbfc539466d35_63299_360x0_resize_box_3.png 360w ,https://serhii.vasylenko.info/2022/01/16/some-techniques-to-enhance-your-terraform-proficiency/cover-image_hu634978e7e6936d2b035fbfc539466d35_63299_480x0_resize_box_3.png 480w ,https://serhii.vasylenko.info/2022/01/16/some-techniques-to-enhance-your-terraform-proficiency/cover-image_hu634978e7e6936d2b035fbfc539466d35_63299_720x0_resize_box_3.png 720w ,https://serhii.vasylenko.info/2022/01/16/some-techniques-to-enhance-your-terraform-proficiency/cover-image_hu634978e7e6936d2b035fbfc539466d35_63299_1080x0_resize_box_3.png 1080w ,https://serhii.vasylenko.info/2022/01/16/some-techniques-to-enhance-your-terraform-proficiency/cover-image_hu634978e7e6936d2b035fbfc539466d35_63299_1500x0_resize_box_3.png 1500w ,https://serhii.vasylenko.info/2022/01/16/some-techniques-to-enhance-your-terraform-proficiency/cover-image.png 2400w" sizes="(min-width: 768px) 720px, 100vw" src=https://serhii.vasylenko.info/2022/01/16/some-techniques-to-enhance-your-terraform-proficiency/cover-image.png alt width=2400 height=1200></figure><div class=post-content><p>Terraform built-in functionality is very feature-rich: functions, expressions, and meta-arguments provide many ways to shape the code and fit it to a particular use case. I want to share a few valuable practices to boost your Terraform expertise in this blog.</p><div class=attention>Some code examples in this article will work with Terraform version 0.15 and onwards. But if you&rsquo;re still using 0.14 or lower, here&rsquo;s another motivation for you to upgrade.</div><h2 id=conditional-resources-creation>Conditional resources creation<a hidden class=anchor aria-hidden=true href=#conditional-resources-creation>#</a></h2><p><figure><img loading=lazy src=condiitonal-resource-creation.png></figure>Let&rsquo;s start from the most popular one (although, still may be new for somebody): whether to create a resource depending on some fact, e.g., the value of a variable. Terraform meta-argument <code>count</code> helps to describe that kind of logic.</p><p>Here is how it may look like:</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-terraform data-lang=terraform><span style=color:#6ab825;font-weight:700>data</span> <span style=color:#ed9d13>&#34;aws_ssm_parameter&#34;</span> <span style=color:#ed9d13>&#34;ami_id&#34;</span> {
  <span style=color:#bbb>count</span>    = <span style=color:#24909d>var</span>.<span style=color:#bbb>ami_channel</span> == <span style=color:#ed9d13>&#34;&#34;</span> ? <span style=color:#3677a9>0</span> : <span style=color:#3677a9>1</span>

  <span style=color:#bbb>name</span>     = local.ami_channels[<span style=color:#24909d>var</span>.ami_channel]
}
</code></pre></div><p>The notation <code>var.ami_channel == "" ? 0 : 1</code> is called <em>conditional expression</em> and means the following: if my variable is empty (<code>var.ami_channel == ""</code> â€” hence, true) then set the count to 0, otherwise set to 1.</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>condition ? true_val : false_val
</code></pre></div><p>In this illustration, I want to get the AMI ID from the SSM Parameter only if the AMI channel (e.g., beta or alpha) is specified. Otherwise, providing that the <code>ami_channel</code> variable is an empty string by default (""), the data source should not be created.</p><p>When following this method, keep in mind that the resource address will contain the index identifier. So when I need to use the value of the SSM parameter from our example, I need to reference it the following way:</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-terraform data-lang=terraform><span style=color:#bbb>ami_id</span> = <span style=color:#24909d>data</span>.aws_ssm_parameter.ami_id[<span style=color:#3677a9>0</span>].value
</code></pre></div><p>The <code>count</code> meta-argument can also be used when you need to conditionally create a Terraform module.</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-terraform data-lang=terraform><span style=color:#6ab825;font-weight:700>module</span> <span style=color:#ed9d13>&#34;bucket&#34;</span> {
  <span style=color:#bbb>count</span>             = <span style=color:#24909d>var</span>.<span style=color:#bbb>create_bucket</span> == <span style=color:#6ab825;font-weight:700>true</span> ? <span style=color:#3677a9>1</span> : <span style=color:#3677a9>0</span>
  <span style=color:#bbb>source</span>            = <span style=color:#ed9d13>&#34;./modules/s3_bucket&#34;</span>

  <span style=color:#bbb>name</span>              = <span style=color:#ed9d13>&#34;my-unique-bucket&#34;</span>
  ...
}
</code></pre></div><p>The <code>var.create_bucket == true ? 1 : 0</code> expression can be written even shorter: <code>var.create_bucket ? 1 : 0</code> because the <code>create_bucket</code> variable has boolean type, apparently.</p><p>But what if you need to produce more than one instance of a resource or module? And still be able to avoid their creation.</p><p>Another meta-argument â€” <code>for_each</code> â€” will do the trick.</p><p>For example, this is how it looks for a module:</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-terraform data-lang=terraform><span style=color:#6ab825;font-weight:700>module</span> <span style=color:#ed9d13>&#34;bucket&#34;</span> {
  <span style=color:#bbb>for_each</span>          = <span style=color:#24909d>var</span>.<span style=color:#bbb>bucket_names</span> == [] ? [] : <span style=color:#24909d>var</span>.bucket_names
  <span style=color:#bbb>source</span>            = <span style=color:#ed9d13>&#34;./modules/s3_bucket&#34;</span>
  
  <span style=color:#bbb>name</span>              = <span style=color:#ed9d13>&#34;</span><span style=color:#ed9d13>${</span><span style=color:#24909d>each</span>.key<span style=color:#ed9d13>}</span><span style=color:#ed9d13>&#34;</span>
  <span style=color:#bbb>enable_encryption</span> = <span style=color:#6ab825;font-weight:700>true</span>
  ...
}
</code></pre></div><p>In this illustration, I also used a conditional expression that makes Terraform iterate through the set of values of <code>var.bucket_names</code> if it&rsquo;s not empty and create several modules. Otherwise, do not iterate at all and do not create anything.</p><p>The same can be done for the resources. For example, when you need to create an arbitrary number of security group rules, e.g., to allowlist some IPs for your bastion host:</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-terraform data-lang=terraform><span style=color:#6ab825;font-weight:700>resource</span> <span style=color:#ed9d13>&#34;aws_security_group_rule&#34;</span> <span style=color:#ed9d13>&#34;allowlist&#34;</span> {
  <span style=color:#bbb>for_each</span>           = <span style=color:#24909d>var</span>.<span style=color:#bbb>cidr_blocks</span> == [] ? [] : <span style=color:#24909d>var</span>.cidr_blocks
  <span style=color:#bbb>type</span>               = <span style=color:#ed9d13>&#34;ingress&#34;</span>
  <span style=color:#bbb>from_port</span>          = <span style=color:#3677a9>22</span>
  <span style=color:#bbb>to_port</span>            = <span style=color:#3677a9>22</span>
  <span style=color:#bbb>protocol</span>           = <span style=color:#ed9d13>&#34;tcp&#34;</span>
  <span style=color:#bbb>cidr_blocks</span>        = [<span style=color:#24909d>each</span>.value]
  <span style=color:#bbb>security_group_id</span>  = aws_security_group.bastion.id
}
</code></pre></div><p>And just like with the <code>count</code> meta-argument, with the <code>for_each</code>, resource addresses will have the identifier named by the values provided to <code>for_each</code>.
For example, here is how I would reference a resource created in the module with <code>for_each</code> described earlier:</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-terraform data-lang=terraform><span style=color:#bbb>bucket_name</span> = <span style=color:#24909d>module</span>.bucket[<span style=color:#ed9d13>&#34;photos&#34;</span>].name
</code></pre></div><h2 id=conditional-resource-arguments-attributes-setting>Conditional resource arguments (attributes) setting<a hidden class=anchor aria-hidden=true href=#conditional-resource-arguments-attributes-setting>#</a></h2><figure><img loading=lazy src=conditional-resource-argument.png></figure><p>Now let&rsquo;s go deeper and see how resource arguments can be conditionally set (or not).
First, let&rsquo;s review the conditional argument value setting with the <code>null</code> data type:</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-terraform data-lang=terraform><span style=color:#6ab825;font-weight:700>resource</span> <span style=color:#ed9d13>&#34;aws_launch_template&#34;</span> <span style=color:#ed9d13>&#34;this&#34;</span> {
  <span style=color:#bbb>name</span>     = <span style=color:#ed9d13>&#34;my-launch-template&#34;</span>
  ...
  <span style=color:#bbb>key_name</span> = <span style=color:#24909d>var</span>.use_default_keypair ? <span style=color:#24909d>var</span>.keypair_name : null
  ...
</code></pre></div><p>Here I want to skip the usage of the EC2 Key Pair for the Launch Template in some instances and Terraform allows me to write the conditional expression that will set the <code>null</code> value for the argument. It means the <em>absence</em> or <em>omission</em> and Terraform would behave the same as if you did not specify the argument at all.</p><p>Dynamic blocks are another case where conditional creation suits best. Take a look at the following piece of CloudFront resource code where I want to either describe the configuration for the custom error response or omit that completely:</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-terraform data-lang=terraform><span style=color:#6ab825;font-weight:700>resource</span> <span style=color:#ed9d13>&#34;aws_cloudfront_distribution&#34;</span> <span style=color:#ed9d13>&#34;cdn&#34;</span> {
  <span style=color:#bbb>enabled</span> = <span style=color:#6ab825;font-weight:700>true</span>
  ...
  dynamic <span style=color:#ed9d13>&#34;custom_error_response&#34;</span> {
    <span style=color:#bbb>for_each</span> = <span style=color:#24909d>var</span>.<span style=color:#bbb>custom_error_response</span> == null ? [] : [<span style=color:#24909d>var</span>.custom_error_response]
    <span style=color:#bbb>iterator</span> = cer
    content {
      <span style=color:#bbb>error_code</span>            =<span style=color:#24909d> lookup</span>(cer.value, <span style=color:#ed9d13>&#34;error_code&#34;</span>, null)
      <span style=color:#bbb>error_caching_min_ttl</span> =<span style=color:#24909d> lookup</span>(cer.value, <span style=color:#ed9d13>&#34;error_caching_min_ttl&#34;</span>, null)
      <span style=color:#bbb>response_code</span>         =<span style=color:#24909d> lookup</span>(cer.value, <span style=color:#ed9d13>&#34;response_code&#34;</span>, null)
      <span style=color:#bbb>response_page_path</span>    =<span style=color:#24909d> lookup</span>(cer.value, <span style=color:#ed9d13>&#34;response_page_path&#34;</span>, null)
    }
  }
  ...
}
</code></pre></div><p>The <code>custom_error_response</code> variable is <code>null</code> by default, but it has the <code>object</code> type, and users can assign the variable with the required nested specifications if needed. And when they do it, Terraform will add the <code>custom_error_response</code> block to the resource configuration. Otherwise, it will be omitted entirely.</p><h2 id=convert-types-with-ease>Convert types with ease<a hidden class=anchor aria-hidden=true href=#convert-types-with-ease>#</a></h2><p><figure><img loading=lazy src=types-converstion.png></figure>Ok, let&rsquo;s move to the less conditional things now ðŸ˜…</p><p>Terraform has several type conversion functions: <code>tobool()</code>, <code>tolist()</code>,<code>tomap()</code>, <code>tonumber()</code>, <code>toset()</code>, and <code>tostring()</code>. Their purpose is to convert the input values to the compatible types.</p><p>For example, suppose I need to pass the set to the <code>for_each</code> (it accepts only sets and maps types of value), but I got the list as an input; let&rsquo;s say I got it as an output from another module. In such a case, I would do something like this:</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-terraform data-lang=terraform><span style=color:#bbb>for_each</span> = <span style=color:#24909d>toset</span>(<span style=color:#24909d>var</span>.remote_access_ports)
</code></pre></div><p>However, I can make my code cleaner and avoid the explicit conversion â€” I just need to define the value type in the configuration block of the <code>my_list</code> variable. Terraform will do the conversion automatically when the value is assigned.</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-terraform data-lang=terraform><span style=color:#6ab825;font-weight:700>variable</span> <span style=color:#ed9d13>&#34;remote_access_ports&#34;</span> {
  <span style=color:#bbb>description</span> = <span style=color:#ed9d13>&#34;Ports for remote access&#34;</span>
  <span style=color:#bbb>type</span>        = set(string)
}
</code></pre></div><p>While Terraform can do a lot of implicit conversions for you, explicit type conversions are practical during values normalization or when you need to calculate some complex value for a variable. For example, the Local Values, known as <code>locals</code>, are the most suitable place for doing that.</p><p>By the way, although there is a <code>tolist()</code> function, there is no such thing as the <code>tostring()</code> function. But what if you need to convert the list to string in Terraform?</p><p>The <code>one()</code> function can help here: it takes a list, set, or tuple value with either zero or one element and returns either <code>null</code> or that one element in the form of string.</p><p>It&rsquo;s useful in cases when a resource created using conditional expression is represented as either a zero- or one-element list, and you need to get a single value which may be either <code>null</code> or <code>string</code>, for example:</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-terraform data-lang=terraform><span style=color:#6ab825;font-weight:700>resource</span> <span style=color:#ed9d13>&#34;aws_kms_key&#34;</span> <span style=color:#ed9d13>&#34;main&#34;</span> {
  <span style=color:#bbb>count</span>               = <span style=color:#24909d>var</span>.ebs_encrypted ? <span style=color:#3677a9>1</span> : <span style=color:#3677a9>0</span>

  <span style=color:#bbb>enable_key_rotation</span> = <span style=color:#6ab825;font-weight:700>true</span>
  <span style=color:#bbb>tags</span>                = <span style=color:#24909d>var</span>.tags
}
<span style=color:#6ab825;font-weight:700>
</span><span style=color:#6ab825;font-weight:700>resource</span> <span style=color:#ed9d13>&#34;aws_kms_alias&#34;</span> <span style=color:#ed9d13>&#34;main&#34;</span> {
  <span style=color:#bbb>count</span>         = <span style=color:#24909d>var</span>.ebs_encrypted ? <span style=color:#3677a9>1</span> : <span style=color:#3677a9>0</span>

  <span style=color:#bbb>name</span>          = <span style=color:#ed9d13>&#34;alias/encrypt-ebs&#34;</span>
  <span style=color:#bbb>target_key_id</span> = one(aws_kms_key.main[*]key_id)
}

</code></pre></div><h2 id=write-yaml-or-json-as-terraform-code-hcl>Write YAML or JSON as Terraform code (HCL)<a hidden class=anchor aria-hidden=true href=#write-yaml-or-json-as-terraform-code-hcl>#</a></h2><p><figure><img loading=lazy src=write-yaml-json-as-terraform-code.png></figure>Sometimes you need to supply JSON or YAML files to the services you manage with Terraform. For example, if you want to create something with CloudFormation using Terraform (and I am not kidding). Sometimes the AWS Terraform provider does not support the needed resource, and you want to maintain the whole infrastructure code using only one tool.</p><p>Instead of maintaining another file in JSON or YAML format, you can embed JSON or YAML code management into HCL by taking benefit of the <code>jsonencode()</code> or <code>yamlencode()</code> functions.</p><p>The attractiveness of this approach is that you can reference other Terraform resources or their attributes right in the code of your object, and you have more freedom in terms of the code syntax and its formatting comparable to native JSON or YAML.</p><p>Here is how it looks like:</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-terraform data-lang=terraform>locals {
	<span style=color:#bbb>some_string</span> = <span style=color:#ed9d13>&#34;ult&#34;</span>
  <span style=color:#bbb>myjson_object</span> =<span style=color:#24909d> jsonencode</span>({
    <span style=color:#ed9d13>&#34;Hashicorp Products&#34;</span>: {
      Terra: <span style=color:#ed9d13>&#34;form&#34;</span>
      Con:   <span style=color:#ed9d13>&#34;sul&#34;</span>
      Vag:   <span style=color:#ed9d13>&#34;rant&#34;</span>
      Va:    local.some_string
    }
  })
}
</code></pre></div><p>The value of the <code>myjson_object</code> local variable would look like this:</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>{
  <span style=color:#6ab825;font-weight:700>&#34;Hashicorp Products&#34;</span>: {
    <span style=color:#6ab825;font-weight:700>&#34;Con&#34;</span>: <span style=color:#ed9d13>&#34;sul&#34;</span>,
    <span style=color:#6ab825;font-weight:700>&#34;Terra&#34;</span>: <span style=color:#ed9d13>&#34;form&#34;</span>,
    <span style=color:#6ab825;font-weight:700>&#34;Va&#34;</span>: <span style=color:#ed9d13>&#34;ult&#34;</span>,
    <span style=color:#6ab825;font-weight:700>&#34;Vag&#34;</span>: <span style=color:#ed9d13>&#34;rant&#34;</span>
  }
}
</code></pre></div><p>And here is a piece of real-world example:</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-terraform data-lang=terraform>locals {
  <span style=color:#bbb>cf_template_body</span> =<span style=color:#24909d> jsonencode</span>({
    Resources : {
      DedicatedHostGroup : {
        Type : <span style=color:#ed9d13>&#34;AWS::ResourceGroups::Group&#34;</span>
        Properties : {
          Name : <span style=color:#24909d>var</span>.service_name
          Configuration : [
            {
              Type : <span style=color:#ed9d13>&#34;AWS::EC2::HostManagement&#34;</span>
              Parameters : [
                {
                  Name : <span style=color:#ed9d13>&#34;auto-allocate-host&#34;</span>
                  Values : [<span style=color:#24909d>var</span>.auto_allocate_host]
                },
			...
			...
</code></pre></div><h2 id=templatize-stuff>Templatize stuff<a hidden class=anchor aria-hidden=true href=#templatize-stuff>#</a></h2><p><figure><img loading=lazy src=templatize-stuff.png></figure>The last case in this blog but not the least by its efficacy â€” render source file content as a template in Terraform.</p><p>Let&rsquo;s review the following scenario: you launch an EC2 instance and want to supply it with a bash script (via the user-data parameter) for some additional configuration at launch.</p><p>Suppose we have the following bash script <code>instance-init.sh</code> that sets the hostname and registers our instance in a monitoring system:</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#cd2828;font-weight:700>#!/bin/bash
</span><span style=color:#cd2828;font-weight:700></span>
hostname example.com
bash /opt/system-init/register-monitoring.sh
</code></pre></div><p>But what if you want to set a different hostname per instance, and some instances should not be registered in the monitoring system?</p><p>In such a case, here is how the script file content will look:</p><pre tabindex=0><code class=language-gotemplate data-lang=gotemplate>#!/bin/bash

hostname ${system_hostname}
%{ if register_monitoring }
bash /opt/system-init/register-monitoring.sh
%{endif}
</code></pre><p>And when you supply this file as an argument for the EC2 instance resource in Terraform, you will use the <code>templatefile()</code> function to make the magic happen:</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-terraform data-lang=terraform><span style=color:#6ab825;font-weight:700>resource</span> <span style=color:#ed9d13>&#34;aws_instance&#34;</span> <span style=color:#ed9d13>&#34;web&#34;</span> {
  <span style=color:#bbb>ami</span>           = <span style=color:#24909d>var</span>.my_ami_id
  <span style=color:#bbb>instance_type</span> = <span style=color:#24909d>var</span>.instance_type
  ...
  <span style=color:#bbb>user_data</span> = <span style=color:#24909d>templatefile</span>(<span style=color:#ed9d13>&#34;</span><span style=color:#ed9d13>${</span>path.<span style=color:#24909d>module</span><span style=color:#ed9d13>}</span><span style=color:#ed9d13>/instance-init.tftpl&#34;</span>, {
    <span style=color:#bbb>system_hostname</span>     = <span style=color:#24909d>var</span>.system_hostname
    <span style=color:#bbb>register_monitoring</span> = <span style=color:#24909d>var</span>.add_to_monitoring
  })
  ...
}
</code></pre></div><p>And of course, you can create a template from any file type. The only requirement here is that the template file must exist on the disk at the beginning of the Terraform execution.</p><h2 id=key-takeaways>Key takeaways<a hidden class=anchor aria-hidden=true href=#key-takeaways>#</a></h2><p>Terraform is far beyond the standard resource management operations. With the power of built-in functions, you can write more versatile code and reusable Terraform modules.</p><p>âœ… Use <a href=https://www.terraform.io/language/expressions/conditionals>conditional expressions</a> with <a href=https://www.terraform.io/language/meta-arguments/count>count</a> and <a href=https://www.terraform.io/language/meta-arguments/for_each>for_each</a> meta-arguments, when the creation of a resource depends on some context or user input.</p><p>âœ… Take advantage of <a href=https://www.terraform.io/language/expressions/types#type-conversion>implicit type conversion</a> when working with input variables and their values to keep your code cleaner.</p><p>âœ… Embed YAML and JSON-based objects right into your Terraform code using built-in <a href=https://www.terraform.io/language/functions/jsonencode>encoding</a> <a href=https://www.terraform.io/language/functions/yamlencode>functions</a>.</p><p>âœ… And when you need to pass some files to the managed service, you can treat them as <a href=https://www.terraform.io/language/functions/templatefile>templates</a> and make them multipurpose.</p><p>Thank you for reading down to this point! ðŸ¤—</p><p>If you have some favorite Terraform tricks â€” I would love to know!</p></div><footer class=post-footer><div class=write_me_on_twitter><p>Send me a message <a href=https://twitter.com/vasylenko>@vasylenko</a> on Twitter with your feedback or questions!</p></div><div class=post-series><p>This post is a part of the <b>"Terraform Proficiency"</b> series.<br>Other posts in this series:</p><ul><li style=opacity:.75>Jan 16, 2022 â€” Some Techniques to Enhance Your Terraform Proficiency</li><li>Nov 24, 2021 â€” <a href=https://serhii.vasylenko.info/2021/11/24/guide-to-using-terraform-in-ci/cd/>Guide to Using Terraform in CI/CD</a></li><li>Aug 25, 2020 â€” <a href=https://serhii.vasylenko.info/2020/08/25/terraform-cli-shortcuts.html>Terraform CLI shortcuts</a></li></ul></div><ul class=post-tags></ul><div class=license><p>This work is licensed under a <a rel=license href=http://creativecommons.org/licenses/by-nd/4.0/>Creative Commons Attribution-NoDerivatives 4.0 International License</a></p></div><nav class=paginav><a class=next href=https://serhii.vasylenko.info/2021/11/24/guide-to-using-terraform-in-ci/cd/><span class=title>Next Page Â»</span><br><span>Guide to Using Terraform in CI/CD</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2022 <a href=https://serhii.vasylenko.info>Serhii Vasylenko â€” Technical Blog</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById('menu');menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script><script>document.querySelectorAll('pre > code').forEach(b=>{const c=b.parentNode.parentNode,a=document.createElement('button');a.classList.add('copy-code'),a.innerText='copy';function d(){a.innerText='copied!',setTimeout(()=>{a.innerText='copy'},2e3)}a.addEventListener('click',e=>{if('clipboard'in navigator){navigator.clipboard.writeText(b.textContent),d();return}const a=document.createRange();a.selectNodeContents(b);const c=window.getSelection();c.removeAllRanges(),c.addRange(a);try{document.execCommand('copy'),d()}catch(a){}c.removeRange(a)}),c.classList.contains("highlight")?c.appendChild(a):c.parentNode.firstChild==c||(b.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?b.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(a):b.parentNode.appendChild(a))})</script></body></html>