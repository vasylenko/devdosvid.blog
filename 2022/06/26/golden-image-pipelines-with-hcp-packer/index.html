<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Golden Image Pipelines With HCP Packer | devDosvid ‚Äî my engineering experience</title><meta name=keywords content="packer,terraform,cloud,ami,pipeline,infrastructure as code"><meta name=description content="How to create an end-to-end golden image workflow with the HCP Packer image registry"><meta name=author content="Serhii Vasylenko"><link rel=canonical href=https://devdosvid.blog/2022/06/26/golden-image-pipelines-with-hcp-packer/><link crossorigin=anonymous href=/assets/css/stylesheet.7522e8faf352606247f2b5119e00dc68cfece255797636ffdc4e7aa2f38616f7.css integrity="sha256-dSLo+vNSYGJH8rURngDcaM/s4lV5djb/3E56ovOGFvc=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://devdosvid.blog/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://devdosvid.blog/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://devdosvid.blog/favicon-32x32.png><link rel=apple-touch-icon href=https://devdosvid.blog/apple-touch-icon.png><link rel=mask-icon href=https://devdosvid.blog/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><script type=text/javascript>window.heap=window.heap||[],heap.load=function(i,o){window.heap.appid=i,window.heap.config=o=o||{},e=document.createElement("script"),e.type="text/javascript",e.async=!0,e.src="https://cdn.heapanalytics.com/js/heap-"+i+".js",n=document.getElementsByTagName("script")[0],n.parentNode.insertBefore(e,n);for(var e,n,a=function(e){return function(){heap.push([e].concat(Array.prototype.slice.call(arguments,0)))}},s=["addEventProperties","addUserProperties","clearEventProperties","identify","resetIdentity","removeEventProperty","setEventProperties","track","unsetEventProperty"],t=0;t<s.length;t++)heap[s[t]]=a(s[t])},heap.load("2300872157")</script><meta name=twitter:creator content="@vasylenko"><meta name=twitter:site content="@vasylenko"><meta property="og:title" content="Golden Image Pipelines With HCP Packer"><meta property="og:description" content="How to create an end-to-end golden image workflow with the HCP Packer image registry"><meta property="og:type" content="article"><meta property="og:url" content="https://devdosvid.blog/2022/06/26/golden-image-pipelines-with-hcp-packer/"><meta property="og:image" content="https://devdosvid.blog/2022/06/26/golden-image-pipelines-with-hcp-packer/cover-image.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-06-26T15:13:12+02:00"><meta property="article:modified_time" content="2022-06-27T19:43:05+02:00"><meta property="og:site_name" content="devDosvid ‚Äî my engineering experience"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://devdosvid.blog/2022/06/26/golden-image-pipelines-with-hcp-packer/cover-image.png"><meta name=twitter:title content="Golden Image Pipelines With HCP Packer"><meta name=twitter:description content="How to create an end-to-end golden image workflow with the HCP Packer image registry"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://devdosvid.blog/posts/"},{"@type":"ListItem","position":3,"name":"Golden Image Pipelines With HCP Packer","item":"https://devdosvid.blog/2022/06/26/golden-image-pipelines-with-hcp-packer/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Golden Image Pipelines With HCP Packer","name":"Golden Image Pipelines With HCP Packer","description":"How to create an end-to-end golden image workflow with the HCP Packer image registry","keywords":["packer","terraform","cloud","ami","pipeline","infrastructure as code"],"articleBody":"Many of us know and use Packer to build golden images for cloud providers. But did you know that Packer is not just a CLI tool?\nThere is an HCP (stands for HashiCorp Cloud Platform) Packer that acts as the image registry that stores the image metadata, allows you to organize images in distribution channels, and perform other management actions.\nIn this blog, I would like to showcase some features of the HCP Packer and explain how you can use it to set up an image factory for the organization (or for your own fun üôÉ) to maintain the Golden Images.\nI will be using AWS AMI as the OS image appliance for examples in this blog, but Packer supports many other formats and clouds through its plugins.\nHCP Packer Registry HCP Packer is the image metadata registry that stores the information (not an image file) about OS images you create using the Packer CLI tool.\nIt solves the challenge of the Golden Image pipeline maintenance by acting as a hub that organizes and streamlines the processes of OS image creation, usage, and continuity.\n  OS Image lifecycle with HCP Packer\n  HCP Packer introduces several new concepts that compose the registry: Image Buckets, Iterations, and Channels. Further in this blog, I will explain them, but let‚Äôs start with security first.\nSecurity First ‚Äî Creating Service Principals Before launching the builds, you need to create a Service Principal to allow your local Packer CLI to communicate with the HCP.\nI recommend creating at least two principals: the one with the ‚Äúcontributor‚Äù role ‚Äî used by Packer CLI to store the image metadata in HCP; and another one with the ‚Äúviewer‚Äù role ‚Äî used by Terraform (as it requires only read-level access for Packer HCP).\n  Service Principals for HCP\n  Once you have created a principal, you can generate a key for authentication. The key consists of an ID and a secret.\nBoth the Packer CLI and the Packer Terraform provider support environment variables for the principal client ID and client secret for authentication:\nHCP_CLIENT_ID and HCP_CLIENT_SECRET\n Image Buckets to Store Image Metadata The central entity in HCP Packer is the Image Buckets.\nImage Bucket is a repository where the metadata from a Packer template is stored once image(s) creation is completed.\nImage Bucket can contain a single image or several images if you define several sources for the build block in the Packet template.\nFor example, a bucket can span several custom AMIs based on Ubuntu AMI provided by Amazon and built and distributed within several regions.\nYou cannot create buckets manually from the web interface (at least as of June 2022), but I will show you how they are defined as code inside a Packer template file just a bit later.\n  HCP Packer Image Buckets\n  Iterations of Image Creation Every execution of the build action made by Packer CLI (if used in conjunction with HCP) is recorded specially and called Iteration.\nEach Iteration has a unique fingerprint ‚Äî an SHA value of the head reference in the Git repository that contains your Packer template.\nTip: you can override that with the HCP_PACKER_BUILD_FINGERPRINT env variable if you want to set the Iteration ID manually.    HCP Packer Iterations\n  Every Iteration consists of at least one Build ‚Äî another special record that contains image metadata produced by Packer CLI.\nThe Builds inside Iteration are represented by the number of sources specified in your Packer template‚Äôs build section.\n  HCP Packer Iteration Builds\n  Packer Template Configuration for HCP Let‚Äôs now review a code example to understand how all this combines.\nHere is a build block from Packer template file.\n  HCP Packer registry usage in a Packer template\n  Look at the hcp_packer_registry block: it defines the Bucket where Packer will store image information and custom labels for the Bucket and the image.\nThe bucket_name defines my Image Bucket: Packer will either use the existing Bucket with that name or create a new one if it does not exist.\nThe bucket_labels map defines custom labels you specify for an Image Bucket. In my example, I set the Bucket owner and the OS name.\nThe build_labels map defines custom labels for the Builds within the Iteration inside a bucket.\nAnd because I define two sources here, my Iteration will have two Builds inside it.\nUsing Channels Although all Iterations have unique identifiers, giving a familiar name to some of them would be more convenient.\nChannel is a way to assign a specific Iteration to a friendly name that you can use later:\n in other Packer templates, if you want to use your custom image as the base for other images in Terraform code (we will review this further) to reference the image by the channel name, avoiding the hard code of the image ID.  Channels are created through the web interface or using the API. And I hope HashiCorp will add HCP Packer resources to the HCP Terraform provider in the future so channel creation can be described as code.\n  HCP Packer Image Channel\n  You can manually promote an Iteration to a channel with a web interface.\nBut before promoting an Iteration to a channel, you might want to perform the following:\n  test and validate the newly created image before its promotion to a channel: create a temporary virtual machine using Terraform and ensure it successfully boots from the image.\n  assess that VM with some vulnerability scanning service. For example, if you‚Äôre an AWS customer, then Amazon Inspector might work for you in such a case.\n  Once an image from the Iteration is validated and passed the security assessment, it‚Äôs safe to promote that Iteration to a channel.\nHCP Packer provides a rich API that you can leverage to automate that process.\nWhen a packer build successfully finishes its execution, it returns the Iteration ID (ULID) that you can use later for an API call with a request to promote the new Iteration to a channel.\n  Packer build output with Iteration ULID\n  The ‚ÄúUpdate Channel‚Äù PATCH API method is needed to assign the Iteration to a channel.\nFirst, you need to obtain the access token as described in this guide.\nThen, the following cURL request can be used to update the channel with a new Iteration ULID (please expand the code snippet below):\n Click here to see the code snippet HCP_ACCESS_TOKEN=\"your token here\"  HCP_ORG_ID=\"your org id here\" HCP_PROJECT_ID=\"your project id here\" HCP_BUCKET_NAME=\"amazon-linux2\" HCP_CHANNEL_NAME=\"stable\" HCP_BASE_URL=\"https://api.cloud.hashicorp.com/packer/2021-04-30\"  curl -X PATCH \\ --header \"Authorization: Bearer $HCP_ACCESS_TOKEN\" \\ --data '{ \"incremental_version\":\"3\", \"iteration_id\":\"01H8V7WBDWRBCMZDZ2HG3MKSDL\" }' \\ \"${HCP_BASE_URL}/organizations/${HCP_ORG_ID}/projects/${HCP_PROJECT_ID}/images/${HCP_BUCKET_NAME}/channels/${HCP_CHANNEL_NAME}\"    Using HCP Packer with Terraform Having a streamlined golden image creation process is good. Still, it would be even better to have an easy way to always use the latest validated image without hardcoding or some other duck taping.\nWith the help of the HCP Terraform provider, you can reference the image channel in your Terraform code and have a completed end-to-end workflow.\nHere is an example of the Terraform configuration that uses the HCP Packer registry as the source of AMI ID for an AWS instance:\n  Using HCP Packer registry with Terraform\n  Two data sources do all the magic here.\nThe hcp_packer_iteration data source gets the most recent Iteration assigned to the specified Channel (i.e., latest). We need that because the Iteration (not the Channel) holds the image information.\nThen the hcp_packer_image gets the cloud image ID (AWS AMI ID in my example) from that Iteration so you can use it later in your code.\nThe configuration of the hcp provider in this example is empty on purpose: this provider supports HCP_CLIENT_ID and HCP_CLIENT_SECRET env variables to use their values for the authentication and avoid hard coding. Alternatively, you can use the client_id and client_secret options to configure the provider.\nAlso, you can revoke an Iteration on purpose, preventing particular images from being used. For example, your SecOps team can revoke it due to some new CVE announced.\nWhen Iteration is revoked, its cloud_image_id returns the error_revoked value instead of the actual image ID.\nYou can add a bit of conditional logic to the Terraform code to catch that case and act accordingly. For example:\n  Work with revoked HCP Packer image in Terraform\n  Or you can also validate this using recently announced post- and preconditions.\nWhy HCP Packer? So what makes the HCP Packer a good fit and worth a try?\n1Ô∏è‚É£ A centralized place to view and manage the OS images throughout an organization. And as for me, it is good to have a neat web panel to look at things.\n2Ô∏è‚É£ Image Channels that help with logical organization and control.\n3Ô∏è‚É£ Ability to revoke an image to prevent its usage.\n4Ô∏è‚É£ API and Terraform provider as additional tools that enrich the user experience.\nWhen dealing with multiple golden images or with various cloud providers, the HCP Packer can be a good fit for your image pipeline.\nAs a registry, it enables the end-to-end workflow for golden image usage: create, validate, use and decommission the images in a centralized way.\nAnd no more hard-coded IDs, manual variable settings, or other duck tape and glue in your Terraform.\nIf you want to learn more about HCP Packer and have some practice, I suggest starting from the tutorial at HashiCorp Learn portal.\n","wordCount":"1532","inLanguage":"en","image":"https://devdosvid.blog/2022/06/26/golden-image-pipelines-with-hcp-packer/cover-image.png","datePublished":"2022-06-26T15:13:12+02:00","dateModified":"2022-06-27T19:43:05+02:00","author":{"@type":"Person","name":"Serhii Vasylenko"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://devdosvid.blog/2022/06/26/golden-image-pipelines-with-hcp-packer/"},"publisher":{"@type":"Person","name":"devDosvid ‚Äî my engineering experience","logo":{"@type":"ImageObject","url":"https://devdosvid.blog/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://devdosvid.blog accesskey=h title="üè† Home (Alt + H)">üè† Home</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://devdosvid.blog/index.xml title="RSS Feed"><span>RSS Feed</span></a></li><li><a href=https://devdosvid.blog/archive title="All posts"><span>All posts</span></a></li><li><a href=https://devdosvid.blog/about/ title="About me"><span>About me</span></a></li><li><a href=https://devdosvid.blog/cv/ title="My CV"><span>My CV</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://devdosvid.blog>Home</a>&nbsp;¬ª&nbsp;<a href=https://devdosvid.blog/posts/>Posts</a></div><h1 class=post-title>Golden Image Pipelines With HCP Packer</h1><div class=post-description>How to create an end-to-end golden image workflow with the HCP Packer image registry</div><div class=post-meta><span title="2022-06-26 15:13:12 +0200 +0200">June 26, 2022</span>&nbsp;¬∑&nbsp;8 min&nbsp;¬∑&nbsp;1532 words&nbsp;¬∑&nbsp;Serhii Vasylenko&nbsp;|&nbsp;<a href=mailto:contact@devdosvid.blog rel="noopener noreferrer" target=_blank>üì© Suggest Changes</a></div></header><figure class=entry-cover><img loading=lazy srcset="https://devdosvid.blog/2022/06/26/golden-image-pipelines-with-hcp-packer/cover-image_hu523b557ef799e547a01eaa8f5611322e_32415_360x0_resize_box_3.png 360w ,https://devdosvid.blog/2022/06/26/golden-image-pipelines-with-hcp-packer/cover-image_hu523b557ef799e547a01eaa8f5611322e_32415_480x0_resize_box_3.png 480w ,https://devdosvid.blog/2022/06/26/golden-image-pipelines-with-hcp-packer/cover-image_hu523b557ef799e547a01eaa8f5611322e_32415_720x0_resize_box_3.png 720w ,https://devdosvid.blog/2022/06/26/golden-image-pipelines-with-hcp-packer/cover-image_hu523b557ef799e547a01eaa8f5611322e_32415_1080x0_resize_box_3.png 1080w ,https://devdosvid.blog/2022/06/26/golden-image-pipelines-with-hcp-packer/cover-image.png 1200w" sizes="(min-width: 768px) 720px, 100vw" src=https://devdosvid.blog/2022/06/26/golden-image-pipelines-with-hcp-packer/cover-image.png alt width=1200 height=630></figure><div class=post-content><p>Many of us know and use Packer to build golden images for cloud providers. But did you know that Packer is not just a CLI tool?</p><p>There is an HCP (<em>stands for <strong>H</strong>ashiCorp <strong>C</strong>loud <strong>P</strong>latform</em>) Packer that acts as the image registry that stores the image metadata, allows you to organize images in distribution channels, and perform other management actions.</p><p>In this blog, I would like to showcase some features of the HCP Packer and explain how you can use it to set up an image factory for the organization (or for your own fun üôÉ) to maintain the Golden Images.</p><p>I will be using AWS AMI as the OS image appliance for examples in this blog, but Packer supports many other formats and clouds through its <a href=https://www.packer.io/plugins>plugins</a>.</p><h2 id=hcp-packer-registry>HCP Packer Registry<a hidden class=anchor aria-hidden=true href=#hcp-packer-registry>#</a></h2><p>HCP Packer is the image metadata registry that stores the information (not an image file) about OS images you create using the Packer CLI tool.</p><p>It solves the challenge of the Golden Image pipeline maintenance by acting as a hub that organizes and streamlines the processes of OS image creation, usage, and continuity.</p><figure><img loading=lazy src=hcp-packer-how-it-works.png alt="OS Image lifecycle with HCP Packer" width=800 height=200><figcaption><p>OS Image lifecycle with HCP Packer</p></figcaption></figure><p>HCP Packer introduces several new concepts that compose the registry: Image Buckets, Iterations, and Channels. Further in this blog, I will explain them, but let&rsquo;s start with security first.</p><h2 id=security-first--creating-service-principals>Security First ‚Äî Creating Service Principals<a hidden class=anchor aria-hidden=true href=#security-first--creating-service-principals>#</a></h2><p>Before launching the builds, you need to create a Service Principal to allow your local Packer CLI to communicate with the HCP.</p><p>I recommend creating at least two principals: the one with the &ldquo;contributor&rdquo; role ‚Äî used by Packer CLI to store the image metadata in HCP; and another one with the &ldquo;viewer&rdquo; role ‚Äî used by Terraform (as it requires only read-level access for Packer HCP).</p><figure><img loading=lazy src=hcp-packer-service-principals.png alt="Service Principals for HCP" width=800 height=325><figcaption><p>Service Principals for HCP</p></figcaption></figure><p>Once you have created a principal, you can generate a key for authentication. The key consists of an ID and a secret.</p><div class=attention><p>Both the Packer CLI and the Packer Terraform provider support environment variables for the principal client ID and client secret for authentication:</p><p><code>HCP_CLIENT_ID</code> and <code>HCP_CLIENT_SECRET</code></p></div><h2 id=image-buckets-to-store-image-metadata>Image Buckets to Store Image Metadata<a hidden class=anchor aria-hidden=true href=#image-buckets-to-store-image-metadata>#</a></h2><p>The central entity in HCP Packer is the Image Buckets.</p><p><strong>Image Bucket</strong> is a repository where the metadata from a Packer template is stored once image(s) creation is completed.</p><p>Image Bucket can contain a single image or several images if you define several sources for the <code>build</code> block in the Packet template.</p><p>For example, a bucket can span several custom AMIs based on Ubuntu AMI provided by Amazon and built and distributed within several regions.</p><p>You cannot create buckets manually from the web interface (at least as of June 2022), but I will show you how they are defined as code inside a Packer template file just a bit later.</p><figure><img loading=lazy src=image-buckets.png alt="HCP Packer Image Buckets" width=800 height=381><figcaption><p>HCP Packer Image Buckets</p></figcaption></figure><h2 id=iterations-of-image-creation>Iterations of Image Creation<a hidden class=anchor aria-hidden=true href=#iterations-of-image-creation>#</a></h2><p>Every execution of the <code>build</code> action made by Packer CLI (if used in conjunction with HCP) is recorded specially and called <strong>Iteration</strong>.</p><p>Each Iteration has a unique fingerprint ‚Äî an SHA value of the head reference in the Git repository that contains your Packer template.</p><div class=attention>Tip: you can override that with the <code>HCP_PACKER_BUILD_FINGERPRINT</code> env variable if you want to set the Iteration ID manually.</div><figure><img loading=lazy src=packer-iterations.png alt="HCP Packer Iterations" width=800 height=381><figcaption><p>HCP Packer Iterations</p></figcaption></figure><p>Every Iteration consists of at least one Build ‚Äî another special record that contains image metadata produced by Packer CLI.</p><p>The Builds inside Iteration are represented by the number of sources specified in your Packer template&rsquo;s <code>build</code> section.</p><figure><img loading=lazy src=packer-iteration-builds.png alt="HCP Packer Iteration Builds" width=800 height=785><figcaption><p>HCP Packer Iteration Builds</p></figcaption></figure><h2 id=packer-template-configuration-for-hcp>Packer Template Configuration for HCP<a hidden class=anchor aria-hidden=true href=#packer-template-configuration-for-hcp>#</a></h2><p>Let&rsquo;s now review a code example to understand how all this combines.</p><p>Here is a <code>build</code> block from Packer template file.</p><figure><img loading=lazy src=packer-template-example.png alt="HCP Packer registry usage in a Packer template" width=800 height=533><figcaption><p>HCP Packer registry usage in a Packer template</p></figcaption></figure><p>Look at the <code>hcp_packer_registry</code> block: it defines the Bucket where Packer will store image information and custom labels for the Bucket and the image.</p><p>The <code>bucket_name</code> defines my Image Bucket: Packer will either use the existing Bucket with that name or create a new one if it does not exist.</p><p>The <code>bucket_labels</code> map defines custom labels you specify for an Image Bucket. In my example, I set the Bucket owner and the OS name.</p><p>The <code>build_labels</code> map defines custom labels for the Builds within the Iteration inside a bucket.</p><p>And because I define two <code>sources</code> here, my Iteration will have two Builds inside it.</p><h2 id=using-channels>Using Channels<a hidden class=anchor aria-hidden=true href=#using-channels>#</a></h2><p>Although all Iterations have unique identifiers, giving a familiar name to some of them would be more convenient.</p><p><strong>Channel</strong> is a way to assign a specific Iteration to a friendly name that you can use later:</p><ul><li>in other Packer templates, if you want to use your custom image as the base for other images</li><li>in Terraform code (we will review this further) to reference the image by the channel name, avoiding the hard code of the image ID.</li></ul><p>Channels are created through the web interface or using the API. And I hope HashiCorp will add HCP Packer resources to the HCP Terraform provider in the future so channel creation can be described as code.</p><figure><img loading=lazy src=hcp-packer-image-channel.png alt="HCP Packer Image Channel" width=800 height=462><figcaption><p>HCP Packer Image Channel</p></figcaption></figure><p>You can manually promote an Iteration to a channel with a web interface.</p><p>But before promoting an Iteration to a channel, you might want to perform the following:</p><ul><li><p>test and validate the newly created image before its promotion to a channel: create a temporary virtual machine using Terraform and ensure it successfully boots from the image.</p></li><li><p>assess that VM with some vulnerability scanning service. For example, if you&rsquo;re an AWS customer, then <a href=https://docs.aws.amazon.com/inspector/latest/user/what-is-inspector.html>Amazon Inspector</a> might work for you in such a case.</p></li></ul><p>Once an image from the Iteration is validated and passed the security assessment, it&rsquo;s safe to promote that Iteration to a channel.</p><p>HCP Packer provides a rich <a href=https://cloud.hashicorp.com/api-docs/packer>API</a> that you can leverage to automate that process.</p><p>When a <code>packer build</code> successfully finishes its execution, it returns the Iteration ID (ULID) that you can use later for an API call with a request to promote the new Iteration to a channel.</p><figure><img loading=lazy src=packer-build-output.png alt="Packer build output with Iteration ULID" width=800 height=198><figcaption><p>Packer build output with Iteration ULID</p></figcaption></figure><p>The &ldquo;Update Channel&rdquo; PATCH API method is needed to assign the Iteration to a channel.</p><p>First, you need to obtain the access token as described in <a href=https://support.hashicorp.com/hc/en-us/articles/6676505991699-HCP-API-Authentication-with-Curl>this guide</a>.</p><p>Then, the following cURL request can be used to update the channel with a new Iteration ULID (please expand the code snippet below):</p><div class=code-snippet><details><summary markdown=span>Click here to see the code snippet</summary><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#40ffff>HCP_ACCESS_TOKEN</span>=<span style=color:#ed9d13>&#34;your token here&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#40ffff>HCP_ORG_ID</span>=<span style=color:#ed9d13>&#34;your org id here&#34;</span>
</span></span><span style=display:flex><span><span style=color:#40ffff>HCP_PROJECT_ID</span>=<span style=color:#ed9d13>&#34;your project id here&#34;</span>
</span></span><span style=display:flex><span><span style=color:#40ffff>HCP_BUCKET_NAME</span>=<span style=color:#ed9d13>&#34;amazon-linux2&#34;</span>
</span></span><span style=display:flex><span><span style=color:#40ffff>HCP_CHANNEL_NAME</span>=<span style=color:#ed9d13>&#34;stable&#34;</span>
</span></span><span style=display:flex><span><span style=color:#40ffff>HCP_BASE_URL</span>=<span style=color:#ed9d13>&#34;https://api.cloud.hashicorp.com/packer/2021-04-30&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>curl -X PATCH <span style=color:#ed9d13>\
</span></span></span><span style=display:flex><span><span style=color:#ed9d13></span>--header <span style=color:#ed9d13>&#34;Authorization: Bearer </span><span style=color:#40ffff>$HCP_ACCESS_TOKEN</span><span style=color:#ed9d13>&#34;</span> <span style=color:#ed9d13>\
</span></span></span><span style=display:flex><span><span style=color:#ed9d13></span>--data <span style=color:#ed9d13>&#39;{
</span></span></span><span style=display:flex><span><span style=color:#ed9d13>&#34;incremental_version&#34;:&#34;3&#34;,
</span></span></span><span style=display:flex><span><span style=color:#ed9d13>&#34;iteration_id&#34;:&#34;01H8V7WBDWRBCMZDZ2HG3MKSDL&#34;
</span></span></span><span style=display:flex><span><span style=color:#ed9d13>}&#39;</span> <span style=color:#ed9d13>\
</span></span></span><span style=display:flex><span><span style=color:#ed9d13></span><span style=color:#ed9d13>&#34;</span><span style=color:#ed9d13>${</span><span style=color:#40ffff>HCP_BASE_URL</span><span style=color:#ed9d13>}</span><span style=color:#ed9d13>/organizations/</span><span style=color:#ed9d13>${</span><span style=color:#40ffff>HCP_ORG_ID</span><span style=color:#ed9d13>}</span><span style=color:#ed9d13>/projects/</span><span style=color:#ed9d13>${</span><span style=color:#40ffff>HCP_PROJECT_ID</span><span style=color:#ed9d13>}</span><span style=color:#ed9d13>/images/</span><span style=color:#ed9d13>${</span><span style=color:#40ffff>HCP_BUCKET_NAME</span><span style=color:#ed9d13>}</span><span style=color:#ed9d13>/channels/</span><span style=color:#ed9d13>${</span><span style=color:#40ffff>HCP_CHANNEL_NAME</span><span style=color:#ed9d13>}</span><span style=color:#ed9d13>&#34;</span>
</span></span></code></pre></div></details></div><h2 id=using-hcp-packer-with-terraform>Using HCP Packer with Terraform<a hidden class=anchor aria-hidden=true href=#using-hcp-packer-with-terraform>#</a></h2><p>Having a streamlined golden image creation process is good. Still, it would be even better to have an easy way to always use the latest validated image without hardcoding or some other duck taping.</p><p>With the help of the <a href=https://registry.terraform.io/providers/hashicorp/hcp>HCP Terraform provider</a>, you can reference the image channel in your Terraform code and have a completed end-to-end workflow.</p><p>Here is an example of the Terraform configuration that uses the HCP Packer registry as the source of AMI ID for an AWS instance:</p><figure><img loading=lazy src=terraform-hcp-packer.png alt="Using HCP Packer registry with Terraform" width=800 height=510><figcaption><p>Using HCP Packer registry with Terraform</p></figcaption></figure><p>Two data sources do all the magic here.</p><p>The <code>hcp_packer_iteration</code> data source gets the most recent Iteration assigned to the specified Channel (i.e., latest). We need that because the Iteration (not the Channel) holds the image information.</p><p>Then the <code>hcp_packer_image</code> gets the cloud image ID (AWS AMI ID in my example) from that Iteration so you can use it later in your code.</p><p>The configuration of the <code>hcp</code> provider in this example is empty on purpose: this provider supports <code>HCP_CLIENT_ID</code> and <code>HCP_CLIENT_SECRET</code> env variables to use their values for the <a href=https://registry.terraform.io/providers/hashicorp/hcp/latest/docs/guides/auth>authentication</a> and avoid hard coding. Alternatively, you can use the <code>client_id</code> and <code>client_secret</code> options to configure the provider.</p><p>Also, you can revoke an Iteration on purpose, preventing particular images from being used. For example, your SecOps team can revoke it due to some new CVE announced.</p><p>When Iteration is revoked, its cloud_image_id returns the <code>error_revoked</code> value instead of the actual image ID.</p><p>You can add a bit of conditional logic to the Terraform code to catch that case and act accordingly. For example:</p><figure><img loading=lazy src=logic-for-revoked-iteration.png alt="Work with revoked HCP Packer image in Terraform" width=800 height=222><figcaption><p>Work with revoked HCP Packer image in Terraform</p></figcaption></figure><p>Or you can also validate this using recently announced <a href=https://devdosvid.blog/2022/05/04/new-lifecycle-options-and-refactoring-capabilities-in-terraform-1-1-and-1-2/#precondition-and-postcondition>post- and preconditions</a>.</p><h2 id=why-hcp-packer>Why HCP Packer?<a hidden class=anchor aria-hidden=true href=#why-hcp-packer>#</a></h2><p>So what makes the HCP Packer a good fit and worth a try?</p><p>1Ô∏è‚É£ A centralized place to view and manage the OS images throughout an organization. And as for me, it is good to have a neat web panel to look at things.</p><p>2Ô∏è‚É£ Image Channels that help with logical organization and control.</p><p>3Ô∏è‚É£ Ability to revoke an image to prevent its usage.</p><p>4Ô∏è‚É£ API and Terraform provider as additional tools that enrich the user experience.</p><p>When dealing with multiple golden images or with various cloud providers, the <a href=https://cloud.hashicorp.com/products/packer>HCP Packer</a> can be a good fit for your image pipeline.</p><p>As a registry, it enables the end-to-end workflow for golden image usage: create, validate, use and decommission the images in a centralized way.</p><p>And no more hard-coded IDs, manual variable settings, or other duck tape and glue in your Terraform.</p><p>If you want to learn more about HCP Packer and have some practice, I suggest starting from the <a href=https://learn.hashicorp.com/collections/packer/hcp>tutorial at HashiCorp Learn portal</a>.</p></div><footer class=post-footer><div class="sp-form-outer sp-force-hide"><div id=sp-form-211745 sp-id=211745 sp-hash=9ef750f82b8d5e11b34ea23df27756cb738d703108d46ebff940b44ce4757404 sp-lang=en class="sp-form sp-form-regular sp-form-embed" sp-show-options=%7B%22satellite%22%3Afalse%2C%22maDomain%22%3A%22login.sendpulse.com%22%2C%22formsDomain%22%3A%22forms.sendpulse.com%22%2C%22condition%22%3A%22onEnter%22%2C%22scrollTo%22%3A25%2C%22delay%22%3A10%2C%22repeat%22%3A3%2C%22background%22%3A%22rgba(0%2C%200%2C%200%2C%200.5)%22%2C%22position%22%3A%22bottom-right%22%2C%22animation%22%3A%22%22%2C%22hideOnMobile%22%3Afalse%2C%22urlFilter%22%3Afalse%2C%22urlFilterConditions%22%3A%5B%7B%22force%22%3A%22hide%22%2C%22clause%22%3A%22contains%22%2C%22token%22%3A%22%22%7D%5D%2C%22analytics%22%3A%7B%22ga%22%3A%7B%22eventLabel%22%3A%22Subscription_form_devDosvid%22%2C%22send%22%3Afalse%7D%2C%22ym%22%3A%7B%22counterId%22%3Anull%2C%22eventLabel%22%3Anull%2C%22targetId%22%3Anull%2C%22send%22%3Afalse%7D%7D%2C%22utmEnable%22%3Afalse%7D><div class=sp-form-fields-wrapper><div class=sp-message><div></div></div><form novalidate class=sp-element-container><div class="sp-field sp-field-full-width-add sp-field-full-width sp-field-full-width-add-active" sp-id=sp-d7ac453c-4371-4ac2-94ad-209ba95924ce data-><div><h3>Subscribe to be notified about blog updates!</h3></div></div><div class=sp-field sp-id=sp-07c6298b-0a1a-4417-b7d9-b2205b910fc7><label class=sp-control-label><span>Email</span><strong>*</strong></label><input type=email sp-type=email name=sform[email] class=sp-form-control placeholder=username@example.com sp-tips=%7B%22required%22%3A%22Required%20field%22%2C%22wrong%22%3A%22Wrong%20email%22%7D autocomplete=on required></div><div class="sp-field sp-button-container" sp-id=sp-92706abe-5113-4db0-b255-c64ad75a46f7><button id=sp-92706abe-5113-4db0-b255-c64ad75a46f7 class=sp-button>Subscribe</button></div></form></div></div></div><script type=text/javascript async src=//web.webformscr.com/apps/fc3/build/default-handler.js?1651223786960></script><ul class=post-tags></ul><div class=license><p>This work is licensed under a <a rel=license href=http://creativecommons.org/licenses/by-nd/4.0/>Creative Commons Attribution-NoDerivatives 4.0 International License</a></p></div><nav class=paginav><a class=next href=https://devdosvid.blog/2022/05/04/new-lifecycle-options-and-refactoring-capabilities-in-terraform-1-1-and-1-2/><span class=title>Next ¬ª</span><br><span>New Lifecycle Options and Refactoring Capabilities in Terraform 1.1 and 1.2</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2022 <a href=https://devdosvid.blog>devDosvid ‚Äî my engineering experience</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(t){t.preventDefault();var e=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView({behavior:"smooth"}),e==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${e}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(t=>{const n=t.parentNode.parentNode,e=document.createElement("button");e.classList.add("copy-code"),e.innerHTML="copy";function s(){e.innerHTML="copied!",setTimeout(()=>{e.innerHTML="copy"},2e3)}e.addEventListener("click",o=>{if("clipboard"in navigator){navigator.clipboard.writeText(t.textContent),s();return}const e=document.createRange();e.selectNodeContents(t);const n=window.getSelection();n.removeAllRanges(),n.addRange(e);try{document.execCommand("copy"),s()}catch(e){}n.removeRange(e)}),n.classList.contains("highlight")?n.appendChild(e):n.parentNode.firstChild==n||(t.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?t.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(e):t.parentNode.appendChild(e))})</script></body></html>