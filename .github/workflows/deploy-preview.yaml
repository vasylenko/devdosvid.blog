name: Deploy to Preview
on:
  pull_request:

env:
  HUGO_VERSION: 0.101.0
  CONTENT_DIR: publishdir
  CF_PREVIEW_PROJECT_NAME: devdosvid-preview
  DEPLOY_ENV_NAME: Preview

jobs:
  build:
    name: Build the blog
    runs-on: ubuntu-latest
    outputs:
      has_updates: ${{steps.check_updated_posts.has_updates}}
      updates_list: ${{steps.check_updated_posts.updates_list}}
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          submodules: recursive
          fetch-depth: 0
      - id: check_updated_posts
        run: |
          git diff-tree --no-commit-id --name-only -r ${{ github.event.before }}..${{ github.event.after }}
          updates_list=$(git diff-tree --no-commit-id --name-only -r ${{ github.event.before }}..${{ github.event.after }} | grep 'content/posts/')
          echo $updates_list
#          if [[ -n $updates_list ]]
#          then
#            echo "::set-output name=has_updates::true"
#            echo "::set-output name=updates_list::$(echo $updates_list)"
#          fi
#


      - name: Prepare Hugo
        run: |
          set -ex
          wget -q "https://github.com/gohugoio/hugo/releases/download/v${{ env.HUGO_VERSION }}/hugo_${{ env.HUGO_VERSION }}_Linux-64bit.tar.gz"
          tar -xf hugo_${{ env.HUGO_VERSION }}_Linux-64bit.tar.gz

      - name: Build blog
        run: ./hugo --environment development --baseURL="" --debug --templateMetrics --templateMetricsHints

      - name: Upload artifacts
        uses: actions/upload-artifact@v3
        with:
          name: ${{ env.CONTENT_DIR }}
          path: ${{ env.CONTENT_DIR }}

  deploy:
    name: Deploy to Cloudflare Pages
    runs-on: ubuntu-latest
    needs: [build]
    permissions:
      contents: read
      deployments: write
      pull-requests: write
    outputs:
      cf_preview_url: ${{ steps.deploy_to_cloudflare.outputs.url }}
    steps:
      - name: Get the new website content
        uses: actions/download-artifact@v2
        with:
          name: ${{ env.CONTENT_DIR }}
          path: ./${{ env.CONTENT_DIR }}

      - name: Create GH Deployment object
        uses: octokit/request-action@v2.x
        id: create_deployment
        with:
          route: POST /repos/{repo}/deployments
          required_contexts: "[]"
          owner: ${{ github.repository_owner }}
          repo: ${{ github.repository }}
          ref: ${{ github.head_ref }}
          auto_merge: false
          environment: ${{ env.DEPLOY_ENV_NAME }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Deploy to CloudFlare
        uses: cloudflare/pages-action@1
        id: deploy_to_cloudflare
        with:
          apiToken: ${{ secrets.CLOUDFLARE_GH_PAGES_ACTION_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: ${{ env.CF_PREVIEW_PROJECT_NAME }}
          directory: ${{ env.CONTENT_DIR }}
          gitHubToken: ${{ secrets.GITHUB_TOKEN }}

      - name: Set Deployment Status
        uses: octokit/request-action@v2.x
        id: set_deployment_status
        with:
          route: POST /repos/{repo}/deployments/{deployment_id}/statuses
          deployment_id: ${{ fromJson(steps.create_deployment.outputs.data).id }}
          owner: ${{ github.repository_owner }}
          repo: ${{ github.repository }}
          state: success
          environment: ${{ env.DEPLOY_ENV_NAME }}
          environment_url: ${{ steps.deploy_to_cloudflare.outputs.url }}
          log_url: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  psi_tests:
    name: PSI tests
    runs-on: ubuntu-latest
    needs: [ build,deploy ]
    permissions:
      contents: read
      pull-requests: write
    if: contains(needs.build.check_blogpost_updates.has_updates, 'true')
    steps:
      - name: Run PSI tests
        id: psi_test
        run: |
          sudo npm install --quiet --location=global psi
          API_POST_BODY=PR_DESCRIPTION_TEST_RESULTS.md
          LATEST_BLOG_POST_URL="${{ needs.deploy.outputs.cf_preview_url }}$(curl -s ${{ needs.deploy.outputs.cf_preview_url }}/latest-post/)"
          echo -e "### Latest blog post\nðŸ’» **${LATEST_BLOG_POST_URL}**" >> $API_POST_BODY
          for strategy in mobile desktop
          do
            echo -e "\n" >> $API_POST_BODY
            echo -e "### ${strategy^} tests\n" >> $API_POST_BODY
            echo "Metric | Value" >> $API_POST_BODY
            echo "------ | -----" >> $API_POST_BODY
            psi $LATEST_BLOG_POST_URL --key ${{ secrets.GOOGLE_PSI_API_KEY }} --strategy $strategy --format json|jq -r '.ruleResults|to_entries[]|[.key,.value]|@csv' |tr -d '"'|tr ',' '|' >> $API_POST_BODY            
          done
          echo "::set-output name=api_post_body::$(cat $API_POST_BODY | sed 's/$/\\n/' | tr -d '\n')"

      - name: Add deployment link and test URL to the PR comment
        run: |
          curl -s -i -o /dev/null -w "%{http_code}" \
          -X POST \
          -H "Accept: application/vnd.github+json" \
          -H 'Content-Type: text/x-markdown' \
          -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.number }}/comments \
          -d '{"body":"${{ steps.psi_test.outputs.api_post_body }}"}' \
          > response_code.txt
          grep -q 201 response_code.txt || exit 1
    # https://docs.github.com/en/rest/issues/comments#create-an-issue-comment--status-codes
