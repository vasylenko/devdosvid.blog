<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
    <channel>
        <title>guide on Serhii Vasylenko</title>
        <link>https://serhii.vasylenko.info/tags/guide/</link>
        <description>Recent content in guide on Serhii Vasylenko</description>
        <generator>Hugo -- gohugo.io</generator>
        <language>en-us</language>
        <managingEditor>email-from-blog@vasylenko.info (Serhii Vasylenko)</managingEditor>
        <webMaster>email-from-blog@vasylenko.info (Serhii Vasylenko)</webMaster>
        <lastBuildDate>Sun, 16 Jan 2022 01:59:51 +0200</lastBuildDate><atom:link href="https://serhii.vasylenko.info/tags/guide/index.xml" rel="self" type="application/rss+xml" />
        <item>
            <title>Some Techniques to Enhance Your Terraform Proficiency</title>
            <link>https://serhii.vasylenko.info/2022/01/16/some-techniques-to-enhance-your-terraform-proficiency/</link>
            <pubDate>Sun, 16 Jan 2022 01:59:51 +0200</pubDate>
            <author>email-from-blog@vasylenko.info (Serhii Vasylenko)</author>
            <guid isPermaLink="false">009d86d5f56c5c84299d35b176ec9316</guid>
            <description>Learn what cool things Terraform can do with its built-in functionality</description>
            <content>
                <image>
                    <url>"https://serhii.vasylenko.info/2022/01/16/some-techniques-to-enhance-your-terraform-proficiency/cover-image.png"</url>
                </image>&lt;p&gt;Terraform built-in functionality is very feature-rich: functions, expressions,  and meta-arguments provide many ways to shape the code and fit it to a particular use case. I want to share a few valuable practices to boost your Terraform expertise in this blog.&lt;/p&gt;
&lt;div class=&#34;attention&#34;&gt;
    Some code examples in this article will work with Terraform version 0.15 and onwards. But if you&amp;rsquo;re still using 0.14 or lower, here&amp;rsquo;s another motivation for you to upgrade.
&lt;/div&gt;
&lt;h2 id=&#34;conditional-resources-creation&#34;&gt;Conditional resources creation&lt;/h2&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img loading=&#34;lazy&#34; src=&#34;condiitonal-resource-creation.png&#34;/&gt; 
&lt;/figure&gt;

Let&amp;rsquo;s start from the most popular one (although, still may be new for somebody): whether to create a resource depending on some fact, e.g., the value of a variable. Terraform meta-argument &lt;code&gt;count&lt;/code&gt; helps to describe that kind of logic.&lt;/p&gt;
&lt;p&gt;Here is how it may look like:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-terraform&#34; data-lang=&#34;terraform&#34;&gt;&lt;span style=&#34;color:#6ab825;font-weight:bold&#34;&gt;data&lt;/span&gt; &lt;span style=&#34;color:#ed9d13&#34;&gt;&amp;#34;aws_ssm_parameter&amp;#34;&lt;/span&gt; &lt;span style=&#34;color:#ed9d13&#34;&gt;&amp;#34;ami_id&amp;#34;&lt;/span&gt; {
  &lt;span style=&#34;color:#bbb&#34;&gt;count&lt;/span&gt;    = &lt;span style=&#34;color:#24909d&#34;&gt;var&lt;/span&gt;.&lt;span style=&#34;color:#bbb&#34;&gt;ami_channel&lt;/span&gt; == &lt;span style=&#34;color:#ed9d13&#34;&gt;&amp;#34;&amp;#34;&lt;/span&gt; ? &lt;span style=&#34;color:#3677a9&#34;&gt;0&lt;/span&gt; : &lt;span style=&#34;color:#3677a9&#34;&gt;1&lt;/span&gt;

  &lt;span style=&#34;color:#bbb&#34;&gt;name&lt;/span&gt;     = local.ami_channels[&lt;span style=&#34;color:#24909d&#34;&gt;var&lt;/span&gt;.ami_channel]
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;The notation &lt;code&gt;var.ami_channel == &amp;quot;&amp;quot; ? 0 : 1&lt;/code&gt; is called &lt;em&gt;conditional expression&lt;/em&gt; and means the following: if my variable is empty (&lt;code&gt;var.ami_channel == &amp;quot;&amp;quot;&lt;/code&gt; — hence, true) then set the count to 0, otherwise set to 1.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-shell&#34; data-lang=&#34;shell&#34;&gt;condition ? true_val : false_val
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;In this illustration, I want to get the AMI ID from the SSM Parameter only if the AMI channel (e.g., beta or alpha) is specified. Otherwise, providing that the &lt;code&gt;ami_channel&lt;/code&gt; variable is an empty string by default (&amp;quot;&amp;quot;), the data source should not be created.&lt;/p&gt;
&lt;p&gt;When following this method, keep in mind that the resource address will contain the index identifier. So when I need to use the value of the SSM parameter from our example, I need to reference it the following way:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-terraform&#34; data-lang=&#34;terraform&#34;&gt;&lt;span style=&#34;color:#bbb&#34;&gt;ami_id&lt;/span&gt; = &lt;span style=&#34;color:#24909d&#34;&gt;data&lt;/span&gt;.aws_ssm_parameter.ami_id[&lt;span style=&#34;color:#3677a9&#34;&gt;0&lt;/span&gt;].value
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;The &lt;code&gt;count&lt;/code&gt; meta-argument can also be used when you need to conditionally create a Terraform module.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-terraform&#34; data-lang=&#34;terraform&#34;&gt;&lt;span style=&#34;color:#6ab825;font-weight:bold&#34;&gt;module&lt;/span&gt; &lt;span style=&#34;color:#ed9d13&#34;&gt;&amp;#34;bucket&amp;#34;&lt;/span&gt; {
  &lt;span style=&#34;color:#bbb&#34;&gt;count&lt;/span&gt;             = &lt;span style=&#34;color:#24909d&#34;&gt;var&lt;/span&gt;.&lt;span style=&#34;color:#bbb&#34;&gt;create_bucket&lt;/span&gt; == &lt;span style=&#34;color:#6ab825;font-weight:bold&#34;&gt;true&lt;/span&gt; ? &lt;span style=&#34;color:#3677a9&#34;&gt;1&lt;/span&gt; : &lt;span style=&#34;color:#3677a9&#34;&gt;0&lt;/span&gt;
  &lt;span style=&#34;color:#bbb&#34;&gt;source&lt;/span&gt;            = &lt;span style=&#34;color:#ed9d13&#34;&gt;&amp;#34;./modules/s3_bucket&amp;#34;&lt;/span&gt;

  &lt;span style=&#34;color:#bbb&#34;&gt;name&lt;/span&gt;              = &lt;span style=&#34;color:#ed9d13&#34;&gt;&amp;#34;my-unique-bucket&amp;#34;&lt;/span&gt;
  ...
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;The &lt;code&gt;var.create_bucket == true ? 1 : 0&lt;/code&gt;  expression can be written even shorter: &lt;code&gt;var.create_bucket ? 1 : 0&lt;/code&gt;  because the &lt;code&gt;create_bucket&lt;/code&gt; variable has boolean type, apparently.&lt;/p&gt;
&lt;p&gt;But what if you need to produce more than one instance of a resource or module? And still be able to avoid their creation.&lt;/p&gt;
&lt;p&gt;Another meta-argument — &lt;code&gt;for_each&lt;/code&gt; — will do the trick.&lt;/p&gt;
&lt;p&gt;For example, this is how it looks for a module:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-terraform&#34; data-lang=&#34;terraform&#34;&gt;&lt;span style=&#34;color:#6ab825;font-weight:bold&#34;&gt;module&lt;/span&gt; &lt;span style=&#34;color:#ed9d13&#34;&gt;&amp;#34;bucket&amp;#34;&lt;/span&gt; {
  &lt;span style=&#34;color:#bbb&#34;&gt;for_each&lt;/span&gt;          = &lt;span style=&#34;color:#24909d&#34;&gt;var&lt;/span&gt;.&lt;span style=&#34;color:#bbb&#34;&gt;bucket_names&lt;/span&gt; == [] ? [] : &lt;span style=&#34;color:#24909d&#34;&gt;var&lt;/span&gt;.bucket_names
  &lt;span style=&#34;color:#bbb&#34;&gt;source&lt;/span&gt;            = &lt;span style=&#34;color:#ed9d13&#34;&gt;&amp;#34;./modules/s3_bucket&amp;#34;&lt;/span&gt;
  
  &lt;span style=&#34;color:#bbb&#34;&gt;name&lt;/span&gt;              = &lt;span style=&#34;color:#ed9d13&#34;&gt;&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#ed9d13&#34;&gt;${&lt;/span&gt;&lt;span style=&#34;color:#24909d&#34;&gt;each&lt;/span&gt;.key&lt;span style=&#34;color:#ed9d13&#34;&gt;}&lt;/span&gt;&lt;span style=&#34;color:#ed9d13&#34;&gt;&amp;#34;&lt;/span&gt;
  &lt;span style=&#34;color:#bbb&#34;&gt;enable_encryption&lt;/span&gt; = &lt;span style=&#34;color:#6ab825;font-weight:bold&#34;&gt;true&lt;/span&gt;
  ...
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;In this illustration, I also used a conditional expression that makes Terraform iterate through the set of values of &lt;code&gt;var.bucket_names&lt;/code&gt; if it&amp;rsquo;s not empty and create several modules. Otherwise, do not iterate at all and do not create anything.&lt;/p&gt;
&lt;p&gt;The same can be done for the resources. For example, when you need to create an arbitrary number of security group rules, e.g., to allowlist some IPs for your bastion host:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-terraform&#34; data-lang=&#34;terraform&#34;&gt;&lt;span style=&#34;color:#6ab825;font-weight:bold&#34;&gt;resource&lt;/span&gt; &lt;span style=&#34;color:#ed9d13&#34;&gt;&amp;#34;aws_security_group_rule&amp;#34;&lt;/span&gt; &lt;span style=&#34;color:#ed9d13&#34;&gt;&amp;#34;allowlist&amp;#34;&lt;/span&gt; {
  &lt;span style=&#34;color:#bbb&#34;&gt;for_each&lt;/span&gt;           = &lt;span style=&#34;color:#24909d&#34;&gt;var&lt;/span&gt;.&lt;span style=&#34;color:#bbb&#34;&gt;cidr_blocks&lt;/span&gt; == [] ? [] : &lt;span style=&#34;color:#24909d&#34;&gt;var&lt;/span&gt;.cidr_blocks
  &lt;span style=&#34;color:#bbb&#34;&gt;type&lt;/span&gt;               = &lt;span style=&#34;color:#ed9d13&#34;&gt;&amp;#34;ingress&amp;#34;&lt;/span&gt;
  &lt;span style=&#34;color:#bbb&#34;&gt;from_port&lt;/span&gt;          = &lt;span style=&#34;color:#3677a9&#34;&gt;22&lt;/span&gt;
  &lt;span style=&#34;color:#bbb&#34;&gt;to_port&lt;/span&gt;            = &lt;span style=&#34;color:#3677a9&#34;&gt;22&lt;/span&gt;
  &lt;span style=&#34;color:#bbb&#34;&gt;protocol&lt;/span&gt;           = &lt;span style=&#34;color:#ed9d13&#34;&gt;&amp;#34;tcp&amp;#34;&lt;/span&gt;
  &lt;span style=&#34;color:#bbb&#34;&gt;cidr_blocks&lt;/span&gt;        = [&lt;span style=&#34;color:#24909d&#34;&gt;each&lt;/span&gt;.value]
  &lt;span style=&#34;color:#bbb&#34;&gt;security_group_id&lt;/span&gt;  = aws_security_group.bastion.id
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;And just like with the &lt;code&gt;count&lt;/code&gt; meta-argument, with the  &lt;code&gt;for_each&lt;/code&gt;, resource addresses will have the identifier named by the values provided to &lt;code&gt;for_each&lt;/code&gt;.
For example, here is how I would reference a resource created in the module with &lt;code&gt;for_each&lt;/code&gt; described earlier:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-terraform&#34; data-lang=&#34;terraform&#34;&gt;&lt;span style=&#34;color:#bbb&#34;&gt;bucket_name&lt;/span&gt; = &lt;span style=&#34;color:#24909d&#34;&gt;module&lt;/span&gt;.bucket[&lt;span style=&#34;color:#ed9d13&#34;&gt;&amp;#34;photos&amp;#34;&lt;/span&gt;].name
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id=&#34;conditional-resource-arguments-attributes-setting&#34;&gt;Conditional resource arguments (attributes) setting&lt;/h2&gt;
&lt;figure&gt;
    &lt;img loading=&#34;lazy&#34; src=&#34;conditional-resource-argument.png&#34;/&gt; 
&lt;/figure&gt;

&lt;p&gt;Now let&amp;rsquo;s go deeper and see how resource arguments can be conditionally set (or not).
First, let&amp;rsquo;s review the conditional argument value setting with the &lt;code&gt;null&lt;/code&gt; data type:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-terraform&#34; data-lang=&#34;terraform&#34;&gt;&lt;span style=&#34;color:#6ab825;font-weight:bold&#34;&gt;resource&lt;/span&gt; &lt;span style=&#34;color:#ed9d13&#34;&gt;&amp;#34;aws_launch_template&amp;#34;&lt;/span&gt; &lt;span style=&#34;color:#ed9d13&#34;&gt;&amp;#34;this&amp;#34;&lt;/span&gt; {
  &lt;span style=&#34;color:#bbb&#34;&gt;name&lt;/span&gt;     = &lt;span style=&#34;color:#ed9d13&#34;&gt;&amp;#34;my-launch-template&amp;#34;&lt;/span&gt;
  ...
  &lt;span style=&#34;color:#bbb&#34;&gt;key_name&lt;/span&gt; = &lt;span style=&#34;color:#24909d&#34;&gt;var&lt;/span&gt;.use_default_keypair ? &lt;span style=&#34;color:#24909d&#34;&gt;var&lt;/span&gt;.keypair_name : null
  ...
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Here I want to skip the usage of the EC2 Key Pair for the Launch Template in some instances and Terraform allows me to write the conditional expression that will set the &lt;code&gt;null&lt;/code&gt; value for the argument. It means the &lt;em&gt;absence&lt;/em&gt; or &lt;em&gt;omission&lt;/em&gt; and Terraform would behave the same as if you did not specify the argument at all.&lt;/p&gt;
&lt;p&gt;Dynamic blocks are another case where conditional creation suits best. Take a look at the following piece of CloudFront resource code where I want to either describe the configuration for the custom error response or omit that completely:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-terraform&#34; data-lang=&#34;terraform&#34;&gt;&lt;span style=&#34;color:#6ab825;font-weight:bold&#34;&gt;resource&lt;/span&gt; &lt;span style=&#34;color:#ed9d13&#34;&gt;&amp;#34;aws_cloudfront_distribution&amp;#34;&lt;/span&gt; &lt;span style=&#34;color:#ed9d13&#34;&gt;&amp;#34;cdn&amp;#34;&lt;/span&gt; {
  &lt;span style=&#34;color:#bbb&#34;&gt;enabled&lt;/span&gt; = &lt;span style=&#34;color:#6ab825;font-weight:bold&#34;&gt;true&lt;/span&gt;
  ...
  dynamic &lt;span style=&#34;color:#ed9d13&#34;&gt;&amp;#34;custom_error_response&amp;#34;&lt;/span&gt; {
    &lt;span style=&#34;color:#bbb&#34;&gt;for_each&lt;/span&gt; = &lt;span style=&#34;color:#24909d&#34;&gt;var&lt;/span&gt;.&lt;span style=&#34;color:#bbb&#34;&gt;custom_error_response&lt;/span&gt; == null ? [] : [&lt;span style=&#34;color:#24909d&#34;&gt;var&lt;/span&gt;.custom_error_response]
    &lt;span style=&#34;color:#bbb&#34;&gt;iterator&lt;/span&gt; = cer
    content {
      &lt;span style=&#34;color:#bbb&#34;&gt;error_code&lt;/span&gt;            =&lt;span style=&#34;color:#24909d&#34;&gt; lookup&lt;/span&gt;(cer.value, &lt;span style=&#34;color:#ed9d13&#34;&gt;&amp;#34;error_code&amp;#34;&lt;/span&gt;, null)
      &lt;span style=&#34;color:#bbb&#34;&gt;error_caching_min_ttl&lt;/span&gt; =&lt;span style=&#34;color:#24909d&#34;&gt; lookup&lt;/span&gt;(cer.value, &lt;span style=&#34;color:#ed9d13&#34;&gt;&amp;#34;error_caching_min_ttl&amp;#34;&lt;/span&gt;, null)
      &lt;span style=&#34;color:#bbb&#34;&gt;response_code&lt;/span&gt;         =&lt;span style=&#34;color:#24909d&#34;&gt; lookup&lt;/span&gt;(cer.value, &lt;span style=&#34;color:#ed9d13&#34;&gt;&amp;#34;response_code&amp;#34;&lt;/span&gt;, null)
      &lt;span style=&#34;color:#bbb&#34;&gt;response_page_path&lt;/span&gt;    =&lt;span style=&#34;color:#24909d&#34;&gt; lookup&lt;/span&gt;(cer.value, &lt;span style=&#34;color:#ed9d13&#34;&gt;&amp;#34;response_page_path&amp;#34;&lt;/span&gt;, null)
    }
  }
  ...
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;The &lt;code&gt;custom_error_response&lt;/code&gt; variable is &lt;code&gt;null&lt;/code&gt; by default, but it has the &lt;code&gt;object&lt;/code&gt; type, and users can assign the variable with the required nested specifications if needed. And when they do it, Terraform will add the &lt;code&gt;custom_error_response&lt;/code&gt; block to the resource configuration. Otherwise, it will be omitted entirely.&lt;/p&gt;
&lt;h2 id=&#34;convert-types-with-ease&#34;&gt;Convert types with ease&lt;/h2&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img loading=&#34;lazy&#34; src=&#34;types-converstion.png&#34;/&gt; 
&lt;/figure&gt;

Ok, let&amp;rsquo;s move to the less conditional things now 😅&lt;/p&gt;
&lt;p&gt;Terraform has several type conversion functions: &lt;code&gt;tobool()&lt;/code&gt;, &lt;code&gt;tolist()&lt;/code&gt;,&lt;code&gt;tomap()&lt;/code&gt;, &lt;code&gt;tonumber()&lt;/code&gt;, &lt;code&gt;toset()&lt;/code&gt;, and &lt;code&gt;tostring()&lt;/code&gt;. Their purpose is to convert the input values to the compatible types.&lt;/p&gt;
&lt;p&gt;For example, suppose I need to pass the set to the &lt;code&gt;for_each&lt;/code&gt; (it accepts only sets and maps types of value), but I got the list as an input; let&amp;rsquo;s say I got it as an output from another module. In such a case, I would do something like this:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-terraform&#34; data-lang=&#34;terraform&#34;&gt;&lt;span style=&#34;color:#bbb&#34;&gt;for_each&lt;/span&gt; = &lt;span style=&#34;color:#24909d&#34;&gt;toset&lt;/span&gt;(&lt;span style=&#34;color:#24909d&#34;&gt;var&lt;/span&gt;.remote_access_ports)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;However, I can make my code cleaner and avoid the explicit conversion — I just need to define the value type in the configuration block of the &lt;code&gt;my_list&lt;/code&gt; variable. Terraform will do the conversion automatically when the value is assigned.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-terraform&#34; data-lang=&#34;terraform&#34;&gt;&lt;span style=&#34;color:#6ab825;font-weight:bold&#34;&gt;variable&lt;/span&gt; &lt;span style=&#34;color:#ed9d13&#34;&gt;&amp;#34;remote_access_ports&amp;#34;&lt;/span&gt; {
  &lt;span style=&#34;color:#bbb&#34;&gt;description&lt;/span&gt; = &lt;span style=&#34;color:#ed9d13&#34;&gt;&amp;#34;Ports for remote access&amp;#34;&lt;/span&gt;
  &lt;span style=&#34;color:#bbb&#34;&gt;type&lt;/span&gt;        = set(string)
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;While Terraform can do a lot of implicit conversions for you, explicit type conversions are practical during values normalization or when you need to calculate some complex value for a variable. For example, the Local Values, known as &lt;code&gt;locals&lt;/code&gt;, are the most suitable place for doing that.&lt;/p&gt;
&lt;p&gt;By the way, although there is a &lt;code&gt;tolist()&lt;/code&gt; function, there is no such thing as the &lt;code&gt;tostring()&lt;/code&gt; function. But what if you need to convert the list to string in Terraform?&lt;/p&gt;
&lt;p&gt;The &lt;code&gt;one()&lt;/code&gt; function can help here: it takes a list, set, or tuple value with either zero or one element and returns either &lt;code&gt;null&lt;/code&gt; or that one element in the form of string.&lt;/p&gt;
&lt;p&gt;It&amp;rsquo;s useful in cases when a resource created using conditional expression is represented as either a zero- or one-element list, and you need to get a single value which may be either &lt;code&gt;null&lt;/code&gt; or &lt;code&gt;string&lt;/code&gt;, for example:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-terraform&#34; data-lang=&#34;terraform&#34;&gt;&lt;span style=&#34;color:#6ab825;font-weight:bold&#34;&gt;resource&lt;/span&gt; &lt;span style=&#34;color:#ed9d13&#34;&gt;&amp;#34;aws_kms_key&amp;#34;&lt;/span&gt; &lt;span style=&#34;color:#ed9d13&#34;&gt;&amp;#34;main&amp;#34;&lt;/span&gt; {
  &lt;span style=&#34;color:#bbb&#34;&gt;count&lt;/span&gt;               = &lt;span style=&#34;color:#24909d&#34;&gt;var&lt;/span&gt;.ebs_encrypted ? &lt;span style=&#34;color:#3677a9&#34;&gt;1&lt;/span&gt; : &lt;span style=&#34;color:#3677a9&#34;&gt;0&lt;/span&gt;

  &lt;span style=&#34;color:#bbb&#34;&gt;enable_key_rotation&lt;/span&gt; = &lt;span style=&#34;color:#6ab825;font-weight:bold&#34;&gt;true&lt;/span&gt;
  &lt;span style=&#34;color:#bbb&#34;&gt;tags&lt;/span&gt;                = &lt;span style=&#34;color:#24909d&#34;&gt;var&lt;/span&gt;.tags
}
&lt;span style=&#34;color:#6ab825;font-weight:bold&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#6ab825;font-weight:bold&#34;&gt;resource&lt;/span&gt; &lt;span style=&#34;color:#ed9d13&#34;&gt;&amp;#34;aws_kms_alias&amp;#34;&lt;/span&gt; &lt;span style=&#34;color:#ed9d13&#34;&gt;&amp;#34;main&amp;#34;&lt;/span&gt; {
  &lt;span style=&#34;color:#bbb&#34;&gt;count&lt;/span&gt;         = &lt;span style=&#34;color:#24909d&#34;&gt;var&lt;/span&gt;.ebs_encrypted ? &lt;span style=&#34;color:#3677a9&#34;&gt;1&lt;/span&gt; : &lt;span style=&#34;color:#3677a9&#34;&gt;0&lt;/span&gt;

  &lt;span style=&#34;color:#bbb&#34;&gt;name&lt;/span&gt;          = &lt;span style=&#34;color:#ed9d13&#34;&gt;&amp;#34;alias/encrypt-ebs&amp;#34;&lt;/span&gt;
  &lt;span style=&#34;color:#bbb&#34;&gt;target_key_id&lt;/span&gt; = one(aws_kms_key.main[*]key_id)
}

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id=&#34;write-yaml-or-json-as-terraform-code-hcl&#34;&gt;Write YAML or JSON as Terraform code (HCL)&lt;/h2&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img loading=&#34;lazy&#34; src=&#34;write-yaml-json-as-terraform-code.png&#34;/&gt; 
&lt;/figure&gt;

Sometimes you need to supply JSON or YAML files to the services you manage with Terraform. For example, if you want to create something with CloudFormation using Terraform (and I am not kidding). Sometimes the AWS Terraform provider does not support the needed resource, and you want to maintain the whole infrastructure code using only one tool.&lt;/p&gt;
&lt;p&gt;Instead of maintaining another file in JSON or YAML format, you can embed JSON or YAML code management into HCL by taking benefit of the  &lt;code&gt;jsonencode()&lt;/code&gt; or &lt;code&gt;yamlencode()&lt;/code&gt;  functions.&lt;/p&gt;
&lt;p&gt;The attractiveness of this approach is that you can reference other Terraform resources or their attributes right in the code of your object, and you have more freedom in terms of the code syntax and its formatting comparable to native JSON or YAML.&lt;/p&gt;
&lt;p&gt;Here is how it looks like:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-terraform&#34; data-lang=&#34;terraform&#34;&gt;locals {
	&lt;span style=&#34;color:#bbb&#34;&gt;some_string&lt;/span&gt; = &lt;span style=&#34;color:#ed9d13&#34;&gt;&amp;#34;ult&amp;#34;&lt;/span&gt;
  &lt;span style=&#34;color:#bbb&#34;&gt;myjson_object&lt;/span&gt; =&lt;span style=&#34;color:#24909d&#34;&gt; jsonencode&lt;/span&gt;({
    &lt;span style=&#34;color:#ed9d13&#34;&gt;&amp;#34;Hashicorp Products&amp;#34;&lt;/span&gt;: {
      Terra: &lt;span style=&#34;color:#ed9d13&#34;&gt;&amp;#34;form&amp;#34;&lt;/span&gt;
      Con:   &lt;span style=&#34;color:#ed9d13&#34;&gt;&amp;#34;sul&amp;#34;&lt;/span&gt;
      Vag:   &lt;span style=&#34;color:#ed9d13&#34;&gt;&amp;#34;rant&amp;#34;&lt;/span&gt;
      Va:    local.some_string
    }
  })
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;The value of the &lt;code&gt;myjson_object&lt;/code&gt; local variable would look like this:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-json&#34; data-lang=&#34;json&#34;&gt;{
  &lt;span style=&#34;color:#6ab825;font-weight:bold&#34;&gt;&amp;#34;Hashicorp Products&amp;#34;&lt;/span&gt;: {
    &lt;span style=&#34;color:#6ab825;font-weight:bold&#34;&gt;&amp;#34;Con&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#ed9d13&#34;&gt;&amp;#34;sul&amp;#34;&lt;/span&gt;,
    &lt;span style=&#34;color:#6ab825;font-weight:bold&#34;&gt;&amp;#34;Terra&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#ed9d13&#34;&gt;&amp;#34;form&amp;#34;&lt;/span&gt;,
    &lt;span style=&#34;color:#6ab825;font-weight:bold&#34;&gt;&amp;#34;Va&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#ed9d13&#34;&gt;&amp;#34;ult&amp;#34;&lt;/span&gt;,
    &lt;span style=&#34;color:#6ab825;font-weight:bold&#34;&gt;&amp;#34;Vag&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#ed9d13&#34;&gt;&amp;#34;rant&amp;#34;&lt;/span&gt;
  }
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;And here is a piece of real-world example:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-terraform&#34; data-lang=&#34;terraform&#34;&gt;locals {
  &lt;span style=&#34;color:#bbb&#34;&gt;cf_template_body&lt;/span&gt; =&lt;span style=&#34;color:#24909d&#34;&gt; jsonencode&lt;/span&gt;({
    Resources : {
      DedicatedHostGroup : {
        Type : &lt;span style=&#34;color:#ed9d13&#34;&gt;&amp;#34;AWS::ResourceGroups::Group&amp;#34;&lt;/span&gt;
        Properties : {
          Name : &lt;span style=&#34;color:#24909d&#34;&gt;var&lt;/span&gt;.service_name
          Configuration : [
            {
              Type : &lt;span style=&#34;color:#ed9d13&#34;&gt;&amp;#34;AWS::EC2::HostManagement&amp;#34;&lt;/span&gt;
              Parameters : [
                {
                  Name : &lt;span style=&#34;color:#ed9d13&#34;&gt;&amp;#34;auto-allocate-host&amp;#34;&lt;/span&gt;
                  Values : [&lt;span style=&#34;color:#24909d&#34;&gt;var&lt;/span&gt;.auto_allocate_host]
                },
			...
			...
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id=&#34;templatize-stuff&#34;&gt;Templatize stuff&lt;/h2&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img loading=&#34;lazy&#34; src=&#34;templatize-stuff.png&#34;/&gt; 
&lt;/figure&gt;

The last case in this blog but not the least by its efficacy — render source file content as a template in Terraform.&lt;/p&gt;
&lt;p&gt;Let&amp;rsquo;s review the following scenario: you launch an EC2 instance and want to supply it with a bash script (via the user-data parameter) for some additional configuration at launch.&lt;/p&gt;
&lt;p&gt;Suppose we have the following bash script &lt;code&gt;instance-init.sh&lt;/code&gt; that sets the hostname and registers our instance in a monitoring system:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;color:#cd2828;font-weight:bold&#34;&gt;#!/bin/bash
&lt;/span&gt;&lt;span style=&#34;color:#cd2828;font-weight:bold&#34;&gt;&lt;/span&gt;
hostname example.com
bash /opt/system-init/register-monitoring.sh
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;But what if you want to set a different hostname per instance, and some instances should not be registered in the monitoring system?&lt;/p&gt;
&lt;p&gt;In such a case, here is how the script file content will look:&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code class=&#34;language-gotemplate&#34; data-lang=&#34;gotemplate&#34;&gt;#!/bin/bash

hostname ${system_hostname}
%{ if register_monitoring }
bash /opt/system-init/register-monitoring.sh
%{endif}
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;And when you supply this file as an argument for the EC2 instance resource in Terraform, you will use the &lt;code&gt;templatefile()&lt;/code&gt; function to make the magic happen:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-terraform&#34; data-lang=&#34;terraform&#34;&gt;&lt;span style=&#34;color:#6ab825;font-weight:bold&#34;&gt;resource&lt;/span&gt; &lt;span style=&#34;color:#ed9d13&#34;&gt;&amp;#34;aws_instance&amp;#34;&lt;/span&gt; &lt;span style=&#34;color:#ed9d13&#34;&gt;&amp;#34;web&amp;#34;&lt;/span&gt; {
  &lt;span style=&#34;color:#bbb&#34;&gt;ami&lt;/span&gt;           = &lt;span style=&#34;color:#24909d&#34;&gt;var&lt;/span&gt;.my_ami_id
  &lt;span style=&#34;color:#bbb&#34;&gt;instance_type&lt;/span&gt; = &lt;span style=&#34;color:#24909d&#34;&gt;var&lt;/span&gt;.instance_type
  ...
  &lt;span style=&#34;color:#bbb&#34;&gt;user_data&lt;/span&gt; = &lt;span style=&#34;color:#24909d&#34;&gt;templatefile&lt;/span&gt;(&lt;span style=&#34;color:#ed9d13&#34;&gt;&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#ed9d13&#34;&gt;${&lt;/span&gt;path.&lt;span style=&#34;color:#24909d&#34;&gt;module&lt;/span&gt;&lt;span style=&#34;color:#ed9d13&#34;&gt;}&lt;/span&gt;&lt;span style=&#34;color:#ed9d13&#34;&gt;/instance-init.tftpl&amp;#34;&lt;/span&gt;, {
    &lt;span style=&#34;color:#bbb&#34;&gt;system_hostname&lt;/span&gt;     = &lt;span style=&#34;color:#24909d&#34;&gt;var&lt;/span&gt;.system_hostname
    &lt;span style=&#34;color:#bbb&#34;&gt;register_monitoring&lt;/span&gt; = &lt;span style=&#34;color:#24909d&#34;&gt;var&lt;/span&gt;.add_to_monitoring
  })
  ...
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;And of course, you can create a template from any file type. The only requirement here is that the template file must exist on the disk at the beginning of the Terraform execution.&lt;/p&gt;
&lt;h2 id=&#34;key-takeaways&#34;&gt;Key takeaways&lt;/h2&gt;
&lt;p&gt;Terraform is far beyond the standard resource management operations. With the power of built-in functions, you can write more versatile code and reusable Terraform modules.&lt;/p&gt;
&lt;p&gt;✅ Use &lt;a href=&#34;https://www.terraform.io/language/expressions/conditionals&#34;&gt;conditional expressions&lt;/a&gt; with &lt;a href=&#34;https://www.terraform.io/language/meta-arguments/count&#34;&gt;count&lt;/a&gt; and &lt;a href=&#34;https://www.terraform.io/language/meta-arguments/for_each&#34;&gt;for_each&lt;/a&gt; meta-arguments, when the creation of a resource depends on some context or user input.&lt;/p&gt;
&lt;p&gt;✅ Take advantage of &lt;a href=&#34;https://www.terraform.io/language/expressions/types#type-conversion&#34;&gt;implicit type conversion&lt;/a&gt; when working with input variables and their values to keep your code cleaner.&lt;/p&gt;
&lt;p&gt;✅ Embed YAML and JSON-based objects right into your Terraform code using built-in &lt;a href=&#34;https://www.terraform.io/language/functions/jsonencode&#34;&gt;encoding&lt;/a&gt; &lt;a href=&#34;https://www.terraform.io/language/functions/yamlencode&#34;&gt;functions&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;✅ And when you need to pass some files to the managed service, you can treat them as &lt;a href=&#34;https://www.terraform.io/language/functions/templatefile&#34;&gt;templates&lt;/a&gt; and make them multipurpose.&lt;/p&gt;
&lt;p&gt;Thank you for reading down to this point! 🤗&lt;/p&gt;
&lt;p&gt;If you have some favorite Terraform tricks — I would love to know!&lt;/p&gt;
</content>
        </item>
        
    </channel>
</rss>