<!doctype html><html lang=en dir=auto>
<head><meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=robots content="index, follow">
<title>Customizing mac1.metal EC2 AMI ‚Äî new guts, more glory | Serhii Vasylenko</title>
<meta name=keywords content="aws,ansible,packer,macos,ec2">
<meta name=description content="How to build mac1.metal Instance AMI for CI/CD using Ansible and Packer">
<meta name=author content="Serhii Vasylenko">
<link rel=canonical href=https://serhii.vasylenko.info/2021/02/01/customizing-mac1-metal-ec2-ami.html>
<link crossorigin=anonymous href=/assets/css/stylesheet.min.9d0ee5f7e9290da0756b77773249ca87656d25d05fe5e05caecbace6c375a707.css integrity="sha256-nQ7l9+kpDaB1a3d3MknKh2VtJdBf5eBcrsus5sN1pwc=" rel="preload stylesheet" as=style>
<link rel=preload href=/apple-touch-icon.png as=image>
<script defer crossorigin=anonymous src=/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5+kdJvBz5iKbt6B5PJI=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://serhii.vasylenko.info/favicon.ico>
<link rel=icon type=image/png sizes=16x16 href=https://serhii.vasylenko.info/favicon-16x16.png>
<link rel=icon type=image/png sizes=32x32 href=https://serhii.vasylenko.info/favicon-32x32.png>
<link rel=apple-touch-icon href=https://serhii.vasylenko.info/apple-touch-icon.png>
<link rel=mask-icon href=https://serhii.vasylenko.info/safari-pinned-tab.svg>
<meta name=theme-color content="#2e2e33">
<meta name=msapplication-TileColor content="#2e2e33">
<meta name=generator content="Hugo 0.88.0">
<noscript>
<style>#theme-toggle,.top-link{display:none}</style>
<style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style>
</noscript>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-GK7SE0XWGK"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-GK7SE0XWGK',{anonymize_ip:!1})}</script>
<meta property="og:title" content="Customizing mac1.metal EC2 AMI ‚Äî new guts, more glory">
<meta property="og:description" content="How to build mac1.metal Instance AMI for CI/CD using Ansible and Packer">
<meta property="og:type" content="article">
<meta property="og:url" content="https://serhii.vasylenko.info/2021/02/01/customizing-mac1-metal-ec2-ami.html">
<meta property="og:image" content="https://serhii.vasylenko.info/2021-02-01-customizing-mac1-metal-ec2-ami.png"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2021-02-01T00:00:00+00:00">
<meta property="article:modified_time" content="2021-02-01T00:00:00+00:00"><meta property="og:site_name" content="Serhii Vasylenko ‚Äî Personal Blog">
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="https://serhii.vasylenko.info/2021-02-01-customizing-mac1-metal-ec2-ami.png">
<meta name=twitter:title content="Customizing mac1.metal EC2 AMI ‚Äî new guts, more glory">
<meta name=twitter:description content="How to build mac1.metal Instance AMI for CI/CD using Ansible and Packer">
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://serhii.vasylenko.info/posts/"},{"@type":"ListItem","position":3,"name":"Customizing mac1.metal EC2 AMI ‚Äî new guts, more glory","item":"https://serhii.vasylenko.info/2021/02/01/customizing-mac1-metal-ec2-ami.html"}]}</script>
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Customizing mac1.metal EC2 AMI ‚Äî new guts, more glory","name":"Customizing mac1.metal EC2 AMI ‚Äî new guts, more glory","description":"How to build mac1.metal Instance AMI for CI/CD using Ansible and Packer","keywords":["aws","ansible","packer","macos","ec2"],"articleBody":"I guess macOS was designed for a user, not for the ops or engineers, so this is why its customization and usage for CI/CD are not trivial (compared to something Linux-based). A smart guess, huh?\nConfiguration Management Native Apple‚Äôs Mobile device management (a.k.a MDM) and Jamf is probably the most potent combination for macOS configuration. But as much as it‚Äôs mighty, it is a cumbersome combination, and Jamf is not free.\nThen we have Ansible, Chef, Puppet, SaltStack ‚Äî they all are good with Linux, but what about macOS?\nI tried to search for use cases of mentioned CM tools for macOS. However, I concluded that they wrap the execution of native macOS command-line utilities most of the time.\nAnd if you search for the ‚Äòmacos‚Äô word in Chef Supermarket or Puppet Forge, you won‚Äôt be impressed by the number of actively maintained packages. Although, here is a motivating article about using Chef automating-macos-provisioning-with-chef if you prefer it. I could not find something similar and fresh for Puppet, so I am sorry, Puppet fans.\nThat is why I decided to follow the KISS principle and chose Ansible.\nIt‚Äôs easy to write and read the configuration, it allows to group tasks and to add execution logic , and it feels more DevOps executing shell commands inside Ansible tasks instead of shell scripts; I know you know that üòÇ\nBy the way, Ansible Galaxy does not have many management packages for macOS, either. But thankfully, it has the basics:\n homebrew with homebrew_cask and homebrew_tap ‚Äî to install software launchd ‚Äî to manage services osx_defaults ‚Äî to manage some user settings (not all!)  I used Ansible to build the macOS AMI for CI/CD, so here are some tips for such a case.\nSome values are hardcoded intentionally in the code examples for the sake of simplicity and easy reading. You would probably want to parametrize them.\nXcode installation example The following tasks will help you to automate the basics.\n1 2 3 4 5 6 7 8 9 10 11 12 13  - name: Install Xcode shell: \"xip --expand Xcode.xip\" args: chdir: /Applications - name: Accept License Agreement shell: \"/Applications/Xcode.app/Contents/Developer/usr/bin/xcodebuild -license accept\" - name: Accept License Agreement shell: \"/Applications/Xcode.app/Contents/Developer/usr/bin/xcodebuild -runFirstLaunch\" - name: Switch into newly installed Xcode context shell: \"xcode-select --switch /Applications/Xcode.app/Contents/Developer\"   Example of software installation with Brew {% raw %}\n1 2 3 4 5 6 7 8  - name: Install common build software community.general.homebrew: name: \"{{ item }}\" state: latest loop: - swiftlint - swiftformat - wget   {% endraw %}\nScreenSharing (remote desktop) configuration example 1 2 3 4 5 6 7 8 9  - name: Turn On Remote Management shell: \"./kickstart -activate -configure -allowAccessFor -specifiedUsers\" args: chdir: /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/ - name: Enable Remote Management for CI user shell: \"./kickstart -configure -users ec2-user -access -on -privs -all\" args: chdir: /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/   Shell rulez, yes.\nBuilding the AMI Packer by HashiCorp, of course.\nI would love to compare Packer with EC2 Image Builder, but it does not support macOS yet (as of Feb'21).\nPacker configuration is straightforward, so I want to highlight only the things specific to the ‚Äúmac1.metal‚Äù use case.\nTimeouts As I mentioned in the previous article, the creation and deletion time of the ‚Äúmac1.metal‚Äù Instance is significantly bigger than Linux. That is why you should raise the polling parameters for the builder.\nExample:\n1 2 3 4  \"aws_polling\": { \"delay_seconds\": 30, \"max_attempts\": 60 }   And it would be best if you also increased the SSH timeout:\n1  \"ssh_timeout\": \"1h\"   Fortunately, Packer‚Äôs AMI builder does not require an explicit declaration of the Dedicated Host ID. So you can just reference the same subnet where you allocated the Host, assuming you did it with the enabled ‚ÄúAuto placement‚Äù parameter during the host creation.\nExample:\n1 2  \"tenancy\": \"host\", \"subnet_id\": \"your-subnet-id\"   Provisioning Packer has Ansible Provisioner that I used for the AMI. Its documentation is also very clean and straightforward.\nBut it is still worth mentioning that if you want to parametrize the Ansible playbook, then the following configuration example will be handy:\n1 2 3 4 5 6 7 8  \"extra_arguments\": [ \"--extra-vars\", \"your-variable-foo=your-value-bar]\" ], \"ansible_env_vars\": [ \"ANSIBLE_PYTHON_INTERPRETER=auto_legacy_silent\", \"ANSIBLE_OTHER_ENV_VARIABLE=other_value\" ]   Configuration at launch If you‚Äôre familiar with AWS EC2, you probably know what the Instance user data is.\nA group of AWS developers made something similar for the macOS: EC2 macOS Init.\nIt does not support cloud-init as on Linux-based Instances, but it can run shell scripts, which is quite enough.\nEC2 macOS Init utility is a Launch Daemon (macOS terminology) that runs on behalf of the root user at system boot. It executes the commands according to the so-called Priority Groups, or the sequence in other words.\nThe number of the group corresponds to the execution order. You can put several tasks into a single Priority Group, and the tool will execute them simultaneously.\nEC2 macOS Init uses a human-readable configuration file in toml format.\nExample:\n1 2 3 4 5 6 7 8 9  [[Module]] Name = \"Create-some-folder\" PriorityGroup = 3 FatalOnError = false RunPerInstance = true [Module.Command] Cmd = [\"mkdir\", \"/Users/ec2-user/my-directory\"] RunAsUser = \"ec2-user\" EnvironmentVars = [\"MY_VAR_FOO=myValueBar\"]   I should clarify some things here.\nModules ‚Äî a set of pre-defined modules for different purposes. It is something similar to the Ansible modules.\nYou can find the list of available modules here ec2-macos-init/lib/ec2macosinit\nThe RunPerInstance directive controls whether a module should run. There are three of such directives, and here is what they mean:\n RunPerBoot ‚Äî module will run at every system boot RunPerInstance ‚Äî module will run once for the Instance. Each Instance has a unique ID; the init tool fetches it from the AWS API before the execution and keeps its execution history per Instance ID. When you create a new Instance from the AMI, it will have a unique ID, and the module will run again. RunOnce ‚Äî module will run only once, despite the instance ID change  I mentioned the execution history above. When EC2 macOS Init runs on the Instance first time, it creates a unique directory with the name per Instance ID to store the execution history and user data copy.\nRunPerInstance and RunOnce directives depend on the execution history, and modules with those directives will run again on the next boot if the previous execution failed. It was not obvious to me why RunOnce keeps repeating itself every boot until I dug into the source code.\nFinally, there is a module for user data. It runs at the end by default (priority group #4) and pulls the user data script from AWS API before script execution.\nI suggest looking into the default init.toml configuration file to get yourself more familiar with the capabilities of the tool.\nThe init tool can also clear its history, which is useful for the new AMI creation.\nExample:\n1  ec2-macos-init clean -all   And you can run the init manually for debugging purposes.\nExample:\n1  ec2-macos-init run   You can also combine the EC2 macOS Init actions (made by modules) with your script in user data for more accurate nontrivial configurations.\nWrapping up As a whole, building and operating macOS-based AMI does not differ from AMI management for other platforms.\nThere are the same principle stages: prepare, clear, build, execute deployment script (if necessary). Though, the particular implementation of each step has its nuances and constraints.\nSo the whole process may look as follows:\n Provision and configure needed software with Ansible playbook Clean-up system logs and EC2 macOS Init history (again, with Ansible task) Create the AMI Add more customizations at launch with EC2 macOS Init modules and user data (that also executes your Ansible playbook or shell commands)  Getting into all this was both fun and interesting. Sometimes painful, though. üòÜ\nI sincerely hope this article was helpful to you. Thank you for reading!\n","wordCount":"1293","inLanguage":"en","image":"https://serhii.vasylenko.info/2021-02-01-customizing-mac1-metal-ec2-ami.png","datePublished":"2021-02-01T00:00:00Z","dateModified":"2021-02-01T00:00:00Z","author":{"@type":"Person","name":"Serhii Vasylenko"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://serhii.vasylenko.info/2021/02/01/customizing-mac1-metal-ec2-ami.html"},"publisher":{"@type":"Person","name":"Serhii Vasylenko","logo":{"@type":"ImageObject","url":"https://serhii.vasylenko.info/favicon.ico"}}}</script>
</head>
<body id=top>
<script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script>
<header class=header>
<nav class=nav>
<div class=logo>
<a href=https://serhii.vasylenko.info accesskey=h title="Home (Alt + H)">
<img src=/apple-touch-icon.png alt=logo aria-label=logo height=" 30px">Home</a>
<span class=logo-switches>
<button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</button>
</span>
</div>
<ul id=menu>
<li>
<a href=https://serhii.vasylenko.info/categories/ title=Categories>
<span>Categories</span>
</a>
</li>
<li>
<a href=https://serhii.vasylenko.info/search/ title="Search (Alt + /)" accesskey=/>
<span>Search</span>
</a>
</li>
<li>
<a href=https://serhii.vasylenko.info/about/ title="About me">
<span>About me</span>
</a>
</li>
<li>
<a href=https://serhii.vasylenko.info/cv/ title="My CV">
<span>My CV</span>
</a>
</li>
</ul>
</nav>
</header>
<main class=main>
<article class=post-single>
<header class=post-header>
<div class=breadcrumbs><a href=https://serhii.vasylenko.info>Home</a>&nbsp;¬ª&nbsp;<a href=https://serhii.vasylenko.info/posts/>Posts</a></div>
<h1 class=post-title>
Customizing mac1.metal EC2 AMI ‚Äî new guts, more glory
</h1>
<div class=post-description>
How to build mac1.metal Instance AMI for CI/CD using Ansible and Packer
</div>
<div class=post-meta>February 1, 2021&nbsp;¬∑&nbsp;Serhii Vasylenko&nbsp;|&nbsp;<a href=mailto:email-from-blog@vasylenko.info rel="noopener noreferrer" target=_blank>üì© Suggest Changes</a>
</div>
</header>
<figure class=entry-cover>
<img loading=lazy srcset="https://serhii.vasylenko.info/2021/02/01/2021-02-01-customizing-mac1-metal-ec2-ami_huf0a2b01d06e478057f4876b34ba74b7a_66812_360x0_resize_box_3.png 360w ,https://serhii.vasylenko.info/2021/02/01/2021-02-01-customizing-mac1-metal-ec2-ami_huf0a2b01d06e478057f4876b34ba74b7a_66812_480x0_resize_box_3.png 480w ,https://serhii.vasylenko.info/2021/02/01/2021-02-01-customizing-mac1-metal-ec2-ami_huf0a2b01d06e478057f4876b34ba74b7a_66812_720x0_resize_box_3.png 720w ,https://serhii.vasylenko.info/2021/02/01/2021-02-01-customizing-mac1-metal-ec2-ami.png 1000w" sizes="(min-width: 768px) 720px, 100vw" src=https://serhii.vasylenko.info/2021/02/01/2021-02-01-customizing-mac1-metal-ec2-ami.png alt width=1000 height=500>
</figure><div class=toc>
<details>
<summary accesskey=c title="(Alt + C)">
<span class=details>Table of Contents</span>
</summary>
<div class=inner><ul>
<li>
<a href=#configuration-management aria-label="Configuration Management">Configuration Management</a><ul>
<li>
<a href=#xcode-installation-example aria-label="Xcode installation example">Xcode installation example</a></li>
<li>
<a href=#example-of-software-installation-with-brew aria-label="Example of software installation with Brew">Example of software installation with Brew</a></li>
<li>
<a href=#screensharing-remote-desktop-configuration-example aria-label="ScreenSharing (remote desktop) configuration example">ScreenSharing (remote desktop) configuration example</a></li></ul>
</li>
<li>
<a href=#building-the-ami aria-label="Building the AMI">Building the AMI</a><ul>
<li>
<a href=#timeouts aria-label=Timeouts>Timeouts</a></li>
<li>
<a href=#provisioning aria-label=Provisioning>Provisioning</a></li></ul>
</li>
<li>
<a href=#configuration-at-launch aria-label="Configuration at launch">Configuration at launch</a></li>
<li>
<a href=#wrapping-up aria-label="Wrapping up">Wrapping up</a>
</li>
</ul>
</div>
</details>
</div>
<div class=post-content><p>I guess macOS was designed for a user, not for the ops or engineers, so this is why its customization and usage for CI/CD are not trivial (compared to something Linux-based). A smart guess, huh?</p>
<h1 id=configuration-management>Configuration Management<a hidden class=anchor aria-hidden=true href=#configuration-management>#</a></h1>
<p>Native Apple&rsquo;s Mobile device management (a.k.a MDM) and Jamf is probably the most potent combination for macOS configuration. But as much as it&rsquo;s mighty, it is a cumbersome combination, and Jamf is not free.</p>
<p>Then we have Ansible, Chef, Puppet, SaltStack ‚Äî they all are good with Linux, but what about macOS?</p>
<p>I tried to search for use cases of mentioned CM tools for macOS. However, I concluded that they wrap the execution of native macOS command-line utilities most of the time.</p>
<p>And if you search for the &lsquo;macos&rsquo; word in Chef Supermarket or Puppet Forge, you won&rsquo;t be impressed by the number of actively maintained packages. Although, here is a motivating article about using Chef <a href=https://pspdfkit.com/blog/2016/chef-on-macos/>automating-macos-provisioning-with-chef</a> if you prefer it. I could not find something similar and fresh for Puppet, so I am sorry, Puppet fans.</p>
<p>That is why I decided to follow the KISS principle and chose Ansible.</p>
<p>It&rsquo;s easy to write and read the configuration, it allows to group tasks and to add execution logic <del>, and it feels more DevOps executing shell commands inside Ansible tasks instead of shell scripts; I know you know that üòÇ</del></p>
<p>By the way, Ansible Galaxy does not have many management packages for macOS, either. But thankfully, it has the basics:</p>
<ul>
<li><a href=https://docs.ansible.com/ansible/latest/collections/community/general/homebrew_module.html#ansible-collections-community-general-homebrew-module>homebrew</a> with <a href=https://docs.ansible.com/ansible/latest/collections/community/general/homebrew_cask_module.html#ansible-collections-community-general-homebrew-cask-module>homebrew_cask</a> and <a href=https://docs.ansible.com/ansible/latest/collections/community/general/homebrew_tap_module.html#ansible-collections-community-general-homebrew-tap-module>homebrew_tap</a> ‚Äî to install software</li>
<li><a href=https://docs.ansible.com/ansible/latest/collections/community/general/launchd_module.html#ansible-collections-community-general-launchd-module>launchd</a> ‚Äî to manage services</li>
<li><a href=https://docs.ansible.com/ansible/latest/collections/community/general/osx_defaults_module.html#ansible-collections-community-general-osx-defaults-module>osx_defaults</a> ‚Äî to manage some user settings (not all!)</li>
</ul>
<p>I used Ansible to build the macOS AMI for CI/CD, so here are some tips for such a case.</p>
<p><em>Some values are hardcoded intentionally in the code examples for the sake of simplicity and easy reading. You would probably want to parametrize them.</em></p>
<h2 id=xcode-installation-example>Xcode installation example<a hidden class=anchor aria-hidden=true href=#xcode-installation-example>#</a></h2>
<p>The following tasks will help you to automate the basics.</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Install Xcode</span>
      <span style=color:#f92672>shell</span>: <span style=color:#e6db74>&#34;xip --expand Xcode.xip&#34;</span>
      <span style=color:#f92672>args</span>:
        <span style=color:#f92672>chdir</span>: <span style=color:#ae81ff>/Applications</span>

- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Accept License Agreement</span>
  <span style=color:#f92672>shell</span>: <span style=color:#e6db74>&#34;/Applications/Xcode.app/Contents/Developer/usr/bin/xcodebuild -license accept&#34;</span>

- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Accept License Agreement</span>
  <span style=color:#f92672>shell</span>: <span style=color:#e6db74>&#34;/Applications/Xcode.app/Contents/Developer/usr/bin/xcodebuild -runFirstLaunch&#34;</span>

- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Switch into newly installed Xcode context</span>
  <span style=color:#f92672>shell</span>: <span style=color:#e6db74>&#34;xcode-select --switch /Applications/Xcode.app/Contents/Developer&#34;</span>
</code></pre></td></tr></table>
</div>
</div><h2 id=example-of-software-installation-with-brew>Example of software installation with Brew<a hidden class=anchor aria-hidden=true href=#example-of-software-installation-with-brew>#</a></h2>
<p>{% raw %}</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Install common build software</span>
  <span style=color:#f92672>community.general.homebrew</span>:
    <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;{{ item }}&#34;</span>
    <span style=color:#f92672>state</span>: <span style=color:#ae81ff>latest</span>
  <span style=color:#f92672>loop</span>:
    - <span style=color:#ae81ff>swiftlint</span>
    - <span style=color:#ae81ff>swiftformat</span>
    - <span style=color:#ae81ff>wget</span>
</code></pre></td></tr></table>
</div>
</div><p>{% endraw %}</p>
<h2 id=screensharing-remote-desktop-configuration-example>ScreenSharing (remote desktop) configuration example<a hidden class=anchor aria-hidden=true href=#screensharing-remote-desktop-configuration-example>#</a></h2>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Turn On Remote Management</span>
  <span style=color:#f92672>shell</span>: <span style=color:#e6db74>&#34;./kickstart -activate -configure -allowAccessFor -specifiedUsers&#34;</span>
  <span style=color:#f92672>args</span>:
    <span style=color:#f92672>chdir</span>: <span style=color:#ae81ff>/System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/</span>

- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Enable Remote Management for CI user</span>
  <span style=color:#f92672>shell</span>: <span style=color:#e6db74>&#34;./kickstart -configure -users ec2-user -access -on -privs -all&#34;</span>
  <span style=color:#f92672>args</span>:
    <span style=color:#f92672>chdir</span>: <span style=color:#ae81ff>/System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/</span>
</code></pre></td></tr></table>
</div>
</div><p>Shell rulez, yes.</p>
<h1 id=building-the-ami>Building the AMI<a hidden class=anchor aria-hidden=true href=#building-the-ami>#</a></h1>
<p><img loading=lazy src=ami-build.gif alt>
</p>
<p><a href=https://www.packer.io/docs/builders/amazon/ebs>Packer by HashiCorp</a>, of course.</p>
<p>I would love to compare Packer with EC2 Image Builder, but it <a href=https://docs.aws.amazon.com/imagebuilder/latest/userguide/what-is-image-builder.html#image-builder-os>does not support macOS</a> yet (as of Feb'21).</p>
<p>Packer configuration is straightforward, so I want to highlight only the things specific to the &ldquo;mac1.metal&rdquo; use case.</p>
<h2 id=timeouts>Timeouts<a hidden class=anchor aria-hidden=true href=#timeouts>#</a></h2>
<p>As I mentioned in the <a href=https://serhii.vasylenko.info/2021/01/19/mac1-metal-EC2-Instance-user-experience.html>previous article</a>, the creation and deletion time of the &ldquo;mac1.metal&rdquo; Instance is significantly bigger than Linux. That is why you should raise the polling parameters for the builder.</p>
<p>Example:</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#e6db74>&#34;aws_polling&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> {
        <span style=color:#f92672>&#34;delay_seconds&#34;</span>: <span style=color:#ae81ff>30</span>,
        <span style=color:#f92672>&#34;max_attempts&#34;</span>: <span style=color:#ae81ff>60</span>
}
</code></pre></td></tr></table>
</div>
</div><p>And it would be best if you also increased the SSH timeout:</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>  <span style=color:#e6db74>&#34;ssh_timeout&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#e6db74>&#34;1h&#34;</span>
</code></pre></td></tr></table>
</div>
</div><p>Fortunately, Packer&rsquo;s AMI builder does not require an explicit declaration of the Dedicated Host ID. So you can just reference the same subnet where you allocated the Host, assuming you did it with the enabled &ldquo;Auto placement&rdquo; parameter during the host creation.</p>
<p>Example:</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>  <span style=color:#e6db74>&#34;tenancy&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#e6db74>&#34;host&#34;</span><span style=color:#960050;background-color:#1e0010>,</span>
  <span style=color:#e6db74>&#34;subnet_id&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#e6db74>&#34;your-subnet-id&#34;</span>
</code></pre></td></tr></table>
</div>
</div><h2 id=provisioning>Provisioning<a hidden class=anchor aria-hidden=true href=#provisioning>#</a></h2>
<p>Packer has <a href=https://www.packer.io/docs/provisioners/ansible>Ansible Provisioner</a> that I used for the AMI. Its documentation is also very clean and straightforward.</p>
<p>But it is still worth mentioning that if you want to parametrize the Ansible playbook, then the following configuration example will be handy:</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>  <span style=color:#e6db74>&#34;extra_arguments&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> [
    <span style=color:#e6db74>&#34;--extra-vars&#34;</span>,
    <span style=color:#e6db74>&#34;your-variable-foo=your-value-bar]&#34;</span>
  ]<span style=color:#960050;background-color:#1e0010>,</span>
  <span style=color:#e6db74>&#34;ansible_env_vars&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> [
    <span style=color:#e6db74>&#34;ANSIBLE_PYTHON_INTERPRETER=auto_legacy_silent&#34;</span>,
    <span style=color:#e6db74>&#34;ANSIBLE_OTHER_ENV_VARIABLE=other_value&#34;</span>
  ]
</code></pre></td></tr></table>
</div>
</div><h1 id=configuration-at-launch>Configuration at launch<a hidden class=anchor aria-hidden=true href=#configuration-at-launch>#</a></h1>
<p>If you&rsquo;re familiar with AWS EC2, you probably know what the Instance <code>user data</code> is.</p>
<p>A group of AWS developers made something similar for the macOS: <a href=https://github.com/aws/ec2-macos-init>EC2 macOS Init</a>.</p>
<p>It does not support <code>cloud-init</code> as on Linux-based Instances, but it can run shell scripts, which is quite enough.</p>
<p>EC2 macOS Init utility is a Launch Daemon (macOS terminology) that runs on behalf of the <code>root</code> user at system boot. It executes the commands according to the so-called Priority Groups, or the sequence in other words.</p>
<p>The number of the group corresponds to the execution order. You can put several tasks into a single Priority Group, and the tool will execute them simultaneously.</p>
<p>EC2 macOS Init uses a human-readable configuration file in <code>toml</code> format.</p>
<p>Example:</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>[[Module]]
  Name = &#34;Create-some-folder&#34;
  PriorityGroup = 3
  FatalOnError = false 
  RunPerInstance = true 
  [Module.Command]
    Cmd = [&#34;mkdir&#34;, &#34;/Users/ec2-user/my-directory&#34;] 
    RunAsUser = &#34;ec2-user&#34;
    EnvironmentVars = [&#34;MY_VAR_FOO=myValueBar&#34;]
</code></pre></td></tr></table>
</div>
</div><p>I should clarify some things here.</p>
<p>Modules ‚Äî a set of pre-defined modules for different purposes. It is something similar to the Ansible modules.</p>
<p>You can find the list of available modules here <a href=https://github.com/aws/ec2-macos-init/tree/master/lib/ec2macosinit>ec2-macos-init/lib/ec2macosinit</a></p>
<p>The <code>RunPerInstance</code> directive controls whether a module should run. There are three of such directives, and here is what they mean:</p>
<ul>
<li><code>RunPerBoot</code> ‚Äî module will run at every system boot</li>
<li><code>RunPerInstance</code> ‚Äî module will run once for the Instance. Each Instance has a unique ID; the init tool fetches it from the AWS API before the execution and keeps its execution history per Instance ID. When you create a new Instance from the AMI, it will have a unique ID, and the module will run again.</li>
<li><code>RunOnce</code> ‚Äî module will run only once, despite the instance ID change</li>
</ul>
<p>I mentioned the execution history above. When EC2 macOS Init runs on the Instance first time, it creates a unique directory with the name per Instance ID to store the execution history and user data copy.</p>
<p><code>RunPerInstance</code> and <code>RunOnce</code> directives depend on the execution history, and modules with those directives will run again on the next boot if the previous execution failed. It was not obvious to me why RunOnce keeps repeating itself every boot until I dug into <a href=https://github.com/aws/ec2-macos-init/blob/master/lib/ec2macosinit/module.go#L110>the source code</a>.</p>
<p>Finally, there is a module for user data. It runs at the end by default (priority group #4) and pulls the user data script from AWS API before script execution.</p>
<p>I suggest looking into the default <a href=https://github.com/aws/ec2-macos-init/blob/master/configuration/init.toml>init.toml</a> configuration file to get yourself more familiar with the capabilities of the tool.</p>
<p>The init tool can also clear its history, which is useful for the new AMI creation.</p>
<p>Example:</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>ec2-macos-init clean -all
</code></pre></td></tr></table>
</div>
</div><p>And you can run the init manually for debugging purposes.</p>
<p>Example:</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>ec2-macos-init run
</code></pre></td></tr></table>
</div>
</div><p>You can also combine the EC2 macOS Init actions (made by modules) with your script in user data for more accurate nontrivial configurations.</p>
<h1 id=wrapping-up>Wrapping up<a hidden class=anchor aria-hidden=true href=#wrapping-up>#</a></h1>
<p>As a whole, building and operating macOS-based AMI does not differ from AMI management for other platforms.</p>
<p>There are the same principle stages: prepare, clear, build, execute deployment script (if necessary). Though, the particular implementation of each step has its nuances and constraints.</p>
<p>So the whole process may look as follows:</p>
<ul>
<li>Provision and configure needed software with Ansible playbook</li>
<li>Clean-up system logs and EC2 macOS Init history (again, with Ansible task)</li>
<li>Create the AMI</li>
<li>Add more customizations at launch with EC2 macOS Init modules and user data (that also executes your Ansible playbook or shell commands)</li>
</ul>
<p>Getting into all this was both fun and interesting. Sometimes painful, though. üòÜ</p>
<p>I sincerely hope this article was helpful to you. Thank you for reading!</p>
</div>
<footer class=post-footer>
<p>If you liked the article, please <b>support me by sharing</b> it on social networks üôè</p>
<p>Also feel free to <a href=mailto:email-from-blog@vasylenko.info style=text-transform:lowercase;text-decoration:underline rel="noopener noreferrer" target=_blank>üì© Suggest Changes</a> by emailing me or leave your comment below!</p>
<div class=share-buttons>
<a target=_blank rel="noopener noreferrer" aria-label="share Customizing mac1.metal EC2 AMI ‚Äî new guts, more glory on twitter" href="https://twitter.com/intent/tweet/?text=Customizing%20mac1.metal%20EC2%20AMI%20%e2%80%94%20new%20guts%2c%20more%20glory&url=https%3a%2f%2fserhii.vasylenko.info%2f2021%2f02%2f01%2fcustomizing-mac1-metal-ec2-ami.html&hashtags=aws%2cansible%2cpacker%2cmacos%2cec2"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share Customizing mac1.metal EC2 AMI ‚Äî new guts, more glory on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fserhii.vasylenko.info%2f2021%2f02%2f01%2fcustomizing-mac1-metal-ec2-ami.html&title=Customizing%20mac1.metal%20EC2%20AMI%20%e2%80%94%20new%20guts%2c%20more%20glory&summary=Customizing%20mac1.metal%20EC2%20AMI%20%e2%80%94%20new%20guts%2c%20more%20glory&source=https%3a%2f%2fserhii.vasylenko.info%2f2021%2f02%2f01%2fcustomizing-mac1-metal-ec2-ami.html"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share Customizing mac1.metal EC2 AMI ‚Äî new guts, more glory on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fserhii.vasylenko.info%2f2021%2f02%2f01%2fcustomizing-mac1-metal-ec2-ami.html&title=Customizing%20mac1.metal%20EC2%20AMI%20%e2%80%94%20new%20guts%2c%20more%20glory"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share Customizing mac1.metal EC2 AMI ‚Äî new guts, more glory on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fserhii.vasylenko.info%2f2021%2f02%2f01%2fcustomizing-mac1-metal-ec2-ami.html"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg>
</a>
</div>
<ul class=post-tags>
<li><a href=https://serhii.vasylenko.info/tags/aws/>aws</a></li>
<li><a href=https://serhii.vasylenko.info/tags/ansible/>ansible</a></li>
<li><a href=https://serhii.vasylenko.info/tags/packer/>packer</a></li>
<li><a href=https://serhii.vasylenko.info/tags/macos/>macos</a></li>
<li><a href=https://serhii.vasylenko.info/tags/ec2/>ec2</a></li>
</ul>
<nav class=paginav>
<a class=prev href=https://serhii.vasylenko.info/2021/02/14/image-compression-with-tinypng-from-macos-contextual-menu.html>
<span class=title>¬´ Prev Page</span>
<br>
<span>Using TinyPNG Image Compression From MacOS Finder Contextual Menu</span>
</a>
<a class=next href=https://serhii.vasylenko.info/2021/01/20/terraforming-mac1-metal-at-AWS.html>
<span class=title>Next Page ¬ª</span>
<br>
<span>Terraforming mac1.metal at AWS</span>
</a>
</nav>
</footer><div id=disqus_thread></div>
<script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return}var b=document,a=b.createElement('script');a.async=!0,a.src='//serhii-vasylenko-info.disqus.com/embed.js',a.setAttribute('data-timestamp',+new Date),(b.head||b.body).appendChild(a)})()</script>
<noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript>
<a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a>
</article>
</main>
<footer class=footer>
<span>&copy; 2021 <a href=https://serhii.vasylenko.info>Serhii Vasylenko</a></span>
<span>
Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a>
</span>
</footer>
<a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a>
<script>let menu=document.getElementById('menu');menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)},document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script>
<script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script>
<script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script>
<script>document.querySelectorAll('pre > code').forEach(b=>{const c=b.parentNode.parentNode,a=document.createElement('button');a.classList.add('copy-code'),a.innerText='copy';function d(){a.innerText='copied!',setTimeout(()=>{a.innerText='copy'},2e3)}a.addEventListener('click',e=>{if('clipboard'in navigator){navigator.clipboard.writeText(b.textContent),d();return}const a=document.createRange();a.selectNodeContents(b);const c=window.getSelection();c.removeAllRanges(),c.addRange(a);try{document.execCommand('copy'),d()}catch(a){}c.removeRange(a)}),c.classList.contains("highlight")?c.appendChild(a):c.parentNode.firstChild==c||(b.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?b.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(a):b.parentNode.appendChild(a))})</script>
</body>
</html>