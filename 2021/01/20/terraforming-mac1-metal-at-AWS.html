<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Terraforming mac1.metal at AWS | devDosvid â€” technical blog about cloud engineering</title><meta name=keywords content="aws,terraform,automation,ec2"><meta name=description content="How to manage mac1.metal EC2 instances with Terraform"><meta name=author content="Serhii Vasylenko"><link rel=canonical href=https://devdosvid.blog/2021/01/20/terraforming-mac1-metal-at-AWS.html><link crossorigin=anonymous href=/assets/css/stylesheet.min.c29b2e302c637564d196d6dc41ee1d0a35a4d6fad2dc48550b9aac2d0f962e62.css integrity="sha256-wpsuMCxjdWTRltbcQe4dCjWk1vrS3EhVC5qsLQ+WLmI=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.min.2840b7fccd34145847db71a290569594bdbdb00047097f75d6495d162f5d7dff.js integrity="sha256-KEC3/M00FFhH23GikFaVlL29sABHCX911kldFi9dff8=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://devdosvid.blog/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://devdosvid.blog/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://devdosvid.blog/favicon-32x32.png><link rel=apple-touch-icon href=https://devdosvid.blog/apple-touch-icon.png><link rel=mask-icon href=https://devdosvid.blog/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script type=text/javascript>window.heap=window.heap||[],heap.load=function(i,o){window.heap.appid=i,window.heap.config=o=o||{},e=document.createElement("script"),e.type="text/javascript",e.async=!0,e.src="https://cdn.heapanalytics.com/js/heap-"+i+".js",n=document.getElementsByTagName("script")[0],n.parentNode.insertBefore(e,n);for(var e,n,a=function(e){return function(){heap.push([e].concat(Array.prototype.slice.call(arguments,0)))}},s=["addEventProperties","addUserProperties","clearEventProperties","identify","resetIdentity","removeEventProperty","setEventProperties","track","unsetEventProperty"],t=0;t<s.length;t++)heap[s[t]]=a(s[t])},heap.load("2300872157")</script><meta property="og:title" content="Terraforming mac1.metal at AWS"><meta property="og:description" content="How to manage mac1.metal EC2 instances with Terraform"><meta property="og:type" content="article"><meta property="og:url" content="https://devdosvid.blog/2021/01/20/terraforming-mac1-metal-at-AWS.html"><meta property="og:image" content="https://devdosvid.blog/2021-01-20-terraforming-mac1-metal-at-AWS.jpg"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-01-20T00:00:00+00:00"><meta property="article:modified_time" content="2022-04-26T01:02:31+02:00"><meta property="og:site_name" content="devDosvid â€” technical blog about cloud engineering"><meta property="og:see_also" content="https://devdosvid.blog/2021/10/24/auto-scaling-group-for-your-macos-ec2-instances-fleet/"><meta property="og:see_also" content="https://devdosvid.blog/2021/05/27/run-ansible-playbook-on-mac1.metal-instances-fleet-with-aws-systems-manager/"><meta property="og:see_also" content="https://devdosvid.blog/2021/02/01/customizing-mac1-metal-ec2-ami.html"><meta property="og:see_also" content="https://devdosvid.blog/2021/01/19/mac1-metal-EC2-Instance-user-experience.html"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://devdosvid.blog/2021-01-20-terraforming-mac1-metal-at-AWS.jpg"><meta name=twitter:title content="Terraforming mac1.metal at AWS"><meta name=twitter:description content="How to manage mac1.metal EC2 instances with Terraform"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://devdosvid.blog/posts/"},{"@type":"ListItem","position":3,"name":"Terraforming mac1.metal at AWS","item":"https://devdosvid.blog/2021/01/20/terraforming-mac1-metal-at-AWS.html"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Terraforming mac1.metal at AWS","name":"Terraforming mac1.metal at AWS","description":"How to manage mac1.metal EC2 instances with Terraform","keywords":["aws","terraform","automation","ec2"],"articleBody":"Updated on the 23rd of October, 2021: Terraform AWS provider now supports Dedicated Hosts natively  In November 2021, AWS announced the support for Mac mini instances.\nI believe this is huge, even despite the number of constraints this solution has. This offering opens the door to seamless macOS CI/CD integration into existing AWS infrastructure.\nSo here is a quick-start example of creating the dedicated host and the instance altogether using Terraform.\nI intentionally used some hardcoded values for the sake of simplicity in the example.\nresource \"aws_ec2_host\" \"example_host\" {  instance_type = \"mac1.metal\"  availability_zone = \"us-east-1a\" }  resource \"aws_instance\" \"example_instance\" {  ami = data.aws_ami.mac1metal.id  host_id = aws_ec2_host.example_host.id  instance_type = \"mac1.metal\"  subnet_id = data.aws_subnet.example_subnet.id }  data \"aws_subnet\" \"example_subnet\" {  availability_zone = \"us-east-1a\"  filter {  name = \"tag:Tier\"# you should omit this filter if you don't distinguish your subnets on private and public  values = [\"private\"]  } }  data \"aws_ami\" \"mac1metal\" {  owners = [\"amazon\"]  most_recent = true  filter {  name = \"name\"  values = [\"amzn-ec2-macos-11*\"]# get latest BigSur AMI  } } Simple as that, yes. Now, you can integrate it into your CI system and have the Mac instance with the underlying host in a bundle. Pro tip: you can leverage the aws_ec2_instance_type_offerings Data Source and use its output with aws_subnet source to avoid availability zone hardcoding. \nTo make the code more uniform and reusable, you can wrap it into a Terraform module that accepts specific parameters (such as instance_type or availability_zone) as input variables.\n","wordCount":"243","inLanguage":"en","image":"https://devdosvid.blog/2021-01-20-terraforming-mac1-metal-at-AWS.jpg","datePublished":"2021-01-20T00:00:00Z","dateModified":"2022-04-26T01:02:31+02:00","author":{"@type":"Person","name":"Serhii Vasylenko"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://devdosvid.blog/2021/01/20/terraforming-mac1-metal-at-AWS.html"},"publisher":{"@type":"Person","name":"devDosvid â€” technical blog about cloud engineering","logo":{"@type":"ImageObject","url":"https://devdosvid.blog/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://devdosvid.blog accesskey=h title="Home (Alt + H)">Home</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://devdosvid.blog/index.xml title="RSS Feed"><span>RSS Feed</span></a></li><li><a href=https://devdosvid.blog/archive title="All posts"><span>All posts</span></a></li><li><a href=https://devdosvid.blog/about/ title="About me"><span>About me</span></a></li><li><a href=https://devdosvid.blog/cv/ title="My CV"><span>My CV</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://devdosvid.blog>Home</a>&nbsp;Â»&nbsp;<a href=https://devdosvid.blog/posts/>Posts</a></div><h1 class=post-title>Terraforming mac1.metal at AWS</h1><div class=post-description>How to manage mac1.metal EC2 instances with Terraform</div><div class=post-meta><span title="2021-01-20 00:00:00 +0000 UTC">January 20, 2021</span>&nbsp;Â·&nbsp;2 min&nbsp;Â·&nbsp;243 words&nbsp;Â·&nbsp;Serhii Vasylenko&nbsp;|&nbsp;<a href=mailto:contact@devdosvid.blog rel="noopener noreferrer" target=_blank>ðŸ“© Suggest Changes</a></div></header><figure class=entry-cover><img loading=lazy srcset="https://devdosvid.blog/2021/01/20/2021-01-20-terraforming-mac1-metal-at-AWS_hu98db5d6334a3c514db2f9164fffc7a39_25339_360x0_resize_q75_box.jpg 360w ,https://devdosvid.blog/2021/01/20/2021-01-20-terraforming-mac1-metal-at-AWS_hu98db5d6334a3c514db2f9164fffc7a39_25339_480x0_resize_q75_box.jpg 480w ,https://devdosvid.blog/2021/01/20/2021-01-20-terraforming-mac1-metal-at-AWS_hu98db5d6334a3c514db2f9164fffc7a39_25339_720x0_resize_q75_box.jpg 720w ,https://devdosvid.blog/2021/01/20/2021-01-20-terraforming-mac1-metal-at-AWS.jpg 1000w" sizes="(min-width: 768px) 720px, 100vw" src=https://devdosvid.blog/2021/01/20/2021-01-20-terraforming-mac1-metal-at-AWS.jpg alt width=1000 height=500></figure><div class=post-content><div class=updatenotice>Updated on the 23rd of October, 2021: Terraform AWS provider now <a href=https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/ec2_host>supports</a> Dedicated Hosts natively</div><p>In November 2021, AWS <a href=https://aws.amazon.com/blogs/aws/new-use-mac-instances-to-build-test-macos-ios-ipados-tvos-and-watchos-apps/>announced</a> the support for Mac mini instances.</p><p>I believe this is huge, even despite the number of constraints this solution has. This offering opens the door to seamless macOS CI/CD integration into existing AWS infrastructure.</p><p>So here is a quick-start example of creating the dedicated host and the instance altogether using Terraform.</p><p>I intentionally used some hardcoded values for the sake of simplicity in the example.</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#6ab825;font-weight:700>resource</span> <span style=color:#ed9d13>&#34;aws_ec2_host&#34; &#34;example_host&#34;</span> {
</span></span><span style=display:flex><span>  instance_type     = <span style=color:#ed9d13>&#34;mac1.metal&#34;</span>
</span></span><span style=display:flex><span>  availability_zone = <span style=color:#ed9d13>&#34;us-east-1a&#34;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6ab825;font-weight:700>resource</span> <span style=color:#ed9d13>&#34;aws_instance&#34; &#34;example_instance&#34;</span> {
</span></span><span style=display:flex><span>  ami           = <span style=color:#6ab825;font-weight:700>data</span>.<span style=color:#6ab825;font-weight:700>aws_ami</span>.<span style=color:#6ab825;font-weight:700>mac1metal</span>.<span style=color:#6ab825;font-weight:700>id</span>
</span></span><span style=display:flex><span>  host_id       = <span style=color:#6ab825;font-weight:700>aws_ec2_host</span>.<span style=color:#6ab825;font-weight:700>example_host</span>.<span style=color:#6ab825;font-weight:700>id</span>
</span></span><span style=display:flex><span>  instance_type = <span style=color:#ed9d13>&#34;mac1.metal&#34;</span>
</span></span><span style=display:flex><span>  subnet_id     = <span style=color:#6ab825;font-weight:700>data</span>.<span style=color:#6ab825;font-weight:700>aws_subnet</span>.<span style=color:#6ab825;font-weight:700>example_subnet</span>.<span style=color:#6ab825;font-weight:700>id</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6ab825;font-weight:700>data</span> <span style=color:#ed9d13>&#34;aws_subnet&#34; &#34;example_subnet&#34;</span> {
</span></span><span style=display:flex><span>  availability_zone = <span style=color:#ed9d13>&#34;us-east-1a&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#6ab825;font-weight:700>filter</span> {
</span></span><span style=display:flex><span>    name   = <span style=color:#ed9d13>&#34;tag:Tier&#34;</span><span style=color:#999;font-style:italic> # you should omit this filter if you don&#39;t distinguish your subnets on private and public 
</span></span></span><span style=display:flex><span><span style=color:#999;font-style:italic></span>    values = [<span style=color:#ed9d13>&#34;private&#34;</span>]
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6ab825;font-weight:700>data</span> <span style=color:#ed9d13>&#34;aws_ami&#34; &#34;mac1metal&#34;</span> {
</span></span><span style=display:flex><span>  owners      = [<span style=color:#ed9d13>&#34;amazon&#34;</span>]
</span></span><span style=display:flex><span>  most_recent = <span style=color:#6ab825;font-weight:700>true</span>
</span></span><span style=display:flex><span>  <span style=color:#6ab825;font-weight:700>filter</span> {
</span></span><span style=display:flex><span>    name   = <span style=color:#ed9d13>&#34;name&#34;</span>
</span></span><span style=display:flex><span>    values = [<span style=color:#ed9d13>&#34;amzn-ec2-macos-11*&#34;</span>]<span style=color:#999;font-style:italic> # get latest BigSur AMI
</span></span></span><span style=display:flex><span><span style=color:#999;font-style:italic></span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Simple as that, yes. Now, you can integrate it into your CI system and have the Mac instance with the underlying host in a bundle.<div class=attention>Pro tip: you can leverage the <code>aws_ec2_instance_type_offerings</code> <a href=https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/ec2_instance_type_offerings>Data Source</a> and use its output with <code>aws_subnet</code> source to avoid availability zone hardcoding.</div></p><p>To make the code more uniform and reusable, you can wrap it into a <a href=/2020/09/09/terraform-modules-explained.html>Terraform module</a> that accepts specific parameters (such as <code>instance_type</code> or <code>availability_zone</code>) as input variables.</p></div><footer class=post-footer><div class=post-series><p>Check out other posts of the <b>"mac1.metal at AWS"</b> series:</p><ul><li>Oct 24, 2021 â€” <a href="https://devdosvid.blog/2021/10/24/auto-scaling-group-for-your-macos-ec2-instances-fleet/?utm_blogseries=mac1.metal-at-aws">Auto Scaling Group for your macOS EC2 Instances fleet</a></li><li>May 27, 2021 â€” <a href="https://devdosvid.blog/2021/05/27/run-ansible-playbook-on-mac1.metal-instances-fleet-with-aws-systems-manager/?utm_blogseries=mac1.metal-at-aws">Run Ansible playbook on mac1.metal instances fleet with AWS Systems Manager</a></li><li>Feb 01, 2021 â€” <a href="https://devdosvid.blog/2021/02/01/customizing-mac1-metal-ec2-ami.html?utm_blogseries=mac1.metal-at-aws">Customizing mac1.metal EC2 AMI â€” new guts, more glory</a></li><li style=opacity:.75>Jan 20, 2021 â€” Terraforming mac1.metal at AWS</li><li>Jan 19, 2021 â€” <a href="https://devdosvid.blog/2021/01/19/mac1-metal-EC2-Instance-user-experience.html?utm_blogseries=mac1.metal-at-aws">mac1.metal EC2 Instance â€” user experience</a></li></ul></div><ul class=post-tags></ul><div class=license><p>This work is licensed under a <a rel=license href=http://creativecommons.org/licenses/by-nd/4.0/>Creative Commons Attribution-NoDerivatives 4.0 International License</a></p></div><nav class=paginav><a class=prev href=https://devdosvid.blog/2021/02/01/customizing-mac1-metal-ec2-ami.html><span class=title>Â« Prev Page</span><br><span>Customizing mac1.metal EC2 AMI â€” new guts, more glory</span></a>
<a class=next href=https://devdosvid.blog/2021/01/19/mac1-metal-EC2-Instance-user-experience.html><span class=title>Next Page Â»</span><br><span>mac1.metal EC2 Instance â€” user experience</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2022 <a href=https://devdosvid.blog>devDosvid â€” technical blog about cloud engineering</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(t){t.preventDefault();var e=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView({behavior:"smooth"}),e==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${e}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(t=>{const n=t.parentNode.parentNode,e=document.createElement("button");e.classList.add("copy-code"),e.innerText="copy";function s(){e.innerText="copied!",setTimeout(()=>{e.innerText="copy"},2e3)}e.addEventListener("click",o=>{if("clipboard"in navigator){navigator.clipboard.writeText(t.textContent),s();return}const e=document.createRange();e.selectNodeContents(t);const n=window.getSelection();n.removeAllRanges(),n.addRange(e);try{document.execCommand("copy"),s()}catch(e){}n.removeRange(e)}),n.classList.contains("highlight")?n.appendChild(e):n.parentNode.firstChild==n||(t.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?t.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(e):t.parentNode.appendChild(e))})</script></body></html>