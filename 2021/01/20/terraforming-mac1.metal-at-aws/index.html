<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Terraforming mac1.metal at AWS | devDosvid blog</title>
<meta name=keywords content="aws,terraform,automation,ec2"><meta name=description content="How to manage MacOS EC2 Instances with Terraform"><meta name=author content="Serhii Vasylenko"><link rel=canonical href=https://devdosvid.blog/2021/01/20/terraforming-mac1.metal-at-aws/><link crossorigin=anonymous href=/assets/css/stylesheet.51adfef0209146fea88d574556a024fb0fe75550725c247200ff67f0bd77de4a.css integrity="sha256-Ua3+8CCRRv6ojVdFVqAk+w/nVVByXCRyAP9n8L133ko=" rel="preload stylesheet" as=style><link rel=icon href=https://devdosvid.blog/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://devdosvid.blog/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://devdosvid.blog/favicon-32x32.png><link rel=apple-touch-icon href=https://devdosvid.blog/apple-touch-icon.png><link rel=mask-icon href=https://devdosvid.blog/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://devdosvid.blog/2021/01/20/terraforming-mac1.metal-at-aws/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><style>@font-face{font-family:albert sans;font-style:normal;font-display:swap;font-weight:300;src:url(/assets/fonts/AlbertSans-Light.woff2)format('woff');unicode-range:U+??,U+131,U+152-153,U+2BB-2BC,U+2C6,U+2DA,U+2DC,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}@font-face{font-family:albert sans;font-style:italic;font-display:swap;font-weight:300;src:url(/assets/fonts/AlbertSans-LightItalic.woff2)format('woff');unicode-range:U+??,U+131,U+152-153,U+2BB-2BC,U+2C6,U+2DA,U+2DC,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}@font-face{font-family:albert sans;font-style:normal;font-display:swap;font-weight:400;src:url(/assets/fonts/AlbertSans-Regular.woff2)format('woff');unicode-range:U+??,U+131,U+152-153,U+2BB-2BC,U+2C6,U+2DA,U+2DC,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}@font-face{font-family:albert sans;font-style:italic;font-display:swap;font-weight:400;src:url(/assets/fonts/AlbertSans-Italic.woff2)format('woff');unicode-range:U+??,U+131,U+152-153,U+2BB-2BC,U+2C6,U+2DA,U+2DC,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}@font-face{font-family:albert sans;font-style:normal;font-display:swap;font-weight:500;src:url(/assets/fonts/AlbertSans-Medium.woff2)format('woff');unicode-range:U+??,U+131,U+152-153,U+2BB-2BC,U+2C6,U+2DA,U+2DC,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}@font-face{font-family:albert sans;font-style:italic;font-display:swap;font-weight:500;src:url(/assets/fonts/AlbertSans-MediumItalic.woff2)format('woff');unicode-range:U+??,U+131,U+152-153,U+2BB-2BC,U+2C6,U+2DA,U+2DC,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}@font-face{font-family:albert sans;font-style:normal;font-display:swap;font-weight:600;src:url(/assets/fonts/AlbertSans-SemiBold.woff2)format('woff');unicode-range:U+??,U+131,U+152-153,U+2BB-2BC,U+2C6,U+2DA,U+2DC,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}@font-face{font-family:albert sans;font-style:italic;font-display:swap;font-weight:600;src:url(/assets/fonts/AlbertSans-SemiBoldItalic.woff2)format('woff');unicode-range:U+??,U+131,U+152-153,U+2BB-2BC,U+2C6,U+2DA,U+2DC,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}</style><meta name=twitter:creator content="@vasylenko"><meta name=twitter:site content="@vasylenko"><script defer type=text/javascript>window.heap=window.heap||[],heap.load=function(e,t){window.heap.appid=e,window.heap.config=t=t||{},n=document.createElement("script"),n.type="text/javascript",n.async=!0,n.src="https://cdn.heapanalytics.com/js/heap-"+e+".js",o=document.getElementsByTagName("script")[0],o.parentNode.insertBefore(n,o);for(var n,o,a=function(e){return function(){heap.push([e].concat(Array.prototype.slice.call(arguments,0)))}},i=["addEventProperties","addUserProperties","clearEventProperties","identify","resetIdentity","removeEventProperty","setEventProperties","track","unsetEventProperty"],s=0;s<i.length;s++)heap[i[s]]=a(i[s])},heap.load("2300872157")</script><meta property="og:title" content="Terraforming mac1.metal at AWS"><meta property="og:description" content="How to manage MacOS EC2 Instances with Terraform"><meta property="og:type" content="article"><meta property="og:url" content="https://devdosvid.blog/2021/01/20/terraforming-mac1.metal-at-aws/"><meta property="og:image" content="https://devdosvid.blog/2021/01/20/terraforming-mac1.metal-at-aws/cover-image.jpg"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-01-20T00:00:00+00:00"><meta property="article:modified_time" content="2024-05-06T21:14:06+02:00"><meta property="og:site_name" content="devDosvid blog"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://devdosvid.blog/2021/01/20/terraforming-mac1.metal-at-aws/cover-image.jpg"><meta name=twitter:title content="Terraforming mac1.metal at AWS"><meta name=twitter:description content="How to manage MacOS EC2 Instances with Terraform"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://devdosvid.blog/posts/"},{"@type":"ListItem","position":2,"name":"Terraforming mac1.metal at AWS","item":"https://devdosvid.blog/2021/01/20/terraforming-mac1.metal-at-aws/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Terraforming mac1.metal at AWS","name":"Terraforming mac1.metal at AWS","description":"How to manage MacOS EC2 Instances with Terraform","keywords":["aws","terraform","automation","ec2"],"articleBody":" Updated on the 23rd of October, 2021: Terraform AWS provider now supports Dedicated Hosts natively In November 2021, AWS announced the support for Mac mini instances.\nI believe this is huge, even despite the number of constraints this solution has. This offering opens the door to seamless macOS CI/CD integration into existing AWS infrastructure.\nSo here is a quick-start example of creating the dedicated host and the instance altogether using Terraform.\nI intentionally used some hardcoded values for the sake of simplicity in the example.\nresource \"aws_ec2_host\" \"example_host\" { instance_type = \"mac1.metal\" availability_zone = \"us-east-1a\" } resource \"aws_instance\" \"example_instance\" { ami = data.aws_ami.mac1metal.id host_id = aws_ec2_host.example_host.id instance_type = \"mac1.metal\" subnet_id = data.aws_subnet.example_subnet.id } data \"aws_subnet\" \"example_subnet\" { availability_zone = \"us-east-1a\" filter { name = \"tag:Tier\" # you should omit this filter if you don't distinguish your subnets on private and public values = [\"private\"] } } data \"aws_ami\" \"mac1metal\" { owners = [\"amazon\"] most_recent = true filter { name = \"name\" values = [\"amzn-ec2-macos-11*\"] # get latest BigSur AMI } } Simple as that, yes. Now, you can integrate it into your CI system and have the Mac instance with the underlying host in a bundle. Pro tip: you can leverage the aws_ec2_instance_type_offerings Data Source and use its output with aws_subnet source to avoid availability zone hardcoding. To make the code more uniform and reusable, you can wrap it into a Terraform module that accepts specific parameters (such as instance_type or availability_zone) as input variables.\n","wordCount":"245","inLanguage":"en","image":"https://devdosvid.blog/2021/01/20/terraforming-mac1.metal-at-aws/cover-image.jpg","datePublished":"2021-01-20T00:00:00Z","dateModified":"2024-05-06T21:14:06+02:00","author":{"@type":"Person","name":"Serhii Vasylenko"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://devdosvid.blog/2021/01/20/terraforming-mac1.metal-at-aws/"},"publisher":{"@type":"Person","name":"devDosvid blog","logo":{"@type":"ImageObject","url":"https://devdosvid.blog/favicon.ico"}}}</script></head><body id=top><header class=header><nav class=nav><div class=logo><a href=https://devdosvid.blog/ accesskey=h title="üè† Home (Alt + H)">üè† Home</a><div class=logo-switches></div></div><ul id=menu><li><a href=https://devdosvid.blog/index.xml title="RSS Feed"><span>RSS Feed</span></a></li><li><a href=https://devdosvid.blog/archive title="All posts"><span>All posts</span></a></li><li><a href=https://devdosvid.blog/about/ title="About me"><span>About me</span></a></li><li><a href=https://devdosvid.blog/series title="Post Series"><span>Post Series</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://devdosvid.blog/>Home</a>&nbsp;¬ª&nbsp;<a href=https://devdosvid.blog/posts/>Posts</a></div><h1 class=post-title>Terraforming mac1.metal at AWS</h1><div class=post-description>How to manage MacOS EC2 Instances with Terraform</div><div class=post-meta><span title='2021-01-20 00:00:00 +0000 UTC'>January 20, 2021</span>&nbsp;¬∑&nbsp;Serhii Vasylenko&nbsp;|&nbsp;<a href=mailto:contact@devdosvid.blog rel="noopener noreferrer" target=_blank>Contact me</a></div></header><figure class=entry-cover><img srcset="https://devdosvid.blog/2021/01/20/terraforming-mac1.metal-at-aws/cover-image_huff458043029f9c841f80d2eae7947f2b_18482_360x0_resize_q70_box.jpg 360w ,https://devdosvid.blog/2021/01/20/terraforming-mac1.metal-at-aws/cover-image_huff458043029f9c841f80d2eae7947f2b_18482_480x0_resize_q70_box.jpg 480w ,https://devdosvid.blog/2021/01/20/terraforming-mac1.metal-at-aws/cover-image_huff458043029f9c841f80d2eae7947f2b_18482_720x0_resize_q70_box.jpg 720w ,https://devdosvid.blog/2021/01/20/terraforming-mac1.metal-at-aws/cover-image.jpg 1000w" sizes="(min-width: 768px) 720px, 100vw" src=https://devdosvid.blog/2021/01/20/terraforming-mac1.metal-at-aws/cover-image.jpg alt width=1000 height=500></figure><div class=post-content><div class=updatenotice>Updated on the 23rd of October, 2021: Terraform AWS provider now <a href=https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/ec2_host>supports</a> Dedicated Hosts natively</div><p>In November 2021, AWS <a href=https://aws.amazon.com/blogs/aws/new-use-mac-instances-to-build-test-macos-ios-ipados-tvos-and-watchos-apps/>announced</a> the support for Mac mini instances.</p><p>I believe this is huge, even despite the number of constraints this solution has. This offering opens the door to seamless macOS CI/CD integration into existing AWS infrastructure.</p><p>So here is a quick-start example of creating the dedicated host and the instance altogether using Terraform.</p><p>I intentionally used some hardcoded values for the sake of simplicity in the example.</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#ff7b72>resource</span> <span style=color:#a5d6ff>&#34;aws_ec2_host&#34; &#34;example_host&#34;</span> {
</span></span><span style=display:flex><span>  instance_type     <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>&#34;mac1.metal&#34;</span>
</span></span><span style=display:flex><span>  availability_zone <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>&#34;us-east-1a&#34;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>resource</span> <span style=color:#a5d6ff>&#34;aws_instance&#34; &#34;example_instance&#34;</span> {
</span></span><span style=display:flex><span>  ami           <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>data</span>.<span style=color:#ff7b72>aws_ami</span>.<span style=color:#ff7b72>mac1metal</span>.<span style=color:#ff7b72>id</span>
</span></span><span style=display:flex><span>  host_id       <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>aws_ec2_host</span>.<span style=color:#ff7b72>example_host</span>.<span style=color:#ff7b72>id</span>
</span></span><span style=display:flex><span>  instance_type <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>&#34;mac1.metal&#34;</span>
</span></span><span style=display:flex><span>  subnet_id     <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>data</span>.<span style=color:#ff7b72>aws_subnet</span>.<span style=color:#ff7b72>example_subnet</span>.<span style=color:#ff7b72>id</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>data</span> <span style=color:#a5d6ff>&#34;aws_subnet&#34; &#34;example_subnet&#34;</span> {
</span></span><span style=display:flex><span>  availability_zone <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>&#34;us-east-1a&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>filter</span> {
</span></span><span style=display:flex><span>    name   <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>&#34;tag:Tier&#34;</span><span style=color:#8b949e;font-style:italic> # you should omit this filter if you don&#39;t distinguish your subnets on private and public 
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    values <span style=color:#ff7b72;font-weight:700>=</span> [<span style=color:#a5d6ff>&#34;private&#34;</span>]
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>data</span> <span style=color:#a5d6ff>&#34;aws_ami&#34; &#34;mac1metal&#34;</span> {
</span></span><span style=display:flex><span>  owners      <span style=color:#ff7b72;font-weight:700>=</span> [<span style=color:#a5d6ff>&#34;amazon&#34;</span>]
</span></span><span style=display:flex><span>  most_recent <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>true</span>
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>filter</span> {
</span></span><span style=display:flex><span>    name   <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>&#34;name&#34;</span>
</span></span><span style=display:flex><span>    values <span style=color:#ff7b72;font-weight:700>=</span> [<span style=color:#a5d6ff>&#34;amzn-ec2-macos-11*&#34;</span>]<span style=color:#8b949e;font-style:italic> # get latest BigSur AMI
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Simple as that, yes. Now, you can integrate it into your CI system and have the Mac instance with the underlying host in a bundle.<div class=attention>Pro tip: you can leverage the <code>aws_ec2_instance_type_offerings</code> <a href=https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/ec2_instance_type_offerings>Data Source</a> and use its output with <code>aws_subnet</code> source to avoid availability zone hardcoding.</div></p><p>To make the code more uniform and reusable, you can wrap it into a <a href=/2020/09/09/terraform-modules-explained.html>Terraform module</a> that accepts specific parameters (such as <code>instance_type</code> or <code>availability_zone</code>) as input variables.</p></div><footer class=post-footer><div class=substack-embedded-container><h3>Subscribe to blog updates!</h3><iframe title=Substack class=substack-embedded-iframe src=https://devdosvid.substack.com/embed height=250 loading=lazy></iframe></div><script src=https://giscus.app/client.js data-repo=vasylenko/devdosvid.blog data-repo-id="MDEwOlJlcG9zaXRvcnkyNDUyNTMxODE=" data-category=General data-category-id=DIC_kwDODp5EPc4CA59c data-mapping=title data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-lang=en data-theme=purge crossorigin=anonymous async></script><div class=post-series><p>Check out other posts of the <b>"mac1.metal at AWS"</b> series:</p><ul></ul></div><ul class=post-tags></ul><div class=license><p>This work is licensed under a <a rel=license href=http://creativecommons.org/licenses/by-nd/4.0/>Creative Commons Attribution-NoDerivatives 4.0 International License</a></p></div><nav class=paginav><a class=prev href=https://devdosvid.blog/2021/02/01/customizing-mac1.metal-ec2-ami-new-guts-more-glory/><span class=title>¬´ Prev</span><br><span>Customizing mac1.metal EC2 AMI ‚Äî new guts, more glory</span>
</a><a class=next href=https://devdosvid.blog/2021/01/19/mac1.metal-and-mac2.metal-ec2-instances-user-experience/><span class=title>Next ¬ª</span><br><span>mac1.metal and mac2.metal EC2 Instances ‚Äî user experience</span></a></nav></footer></article></main><footer class=footer><div style=width:10em;margin:auto><p style=background-color:#0082ca;color:#fff>From Ukrainian</p><p style=background-color:#ffb548;color:#fff>with love ‚ù§Ô∏è</p></div><span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>