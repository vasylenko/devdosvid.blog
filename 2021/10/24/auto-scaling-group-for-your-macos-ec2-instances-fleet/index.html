<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Auto Scaling Group for your macOS EC2 Instances fleet | Serhii Vasylenko</title><meta name=keywords content="aws,architecture"><meta name=description content="It‚Äôs been almost a year since I started using macOS EC2 instances on AWS: there were ups and downs in service offerings and a lot of discoveries with macOS AMI build automation.
And I like this small but so helpful update of EC2 service very much: with mac1.metal instances, seamless integration of Apple-oriented CI/CD with other AWS infrastructure could finally happen.
While management of a single mac1.metal node (or a tiny number of ones) is not a big deal (especially when Dedicated Host support was added to Terraform provider), governing the fleet of instances is still complicated."><meta name=author content="Serhii Vasylenko"><link rel=canonical href=https://serhii.vasylenko.info/2021/10/24/auto-scaling-group-for-your-macos-ec2-instances-fleet/><link crossorigin=anonymous href=/assets/css/stylesheet.min.d5adee3dae343e50fbaa47a32256a06c37d4e59d28db8f798d5932297c6ec35a.css integrity="sha256-1a3uPa40PlD7qkejIlagbDfU5Z0o2495jVkyKXxuw1o=" rel="preload stylesheet" as=style><link rel=preload href=/apple-touch-icon.png as=image><script defer crossorigin=anonymous src=/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5+kdJvBz5iKbt6B5PJI=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://serhii.vasylenko.info/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://serhii.vasylenko.info/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://serhii.vasylenko.info/favicon-32x32.png><link rel=apple-touch-icon href=https://serhii.vasylenko.info/apple-touch-icon.png><link rel=mask-icon href=https://serhii.vasylenko.info/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.89.2"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-GK7SE0XWGK"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-GK7SE0XWGK',{anonymize_ip:!1})}</script><meta property="og:title" content="Auto Scaling Group for your macOS EC2 Instances fleet"><meta property="og:description" content="It‚Äôs been almost a year since I started using macOS EC2 instances on AWS: there were ups and downs in service offerings and a lot of discoveries with macOS AMI build automation.
And I like this small but so helpful update of EC2 service very much: with mac1.metal instances, seamless integration of Apple-oriented CI/CD with other AWS infrastructure could finally happen.
While management of a single mac1.metal node (or a tiny number of ones) is not a big deal (especially when Dedicated Host support was added to Terraform provider), governing the fleet of instances is still complicated."><meta property="og:type" content="article"><meta property="og:url" content="https://serhii.vasylenko.info/2021/10/24/auto-scaling-group-for-your-macos-ec2-instances-fleet/"><meta property="og:image" content="https://serhii.vasylenko.info/2021/10/24/auto-scaling-group-for-your-macos-ec2-instances-fleet/cover-image.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-10-24T02:00:31+03:00"><meta property="article:modified_time" content="2021-10-24T02:00:31+03:00"><meta property="og:site_name" content="Serhii Vasylenko ‚Äî Personal Blog"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://serhii.vasylenko.info/2021/10/24/auto-scaling-group-for-your-macos-ec2-instances-fleet/cover-image.png"><meta name=twitter:title content="Auto Scaling Group for your macOS EC2 Instances fleet"><meta name=twitter:description content="It‚Äôs been almost a year since I started using macOS EC2 instances on AWS: there were ups and downs in service offerings and a lot of discoveries with macOS AMI build automation.
And I like this small but so helpful update of EC2 service very much: with mac1.metal instances, seamless integration of Apple-oriented CI/CD with other AWS infrastructure could finally happen.
While management of a single mac1.metal node (or a tiny number of ones) is not a big deal (especially when Dedicated Host support was added to Terraform provider), governing the fleet of instances is still complicated."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://serhii.vasylenko.info/posts/"},{"@type":"ListItem","position":3,"name":"Auto Scaling Group for your macOS EC2 Instances fleet","item":"https://serhii.vasylenko.info/2021/10/24/auto-scaling-group-for-your-macos-ec2-instances-fleet/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Auto Scaling Group for your macOS EC2 Instances fleet","name":"Auto Scaling Group for your macOS EC2 Instances fleet","description":"It‚Äôs been almost a year since I started using macOS EC2 instances on AWS: there were ups and downs in service offerings and a lot of discoveries with macOS AMI build automation.\nAnd I like this small but so helpful update of EC2 service very much: with mac1.metal instances, seamless integration of Apple-oriented CI/CD with other AWS infrastructure could finally happen.\nWhile management of a single mac1.metal node (or a tiny number of ones) is not a big deal (especially when Dedicated Host support was added to Terraform provider), governing the fleet of instances is still complicated.","keywords":["aws","architecture"],"articleBody":"It‚Äôs been almost a year since I started using macOS EC2 instances on AWS: there were ups and downs in service offerings and a lot of discoveries with macOS AMI build automation.\nAnd I like this small but so helpful update of EC2 service very much: with mac1.metal instances, seamless integration of Apple-oriented CI/CD with other AWS infrastructure could finally happen.\nWhile management of a single mac1.metal node (or a tiny number of ones) is not a big deal (especially when Dedicated Host support was added to Terraform provider), governing the fleet of instances is still complicated. Or it has been complicated until recent days.\nOfficial / Unofficial Auto Scaling for macOS With a growing number of instances, the following challenges arise:\n Scale mac1.metal instances horizontally Automatically allocate and release Dedicated Hosts needed for instances Automatically replace unhealthy instances  If you have worked with AWS before, you know that Auto Scaling Group service can solve such things.\nHowever, official documentation (as of October 2021) states: ‚ÄúYou cannot use Mac instances with Amazon EC2 Auto Scaling‚Äù.\nBut in fact, you can.\nCombining services to get real power So how does all that work?\nLet‚Äôs review the diagram that illustrates the interconnection between involved services:\n  With the help of Licence Manager service and Launch Templates, you can set up EC2 Auto Scaling Group for mac1.metal and leave the automated instance provisioning to the service.\nLicense Configuration First, you need to create a License Configuration so that the Host resource group can allocate the hots.\nGo to AWS License Manager - Customer managed licenses - Create customer-managed license.\nSpecify Sockets as the Licence type. You may skip setting the Number of Sockets. However, the actual limit of mac1.metal instances per account is regulated by Service Quota. The default number of mac instances allowed per account is 3. Therefore, consider increasing this to a more significant number.\n  Host resource group Second, create the Host resource group: AWS License Manager - Host resource groups - Create host resource group.\nWhen creating the Host resource group, check ‚ÄúAllocate hosts automatically‚Äù and ‚ÄúRelease hosts automatically‚Äù but leave ‚ÄúRecover hosts automatically‚Äù unchecked. Dedicated Host does not support host recovery for mac1.metal. However, Auto Scaling Group will maintain the desired number of instances if one fails the health check (which assumes the case of host failure as well).\nAlso, I recommend specifying ‚Äúmac1‚Äù as an allowed Instance family for the sake of transparent resource management: only this instance type is permitted to allocate hosts in the group.\n  Optionally, you may specify the license association here (the Host group will pick any compatible license) or select the license you created on step one.\nLaunch Template Create Launch Template: EC2 - Launch templates - Create launch template.\nI will skip the description of all Launch Template parameters (but here is a nice tutorial), if you don‚Äôt mind, and keep focus only on the items relevant to the current case.\nSpecify mac1.metal as the Instance type. Later, in Advanced details: find the Tenancy parameter and set it to ‚ÄúDedicated host‚Äù; for Target host by select ‚ÄúHost resource group‚Äù, and once selected the new parameter Tenancy host resource group will appear where you should choose your host group; select your license in License configurations parameter.\n  Auto Scaling Group Finally, create the Auto Scaling Group: EC2 - Auto Scaling groups - Create Auto Scaling group.\nThe vital thing to note here ‚Äî is the availability of the mac1.metal instance in particular AZ.\nMac instances are available in us-east-1 and 7 more regions, but not every Availability Zone in the region supports it. So you must figure out which AZ supports the needed instance type.\nThere is no documentation for that, but there is an AWS CLI command that can answer this question: describe-instance-type-offerings ‚Äî AWS CLI 2.3.0 Command Reference\nHere is an example for the us-east-1 region: üîç Click here to see the code snippet  aws ec2 describe-instance-type-offerings --location-type availability-zone-id --filters Name=instance-type,Values=mac1.metal --region us-east-1 --output text INSTANCETYPEOFFERINGS\tmac1.metal\tuse1-az6\tavailability-zone-id INSTANCETYPEOFFERINGS\tmac1.metal\tuse1-az4\tavailability-zone-id  \nKeep that nuance in mind when selecting a subnet for the mac1.metal instances.\nWhen you know the AZ, specify the respective Subnet in the Auto Scaling Group settings, and you‚Äôre ready to go!\nBring Infrastructure as Code here I suggest describing all that as a code. I prefer Terraform, and its AWS provider supports the needed resources. Except one.\nAs of October 2021, resources supported :\n aws_servicequotas_service_quota aws_licensemanager_license_configuration aws_launch_template aws_autoscaling_group  The Host resource group is not yet supported by the provider, unfortunately. However, we can use CloudFormation in Terraform to overcome that: describe the Host resource group as aws_cloudformation_stack Terraform resource using CloudFormation template from a file.\nHere is how it looks like: üîç Click here to see the code snippet resource \"aws_licensemanager_license_configuration\" \"this\" { name = local.full_name license_counting_type = \"Socket\" } resource \"aws_cloudformation_stack\" \"this\" { name = local.full_name# the name of CloudFormation stack  template_body = file(\"${path.module}/resource-group-cf-stack-template.json\") parameters = { GroupName = local.full_name# the name for the Host group, passed to CloudFormation template  } on_failure = \"DELETE\" }  \nAnd the next code snippet explains the CloudFromation template (which is the resource-group-cf-stack-template.json file in the code snippet above)\nüîç Click here to see the code snippet { \"Parameters\" : { \"GroupName\" : { \"Type\" : \"String\", \"Description\" : \"The name of Host Group\" } }, \"Resources\" : { \"DedicatedHostGroup\": { \"Type\": \"AWS::ResourceGroups::Group\", \"Properties\": { \"Name\": { \"Ref\": \"GroupName\" }, \"Configuration\": [ { \"Type\": \"AWS::ResourceGroups::Generic\", \"Parameters\": [ { \"Name\": \"allowed-resource-types\", \"Values\": [\"AWS::EC2::Host\"] }, { \"Name\": \"deletion-protection\", \"Values\": [\"UNLESS_EMPTY\"] } ] }, { \"Type\": \"AWS::EC2::HostManagement\", \"Parameters\": [ { \"Name\": \"allowed-host-families\", \"Values\": [\"mac1\"] }, { \"Name\": \"auto-allocate-host\", \"Values\": [\"true\"] }, { \"Name\": \"auto-release-host\", \"Values\": [\"true\"] }, { \"Name\": \"any-host-based-license-configuration\", \"Values\": [\"true\"] } ] } ] } } }, \"Outputs\" : { \"ResourceGroupARN\" : { \"Description\": \"ResourceGroupARN\", \"Value\" : { \"Fn::GetAtt\" : [\"DedicatedHostGroup\", \"Arn\"] } } } }  \nThe aws_cloudformation_stack resource will export the DedicatedHostGroup attribute (see the code of CloudFromation template), which you will use later in the Launch Template resource.\nPro tips If you manage an AWS Organization, I have good news: Host groups and Licenses are supported by Resource Access Manager service. Hence, you can host all mac instances in one account and share them with other accounts ‚Äî it might be helpful for costs allocation, for example. Also, check out my blog about AWS RAM if you are very new to this service.\nTo solve the ‚Äúwhich AZ supports mac metal‚Äù puzzle, you can leverage the aws_ec2_instance_type_offerings and aws_subnet_ids data sources.\nCosts considerations License Manager is a free of charge service, as well as Auto Scaling, and Launch Template.\nSo it‚Äôs all about the price for mac1.metal Dedicated Host which is $1.083 per hour as of October 2021. However, Saving Plans can be applied.\nPlease note that the minimum allocation time for that type of host is 24 hours. Maybe someday AWS will change that to 1-hour minimum someday (fingers crossed).\nOh. So. ASG. The Auto Scaling for mac1.metal opens new possibilities for CI/CD: you can integrate that to your favorite tool (GitLab, Jenkins, whatsoever) using AWS Lambda and provision new instances when your development/testing environments need that. Or you can use other cool ASG stuff, such as Lifecycle hooks, to create even more custom scenarios.\nConsidering the ‚Äúhidden‚Äù (undocumented) nature of the described setup, I suggest treating it as rather testing than production-ready for now. However, my tests show that everything works pretty well: hosts are allocated, instances are spawned, and the monthly bill grows.\nI suppose AWS will officially announce all this in the nearest future. Along with that, I am looking forward to the announcement of Monterey-based AMIs and maybe even M1 chip-based instances (will it be mac2.metal?).\nAnd I want to say thanks (thanks, pal!) to OliverKoo, who started digging into that back in April'21.\n","wordCount":"1299","inLanguage":"en","image":"https://serhii.vasylenko.info/2021/10/24/auto-scaling-group-for-your-macos-ec2-instances-fleet/cover-image.png","datePublished":"2021-10-24T02:00:31+03:00","dateModified":"2021-10-24T02:00:31+03:00","author":{"@type":"Person","name":"Serhii Vasylenko"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://serhii.vasylenko.info/2021/10/24/auto-scaling-group-for-your-macos-ec2-instances-fleet/"},"publisher":{"@type":"Person","name":"Serhii Vasylenko","logo":{"@type":"ImageObject","url":"https://serhii.vasylenko.info/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script><header class=header><nav class=nav><div class=logo><a href=https://serhii.vasylenko.info accesskey=h title="Home (Alt + H)"><img src=/apple-touch-icon.png alt=logo aria-label=logo height=" 30px">Home</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://serhii.vasylenko.info/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://serhii.vasylenko.info/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://serhii.vasylenko.info/about/ title="About me"><span>About me</span></a></li><li><a href=https://serhii.vasylenko.info/cv/ title="My CV"><span>My CV</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://serhii.vasylenko.info>Home</a>&nbsp;¬ª&nbsp;<a href=https://serhii.vasylenko.info/posts/>Posts</a></div><h1 class=post-title>Auto Scaling Group for your macOS EC2 Instances fleet</h1><div class=post-meta><span title="2021-10-24 02:00:31 +0300 +0300">October 24, 2021</span>&nbsp;¬∑&nbsp;Serhii Vasylenko&nbsp;|&nbsp;<a href=mailto:email-from-blog@vasylenko.info rel="noopener noreferrer" target=_blank>üì© Suggest Changes</a></div></header><figure class=entry-cover><img loading=lazy srcset="https://serhii.vasylenko.info/2021/10/24/auto-scaling-group-for-your-macos-ec2-instances-fleet/cover-image_huff89775abac5456b585f6a915b69c6b9_294780_360x0_resize_box_3.png 360w ,https://serhii.vasylenko.info/2021/10/24/auto-scaling-group-for-your-macos-ec2-instances-fleet/cover-image_huff89775abac5456b585f6a915b69c6b9_294780_480x0_resize_box_3.png 480w ,https://serhii.vasylenko.info/2021/10/24/auto-scaling-group-for-your-macos-ec2-instances-fleet/cover-image_huff89775abac5456b585f6a915b69c6b9_294780_720x0_resize_box_3.png 720w ,https://serhii.vasylenko.info/2021/10/24/auto-scaling-group-for-your-macos-ec2-instances-fleet/cover-image_huff89775abac5456b585f6a915b69c6b9_294780_1080x0_resize_box_3.png 1080w ,https://serhii.vasylenko.info/2021/10/24/auto-scaling-group-for-your-macos-ec2-instances-fleet/cover-image_huff89775abac5456b585f6a915b69c6b9_294780_1500x0_resize_box_3.png 1500w ,https://serhii.vasylenko.info/2021/10/24/auto-scaling-group-for-your-macos-ec2-instances-fleet/cover-image.png 2400w" sizes="(min-width: 768px) 720px, 100vw" src=https://serhii.vasylenko.info/2021/10/24/auto-scaling-group-for-your-macos-ec2-instances-fleet/cover-image.png alt width=2400 height=1200></figure><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#official--unofficial-auto-scaling-for-macos aria-label="Official / Unofficial Auto Scaling for macOS">Official / Unofficial Auto Scaling for macOS</a></li><li><a href=#combining-services-to-get-real-power aria-label="Combining services to get real power">Combining services to get real power</a><ul><li><a href=#license-configuration aria-label="License Configuration">License Configuration</a></li><li><a href=#host-resource-group aria-label="Host resource group">Host resource group</a></li><li><a href=#launch-template aria-label="Launch Template">Launch Template</a></li><li><a href=#auto-scaling-group aria-label="Auto Scaling Group">Auto Scaling Group</a></li></ul></li><li><a href=#bring-infrastructure-as-code-here aria-label="Bring Infrastructure as Code here">Bring Infrastructure as Code here</a><ul><li><a href=#pro-tips aria-label="Pro tips">Pro tips</a></li></ul></li><li><a href=#costs-considerations aria-label="Costs considerations">Costs considerations</a></li><li><a href=#oh-so-asg aria-label="Oh. So. ASG.">Oh. So. ASG.</a></li></ul></div></details></div><div class=post-content><p>It‚Äôs been almost a year since I started using macOS EC2 instances on AWS: there were <a href=https://serhii.vasylenko.info/2021/01/19/mac1-metal-EC2-Instance-user-experience.html>ups and downs in service offerings</a> and a lot of discoveries with <a href=https://serhii.vasylenko.info/2021/02/01/customizing-mac1-metal-ec2-ami.html>macOS AMI build</a> automation.</p><p>And I like this small but so helpful update of EC2 service very much: with mac1.metal instances, seamless integration of Apple-oriented CI/CD with other AWS infrastructure could finally happen.</p><p>While management of a single mac1.metal node (or a tiny number of ones) is not a big deal (especially when <a href=https://serhii.vasylenko.info/2021/01/20/terraforming-mac1-metal-at-AWS.html>Dedicated Host support</a> was added to Terraform provider), governing the fleet of instances is still complicated. Or it has been complicated until recent days.</p><h2 id=official--unofficial-auto-scaling-for-macos>Official / Unofficial Auto Scaling for macOS<a hidden class=anchor aria-hidden=true href=#official--unofficial-auto-scaling-for-macos>#</a></h2><p>With a growing number of instances, the following challenges arise:</p><ul><li>Scale mac1.metal instances horizontally</li><li>Automatically allocate and release Dedicated Hosts needed for instances</li><li>Automatically replace unhealthy instances</li></ul><p>If you have worked with AWS before, you know that Auto Scaling Group service can solve such things.</p><p>However, official documentation (as of October 2021) <a href=https://github.com/awsdocs/amazon-ec2-user-guide/blob/269ac7494dd3aef62ae5d45e8b11f7ea5cadd2bf/doc_source/ec2-mac-instances.md>states</a>: ‚ÄúYou cannot use Mac instances with Amazon EC2 Auto Scaling‚Äù.</p><p>But in fact, you can.</p><h2 id=combining-services-to-get-real-power>Combining services to get real power<a hidden class=anchor aria-hidden=true href=#combining-services-to-get-real-power>#</a></h2><p>So how does all that work?</p><p>Let‚Äôs review the diagram that illustrates the interconnection between involved services:</p><figure><img loading=lazy src=general-scheme_compressed.png alt="Services interconnection"></figure><p>With the help of Licence Manager service and Launch Templates, you can set up EC2 Auto Scaling Group for mac1.metal and leave the automated instance provisioning to the service.</p><h3 id=license-configuration>License Configuration<a hidden class=anchor aria-hidden=true href=#license-configuration>#</a></h3><p>First, you need to create a License Configuration so that the Host resource group can allocate the hots.</p><p>Go to AWS License Manager -> Customer managed licenses -> Create customer-managed license.</p><p>Specify <strong>Sockets</strong> as the Licence type. You may skip setting the Number of Sockets. However, the actual limit of mac1.metal instances per account is regulated by Service Quota. The default number of mac instances allowed per account is 3. Therefore, consider <a href=https://docs.aws.amazon.com/servicequotas/latest/userguide/request-quota-increase.html>increasing</a> this to a more significant number.</p><figure><img loading=lazy src=license-configuration_compressed.png alt="Licence configuration values"></figure><h3 id=host-resource-group>Host resource group<a hidden class=anchor aria-hidden=true href=#host-resource-group>#</a></h3><p>Second, create the Host resource group: AWS License Manager -> Host resource groups -> Create host resource group.</p><p>When creating the Host resource group, check ‚Äú<strong>Allocate hosts automatically</strong>‚Äù and ‚Äú<strong>Release hosts automatically</strong>‚Äù but leave ‚ÄúRecover hosts automatically‚Äù unchecked. Dedicated Host does <a href=https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/dedicated-hosts-recovery.html#dedicated-hosts-recovery-instances>not support host recovery</a> for mac1.metal.
However, Auto Scaling Group will maintain the desired number of instances if one fails the health check (which assumes the case of host failure as well).</p><p>Also, I recommend specifying ‚Äúmac1‚Äù as an allowed Instance family for the sake of transparent resource management: only this instance type is permitted to allocate hosts in the group.</p><figure><img loading=lazy src=host-resource-group_compressed.png alt="Host resource group configuration values"></figure><p>Optionally, you may specify the license association here (the Host group will pick any compatible license) or select the license you created on step one.</p><h3 id=launch-template>Launch Template<a hidden class=anchor aria-hidden=true href=#launch-template>#</a></h3><p>Create Launch Template: EC2 -> Launch templates -> Create launch template.</p><p>I will skip the description of all Launch Template parameters (but here is a nice <a href=https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-launch-templates.html>tutorial</a>), if you don‚Äôt mind, and keep focus only on the items relevant to the current case.</p><p>Specify mac1.metal as the Instance type. Later, in Advanced details: find the <strong>Tenancy</strong> parameter and set it to ‚ÄúDedicated host‚Äù; for <strong>Target host by</strong> select ‚ÄúHost resource group‚Äù, and once selected the new parameter <strong>Tenancy host resource group</strong> will appear where you should choose your host group; select your license in <strong>License configurations</strong> parameter.</p><figure><img loading=lazy src=launch-template_compressed.png alt="Launch Template configuration values"></figure><h3 id=auto-scaling-group>Auto Scaling Group<a hidden class=anchor aria-hidden=true href=#auto-scaling-group>#</a></h3><p>Finally, create the Auto Scaling Group: EC2 -> Auto Scaling groups -> Create Auto Scaling group.</p><p>The vital thing to note here ‚Äî is the availability of the mac1.metal instance in particular AZ.</p><p>Mac instances are available in us-east-1 and <a href=https://aws.amazon.com/about-aws/whats-new/2021/10/amazon-ec2-mac-instances-additional-regions/>7 more regions</a>, but not every Availability Zone in the region supports it. So you must figure out which AZ supports the needed instance type.</p><p>There is no documentation for that, but there is an AWS CLI command that can answer this question: <a href=https://awscli.amazonaws.com/v2/documentation/api/latest/reference/ec2/describe-instance-type-offerings.html>describe-instance-type-offerings ‚Äî AWS CLI 2.3.0 Command Reference</a></p><p>Here is an example for the us-east-1 region:<p><details><summary markdown=span style=font-size:.8em;font-weight:700>üîç Click here to see the code snippet</summary><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>&gt; aws ec2 describe-instance-type-offerings --location-type availability-zone-id --filters <span style=color:#40ffff>Name</span>=instance-type,Values=mac1.metal --region us-east-1 --output text

INSTANCETYPEOFFERINGS	mac1.metal	use1-az6	availability-zone-id
INSTANCETYPEOFFERINGS	mac1.metal	use1-az4	availability-zone-id
</code></pre></div></details></p></p><p>Keep that nuance in mind when selecting a subnet for the mac1.metal instances.</p><p>When you know the AZ, specify the respective Subnet in the Auto Scaling Group settings, and you&rsquo;re ready to go!</p><h2 id=bring-infrastructure-as-code-here>Bring Infrastructure as Code here<a hidden class=anchor aria-hidden=true href=#bring-infrastructure-as-code-here>#</a></h2><p>I suggest describing all that as a code. I prefer Terraform, and its AWS provider supports the needed resources. Except one.</p><p>As of October 2021, resources supported :</p><ul><li><a href=https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/servicequotas_service_quota>aws_servicequotas_service_quota</a></li><li><a href=https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/licensemanager_license_configuration>aws_licensemanager_license_configuration</a></li><li><a href=https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/launch_template>aws_launch_template</a></li><li><a href=https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/autoscaling_group>aws_autoscaling_group</a></li></ul><p>The Host resource group is not yet supported by the provider, unfortunately. However, we can use CloudFormation in Terraform to overcome that: describe the Host resource group as <a href=https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/cloudformation_stack>aws_cloudformation_stack</a> Terraform resource using CloudFormation template from a file.</p><p>Here is how it looks like:<p><details><summary markdown=span style=font-size:.8em;font-weight:700>üîç Click here to see the code snippet</summary><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=color:#6ab825;font-weight:700>resource</span> <span style=color:#ed9d13>&#34;aws_licensemanager_license_configuration&#34; &#34;this&#34;</span> {
  name                     = <span style=color:#6ab825;font-weight:700>local</span>.<span style=color:#6ab825;font-weight:700>full_name</span>
  license_counting_type    = <span style=color:#ed9d13>&#34;Socket&#34;</span>
}

<span style=color:#6ab825;font-weight:700>resource</span> <span style=color:#ed9d13>&#34;aws_cloudformation_stack&#34; &#34;this&#34;</span> {
  name          = <span style=color:#6ab825;font-weight:700>local</span>.<span style=color:#6ab825;font-weight:700>full_name</span><span style=color:#999;font-style:italic> # the name of CloudFormation stack
</span><span style=color:#999;font-style:italic></span>  template_body = <span style=color:#6ab825;font-weight:700>file</span>(<span style=color:#ed9d13>&#34;${path.module}/resource-group-cf-stack-template.json&#34;</span>)
  parameters = {
    GroupName = <span style=color:#6ab825;font-weight:700>local</span>.<span style=color:#6ab825;font-weight:700>full_name</span><span style=color:#999;font-style:italic> # the name for the Host group, passed to CloudFormation template
</span><span style=color:#999;font-style:italic></span>  }
  on_failure = <span style=color:#ed9d13>&#34;DELETE&#34;</span>
}
</code></pre></div></details></p></p><p>And the next code snippet explains the CloudFromation template (which is the <code>resource-group-cf-stack-template.json</code> file in the code snippet above)</p><p><details><summary markdown=span style=font-size:.8em;font-weight:700>üîç Click here to see the code snippet</summary><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>{
  <span style=color:#6ab825;font-weight:700>&#34;Parameters&#34;</span> : {
    <span style=color:#6ab825;font-weight:700>&#34;GroupName&#34;</span> : {
      <span style=color:#6ab825;font-weight:700>&#34;Type&#34;</span> : <span style=color:#ed9d13>&#34;String&#34;</span>,
      <span style=color:#6ab825;font-weight:700>&#34;Description&#34;</span> : <span style=color:#ed9d13>&#34;The name of Host Group&#34;</span>
    }
  },
  <span style=color:#6ab825;font-weight:700>&#34;Resources&#34;</span> : {
    <span style=color:#6ab825;font-weight:700>&#34;DedicatedHostGroup&#34;</span>: {
      <span style=color:#6ab825;font-weight:700>&#34;Type&#34;</span>: <span style=color:#ed9d13>&#34;AWS::ResourceGroups::Group&#34;</span>,
      <span style=color:#6ab825;font-weight:700>&#34;Properties&#34;</span>: {
        <span style=color:#6ab825;font-weight:700>&#34;Name&#34;</span>: { <span style=color:#6ab825;font-weight:700>&#34;Ref&#34;</span>: <span style=color:#ed9d13>&#34;GroupName&#34;</span> },
        <span style=color:#6ab825;font-weight:700>&#34;Configuration&#34;</span>: [
          {
            <span style=color:#6ab825;font-weight:700>&#34;Type&#34;</span>: <span style=color:#ed9d13>&#34;AWS::ResourceGroups::Generic&#34;</span>,
            <span style=color:#6ab825;font-weight:700>&#34;Parameters&#34;</span>: [
              {
                <span style=color:#6ab825;font-weight:700>&#34;Name&#34;</span>: <span style=color:#ed9d13>&#34;allowed-resource-types&#34;</span>,
                <span style=color:#6ab825;font-weight:700>&#34;Values&#34;</span>: [<span style=color:#ed9d13>&#34;AWS::EC2::Host&#34;</span>]
              },
              {
                <span style=color:#6ab825;font-weight:700>&#34;Name&#34;</span>: <span style=color:#ed9d13>&#34;deletion-protection&#34;</span>,
                <span style=color:#6ab825;font-weight:700>&#34;Values&#34;</span>: [<span style=color:#ed9d13>&#34;UNLESS_EMPTY&#34;</span>]
              }
            ]
          },
          {
            <span style=color:#6ab825;font-weight:700>&#34;Type&#34;</span>: <span style=color:#ed9d13>&#34;AWS::EC2::HostManagement&#34;</span>,
            <span style=color:#6ab825;font-weight:700>&#34;Parameters&#34;</span>: [
              {
                <span style=color:#6ab825;font-weight:700>&#34;Name&#34;</span>: <span style=color:#ed9d13>&#34;allowed-host-families&#34;</span>,
                <span style=color:#6ab825;font-weight:700>&#34;Values&#34;</span>: [<span style=color:#ed9d13>&#34;mac1&#34;</span>]
              },
              {
                <span style=color:#6ab825;font-weight:700>&#34;Name&#34;</span>: <span style=color:#ed9d13>&#34;auto-allocate-host&#34;</span>,
                <span style=color:#6ab825;font-weight:700>&#34;Values&#34;</span>: [<span style=color:#ed9d13>&#34;true&#34;</span>]
              },
              {
                <span style=color:#6ab825;font-weight:700>&#34;Name&#34;</span>: <span style=color:#ed9d13>&#34;auto-release-host&#34;</span>,
                <span style=color:#6ab825;font-weight:700>&#34;Values&#34;</span>: [<span style=color:#ed9d13>&#34;true&#34;</span>]
              },
              {
                <span style=color:#6ab825;font-weight:700>&#34;Name&#34;</span>: <span style=color:#ed9d13>&#34;any-host-based-license-configuration&#34;</span>,
                <span style=color:#6ab825;font-weight:700>&#34;Values&#34;</span>: [<span style=color:#ed9d13>&#34;true&#34;</span>]
              }
            ]
          }
        ]
      }
    }
  },
  <span style=color:#6ab825;font-weight:700>&#34;Outputs&#34;</span> : {
    <span style=color:#6ab825;font-weight:700>&#34;ResourceGroupARN&#34;</span> : {
      <span style=color:#6ab825;font-weight:700>&#34;Description&#34;</span>: <span style=color:#ed9d13>&#34;ResourceGroupARN&#34;</span>,
      <span style=color:#6ab825;font-weight:700>&#34;Value&#34;</span> : { <span style=color:#6ab825;font-weight:700>&#34;Fn::GetAtt&#34;</span> : [<span style=color:#ed9d13>&#34;DedicatedHostGroup&#34;</span>, <span style=color:#ed9d13>&#34;Arn&#34;</span>] }
    }
  }
}
</code></pre></div></details></p><p>The <code>aws_cloudformation_stack</code> resource will export the <code>DedicatedHostGroup</code> attribute (see the code of CloudFromation template), which you will use later in the Launch Template resource.</p><h3 id=pro-tips>Pro tips<a hidden class=anchor aria-hidden=true href=#pro-tips>#</a></h3><p>If you manage an AWS Organization, I have good news: Host groups and Licenses are supported by <a href=https://docs.aws.amazon.com/ram/latest/userguide/shareable.html>Resource Access Manager</a> service. Hence, you can host all mac instances in one account and share them with other accounts ‚Äî it might be helpful for costs allocation, for example. Also, check out <a href=https://serhii.vasylenko.info/2021/09/25/aws-resource-access-manager-multi-account-resource-governance/>my blog about AWS RAM</a> if you are very new to this service.</p><p>To solve the ‚Äúwhich AZ supports mac metal‚Äù puzzle, you can leverage the <a href=https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/ec2_instance_type_offerings>aws_ec2_instance_type_offerings</a> and <a href=https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/subnet_ids>aws_subnet_ids</a> data sources.</p><h2 id=costs-considerations>Costs considerations<a hidden class=anchor aria-hidden=true href=#costs-considerations>#</a></h2><p>License Manager is a <a href=https://aws.amazon.com/license-manager/pricing/>free of charge service</a>, as well as <a href=https://aws.amazon.com/autoscaling/pricing/>Auto Scaling</a>, and <a href=https://aws.amazon.com/about-aws/whats-new/2017/11/introducing-launch-templates-for-amazon-ec2-instances/>Launch Template</a>.</p><p>So it‚Äôs all about the price for mac1.metal Dedicated Host which is <a href=https://aws.amazon.com/ec2/dedicated-hosts/pricing/>$1.083 per hour</a> as of October 2021. However, <a href=https://docs.aws.amazon.com/savingsplans/latest/userguide/what-is-savings-plans.html>Saving Plans</a> can be applied.</p><p>Please note that the minimum allocation time for that type of host is 24 hours. Maybe someday AWS will change that to 1-hour minimum someday (fingers crossed).</p><h2 id=oh-so-asg>Oh. So. ASG.<a hidden class=anchor aria-hidden=true href=#oh-so-asg>#</a></h2><p>The Auto Scaling for mac1.metal opens new possibilities for CI/CD: you can integrate that to your favorite tool (GitLab, Jenkins, whatsoever) using AWS Lambda and provision new instances when your development/testing environments need that. Or you can use other cool ASG stuff, such as Lifecycle hooks, to create even more custom scenarios.</p><p>Considering the ‚Äúhidden‚Äù (undocumented) nature of the described setup, I suggest treating it as rather testing than production-ready for now. However, my tests show that everything works pretty well: hosts are allocated, instances are spawned, and the monthly bill grows.</p><p>I suppose AWS will officially announce all this in the nearest future. Along with that, I am looking forward to the announcement of Monterey-based AMIs and maybe even M1 chip-based instances (will it be mac2.metal?).</p><p>And I want to say thanks (thanks, pal!) to <a href=https://github.com/hashicorp/terraform/issues/28531>OliverKoo</a>, who started digging into that back in April'21.</p></div><footer class=post-footer><p>If you liked the article, please <b>support me by sharing</b> it on social networks üôè</p><p>Also feel free to ask questions or <a href=mailto:email-from-blog@vasylenko.info style=text-transform:lowercase;text-decoration:underline rel="noopener noreferrer" target=_blank>üì© Suggest Changes</a> by emailing me.</p><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share Auto Scaling Group for your macOS EC2 Instances fleet on twitter" href="https://twitter.com/intent/tweet/?text=Auto%20Scaling%20Group%20for%20your%20macOS%20EC2%20Instances%20fleet&url=https%3a%2f%2fserhii.vasylenko.info%2f2021%2f10%2f24%2fauto-scaling-group-for-your-macos-ec2-instances-fleet%2f&hashtags=aws%2carchitecture"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Auto Scaling Group for your macOS EC2 Instances fleet on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fserhii.vasylenko.info%2f2021%2f10%2f24%2fauto-scaling-group-for-your-macos-ec2-instances-fleet%2f&title=Auto%20Scaling%20Group%20for%20your%20macOS%20EC2%20Instances%20fleet&summary=Auto%20Scaling%20Group%20for%20your%20macOS%20EC2%20Instances%20fleet&source=https%3a%2f%2fserhii.vasylenko.info%2f2021%2f10%2f24%2fauto-scaling-group-for-your-macos-ec2-instances-fleet%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Auto Scaling Group for your macOS EC2 Instances fleet on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fserhii.vasylenko.info%2f2021%2f10%2f24%2fauto-scaling-group-for-your-macos-ec2-instances-fleet%2f&title=Auto%20Scaling%20Group%20for%20your%20macOS%20EC2%20Instances%20fleet"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Auto Scaling Group for your macOS EC2 Instances fleet on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fserhii.vasylenko.info%2f2021%2f10%2f24%2fauto-scaling-group-for-your-macos-ec2-instances-fleet%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></div><ul class=post-tags><li><a href=https://serhii.vasylenko.info/tags/aws/>aws</a></li><li><a href=https://serhii.vasylenko.info/tags/architecture/>architecture</a></li></ul><nav class=paginav><a class=prev href=https://serhii.vasylenko.info/2021/11/05/apply-cloudfront-security-headers-with-terraform/><span class=title>¬´ Prev Page</span><br><span>Apply Cloudfront Security Headers With Terraform</span></a>
<a class=next href=https://serhii.vasylenko.info/2021/09/25/aws-resource-access-manager-multi-account-resource-governance/><span class=title>Next Page ¬ª</span><br><span>AWS Resource Access Manager ‚Äî Multi Account Resource Governance</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2021 <a href=https://serhii.vasylenko.info>Serhii Vasylenko</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById('menu');menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script><script>document.querySelectorAll('pre > code').forEach(b=>{const c=b.parentNode.parentNode,a=document.createElement('button');a.classList.add('copy-code'),a.innerText='copy';function d(){a.innerText='copied!',setTimeout(()=>{a.innerText='copy'},2e3)}a.addEventListener('click',e=>{if('clipboard'in navigator){navigator.clipboard.writeText(b.textContent),d();return}const a=document.createRange();a.selectNodeContents(b);const c=window.getSelection();c.removeAllRanges(),c.addRange(a);try{document.execCommand('copy'),d()}catch(a){}c.removeRange(a)}),c.classList.contains("highlight")?c.appendChild(a):c.parentNode.firstChild==c||(b.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?b.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(a):b.parentNode.appendChild(a))})</script></body></html>