<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Run Ansible playbook on mac1.metal instances fleet with AWS Systems Manager | devDosvid — my engineering experience</title><meta name=keywords content="aws,ansible"><meta name=description content="A small adjustment for big capabilities"><meta name=author content="Serhii Vasylenko"><link rel=canonical href=https://devdosvid.blog/2021/05/27/run-ansible-playbook-on-mac1.metal-instances-fleet-with-aws-systems-manager/><link crossorigin=anonymous href=/assets/css/stylesheet.min.75dbafdb25f420631db4d31c430406840b73b1bc645dce61874f3bfe909caf19.css integrity="sha256-dduv2yX0IGMdtNMcQwQGhAtzsbxkXc5hh087/pCcrxk=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.min.2840b7fccd34145847db71a290569594bdbdb00047097f75d6495d162f5d7dff.js integrity="sha256-KEC3/M00FFhH23GikFaVlL29sABHCX911kldFi9dff8=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://devdosvid.blog/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://devdosvid.blog/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://devdosvid.blog/favicon-32x32.png><link rel=apple-touch-icon href=https://devdosvid.blog/apple-touch-icon.png><link rel=mask-icon href=https://devdosvid.blog/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script type=text/javascript>window.heap=window.heap||[],heap.load=function(i,o){window.heap.appid=i,window.heap.config=o=o||{},e=document.createElement("script"),e.type="text/javascript",e.async=!0,e.src="https://cdn.heapanalytics.com/js/heap-"+i+".js",n=document.getElementsByTagName("script")[0],n.parentNode.insertBefore(e,n);for(var e,n,a=function(e){return function(){heap.push([e].concat(Array.prototype.slice.call(arguments,0)))}},s=["addEventProperties","addUserProperties","clearEventProperties","identify","resetIdentity","removeEventProperty","setEventProperties","track","unsetEventProperty"],t=0;t<s.length;t++)heap[s[t]]=a(s[t])},heap.load("2300872157")</script><meta property="og:title" content="Run Ansible playbook on mac1.metal instances fleet with AWS Systems Manager"><meta property="og:description" content="A small adjustment for big capabilities"><meta property="og:type" content="article"><meta property="og:url" content="https://devdosvid.blog/2021/05/27/run-ansible-playbook-on-mac1.metal-instances-fleet-with-aws-systems-manager/"><meta property="og:image" content="https://devdosvid.blog/2021/05/27/run-ansible-playbook-on-mac1.metal-instances-fleet-with-aws-systems-manager/cover-image.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-05-27T00:00:00+00:00"><meta property="article:modified_time" content="2022-04-25T00:25:12+03:00"><meta property="og:site_name" content="devDosvid — my engineering experience"><meta property="og:see_also" content="https://devdosvid.blog/2021/10/24/auto-scaling-group-for-your-macos-ec2-instances-fleet/"><meta property="og:see_also" content="https://devdosvid.blog/2021/02/01/customizing-mac1-metal-ec2-ami.html"><meta property="og:see_also" content="https://devdosvid.blog/2021/01/20/terraforming-mac1-metal-at-AWS.html"><meta property="og:see_also" content="https://devdosvid.blog/2021/01/19/mac1-metal-EC2-Instance-user-experience.html"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://devdosvid.blog/2021/05/27/run-ansible-playbook-on-mac1.metal-instances-fleet-with-aws-systems-manager/cover-image.png"><meta name=twitter:title content="Run Ansible playbook on mac1.metal instances fleet with AWS Systems Manager"><meta name=twitter:description content="A small adjustment for big capabilities"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://devdosvid.blog/posts/"},{"@type":"ListItem","position":3,"name":"Run Ansible playbook on mac1.metal instances fleet with AWS Systems Manager","item":"https://devdosvid.blog/2021/05/27/run-ansible-playbook-on-mac1.metal-instances-fleet-with-aws-systems-manager/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Run Ansible playbook on mac1.metal instances fleet with AWS Systems Manager","name":"Run Ansible playbook on mac1.metal instances fleet with AWS Systems Manager","description":"A small adjustment for big capabilities","keywords":["aws","ansible"],"articleBody":"In days of containers and serverless applications, Ansible looks not such a trendy thing.\nBut still, there are cases when it helps, and there are cases when it combines very well with brand new product offerings, such as EC2 Mac instances.\nThe more I use mac1.metal in AWS, the more I see that Ansible becomes a bedrock of software customization in my case.\nAnd when you have a large instances fleet, the AWS Systems Manager becomes your best friend (the sooner you get along together, the better).\nSo is it possible to use Ansible playbooks for mac1.metal on a big scale, with the help of AWS Systems Manager?\n(Not) Available out of the box AWS Systems Manager (SSM hereafter) has a pre-defined, shared Document that allows running Ansible playbooks.\nIt’s called “AWS-RunAnsiblePlaybook,” and you can find it in AWS SSM → Documents → Owned by Amazon.\nHowever, this Document is not quite “friendly” to macOS. When the SSM agent calls Ansible on the Mac EC2 instance, it does not recognize the Ansible installed with Homebrew (de-facto most used macOS package manager).\nSo if you try to run a command on the mac1.metal instance using this Document, you will get the following error:\nAnsible is not installed. Please install Ansible and rerun the command. The root cause is trivial: the path to Ansible binary is not present on the list of paths available to the SSM agent by default.\nThere are several ways to solve that, but I believe that the most convenient one would be to create your custom Document — a slightly adjusted version of the default one provided by AWS.\nCreating own SSM Document for Ansible installed with Homebrew All you need to do is clone the Document provided by AWS and change its code a little — replace the callouts of ansible with the full path to the binary.\nNavigate to AWS SSM → Documents → Owned by Amazon and type AWS-RunAnsiblePlaybook in the search field.\nSelect the Document by pressing the circle on its top-right corner and then click Actions → Clone document.\nGive the new SSM Document a name, e.g., macos-arbitrary-ansible-playbook, and change the ansible callouts (at the end of the code) with the full path to the ansible symlink made by Homebrew which is /usr/local/bin/ansible\nHere is the complete source code of the Document with adjusted Ansible path:\n Click here to see the code snippet {  \"schemaVersion\": \"2.0\",  \"description\": \"Use this document to run arbitrary Ansible playbooks on macOS EC2 instances. Specify either YAML text or URL. If you specify both, the URL parameter will be used. Use the extravar parameter to send runtime variables to the Ansible execution. Use the check parameter to perform a dry run of the Ansible execution. The output of the dry run shows the changes that will be made when the playbook is executed.\",  \"parameters\": {  \"playbook\": {  \"type\": \"String\",  \"description\": \"(Optional) If you don't specify a URL, then you must specify playbook YAML in this field.\",  \"default\": \"\",  \"displayType\": \"textarea\"  },  \"playbookurl\": {  \"type\": \"String\",  \"description\": \"(Optional) If you don't specify playbook YAML, then you must specify a URL where the playbook is stored. You can specify the URL in the following formats: http://example.com/playbook.yml or s3://examplebucket/plabook.url. For security reasons, you can't specify a URL with quotes.\",  \"default\": \"\",  \"allowedPattern\": \"^\\\\s*$|^(http|https|s3)://[^']*$\"  },  \"extravars\": {  \"type\": \"String\",  \"description\": \"(Optional) Additional variables to pass to Ansible at runtime. Enter a space separated list of key/value pairs. For example: color=red or fruits=[apples,pears]\",  \"default\": \"foo=bar\",  \"displayType\": \"textarea\",  \"allowedPattern\": \"^((^|\\\\s)\\\\w+=(\\\\S+|'.*'))*$\"  },  \"check\": {  \"type\": \"String\",  \"description\": \" (Optional) Use the check parameter to perform a dry run of the Ansible execution.\",  \"allowedValues\": [  \"True\",  \"False\"  ],  \"default\": \"False\"  },  \"timeoutSeconds\": {  \"type\": \"String\",  \"description\": \"(Optional) The time in seconds for a command to be completed before it is considered to have failed.\",  \"default\": \"3600\"  }  },  \"mainSteps\": [  {  \"action\": \"aws:runShellScript\",  \"name\": \"runShellScript\",  \"inputs\": {  \"timeoutSeconds\": \"{{ timeoutSeconds }}\",  \"runCommand\": [  \"#!/bin/bash\",  \"/usr/local/bin/ansible --version\",  \"if [ $? -ne 0 ]; then\",  \" echo \\\"Ansible is not installed. Please install Ansible and rerun the command\\\" \u00262\",  \" exit 1\",  \"fi\",  \"execdir=$(dirname $0)\",  \"cd $execdir\",  \"if [ -z '{{playbook}}' ] ; then\",  \" if [[ \\\"{{playbookurl}}\\\" == http* ]]; then\",  \" wget '{{playbookurl}}' -O playbook.yml\",  \" if [ $? -ne 0 ]; then\",  \" echo \\\"There was a problem downloading the playbook. Make sure the URL is correct and that the playbook exists.\\\" \u00262\",  \" exit 1\",  \" fi\",  \" elif [[ \\\"{{playbookurl}}\\\" == s3* ]] ; then\",  \" aws --version\",  \" if [ $? -ne 0 ]; then\",  \" echo \\\"The AWS CLI is not installed. The CLI is required to process Amazon S3 URLs. Install the AWS CLI and run the command again.\\\" \u00262\",  \" exit 1\",  \" fi\",  \" aws s3 cp '{{playbookurl}}' playbook.yml\",  \" if [ $? -ne 0 ]; then\",  \" echo \\\"Error while downloading the document from S3\\\" \u00262\",  \" exit 1\",  \" fi\",  \" else\",  \" echo \\\"The playbook URL is not valid. Verify the URL and try again.\\\"\",  \" fi\",  \"else\",  \" echo '{{playbook}}'  playbook.yml\",  \"fi\",  \"if [[ \\\"{{check}}\\\" == True ]] ; then\",  \" /usr/local/bin/ansible-playbook -i \\\"localhost,\\\" --check -c local -e \\\"{{extravars}}\\\" playbook.yml\",  \"else\",  \" /usr/local/bin/ansible-playbook -i \\\"localhost,\\\" -c local -e \\\"{{extravars}}\\\" playbook.yml\",  \"fi\"  ]  }  }  ] }    Applying Ansible playbook to the fleet of mac1.metal Let’s give our new SSM Document a try! (I suppose you have at least one mac1 instance running, right?)\nIn AWS SSM, go to the Run Command feature, then click on the Run Command button.\nOn the new panel, type the name of your Document (macos-arbitrary-ansible-playbook in this example) in the search field and press enter.\nSelect the Document, and you’ll see its parameters and settings.\nThe rest is self-explanatory. Enter either a playbook code or a link to the source file, add extra variables if needed, and select the target host or a filtered bunch (I like that feature with tags filtering!). Finally, click on the “Run” orange button to apply your playbook.\nThat’s it! Now you can make all your ansible-playbook dreams come true! 😁\n","wordCount":"1019","inLanguage":"en","image":"https://devdosvid.blog/2021/05/27/run-ansible-playbook-on-mac1.metal-instances-fleet-with-aws-systems-manager/cover-image.png","datePublished":"2021-05-27T00:00:00Z","dateModified":"2022-04-25T00:25:12+03:00","author":{"@type":"Person","name":"Serhii Vasylenko"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://devdosvid.blog/2021/05/27/run-ansible-playbook-on-mac1.metal-instances-fleet-with-aws-systems-manager/"},"publisher":{"@type":"Person","name":"devDosvid — my engineering experience","logo":{"@type":"ImageObject","url":"https://devdosvid.blog/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://devdosvid.blog accesskey=h title="🏠 Home (Alt + H)">🏠 Home</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://devdosvid.blog/index.xml title="RSS Feed"><span>RSS Feed</span></a></li><li><a href=https://devdosvid.blog/archive title="All posts"><span>All posts</span></a></li><li><a href=https://devdosvid.blog/about/ title="About me"><span>About me</span></a></li><li><a href=https://devdosvid.blog/cv/ title="My CV"><span>My CV</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://devdosvid.blog>Home</a>&nbsp;»&nbsp;<a href=https://devdosvid.blog/posts/>Posts</a></div><h1 class=post-title>Run Ansible playbook on mac1.metal instances fleet with AWS Systems Manager</h1><div class=post-description>A small adjustment for big capabilities</div><div class=post-meta><span title="2021-05-27 00:00:00 +0000 UTC">May 27, 2021</span>&nbsp;·&nbsp;5 min&nbsp;·&nbsp;1019 words&nbsp;·&nbsp;Serhii Vasylenko&nbsp;|&nbsp;<a href=mailto:contact@devdosvid.blog rel="noopener noreferrer" target=_blank>📩 Suggest Changes</a></div></header><figure class=entry-cover><img loading=lazy srcset="https://devdosvid.blog/2021/05/27/run-ansible-playbook-on-mac1.metal-instances-fleet-with-aws-systems-manager/cover-image_hudec1707a089e00fa9ac5be62cf3691ae_54216_360x0_resize_box_3.png 360w ,https://devdosvid.blog/2021/05/27/run-ansible-playbook-on-mac1.metal-instances-fleet-with-aws-systems-manager/cover-image_hudec1707a089e00fa9ac5be62cf3691ae_54216_480x0_resize_box_3.png 480w ,https://devdosvid.blog/2021/05/27/run-ansible-playbook-on-mac1.metal-instances-fleet-with-aws-systems-manager/cover-image_hudec1707a089e00fa9ac5be62cf3691ae_54216_720x0_resize_box_3.png 720w ,https://devdosvid.blog/2021/05/27/run-ansible-playbook-on-mac1.metal-instances-fleet-with-aws-systems-manager/cover-image_hudec1707a089e00fa9ac5be62cf3691ae_54216_1080x0_resize_box_3.png 1080w ,https://devdosvid.blog/2021/05/27/run-ansible-playbook-on-mac1.metal-instances-fleet-with-aws-systems-manager/cover-image.png 1200w" sizes="(min-width: 768px) 720px, 100vw" src=https://devdosvid.blog/2021/05/27/run-ansible-playbook-on-mac1.metal-instances-fleet-with-aws-systems-manager/cover-image.png alt width=1200 height=600></figure><div class=post-content><p>In days of containers and serverless applications, Ansible looks not such a trendy thing.</p><p>But still, there are cases when it helps, and there are cases when it combines very well with brand new product offerings, such as EC2 Mac instances.</p><p>The <a href=/2021/02/01/customizing-mac1-metal-ec2-ami.html>more I use mac1.metal</a> in AWS, the more I see that Ansible becomes a bedrock of software customization in my case.</p><p>And when you have a large instances fleet, the AWS Systems Manager becomes your best friend (the sooner you get along together, the better).</p><p>So is it possible to use Ansible playbooks for mac1.metal on a big scale, with the help of AWS Systems Manager?</p><h2 id=not-available-out-of-the-box>(Not) Available out of the box<a hidden class=anchor aria-hidden=true href=#not-available-out-of-the-box>#</a></h2><p>AWS Systems Manager (SSM hereafter) has a pre-defined, shared Document that allows running Ansible playbooks.</p><p>It’s called “AWS-RunAnsiblePlaybook,” and you can find it in AWS SSM → Documents → Owned by Amazon.</p><p>However, this Document is not quite “friendly” to macOS. When the SSM agent calls Ansible on the Mac EC2 instance, it does not recognize the Ansible installed with Homebrew (de-facto most used macOS package manager).</p><p>So if you try to run a command on the mac1.metal instance using this Document, you will get the following error:</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>Ansible is not installed. Please install Ansible and rerun the command.
</span></span></code></pre></div><p>The root cause is trivial: the path to Ansible binary is not present on the list of paths available to the SSM agent by default.</p><p>There are several ways to solve that, but I believe that the most convenient one would be to create your custom Document — a slightly adjusted version of the default one provided by AWS.</p><h2 id=creating-own-ssm-document-for-ansible-installed-with-homebrew>Creating own SSM Document for Ansible installed with Homebrew<a hidden class=anchor aria-hidden=true href=#creating-own-ssm-document-for-ansible-installed-with-homebrew>#</a></h2><p>All you need to do is clone the Document provided by AWS and change its code a little — replace the callouts of <code>ansible</code> with the full path to the binary.</p><p>Navigate to AWS SSM → Documents → Owned by Amazon and type <code>AWS-RunAnsiblePlaybook</code> in the search field.</p><p>Select the Document by pressing the circle on its top-right corner and then click Actions → Clone document.</p><p><img loading=lazy src=aws_ssm_document_clone.png alt></p><p>Give the new SSM Document a name, e.g., <code>macos-arbitrary-ansible-playbook</code>, and change the <code>ansible</code> callouts (at the end of the code) with the full path to the ansible symlink made by Homebrew which is <code>/usr/local/bin/ansible</code></p><p>Here is the complete source code of the Document with adjusted Ansible path:</p><div class=code-snippet><details><summary markdown=span>Click here to see the code snippet</summary><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#6ab825;font-weight:700>&#34;schemaVersion&#34;</span>: <span style=color:#ed9d13>&#34;2.0&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#6ab825;font-weight:700>&#34;description&#34;</span>: <span style=color:#ed9d13>&#34;Use this document to run arbitrary Ansible playbooks on macOS EC2 instances. Specify either YAML text or URL. If you specify both, the URL parameter will be used. Use the extravar parameter to send runtime variables to the Ansible execution. Use the check parameter to perform a dry run of the Ansible execution. The output of the dry run shows the changes that will be made when the playbook is executed.&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#6ab825;font-weight:700>&#34;parameters&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:#6ab825;font-weight:700>&#34;playbook&#34;</span>: {
</span></span><span style=display:flex><span>      <span style=color:#6ab825;font-weight:700>&#34;type&#34;</span>: <span style=color:#ed9d13>&#34;String&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#6ab825;font-weight:700>&#34;description&#34;</span>: <span style=color:#ed9d13>&#34;(Optional) If you don&#39;t specify a URL, then you must specify playbook YAML in this field.&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#6ab825;font-weight:700>&#34;default&#34;</span>: <span style=color:#ed9d13>&#34;&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#6ab825;font-weight:700>&#34;displayType&#34;</span>: <span style=color:#ed9d13>&#34;textarea&#34;</span>
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    <span style=color:#6ab825;font-weight:700>&#34;playbookurl&#34;</span>: {
</span></span><span style=display:flex><span>      <span style=color:#6ab825;font-weight:700>&#34;type&#34;</span>: <span style=color:#ed9d13>&#34;String&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#6ab825;font-weight:700>&#34;description&#34;</span>: <span style=color:#ed9d13>&#34;(Optional) If you don&#39;t specify playbook YAML, then you must specify a URL where the playbook is stored. You can specify the URL in the following formats: http://example.com/playbook.yml  or s3://examplebucket/plabook.url. For security reasons, you can&#39;t specify a URL with quotes.&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#6ab825;font-weight:700>&#34;default&#34;</span>: <span style=color:#ed9d13>&#34;&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#6ab825;font-weight:700>&#34;allowedPattern&#34;</span>: <span style=color:#ed9d13>&#34;^\\s*$|^(http|https|s3)://[^&#39;]*$&#34;</span>
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    <span style=color:#6ab825;font-weight:700>&#34;extravars&#34;</span>: {
</span></span><span style=display:flex><span>      <span style=color:#6ab825;font-weight:700>&#34;type&#34;</span>: <span style=color:#ed9d13>&#34;String&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#6ab825;font-weight:700>&#34;description&#34;</span>: <span style=color:#ed9d13>&#34;(Optional) Additional variables to pass to Ansible at runtime. Enter a space separated list of key/value pairs. For example: color=red or fruits=[apples,pears]&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#6ab825;font-weight:700>&#34;default&#34;</span>: <span style=color:#ed9d13>&#34;foo=bar&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#6ab825;font-weight:700>&#34;displayType&#34;</span>: <span style=color:#ed9d13>&#34;textarea&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#6ab825;font-weight:700>&#34;allowedPattern&#34;</span>: <span style=color:#ed9d13>&#34;^((^|\\s)\\w+=(\\S+|&#39;.*&#39;))*$&#34;</span>
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    <span style=color:#6ab825;font-weight:700>&#34;check&#34;</span>: {
</span></span><span style=display:flex><span>      <span style=color:#6ab825;font-weight:700>&#34;type&#34;</span>: <span style=color:#ed9d13>&#34;String&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#6ab825;font-weight:700>&#34;description&#34;</span>: <span style=color:#ed9d13>&#34; (Optional) Use the check parameter to perform a dry run of the Ansible execution.&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#6ab825;font-weight:700>&#34;allowedValues&#34;</span>: [
</span></span><span style=display:flex><span>        <span style=color:#ed9d13>&#34;True&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#ed9d13>&#34;False&#34;</span>
</span></span><span style=display:flex><span>      ],
</span></span><span style=display:flex><span>      <span style=color:#6ab825;font-weight:700>&#34;default&#34;</span>: <span style=color:#ed9d13>&#34;False&#34;</span>
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    <span style=color:#6ab825;font-weight:700>&#34;timeoutSeconds&#34;</span>: {
</span></span><span style=display:flex><span>      <span style=color:#6ab825;font-weight:700>&#34;type&#34;</span>: <span style=color:#ed9d13>&#34;String&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#6ab825;font-weight:700>&#34;description&#34;</span>: <span style=color:#ed9d13>&#34;(Optional) The time in seconds for a command to be completed before it is considered to have failed.&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#6ab825;font-weight:700>&#34;default&#34;</span>: <span style=color:#ed9d13>&#34;3600&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  <span style=color:#6ab825;font-weight:700>&#34;mainSteps&#34;</span>: [
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#6ab825;font-weight:700>&#34;action&#34;</span>: <span style=color:#ed9d13>&#34;aws:runShellScript&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#6ab825;font-weight:700>&#34;name&#34;</span>: <span style=color:#ed9d13>&#34;runShellScript&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#6ab825;font-weight:700>&#34;inputs&#34;</span>: {
</span></span><span style=display:flex><span>        <span style=color:#6ab825;font-weight:700>&#34;timeoutSeconds&#34;</span>: <span style=color:#ed9d13>&#34;{{ timeoutSeconds }}&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#6ab825;font-weight:700>&#34;runCommand&#34;</span>: [
</span></span><span style=display:flex><span>          <span style=color:#ed9d13>&#34;#!/bin/bash&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#ed9d13>&#34;/usr/local/bin/ansible --version&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#ed9d13>&#34;if [ $? -ne 0 ]; then&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#ed9d13>&#34; echo \&#34;Ansible is not installed. Please install Ansible and rerun the command\&#34; &gt;&amp;2&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#ed9d13>&#34; exit 1&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#ed9d13>&#34;fi&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#ed9d13>&#34;execdir=$(dirname $0)&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#ed9d13>&#34;cd $execdir&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#ed9d13>&#34;if [ -z &#39;{{playbook}}&#39; ] ; then&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#ed9d13>&#34; if [[ \&#34;{{playbookurl}}\&#34; == http* ]]; then&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#ed9d13>&#34;   wget &#39;{{playbookurl}}&#39; -O playbook.yml&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#ed9d13>&#34;   if [ $? -ne 0 ]; then&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#ed9d13>&#34;       echo \&#34;There was a problem downloading the playbook. Make sure the URL is correct and that the playbook exists.\&#34; &gt;&amp;2&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#ed9d13>&#34;       exit 1&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#ed9d13>&#34;   fi&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#ed9d13>&#34; elif [[ \&#34;{{playbookurl}}\&#34; == s3* ]] ; then&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#ed9d13>&#34;   aws --version&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#ed9d13>&#34;   if [ $? -ne 0 ]; then&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#ed9d13>&#34;       echo \&#34;The AWS CLI is not installed. The CLI is required to process Amazon S3 URLs. Install the AWS CLI and run the command again.\&#34; &gt;&amp;2&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#ed9d13>&#34;       exit 1&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#ed9d13>&#34;   fi&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#ed9d13>&#34;   aws s3 cp &#39;{{playbookurl}}&#39; playbook.yml&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#ed9d13>&#34;   if [ $? -ne 0 ]; then&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#ed9d13>&#34;       echo \&#34;Error while downloading the document from S3\&#34; &gt;&amp;2&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#ed9d13>&#34;       exit 1&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#ed9d13>&#34;   fi&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#ed9d13>&#34; else&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#ed9d13>&#34;   echo \&#34;The playbook URL is not valid. Verify the URL and try again.\&#34;&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#ed9d13>&#34; fi&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#ed9d13>&#34;else&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#ed9d13>&#34; echo &#39;{{playbook}}&#39; &gt; playbook.yml&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#ed9d13>&#34;fi&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#ed9d13>&#34;if  [[ \&#34;{{check}}\&#34; == True ]] ; then&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#ed9d13>&#34;   /usr/local/bin/ansible-playbook -i \&#34;localhost,\&#34; --check -c local -e \&#34;{{extravars}}\&#34; playbook.yml&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#ed9d13>&#34;else&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#ed9d13>&#34;   /usr/local/bin/ansible-playbook -i \&#34;localhost,\&#34; -c local -e \&#34;{{extravars}}\&#34; playbook.yml&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#ed9d13>&#34;fi&#34;</span>
</span></span><span style=display:flex><span>        ]
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  ]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></details></div><h2 id=applying-ansible-playbook-to-the-fleet-of-mac1metal>Applying Ansible playbook to the fleet of mac1.metal<a hidden class=anchor aria-hidden=true href=#applying-ansible-playbook-to-the-fleet-of-mac1metal>#</a></h2><p>Let’s give our new SSM Document a try! (I suppose you have at least one mac1 instance running, right?)</p><p>In AWS SSM, go to the Run Command feature, then click on the Run Command button.</p><p>On the new panel, type the name of your Document (<code>macos-arbitrary-ansible-playbook</code> in this example) in the search field and press enter.</p><p>Select the Document, and you’ll see its parameters and settings.</p><p>The rest is self-explanatory. Enter either a playbook code or a link to the source file, add extra variables if needed, and select the target host or a filtered bunch (I like that feature with tags filtering!). Finally, click on the “Run” orange button to apply your playbook.</p><p>That’s it! Now you can make all your ansible-playbook dreams come true! 😁</p></div><footer class=post-footer><div class=post-series><p>Check out other posts of the <b>"mac1.metal at AWS"</b> series:</p><ul><li>Oct 24, 2021 — <a href="https://devdosvid.blog/2021/10/24/auto-scaling-group-for-your-macos-ec2-instances-fleet/?utm_blogseries=mac1.metal-at-aws">Auto Scaling Group for your macOS EC2 Instances fleet</a></li><li style=opacity:.75>May 27, 2021 — Run Ansible playbook on mac1.metal instances fleet with AWS Systems Manager</li><li>Feb 01, 2021 — <a href="https://devdosvid.blog/2021/02/01/customizing-mac1-metal-ec2-ami.html?utm_blogseries=mac1.metal-at-aws">Customizing mac1.metal EC2 AMI — new guts, more glory</a></li><li>Jan 20, 2021 — <a href="https://devdosvid.blog/2021/01/20/terraforming-mac1-metal-at-AWS.html?utm_blogseries=mac1.metal-at-aws">Terraforming mac1.metal at AWS</a></li><li>Jan 19, 2021 — <a href="https://devdosvid.blog/2021/01/19/mac1-metal-EC2-Instance-user-experience.html?utm_blogseries=mac1.metal-at-aws">mac1.metal EC2 Instance — user experience</a></li></ul></div><ul class=post-tags></ul><div class=license><p>This work is licensed under a <a rel=license href=http://creativecommons.org/licenses/by-nd/4.0/>Creative Commons Attribution-NoDerivatives 4.0 International License</a></p></div><div class="sp-form-outer sp-force-hide"><div id=sp-form-211745 sp-id=211745 sp-hash=9ef750f82b8d5e11b34ea23df27756cb738d703108d46ebff940b44ce4757404 sp-lang=en class="sp-form sp-form-regular sp-form-embed" sp-show-options=%7B%22satellite%22%3Afalse%2C%22maDomain%22%3A%22login.sendpulse.com%22%2C%22formsDomain%22%3A%22forms.sendpulse.com%22%2C%22condition%22%3A%22onEnter%22%2C%22scrollTo%22%3A25%2C%22delay%22%3A10%2C%22repeat%22%3A3%2C%22background%22%3A%22rgba(0%2C%200%2C%200%2C%200.5)%22%2C%22position%22%3A%22bottom-right%22%2C%22animation%22%3A%22%22%2C%22hideOnMobile%22%3Afalse%2C%22urlFilter%22%3Afalse%2C%22urlFilterConditions%22%3A%5B%7B%22force%22%3A%22hide%22%2C%22clause%22%3A%22contains%22%2C%22token%22%3A%22%22%7D%5D%2C%22analytics%22%3A%7B%22ga%22%3A%7B%22eventLabel%22%3A%22Subscription_form_devDosvid%22%2C%22send%22%3Afalse%7D%2C%22ym%22%3A%7B%22counterId%22%3Anull%2C%22eventLabel%22%3Anull%2C%22targetId%22%3Anull%2C%22send%22%3Afalse%7D%7D%2C%22utmEnable%22%3Afalse%7D><div class=sp-form-fields-wrapper><div class=sp-message><div></div></div><form novalidate class=sp-element-container><div class="sp-field sp-field-full-width-add sp-field-full-width sp-field-full-width-add-active" sp-id=sp-d7ac453c-4371-4ac2-94ad-209ba95924ce data-><div><h3>Subscribe to be notified about blog updates!</h3></div></div><div class=sp-field sp-id=sp-07c6298b-0a1a-4417-b7d9-b2205b910fc7><label class=sp-control-label><span>Email</span><strong>*</strong></label><input type=email sp-type=email name=sform[email] class=sp-form-control placeholder=username@example.com sp-tips=%7B%22required%22%3A%22Required%20field%22%2C%22wrong%22%3A%22Wrong%20email%22%7D autocomplete=on required></div><div class="sp-field sp-button-container" sp-id=sp-92706abe-5113-4db0-b255-c64ad75a46f7><button id=sp-92706abe-5113-4db0-b255-c64ad75a46f7 class=sp-button>Subscribe</button></div></form></div></div></div><script type=text/javascript async src=//web.webformscr.com/apps/fc3/build/default-handler.js?1651223786960></script><nav class=paginav><a class=prev href=https://devdosvid.blog/2021/09/25/aws-resource-access-manager-multi-account-resource-governance/><span class=title>« Prev Page</span><br><span>AWS Resource Access Manager — Multi Account Resource Governance</span></a>
<a class=next href=https://devdosvid.blog/2021/05/21/configure-http-security-headers-with-cloudfront-functions/><span class=title>Next Page »</span><br><span>Configure HTTP Security headers with CloudFront Functions</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2022 <a href=https://devdosvid.blog>devDosvid — my engineering experience</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(t){t.preventDefault();var e=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView({behavior:"smooth"}),e==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${e}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(t=>{const n=t.parentNode.parentNode,e=document.createElement("button");e.classList.add("copy-code"),e.innerText="copy";function s(){e.innerText="copied!",setTimeout(()=>{e.innerText="copy"},2e3)}e.addEventListener("click",o=>{if("clipboard"in navigator){navigator.clipboard.writeText(t.textContent),s();return}const e=document.createRange();e.selectNodeContents(t);const n=window.getSelection();n.removeAllRanges(),n.addRange(e);try{document.execCommand("copy"),s()}catch(e){}n.removeRange(e)}),n.classList.contains("highlight")?n.appendChild(e):n.parentNode.firstChild==n||(t.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?t.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(e):t.parentNode.appendChild(e))})</script></body></html>