<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Run Ansible playbook on Mac EC2 Instances fleet with AWS Systems Manager | devDosvid blog</title><meta name=keywords content="aws,ansible"><meta name=description content="Configuration management for mac1.metal and mac2.metal AWS Instances"><meta name=author content="Serhii Vasylenko"><link rel=canonical href=https://devdosvid.blog/2021/05/27/run-ansible-playbook-on-mac-ec2-instances-fleet-with-aws-systems-manager/><link crossorigin=anonymous href=/assets/css/stylesheet.6db821c09946fdbf569c172dd76f99824cf02e9190cb306ded6f5d14f79ec826.css integrity="sha256-bbghwJlG/b9WnBct12+ZgkzwLpGQyzBt7W9dFPeeyCY=" rel="preload stylesheet" as=style><link rel=icon href=https://devdosvid.blog/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://devdosvid.blog/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://devdosvid.blog/favicon-32x32.png><link rel=apple-touch-icon href=https://devdosvid.blog/apple-touch-icon.png><link rel=mask-icon href=https://devdosvid.blog/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><style>@font-face{font-family:albert sans;font-style:normal;font-display:swap;font-weight:300;src:url(/assets/fonts/AlbertSans-Light.woff2)format('woff');unicode-range:U+??,U+131,U+152-153,U+2BB-2BC,U+2C6,U+2DA,U+2DC,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}@font-face{font-family:albert sans;font-style:italic;font-display:swap;font-weight:300;src:url(/assets/fonts/AlbertSans-LightItalic.woff2)format('woff');unicode-range:U+??,U+131,U+152-153,U+2BB-2BC,U+2C6,U+2DA,U+2DC,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}@font-face{font-family:albert sans;font-style:normal;font-display:swap;font-weight:400;src:url(/assets/fonts/AlbertSans-Regular.woff2)format('woff');unicode-range:U+??,U+131,U+152-153,U+2BB-2BC,U+2C6,U+2DA,U+2DC,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}@font-face{font-family:albert sans;font-style:italic;font-display:swap;font-weight:400;src:url(/assets/fonts/AlbertSans-Italic.woff2)format('woff');unicode-range:U+??,U+131,U+152-153,U+2BB-2BC,U+2C6,U+2DA,U+2DC,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}@font-face{font-family:albert sans;font-style:normal;font-display:swap;font-weight:500;src:url(/assets/fonts/AlbertSans-Medium.woff2)format('woff');unicode-range:U+??,U+131,U+152-153,U+2BB-2BC,U+2C6,U+2DA,U+2DC,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}@font-face{font-family:albert sans;font-style:italic;font-display:swap;font-weight:500;src:url(/assets/fonts/AlbertSans-MediumItalic.woff2)format('woff');unicode-range:U+??,U+131,U+152-153,U+2BB-2BC,U+2C6,U+2DA,U+2DC,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}@font-face{font-family:albert sans;font-style:normal;font-display:swap;font-weight:600;src:url(/assets/fonts/AlbertSans-SemiBold.woff2)format('woff');unicode-range:U+??,U+131,U+152-153,U+2BB-2BC,U+2C6,U+2DA,U+2DC,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}@font-face{font-family:albert sans;font-style:italic;font-display:swap;font-weight:600;src:url(/assets/fonts/AlbertSans-SemiBoldItalic.woff2)format('woff');unicode-range:U+??,U+131,U+152-153,U+2BB-2BC,U+2C6,U+2DA,U+2DC,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}</style><meta name=twitter:creator content="@vasylenko"><meta name=twitter:site content="@vasylenko"><script defer type=text/javascript>window.heap=window.heap||[],heap.load=function(e,t){window.heap.appid=e,window.heap.config=t=t||{},n=document.createElement("script"),n.type="text/javascript",n.async=!0,n.src="https://cdn.heapanalytics.com/js/heap-"+e+".js",o=document.getElementsByTagName("script")[0],o.parentNode.insertBefore(n,o);for(var n,o,a=function(e){return function(){heap.push([e].concat(Array.prototype.slice.call(arguments,0)))}},i=["addEventProperties","addUserProperties","clearEventProperties","identify","resetIdentity","removeEventProperty","setEventProperties","track","unsetEventProperty"],s=0;s<i.length;s++)heap[i[s]]=a(i[s])},heap.load("2300872157")</script><meta property="og:title" content="Run Ansible playbook on Mac EC2 Instances fleet with AWS Systems Manager"><meta property="og:description" content="Configuration management for mac1.metal and mac2.metal AWS Instances"><meta property="og:type" content="article"><meta property="og:url" content="https://devdosvid.blog/2021/05/27/run-ansible-playbook-on-mac-ec2-instances-fleet-with-aws-systems-manager/"><meta property="og:image" content="https://devdosvid.blog/2021/05/27/run-ansible-playbook-on-mac-ec2-instances-fleet-with-aws-systems-manager/cover-image.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-05-27T00:00:00+00:00"><meta property="article:modified_time" content="2022-07-15T22:47:01+02:00"><meta property="og:site_name" content="devDosvid blog"><meta property="og:see_also" content="https://devdosvid.blog/2021/10/24/auto-scaling-group-for-your-macos-ec2-instances-fleet/"><meta property="og:see_also" content="https://devdosvid.blog/2021/02/01/customizing-mac1.metal-ec2-ami-new-guts-more-glory/"><meta property="og:see_also" content="https://devdosvid.blog/2021/01/20/terraforming-mac1.metal-at-aws/"><meta property="og:see_also" content="https://devdosvid.blog/2021/01/19/mac1.metal-and-mac2.metal-ec2-instances-user-experience/"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://devdosvid.blog/2021/05/27/run-ansible-playbook-on-mac-ec2-instances-fleet-with-aws-systems-manager/cover-image.png"><meta name=twitter:title content="Run Ansible playbook on Mac EC2 Instances fleet with AWS Systems Manager"><meta name=twitter:description content="Configuration management for mac1.metal and mac2.metal AWS Instances"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://devdosvid.blog/posts/"},{"@type":"ListItem","position":3,"name":"Run Ansible playbook on Mac EC2 Instances fleet with AWS Systems Manager","item":"https://devdosvid.blog/2021/05/27/run-ansible-playbook-on-mac-ec2-instances-fleet-with-aws-systems-manager/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Run Ansible playbook on Mac EC2 Instances fleet with AWS Systems Manager","name":"Run Ansible playbook on Mac EC2 Instances fleet with AWS Systems Manager","description":"Configuration management for mac1.metal and mac2.metal AWS Instances","keywords":["aws","ansible"],"articleBody":"In days of containers and serverless applications, Ansible looks not such a trendy thing.\nBut still, there are cases when it helps, and there are cases when it combines very well with brand new product offerings, such as EC2 Mac instances.\nThe more I use mac1.metal in AWS, the more I see that Ansible becomes a bedrock of software customization in my case.\nAnd when you have a large instances fleet, the AWS Systems Manager becomes your best friend (the sooner you get along together, the better).\nSo is it possible to use Ansible playbooks for mac1.metal on a big scale, with the help of AWS Systems Manager?\n(Not) Available out of the box AWS Systems Manager (SSM hereafter) has a pre-defined, shared Document that allows running Ansible playbooks.\nIt’s called “AWS-RunAnsiblePlaybook,” and you can find it in AWS SSM → Documents → Owned by Amazon.\nHowever, this Document is not quite “friendly” to macOS. When the SSM agent calls Ansible on the Mac EC2 instance, it does not recognize the Ansible installed with Homebrew (de-facto most used macOS package manager).\nSo if you try to run a command on the mac1.metal instance using this Document, you will get the following error:\nAnsible is not installed. Please install Ansible and rerun the command. The root cause is trivial: the path to Ansible binary is not present on the list of paths available to the SSM agent by default.\nThere are several ways to solve that, but I believe that the most convenient one would be to create your custom Document — a slightly adjusted version of the default one provided by AWS.\nCreating own SSM Document for Ansible installed with Homebrew All you need to do is clone the Document provided by AWS and change its code a little — replace the callouts of ansible with the full path to the binary.\nNavigate to AWS SSM → Documents → Owned by Amazon and type AWS-RunAnsiblePlaybook in the search field.\nSelect the Document by pressing the circle on its top-right corner and then click Actions → Clone document.\nGive the new SSM Document a name, e.g., macos-arbitrary-ansible-playbook, and change the ansible callouts (at the end of the code) with the full path to the ansible symlink made by Homebrew which is /usr/local/bin/ansible\nHere is the complete source code of the Document with adjusted Ansible path:\nClick here to see the code snippet { \"schemaVersion\": \"2.0\", \"description\": \"Use this document to run arbitrary Ansible playbooks on macOS EC2 instances. Specify either YAML text or URL. If you specify both, the URL parameter will be used. Use the extravar parameter to send runtime variables to the Ansible execution. Use the check parameter to perform a dry run of the Ansible execution. The output of the dry run shows the changes that will be made when the playbook is executed.\", \"parameters\": { \"playbook\": { \"type\": \"String\", \"description\": \"(Optional) If you don't specify a URL, then you must specify playbook YAML in this field.\", \"default\": \"\", \"displayType\": \"textarea\" }, \"playbookurl\": { \"type\": \"String\", \"description\": \"(Optional) If you don't specify playbook YAML, then you must specify a URL where the playbook is stored. You can specify the URL in the following formats: http://example.com/playbook.yml or s3://examplebucket/plabook.url. For security reasons, you can't specify a URL with quotes.\", \"default\": \"\", \"allowedPattern\": \"^\\\\s*$|^(http|https|s3)://[^']*$\" }, \"extravars\": { \"type\": \"String\", \"description\": \"(Optional) Additional variables to pass to Ansible at runtime. Enter a space separated list of key/value pairs. For example: color=red or fruits=[apples,pears]\", \"default\": \"foo=bar\", \"displayType\": \"textarea\", \"allowedPattern\": \"^((^|\\\\s)\\\\w+=(\\\\S+|'.*'))*$\" }, \"check\": { \"type\": \"String\", \"description\": \" (Optional) Use the check parameter to perform a dry run of the Ansible execution.\", \"allowedValues\": [ \"True\", \"False\" ], \"default\": \"False\" }, \"timeoutSeconds\": { \"type\": \"String\", \"description\": \"(Optional) The time in seconds for a command to be completed before it is considered to have failed.\", \"default\": \"3600\" } }, \"mainSteps\": [ { \"action\": \"aws:runShellScript\", \"name\": \"runShellScript\", \"inputs\": { \"timeoutSeconds\": \"{{ timeoutSeconds }}\", \"runCommand\": [ \"#!/bin/bash\", \"/usr/local/bin/ansible --version\", \"if [ $? -ne 0 ]; then\", \" echo \\\"Ansible is not installed. Please install Ansible and rerun the command\\\" \u003e\u00262\", \" exit 1\", \"fi\", \"execdir=$(dirname $0)\", \"cd $execdir\", \"if [ -z '{{playbook}}' ] ; then\", \" if [[ \\\"{{playbookurl}}\\\" == http* ]]; then\", \" wget '{{playbookurl}}' -O playbook.yml\", \" if [ $? -ne 0 ]; then\", \" echo \\\"There was a problem downloading the playbook. Make sure the URL is correct and that the playbook exists.\\\" \u003e\u00262\", \" exit 1\", \" fi\", \" elif [[ \\\"{{playbookurl}}\\\" == s3* ]] ; then\", \" aws --version\", \" if [ $? -ne 0 ]; then\", \" echo \\\"The AWS CLI is not installed. The CLI is required to process Amazon S3 URLs. Install the AWS CLI and run the command again.\\\" \u003e\u00262\", \" exit 1\", \" fi\", \" aws s3 cp '{{playbookurl}}' playbook.yml\", \" if [ $? -ne 0 ]; then\", \" echo \\\"Error while downloading the document from S3\\\" \u003e\u00262\", \" exit 1\", \" fi\", \" else\", \" echo \\\"The playbook URL is not valid. Verify the URL and try again.\\\"\", \" fi\", \"else\", \" echo '{{playbook}}' \u003e playbook.yml\", \"fi\", \"if [[ \\\"{{check}}\\\" == True ]] ; then\", \" /usr/local/bin/ansible-playbook -i \\\"localhost,\\\" --check -c local -e \\\"{{extravars}}\\\" playbook.yml\", \"else\", \" /usr/local/bin/ansible-playbook -i \\\"localhost,\\\" -c local -e \\\"{{extravars}}\\\" playbook.yml\", \"fi\" ] } } ] } Applying Ansible playbook to the fleet of mac1.metal Let’s give our new SSM Document a try! (I suppose you have at least one mac1 instance running, right?)\nIn AWS SSM, go to the Run Command feature, then click on the Run Command button.\nOn the new panel, type the name of your Document (macos-arbitrary-ansible-playbook in this example) in the search field and press enter.\nSelect the Document, and you’ll see its parameters and settings.\nThe rest is self-explanatory. Enter either a playbook code or a link to the source file, add extra variables if needed, and select the target host or a filtered bunch (I like that feature with tags filtering!). Finally, click on the “Run” orange button to apply your playbook.\nThat’s it! Now you can make all your ansible-playbook dreams come true! 😁\n","wordCount":"1019","inLanguage":"en","image":"https://devdosvid.blog/2021/05/27/run-ansible-playbook-on-mac-ec2-instances-fleet-with-aws-systems-manager/cover-image.png","datePublished":"2021-05-27T00:00:00Z","dateModified":"2022-07-15T22:47:01+02:00","author":{"@type":"Person","name":"Serhii Vasylenko"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://devdosvid.blog/2021/05/27/run-ansible-playbook-on-mac-ec2-instances-fleet-with-aws-systems-manager/"},"publisher":{"@type":"Person","name":"devDosvid blog","logo":{"@type":"ImageObject","url":"https://devdosvid.blog/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://devdosvid.blog accesskey=h title="🏠 Home (Alt + H)">🏠 Home</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://devdosvid.blog/index.xml title="RSS Feed"><span>RSS Feed</span></a></li><li><a href=https://devdosvid.blog/archive title="All posts"><span>All posts</span></a></li><li><a href=https://devdosvid.blog/about/ title="About me"><span>About me</span></a></li><li><a href=https://devdosvid.blog/series title="Post Series"><span>Post Series</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://devdosvid.blog>Home</a>&nbsp;»&nbsp;<a href=https://devdosvid.blog/posts/>Posts</a></div><h1 class=post-title>Run Ansible playbook on Mac EC2 Instances fleet with AWS Systems Manager</h1><div class=post-description>Configuration management for mac1.metal and mac2.metal AWS Instances</div><div class=post-meta><span title='2021-05-27 00:00:00 +0000 UTC'>May 27, 2021</span>&nbsp;·&nbsp;Serhii Vasylenko&nbsp;|&nbsp;<a href=mailto:contact@devdosvid.blog rel="noopener noreferrer" target=_blank>📩 Suggest Changes</a></div></header><figure class=entry-cover><img srcset="https://devdosvid.blog/2021/05/27/run-ansible-playbook-on-mac-ec2-instances-fleet-with-aws-systems-manager/cover-image_hu421065adb305040b50fc86a773ed3cd1_15560_360x0_resize_box_3.png 360w ,https://devdosvid.blog/2021/05/27/run-ansible-playbook-on-mac-ec2-instances-fleet-with-aws-systems-manager/cover-image_hu421065adb305040b50fc86a773ed3cd1_15560_480x0_resize_box_3.png 480w ,https://devdosvid.blog/2021/05/27/run-ansible-playbook-on-mac-ec2-instances-fleet-with-aws-systems-manager/cover-image_hu421065adb305040b50fc86a773ed3cd1_15560_720x0_resize_box_3.png 720w ,https://devdosvid.blog/2021/05/27/run-ansible-playbook-on-mac-ec2-instances-fleet-with-aws-systems-manager/cover-image_hu421065adb305040b50fc86a773ed3cd1_15560_1080x0_resize_box_3.png 1080w ,https://devdosvid.blog/2021/05/27/run-ansible-playbook-on-mac-ec2-instances-fleet-with-aws-systems-manager/cover-image.png 1200w" sizes="(min-width: 768px) 720px, 100vw" src=https://devdosvid.blog/2021/05/27/run-ansible-playbook-on-mac-ec2-instances-fleet-with-aws-systems-manager/cover-image.png alt width=1200 height=600></figure><div class=post-content><p>In days of containers and serverless applications, Ansible looks not such a trendy thing.</p><p>But still, there are cases when it helps, and there are cases when it combines very well with brand new product offerings, such as EC2 Mac instances.</p><p>The <a href=/2021/02/01/customizing-mac1-metal-ec2-ami.html>more I use mac1.metal</a> in AWS, the more I see that Ansible becomes a bedrock of software customization in my case.</p><p>And when you have a large instances fleet, the AWS Systems Manager becomes your best friend (the sooner you get along together, the better).</p><p>So is it possible to use Ansible playbooks for mac1.metal on a big scale, with the help of AWS Systems Manager?</p><h2 id=not-available-out-of-the-box>(Not) Available out of the box<a hidden class=anchor aria-hidden=true href=#not-available-out-of-the-box>#</a></h2><p>AWS Systems Manager (SSM hereafter) has a pre-defined, shared Document that allows running Ansible playbooks.</p><p>It’s called “AWS-RunAnsiblePlaybook,” and you can find it in AWS SSM → Documents → Owned by Amazon.</p><p>However, this Document is not quite “friendly” to macOS. When the SSM agent calls Ansible on the Mac EC2 instance, it does not recognize the Ansible installed with Homebrew (de-facto most used macOS package manager).</p><p>So if you try to run a command on the mac1.metal instance using this Document, you will get the following error:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>Ansible is not installed. Please install Ansible and rerun the command.
</span></span></code></pre></div><p>The root cause is trivial: the path to Ansible binary is not present on the list of paths available to the SSM agent by default.</p><p>There are several ways to solve that, but I believe that the most convenient one would be to create your custom Document — a slightly adjusted version of the default one provided by AWS.</p><h2 id=creating-own-ssm-document-for-ansible-installed-with-homebrew>Creating own SSM Document for Ansible installed with Homebrew<a hidden class=anchor aria-hidden=true href=#creating-own-ssm-document-for-ansible-installed-with-homebrew>#</a></h2><p>All you need to do is clone the Document provided by AWS and change its code a little — replace the callouts of <code>ansible</code> with the full path to the binary.</p><p>Navigate to AWS SSM → Documents → Owned by Amazon and type <code>AWS-RunAnsiblePlaybook</code> in the search field.</p><p>Select the Document by pressing the circle on its top-right corner and then click Actions → Clone document.</p><figure><img loading=lazy src=aws_ssm_document_clone.png width=800 height=476.68></figure><p>Give the new SSM Document a name, e.g., <code>macos-arbitrary-ansible-playbook</code>, and change the <code>ansible</code> callouts (at the end of the code) with the full path to the ansible symlink made by Homebrew which is <code>/usr/local/bin/ansible</code></p><p>Here is the complete source code of the Document with adjusted Ansible path:</p><div class=code-snippet><details><summary markdown=span>Click here to see the code snippet</summary><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;schemaVersion&#34;</span>: <span style=color:#e6db74>&#34;2.0&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;description&#34;</span>: <span style=color:#e6db74>&#34;Use this document to run arbitrary Ansible playbooks on macOS EC2 instances. Specify either YAML text or URL. If you specify both, the URL parameter will be used. Use the extravar parameter to send runtime variables to the Ansible execution. Use the check parameter to perform a dry run of the Ansible execution. The output of the dry run shows the changes that will be made when the playbook is executed.&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;parameters&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;playbook&#34;</span>: {
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;String&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;description&#34;</span>: <span style=color:#e6db74>&#34;(Optional) If you don&#39;t specify a URL, then you must specify playbook YAML in this field.&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;default&#34;</span>: <span style=color:#e6db74>&#34;&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;displayType&#34;</span>: <span style=color:#e6db74>&#34;textarea&#34;</span>
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;playbookurl&#34;</span>: {
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;String&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;description&#34;</span>: <span style=color:#e6db74>&#34;(Optional) If you don&#39;t specify playbook YAML, then you must specify a URL where the playbook is stored. You can specify the URL in the following formats: http://example.com/playbook.yml  or s3://examplebucket/plabook.url. For security reasons, you can&#39;t specify a URL with quotes.&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;default&#34;</span>: <span style=color:#e6db74>&#34;&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;allowedPattern&#34;</span>: <span style=color:#e6db74>&#34;^\\s*$|^(http|https|s3)://[^&#39;]*$&#34;</span>
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;extravars&#34;</span>: {
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;String&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;description&#34;</span>: <span style=color:#e6db74>&#34;(Optional) Additional variables to pass to Ansible at runtime. Enter a space separated list of key/value pairs. For example: color=red or fruits=[apples,pears]&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;default&#34;</span>: <span style=color:#e6db74>&#34;foo=bar&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;displayType&#34;</span>: <span style=color:#e6db74>&#34;textarea&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;allowedPattern&#34;</span>: <span style=color:#e6db74>&#34;^((^|\\s)\\w+=(\\S+|&#39;.*&#39;))*$&#34;</span>
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;check&#34;</span>: {
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;String&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;description&#34;</span>: <span style=color:#e6db74>&#34; (Optional) Use the check parameter to perform a dry run of the Ansible execution.&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;allowedValues&#34;</span>: [
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;True&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;False&#34;</span>
</span></span><span style=display:flex><span>      ],
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;default&#34;</span>: <span style=color:#e6db74>&#34;False&#34;</span>
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;timeoutSeconds&#34;</span>: {
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;String&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;description&#34;</span>: <span style=color:#e6db74>&#34;(Optional) The time in seconds for a command to be completed before it is considered to have failed.&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;default&#34;</span>: <span style=color:#e6db74>&#34;3600&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;mainSteps&#34;</span>: [
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;action&#34;</span>: <span style=color:#e6db74>&#34;aws:runShellScript&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;runShellScript&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;inputs&#34;</span>: {
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;timeoutSeconds&#34;</span>: <span style=color:#e6db74>&#34;{{ timeoutSeconds }}&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;runCommand&#34;</span>: [
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;#!/bin/bash&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;/usr/local/bin/ansible --version&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;if [ $? -ne 0 ]; then&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34; echo \&#34;Ansible is not installed. Please install Ansible and rerun the command\&#34; &gt;&amp;2&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34; exit 1&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;fi&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;execdir=$(dirname $0)&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;cd $execdir&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;if [ -z &#39;{{playbook}}&#39; ] ; then&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34; if [[ \&#34;{{playbookurl}}\&#34; == http* ]]; then&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;   wget &#39;{{playbookurl}}&#39; -O playbook.yml&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;   if [ $? -ne 0 ]; then&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;       echo \&#34;There was a problem downloading the playbook. Make sure the URL is correct and that the playbook exists.\&#34; &gt;&amp;2&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;       exit 1&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;   fi&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34; elif [[ \&#34;{{playbookurl}}\&#34; == s3* ]] ; then&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;   aws --version&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;   if [ $? -ne 0 ]; then&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;       echo \&#34;The AWS CLI is not installed. The CLI is required to process Amazon S3 URLs. Install the AWS CLI and run the command again.\&#34; &gt;&amp;2&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;       exit 1&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;   fi&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;   aws s3 cp &#39;{{playbookurl}}&#39; playbook.yml&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;   if [ $? -ne 0 ]; then&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;       echo \&#34;Error while downloading the document from S3\&#34; &gt;&amp;2&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;       exit 1&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;   fi&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34; else&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;   echo \&#34;The playbook URL is not valid. Verify the URL and try again.\&#34;&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34; fi&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;else&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34; echo &#39;{{playbook}}&#39; &gt; playbook.yml&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;fi&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;if  [[ \&#34;{{check}}\&#34; == True ]] ; then&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;   /usr/local/bin/ansible-playbook -i \&#34;localhost,\&#34; --check -c local -e \&#34;{{extravars}}\&#34; playbook.yml&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;else&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;   /usr/local/bin/ansible-playbook -i \&#34;localhost,\&#34; -c local -e \&#34;{{extravars}}\&#34; playbook.yml&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;fi&#34;</span>
</span></span><span style=display:flex><span>        ]
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  ]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></details></div><h2 id=applying-ansible-playbook-to-the-fleet-of-mac1metal>Applying Ansible playbook to the fleet of mac1.metal<a hidden class=anchor aria-hidden=true href=#applying-ansible-playbook-to-the-fleet-of-mac1metal>#</a></h2><p>Let’s give our new SSM Document a try! (I suppose you have at least one mac1 instance running, right?)</p><p>In AWS SSM, go to the Run Command feature, then click on the Run Command button.</p><p>On the new panel, type the name of your Document (<code>macos-arbitrary-ansible-playbook</code> in this example) in the search field and press enter.</p><p>Select the Document, and you’ll see its parameters and settings.</p><p>The rest is self-explanatory. Enter either a playbook code or a link to the source file, add extra variables if needed, and select the target host or a filtered bunch (I like that feature with tags filtering!). Finally, click on the “Run” orange button to apply your playbook.</p><p>That’s it! Now you can make all your ansible-playbook dreams come true! 😁</p></div><footer class=post-footer><div class=substack-embedded-container><h3>Subscribe to blog updates!</h3><iframe class=substack-embedded-iframe src=https://devdosvid.substack.com/embed height=250 loading=lazy></iframe></div><script src=https://giscus.app/client.js data-repo=vasylenko/devdosvid.blog data-repo-id="MDEwOlJlcG9zaXRvcnkyNDUyNTMxODE=" data-category=General data-category-id=DIC_kwDODp5EPc4CA59c data-mapping=title data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-theme=light data-lang=en crossorigin=anonymous async></script><div class=post-series><p>Check out other posts of the <b>"mac1.metal at AWS"</b> series:</p><ul><li><a href="https://devdosvid.blog/2021/10/24/auto-scaling-group-for-your-macos-ec2-instances-fleet/?utm_blogseries=mac1.metal-at-aws">Auto Scaling Group for your macOS EC2 Instances fleet</a></li><li style=opacity:.75>Run Ansible playbook on Mac EC2 Instances fleet with AWS Systems Manager</li><li><a href="https://devdosvid.blog/2021/02/01/customizing-mac1.metal-ec2-ami-new-guts-more-glory/?utm_blogseries=mac1.metal-at-aws">Customizing mac1.metal EC2 AMI — new guts, more glory</a></li><li><a href="https://devdosvid.blog/2021/01/20/terraforming-mac1.metal-at-aws/?utm_blogseries=mac1.metal-at-aws">Terraforming mac1.metal at AWS</a></li><li><a href="https://devdosvid.blog/2021/01/19/mac1.metal-and-mac2.metal-ec2-instances-user-experience/?utm_blogseries=mac1.metal-at-aws">mac1.metal and mac2.metal EC2 Instances — user experience</a></li></ul></div><ul class=post-tags></ul><div class=license><p>This work is licensed under a <a rel=license href=http://creativecommons.org/licenses/by-nd/4.0/>Creative Commons Attribution-NoDerivatives 4.0 International License</a></p></div><nav class=paginav><a class=prev href=https://devdosvid.blog/2021/09/25/aws-resource-access-manager-multi-account-resource-governance/><span class=title>« Prev</span><br><span>AWS Resource Access Manager — Multi Account Resource Governance</span></a>
<a class=next href=https://devdosvid.blog/2021/05/21/configure-http-security-headers-with-cloudfront-functions/><span class=title>Next »</span><br><span>Configure HTTP Security headers with CloudFront Functions</span></a></nav></footer></article></main><footer class=footer><div style=width:10em;margin:auto><p style=background-color:#0082ca;color:#fff>From Ukraine</p><p style=background-color:#ffb548;color:#fff>with love ❤️</p></div><span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>